<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP removed for GitHub Pages compatibility -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: https://api.qrserver.com; connect-src 'self' https: wss: https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com; frame-src 'self' https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com; child-src 'self' https://*.firebasedatabase.app https://*.firebaseapp.com;"> -->
    <title>ÌïôÍ∏â ÌÜ†Î°† Í≤åÏãúÌåê Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            zoom: 0.8;
            margin: 5px;
            padding: 0;
        }

        /* Ìó§Îçî Ïä§ÌÉÄÏùº */
        .header {
            background-color: white;
            color: #333;
            padding: 6px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .header h1::before {
            content: "üí¨";
            margin-right: 10px;
            font-size: 24px;
        }

        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        /* Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà */
        .main-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* ÏôºÏ™Ω Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        .control-panel {
            width: 280px;
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
        .content-area {
            flex: 1;
            background-color: white;
            border-radius: 6px;
            padding: 3px 15px 8px 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .welcome-section {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }

        .welcome-section h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #343a40;
        }

        .welcome-section p {
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* ÏÉÅÌÉú ÌëúÏãú */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        /* Î°úÍ∑∏ ÏòÅÏó≠ */
        .log-container {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #007bff;
        }

        .log-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }

        .log-content {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-warning {
            color: #ffc107;
        }

        .log-info {
            color: #17a2b8;
        }

        /* Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .grid-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.2s;
        }

        .grid-item:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 480px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-step {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .auto-url-display {
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 13px;
            color: #495057;
            font-family: 'Courier New', monospace;
        }

        .test-result {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-weight: bold;
            display: none;
        }

        .test-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            body {
                zoom: 0.9;
            }
            
            .main-container {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                order: 2;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ÌïôÍ∏â ÌÜ†Î°† Í≤åÏãúÌåê Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
        <div class="header-buttons">
            <div id="connectionStatus" class="status-indicator status-connecting">
                üîÑ Ïó∞Í≤∞ Ï§ë...
            </div>
            <button class="btn btn-success" onclick="showCreateClassForm()" id="createClassBtn">
                ‚ûï ÏÉà Î∞ò ÎßåÎì§Í∏∞
            </button>
            <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                ‚öôÔ∏è Firebase ÏÑ§Ï†ï
            </button>
        </div>
    </div>

    <div class="main-container">

        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ -->
        <div class="content-area">
            <div class="welcome-section" id="welcomeMessage">
                <h2>üìö ÌïôÍ∏â ÌÜ†Î°† Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h2>
                <p>ÌïôÍ∏â ÌÜ†Î°†ÏùÑ Ìö®Í≥ºÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨ÌïòÍ≥† Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÏÜåÌÜµÌï† Ïàò ÏûàÎäî ÏãúÏä§ÌÖúÏûÖÎãàÎã§.</p>
                
                <div style="margin-top: 10px; padding: 20px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">‚öôÔ∏è ÏãúÏûëÌïòÍ∏∞</h4>
                    <p style="color: #856404; margin: 0; font-size: 14px;">
                        <strong>Firebase ÏÑ§Ï†ï ÌõÑ Î∞îÎ°ú ÏãúÏûëÌïòÏÑ∏Ïöî!</strong><br><br>
                        1Ô∏è‚É£ Ìó§ÎçîÏùò "‚öôÔ∏è Firebase ÏÑ§Ï†ï" Î≤ÑÌäº ÌÅ¥Î¶≠<br>
                        2Ô∏è‚É£ Firebase ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÏûÖÎ†•<br>
                        3Ô∏è‚É£ Î∞ò ÏÉùÏÑ± ÎòêÎäî Í∏∞Ï°¥ Î∞ò Í¥ÄÎ¶¨ ÏãúÏûë!
                    </p>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">üéØ ÏôÑÏÑ±Îêú Í∏∞Îä•Îì§</h4>
                    <ul style="text-align: left; list-style: none; padding: 0;">
                        <li style="margin: 8px 0; color: #155724;">‚úÖ 1Îã®Í≥Ñ: HTML Íµ¨Ï°∞ Î∞è Ïä§ÌÉÄÏùºÎßÅ</li>
                        <li style="margin: 8px 0; color: #155724;">‚úÖ 2Îã®Í≥Ñ: Firebase SDK Ïó∞Í≤∞</li>
                        <li style="margin: 8px 0; color: #155724;">‚úÖ 3Îã®Í≥Ñ: Î∞ò Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</li>
                        <li style="margin: 8px 0; color: #155724;">‚úÖ 4Îã®Í≥Ñ: Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† Í¥ÄÎ¶¨</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase ÏÑ§Ï†ï Î™®Îã¨ -->
    <div class="modal-overlay" id="firebaseSettingsModal" style="display: none;">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï</h3>
                <button class="close-btn" onclick="closeFirebaseModal()">&times;</button>
            </div>

            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label">üìñ ÏÑ§Ï†ï Î∞©Î≤ï</label>
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; line-height: 1.6;">
                        <p><strong>1.</strong> <a href="https://console.firebase.google.com/" target="_blank" style="color: #3b82f6;">Firebase Console</a>ÏóêÏÑú ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±</p>
                        <p><strong>2.</strong> Realtime Database ÌôúÏÑ±Ìôî (ÌÖåÏä§Ìä∏ Î™®Îìú)</p>
                        <p><strong>3.</strong> ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï ‚Üí Ïõπ Ïï± Ï∂îÍ∞Ä ‚Üí Íµ¨ÏÑ± Ï†ïÎ≥¥ Î≥µÏÇ¨</p>
                        <p><strong>4.</strong> ÏïÑÎûò ÏûÖÎ†•ÎûÄÏóê Ï†ïÎ≥¥ ÏûÖÎ†• ÌõÑ Ï†ÄÏû•</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="text" class="form-input" id="userApiKey" placeholder="AIzaSyB...">
                </div>

                <div class="form-group">
                    <label class="form-label">Project ID</label>
                    <input type="text" class="form-input" id="userProjectId" placeholder="your-project-id" oninput="updateAutoUrl()">
                </div>

                <div class="form-group">
                    <p style="font-size: 14px; color: #6b7280; background: #f0fdf4; padding: 10px; border-radius: 6px; border-left: 4px solid #22c55e;">
                        ‚úÖ <strong>ÏûêÎèô ÏÑ§Ï†ï Ìï≠Î™©:</strong><br>
                        ‚Ä¢ Database URL: Project IDÎ°ú ÏûêÎèô ÏÉùÏÑ±<br>
                        ‚Ä¢ Auth Domain: Project IDÎ°ú ÏûêÎèô ÏÉùÏÑ±<br>
                        ‚Ä¢ Storage Bucket: Project IDÎ°ú ÏûêÎèô ÏÉùÏÑ±
                    </p>
                </div>

                <div class="form-group">
                    <p style="font-size: 14px; color: #dc2626; background: #fef2f2; padding: 10px; border-radius: 6px; border-left: 4px solid #dc2626;">
                        ‚ö†Ô∏è <strong>Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Ïãú Ï§ëÏöî:</strong><br>
                        <strong>Realtime Database ÏßÄÏó≠ÏùÑ Î∞òÎìúÏãú "ÏïÑÏãúÏïÑ ÎÇ®ÎèôÎ∂Ä(asia-southeast1)"Î°ú ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!</strong><br>
                        Îã§Î•∏ ÏßÄÏó≠ ÏÑ†ÌÉù Ïãú ÏûêÎèô ÏÉùÏÑ±Îêú URLÏù¥ ÏûëÎèôÌïòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏäµÎãàÎã§.
                    </p>
                </div>

                <div id="testResult" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeFirebaseModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-info" onclick="resetTeacherName()" style="margin-right: 10px;">üë§ ÍµêÏÇ¨ Ïù¥Î¶Ñ Ïû¨ÏÑ§Ï†ï</button>
                <button class="btn btn-primary" onclick="saveUserFirebaseConfig()">üîó Ïó∞Í≤∞ Î∞è Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- ÏÉà Î∞ò ÎßåÎì§Í∏∞ Î™®Îã¨ -->
    <div class="modal-overlay" id="createClassModal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï ÏÉà Î∞ò ÎßåÎì§Í∏∞</h3>
                <button class="close-btn" onclick="closeCreateClassModal()">&times;</button>
            </div>

            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label">Î∞ò Ïù¥Î¶Ñ</label>
                    <input type="text" class="form-input" id="newClassName" placeholder="Ïòà: 3ÌïôÎÖÑ 1Î∞ò, ÏàòÌïô Ïã¨ÌôîÎ∞ò">
                </div>

                <div class="form-group">
                    <label class="form-label">ÏÑ§Î™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                    <textarea class="form-input" id="newClassDescription" placeholder="Î∞òÏóê ÎåÄÌïú Í∞ÑÎã®Ìïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." style="min-height: 80px; resize: vertical;"></textarea>
                </div>

                <div id="createClassResult" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeCreateClassModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-success" onclick="createNewClass()">‚úÖ Î∞ò ÏÉùÏÑ±</button>
            </div>
        </div>
    </div>

    <!-- ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Î™®Îã¨ -->
    <div class="modal-overlay" id="createTopicModal" style="display: none;">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">üìù ÏÉà ÌÜ†Î°† Ï£ºÏ†ú ÎßåÎì§Í∏∞</h3>
                <button class="close-btn" onclick="closeCreateTopicModal()">&times;</button>
            </div>

            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label">ÌÜ†Î°† Ï†úÎ™©</label>
                    <input type="text" id="topicTitle" class="form-input" placeholder="Ïòà: ÌôòÍ≤Ω Î≥¥Ìò∏Ïùò Ï§ëÏöîÏÑ±" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÌÜ†Î°† ÏÑ§Î™Ö</label>
                    <textarea id="topicDescription" class="form-input" placeholder="ÌÜ†Î°† Ï£ºÏ†úÏóê ÎåÄÌïú ÏûêÏÑ∏Ìïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" rows="3" maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÌÜ†Î°† Ïú†Ìòï</label>
                    <select id="topicType" class="form-input">
                        <option value="chat">üí¨ Ï±ÑÌåÖÌòï ÌÜ†Î°† (Ïã§ÏãúÍ∞Ñ ÎåÄÌôî)</option>
                        <option value="postit">üìù Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°† (ÏùòÍ≤¨ Í≤åÏãú)</option>
                        <option value="debate">‚öñÔ∏è Ï∞¨Î∞òÌÜ†Î°† (Ï∞¨ÏÑ±/Î∞òÎåÄ Ìà¨Ìëú)</option>
                        <option value="general">üó£Ô∏è ÏùºÎ∞ò ÌÜ†Î°†</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ï†úÌïú ÏãúÍ∞Ñ (Î∂Ñ)</label>
                    <select id="topicTimeLimit" class="form-input">
                        <option value="0">Ï†úÌïú ÏóÜÏùå</option>
                        <option value="5">5Î∂Ñ</option>
                        <option value="10">10Î∂Ñ</option>
                        <option value="15">15Î∂Ñ</option>
                        <option value="30">30Î∂Ñ</option>
                        <option value="60">1ÏãúÍ∞Ñ</option>
                    </select>
                </div>
                
                <div id="createTopicResult" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateTopicModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" onclick="createNewTopic()">üöÄ ÌÜ†Î°† ÏÉùÏÑ±</button>
            </div>
        </div>
    </div>

    <script>
        // Í∏ÄÎ°úÎ≤å Î≥ÄÏàò
        let currentStep = 1;
        let userFirebaseConfig = null;
        
        // Î°úÍ∑∏ Ìï®Ïàò - ÏΩòÏÜîÎßå Ï∂úÎ†• (UI Î°úÍ∑∏ Ï†úÍ±∞Îê®)
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }

        // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.className = `status-indicator status-${status}`;
                statusEl.textContent = message;
            }
            // connectionStatus ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï°∞Ïö©Ìûà Î¨¥Ïãú
        }

        // ÌòÑÏû¨ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ (UI Ìå®ÎÑê Ï†úÍ±∞Î°ú Îπà Ìï®Ïàò)
        function updateCurrentStep(step, description) {
            currentStep = step;
            addLog(`Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏: ${step}Îã®Í≥Ñ - ${description}`, 'info');
        }

        // ÏßÑÌñâ ÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏ (UI Ìå®ÎÑê Ï†úÍ±∞Î°ú Îπà Ìï®Ïàò)
        function updateProgress(stepIndex, status, message) {
            addLog(`ÏßÑÌñâ ÏÉÅÌô©: ${message}`, status);
        }

        // Firebase Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
        function startConnectionMonitoring() {
            // FirebaseÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÎã§Î©¥ ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
            if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                console.log('üîÑ FirebaseÍ∞Ä ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏùå - Î™®ÎãàÌÑ∞ÎßÅ Í±¥ÎÑàÎúÄ');
                return;
            }
            
            try {
                const database = firebase.app().database();
                const connectedRef = database.ref('.info/connected');
                
                connectedRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        updateConnectionStatus('connected', 'üü¢ Firebase Ïó∞Í≤∞Îê®');
                        addLog('üü¢ Firebase Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞ ÌôïÏù∏Îê®', 'success');
                    } else {
                        updateConnectionStatus('connecting', 'üîÑ Ïó∞Í≤∞ Ï§ë...');
                        addLog('üîÑ Firebase Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...', 'info');
                    }
                });
            } catch (error) {
                console.log('üö® Firebase Î™®ÎãàÌÑ∞ÎßÅ Ïò§Î•ò:', error);
                updateConnectionStatus('disconnected', '‚ùå Ïó∞Í≤∞ Ïò§Î•ò');
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î∞îÎ°ú ÌÜ†Î°† Í¥ÄÎ¶¨ ÌôîÎ©¥ÏúºÎ°ú
        document.addEventListener('DOMContentLoaded', function() {
            // Î∞îÎ°ú ÌÜ†Î°† Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú ÏãúÏûë
            initMainInterface();
        });
        
        // Î©îÏù∏ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ Ï¥àÍ∏∞Ìôî
        async function initMainInterface() {
            // Firebase ÏÑ§Ï†ïÏù¥ ÏûàÏúºÎ©¥ ÏûêÎèô Ïó∞Í≤∞
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                if (typeof firebase !== 'undefined') {
                    // Firebase SDKÍ∞Ä Ïù¥ÎØ∏ Î°úÎìúÎêú Í≤ΩÏö∞ Î∞îÎ°ú Ïó∞Í≤∞
                    const database = initGlobalDatabase();
                    if (database) {
                        console.log('üöÄ Firebase ÏûêÎèô Ïó∞Í≤∞ ÏÑ±Í≥µ');
                    }
                } else {
                    // Firebase SDK ÏûêÎèô Î°úÎìú ÌõÑ Ïó∞Í≤∞
                    console.log('üì¶ Firebase SDK ÏûêÎèô Î°úÎìú Ï§ë...');
                    updateConnectionStatus('connecting', 'üì¶ SDK Î°úÎìú Ï§ë...');
                    try {
                        await loadFirebaseSDKAuto();
                        const database = initGlobalDatabase();
                        if (database) {
                            console.log('üöÄ Firebase SDK Î°úÎìú Î∞è ÏûêÎèô Ïó∞Í≤∞ ÏÑ±Í≥µ');
                        }
                    } catch (error) {
                        console.log('‚ùå Firebase SDK ÏûêÎèô Î°úÎìú Ïã§Ìå®:', error);
                        updateConnectionStatus('disconnected', '‚ùå Ïó∞Í≤∞ Ïã§Ìå®');
                    }
                }
            } else {
                console.log('‚öôÔ∏è Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Ìó§ÎçîÏùò Firebase ÏÑ§Ï†ï Î≤ÑÌäºÏùÑ Ïù¥Ïö©ÌïòÏÑ∏Ïöî.');
            }
            
            // Î∞îÎ°ú ÌÜ†Î°† Í¥ÄÎ¶¨ ÌôîÎ©¥ ÌëúÏãú
            showMainInterface();
        }
        
        // Î©îÏù∏ ÌÜ†Î°† Í¥ÄÎ¶¨ ÌôîÎ©¥ ÌëúÏãú
        function showMainInterface() {
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>üìö Î∞ò Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h2>
                <p>ÏÉùÏÑ±Ìïú Î∞ò Î™©Î°ùÏùÑ ÌôïÏù∏ÌïòÍ≥† Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§. ÏÉà Î∞òÏùÑ ÎßåÎì§Î†§Î©¥ Ìó§ÎçîÏùò "‚ûï ÏÉà Î∞ò ÎßåÎì§Í∏∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.</p>
                
                <div class="class-list-container" style="margin-top: 10px;">
                    <div id="myClassesList" style="min-height: 100px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            üìÇ ÏïÑÏßÅ Ï∞∏Í∞ÄÌïú Î∞òÏù¥ ÏóÜÏäµÎãàÎã§<br><br>
                            ÏúÑ Î≤ÑÌäºÏúºÎ°ú ÏÉà Î∞òÏùÑ ÎßåÎì§Í±∞ÎÇò Í∏∞Ï°¥ Î∞òÏóê Ï∞∏Í∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                    </div>
                </div>
                
                <div id="classFormContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #007bff; border-radius: 8px; padding: 20px;">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÌèºÏù¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
            `;
            
            // Î∞ò Î™©Î°ù Î°úÎìú
            loadMyClasses();
        }

        // 1Îã®Í≥Ñ ÌëúÏãú
        // showStep1 Ìï®Ïàò Ï†úÍ±∞Îê® (ÎØ∏ÏÇ¨Ïö©)

        // 2Îã®Í≥ÑÎ°ú ÏßÑÌñâ
        function startStep2() {
            addLog('üî• 2Îã®Í≥Ñ ÏßÑÌñâ: Firebase SDK Ïó∞Í≤∞ ÌÖåÏä§Ìä∏', 'warning');
            updateCurrentStep(2, 'Firebase Ïó∞Í≤∞');
            updateProgress(1, 'warning', 'Firebase SDK Î°úÎìú Ï§ë...');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>üî• 2Îã®Í≥Ñ: Firebase SDK Ïó∞Í≤∞</h2>
                <p>Firebase Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏôÄ Ïó∞Í≤∞ÌïòÏó¨ ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•/Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
                
                <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 8px;">‚öôÔ∏è Firebase ÏÑ§Ï†ï</h4>
                    <p style="font-size: 14px; color: #856404; margin: 0;">ÌîÑÎ°úÏ†ùÌä∏: class-discussion-ac0f6<br>
                    ÏßÄÏó≠: ÏïÑÏãúÏïÑ ÎÇ®ÎèôÎ∂Ä (singapore)</p>
                </div>
                
                <button class="btn btn-primary" onclick="loadFirebaseSDK()" id="loadFirebaseBtn">
                    üî• Firebase SDK Î°úÎìú ÏãúÏûë
                </button>
            `;
        }

        // Firebase SDK Î°úÎìú
        function loadFirebaseSDK() {
            try {
                addLog('üì¶ Firebase SDK ÎèôÏ†Å Î°úÎìú ÏãúÏûë...', 'info');
                
                // Firebase ÏÑ§Ï†ï ÎØ∏Î¶¨ ÌôïÏù∏
                const firebaseConfig = getFirebaseConfig();
                addLog(`üîç Firebase ÏÑ§Ï†ï ÌôïÏù∏: ${firebaseConfig.projectId}`, 'info');
                addLog(`üîó Database URL: ${firebaseConfig.databaseURL}`, 'info');
                
                updateConnectionStatus('connecting', 'üì¶ SDK Î°úÎìú Ï§ë...');
                
                document.getElementById('loadFirebaseBtn').disabled = true;
                document.getElementById('loadFirebaseBtn').textContent = '‚è≥ Î°úÎìú Ï§ë...';
                
                // Firebase App SDK Î°úÎìú
                const script1 = document.createElement('script');
            script1.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
            script1.onload = () => {
                addLog('‚úÖ Firebase App SDK (v10.13.0) Î°úÎìú ÏôÑÎ£å', 'success');
                
                // Firebase Database SDK Î°úÎìú
                const script2 = document.createElement('script');
                script2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
                script2.onload = () => {
                    addLog('‚úÖ Firebase Database SDK Î°úÎìú ÏôÑÎ£å', 'success');
                    updateProgress(1, 'warning', 'Firebase SDK Î°úÎìúÎê® - Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë');
                    setTimeout(() => testFirebaseConnection(), 1000);
                };
                script2.onerror = (event) => {
                    addLog('‚ùå Firebase Database SDK Î°úÎìú Ïã§Ìå®', 'error');
                    console.error('Database SDK Î°úÎìú Ïò§Î•ò:', event);
                    updateConnectionStatus('disconnected', '‚ùå Database SDK Ïã§Ìå®');
                    updateProgress(1, 'error', 'Firebase Database SDK Î°úÎìú Ïã§Ìå®');
                    
                    // Îã§Ïãú ÌôúÏÑ±Ìôî
                    document.getElementById('loadFirebaseBtn').disabled = false;
                    document.getElementById('loadFirebaseBtn').textContent = 'üî• Firebase SDK Î°úÎìú ÏãúÏûë';
                };
                document.head.appendChild(script2);
            };
            script1.onerror = (event) => {
                addLog('‚ùå Firebase App SDK Î°úÎìú Ïã§Ìå®', 'error');
                console.error('App SDK Î°úÎìú Ïò§Î•ò:', event);
                updateConnectionStatus('disconnected', '‚ùå App SDK Ïã§Ìå®');
                updateProgress(1, 'error', 'Firebase App SDK Î°úÎìú Ïã§Ìå®');
                
                // Îã§Ïãú ÌôúÏÑ±Ìôî
                document.getElementById('loadFirebaseBtn').disabled = false;
                document.getElementById('loadFirebaseBtn').textContent = 'üî• Firebase SDK Î°úÎìú ÏãúÏûë';
            };
            document.head.appendChild(script1);
            
            } catch (error) {
                addLog('‚ùå Firebase SDK Î°úÎìú Ï§ÄÎπÑ Ïã§Ìå®: ' + error.message, 'error');
                console.error('SDK Î°úÎìú Ï§ÄÎπÑ Ïò§Î•ò:', error);
                updateConnectionStatus('disconnected', '‚ùå Î°úÎìú Ï§ÄÎπÑ Ïã§Ìå®');
                
                // Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
                document.getElementById('loadFirebaseBtn').disabled = false;
                document.getElementById('loadFirebaseBtn').textContent = 'üî• Firebase SDK Î°úÎìú ÏãúÏûë';
            }
        }

        // Firebase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        function testFirebaseConnection() {
            addLog('üîó Firebase Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ ÏãúÏûë', 'info');
            
            try {
                // Firebase ÏÑ§Ï†ï - ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Ïö∞ÏÑ† ÏÇ¨Ïö©
                const firebaseConfig = getFirebaseConfig();
                
                addLog(`üìã ÌîÑÎ°úÏ†ùÌä∏ ID: ${firebaseConfig.projectId}`, 'info');
                addLog('üåè Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏßÄÏó≠: ÏïÑÏãúÏïÑ ÎÇ®ÎèôÎ∂Ä', 'info');
                
                // Firebase Ïï± Ï¥àÍ∏∞Ìôî
                const app = firebase.initializeApp(firebaseConfig, 'testApp-' + Date.now());
                const database = app.database();
                addLog('üöÄ Firebase Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å', 'success');
                
                // Ïó∞Í≤∞ ÏÉÅÌÉú Ïã§ÏãúÍ∞Ñ ÌôïÏù∏
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        addLog('üü¢ Firebase Realtime Database Ïó∞Í≤∞ ÏÑ±Í≥µ!', 'success');
                        updateConnectionStatus('connected', 'üü¢ Firebase Ïó∞Í≤∞Îê®');
                        updateProgress(1, 'success', 'Firebase Ïó∞Í≤∞ ÏôÑÎ£å');
                        showStep3Options();
                    } else {
                        addLog('üü° Firebase Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...', 'warning');
                        updateConnectionStatus('connecting', 'üü° Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...');
                    }
                });
                
                // 5Ï¥à ÌõÑÏóêÎèÑ Ïó∞Í≤∞Ïù¥ ÏïàÎêòÎ©¥ Ïò§Î•òÎ°ú Ï≤òÎ¶¨
                setTimeout(() => {
                    const status = document.getElementById('connectionStatus');
                    if (status.textContent.includes('ÎåÄÍ∏∞ Ï§ë')) {
                        addLog('‚ö†Ô∏è Firebase Ïó∞Í≤∞ ÏãúÍ∞Ñ Ï¥àÍ≥º - ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏ ÌïÑÏöî', 'warning');
                        updateConnectionStatus('disconnected', '‚ö†Ô∏è Ïó∞Í≤∞ ÏãúÍ∞Ñ Ï¥àÍ≥º');
                        updateProgress(1, 'error', 'Firebase Ïó∞Í≤∞ ÏãúÍ∞Ñ Ï¥àÍ≥º');
                    }
                }, 5000);
                
            } catch (error) {
                addLog('‚ùå Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò: ' + error.message, 'error');
                console.error('Firebase ÏÉÅÏÑ∏ Ïò§Î•ò:', error);
                
                // Îçî Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ
                let errorDetail = '';
                if (error.message.includes('Permission denied')) {
                    errorDetail = 'Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í∑úÏπô ÌôïÏù∏ ÌïÑÏöî';
                } else if (error.message.includes('Network')) {
                    errorDetail = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÌôïÏù∏ ÌïÑÏöî';
                } else if (error.message.includes('Project')) {
                    errorDetail = 'Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï ÌôïÏù∏ ÌïÑÏöî';
                } else {
                    errorDetail = error.message;
                }
                
                updateConnectionStatus('disconnected', `‚ùå ${errorDetail}`);
                updateProgress(1, 'error', `Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ${errorDetail}`);
                
                // Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
                document.getElementById('loadFirebaseBtn').disabled = false;
                document.getElementById('loadFirebaseBtn').textContent = 'üî• Firebase SDK Î°úÎìú ÏãúÏûë';
            }
        }

        // 3Îã®Í≥Ñ ÏòµÏÖò ÌëúÏãú
        function showStep3Options() {
            updateProgress(2, 'warning', 'Î∞ò Í¥ÄÎ¶¨ Í∏∞Îä• Ï§ÄÎπÑ Ï§ë');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>üéâ Firebase Ïó∞Í≤∞ ÏÑ±Í≥µ!</h2>
                <p>Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§. Ïù¥Ï†ú ÌïôÍ∏â Í¥ÄÎ¶¨ Í∏∞Îä•ÏùÑ Íµ¨ÌòÑÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                
                <div class="grid-container" style="margin-top: 25px;">
                    <div class="grid-item" onclick="startStep3()">
                        <h4 style="color: #155724; margin-bottom: 8px;">üìö 3Îã®Í≥Ñ: Î∞ò Í¥ÄÎ¶¨</h4>
                        <p style="font-size: 13px; color: #6c757d;">Î∞ò ÏÉùÏÑ±, ÏÑ†ÌÉù, Í¥ÄÎ¶¨ Í∏∞Îä•</p>
                    </div>
                    <div class="grid-item" onclick="alert('4Îã®Í≥ÑÏóêÏÑú Íµ¨ÌòÑÎê©ÎãàÎã§!')">
                        <h4 style="color: #856404; margin-bottom: 8px;">üí¨ 4Îã®Í≥Ñ: ÌÜ†Î°† Ï£ºÏ†ú</h4>
                        <p style="font-size: 13px; color: #6c757d;">ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨</p>
                    </div>
                    <div class="grid-item" onclick="alert('5Îã®Í≥ÑÏóêÏÑú Íµ¨ÌòÑÎê©ÎãàÎã§!')">
                        <h4 style="color: #721c24; margin-bottom: 8px;">üó®Ô∏è 5Îã®Í≥Ñ: Ïã§ÏãúÍ∞Ñ ÌÜ†Î°†</h4>
                        <p style="font-size: 13px; color: #6c757d;">Î©îÏã†Ï†Ä/Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†</p>
                    </div>
                </div>
            `;
        }

        // 3Îã®Í≥Ñ ÏãúÏûë
        function startStep3() {
            addLog('üìö 3Îã®Í≥Ñ ÏãúÏûë: Î∞ò Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Íµ¨ÌòÑ', 'success');
            updateCurrentStep(3, 'Î∞ò Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú');
            updateProgress(2, 'success', 'Î∞ò Í¥ÄÎ¶¨ Í∏∞Îä• Íµ¨ÌòÑ Ï§ë');
            
            // 3Îã®Í≥Ñ Ìó§ÎçîÎ°ú Î≥ÄÍ≤Ω
            updateHeaderForStep3();
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>üìö Î∞ò Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h2>
                <p>ÏÉùÏÑ±Ìïú Î∞ò Î™©Î°ùÏùÑ ÌôïÏù∏ÌïòÍ≥† Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§. ÏÉà Î∞òÏùÑ ÎßåÎì§Î†§Î©¥ Ìó§ÎçîÏùò "‚ûï ÏÉà Î∞ò ÎßåÎì§Í∏∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.</p>
                
                
                <div class="class-list-container" style="margin-top: 10px;">
                    <div id="myClassesList" style="min-height: 100px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            üìÇ ÏïÑÏßÅ Ï∞∏Í∞ÄÌïú Î∞òÏù¥ ÏóÜÏäµÎãàÎã§<br><br>
                            ÏúÑ Î≤ÑÌäºÏúºÎ°ú ÏÉà Î∞òÏùÑ ÎßåÎì§Í±∞ÎÇò Í∏∞Ï°¥ Î∞òÏóê Ï∞∏Í∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                    </div>
                </div>
                
                <div id="classFormContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #007bff; border-radius: 8px; padding: 20px;">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÌèºÏù¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
            `;
            
            // Í∏∞Ï°¥ Î∞ò Î™©Î°ù Î°úÎìú
            loadMyClasses();
        }

        // 3Îã®Í≥Ñ Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        function updateHeaderForStep3() {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <div id="connectionStatus" class="status-indicator status-connecting">
                    üîÑ Ïó∞Í≤∞ Ï§ë...
                </div>
                <button class="btn btn-success" onclick="showCreateClassForm()" id="createClassBtn">
                    ‚ûï ÏÉà Î∞ò ÎßåÎì§Í∏∞
                </button>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    ‚öôÔ∏è Firebase ÏÑ§Ï†ï
                </button>
            `;
            
            // Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ïó∞Í≤∞ ÏÉÅÌÉú Îã§Ïãú Î™®ÎãàÌÑ∞ÎßÅ
            setTimeout(() => {
                startConnectionMonitoring();
            }, 100);
        }
        
        // 2Îã®Í≥Ñ(ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨) Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        function updateHeaderForTopicsManagement() {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <div id="connectionStatus" class="status-indicator status-connecting">
                    üîÑ Ïó∞Í≤∞ Ï§ë...
                </div>
                <button class="btn btn-primary" onclick="goBackToClassList()" id="backToClassBtn">
                    ‚Üê Î∞ò Í¥ÄÎ¶¨Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </button>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    ‚öôÔ∏è Firebase ÏÑ§Ï†ï
                </button>
            `;
            
            // Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ïó∞Í≤∞ ÏÉÅÌÉú Îã§Ïãú Î™®ÎãàÌÑ∞ÎßÅ
            setTimeout(() => {
                startConnectionMonitoring();
            }, 100);
        }

        // 3Îã®Í≥Ñ(Ïã§ÏãúÍ∞Ñ ÌÜ†Î°†Í¥ÄÎ¶¨) Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        function updateHeaderForDiscussion() {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <div id="connectionStatus" class="status-indicator status-connecting">
                    üîÑ Ïó∞Í≤∞ Ï§ë...
                </div>
                <button class="btn btn-primary" onclick="goBackToClassList()" id="backToClassBtn">
                    ‚Üê Î∞ò Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </button>
                <button class="btn btn-info" onclick="backToTopicsManagement()" id="backToTopicsBtn">
                    ‚Üê ÌÜ†Î°†Î∞©ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </button>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    ‚öôÔ∏è Firebase ÏÑ§Ï†ï
                </button>
            `;
            
            // Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ïó∞Í≤∞ ÏÉÅÌÉú Îã§Ïãú Î™®ÎãàÌÑ∞ÎßÅ
            setTimeout(() => {
                startConnectionMonitoring();
            }, 100);
        }
        
        // Î∞ò Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞ Ìï®Ïàò
        function goBackToClassList() {
            // URLÏóêÏÑú ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞ Ï†úÍ±∞ÌïòÍ≥† Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            const currentUrl = window.location.href.split('?')[0];
            window.location.href = currentUrl;
        }

        // ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞ Ìï®Ïàò (3Îã®Í≥Ñ ‚Üí 2Îã®Í≥Ñ)
        function backToTopicsManagement() {
            addLog('üîô ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞', 'info');
            
            // 2Îã®Í≥Ñ(ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨) Ìó§ÎçîÎ°ú Î≥ÄÍ≤Ω
            updateHeaderForTopicsManagement();
            
            // 2Îã®Í≥Ñ(ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨) ÌôîÎ©¥ÏúºÎ°ú ÎêòÎèåÎ¶¨Í∏∞
            updateCurrentStep(5, `Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† Í¥ÄÎ¶¨ - ${window.currentClassName || 'ÌÜ†Î°†Î∞©'}`);
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div class="topics-management-container" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #495057;">üìã ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨</h3>
                        <div>
                            <button onclick="showCreateTopicForm()" class="btn" style="background: #28a745; color: white; margin-right: 10px;">
                                üìù ÏÉà ÌÜ†Î°†Î∞© ÎßåÎì§Í∏∞
                            </button>
                            <button onclick="shareStudentLink()" class="btn" style="background: #17a2b8; color: white;">
                                üîó ÌïôÏÉù ÎßÅÌÅ¨ Í≥µÏú†
                            </button>
                        </div>
                    </div>
                    <div id="topicsGridList" style="min-height: 200px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            üìù ÌÜ†Î°†Î∞©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                        </div>
                    </div>
                </div>
            `;
            
            // ÌÜ†Î°†Î∞© Î™©Î°ù Îã§Ïãú Î°úÎìú
            loadTopicsList();
        }

        // =========================
        // ÍµêÏÇ¨ Ïù¥Î¶Ñ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        // =========================
        
        // ÍµêÏÇ¨ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
        function getTeacherName() {
            let teacherName = localStorage.getItem('teacherName');
            if (!teacherName) {
                teacherName = prompt('ÍµêÏÇ¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî:', 'ÏÑ†ÏÉùÎãò');
                if (teacherName && teacherName.trim()) {
                    localStorage.setItem('teacherName', teacherName.trim());
                } else {
                    teacherName = 'ÏÑ†ÏÉùÎãò'; // Í∏∞Î≥∏Í∞í
                }
            }
            return teacherName;
        }

        // ÍµêÏÇ¨ Ïù¥Î¶Ñ Ïû¨ÏÑ§Ï†ï
        function resetTeacherName() {
            const currentName = localStorage.getItem('teacherName') || 'ÏÑ†ÏÉùÎãò';
            const newName = prompt(`ÌòÑÏû¨ ÍµêÏÇ¨ Ïù¥Î¶Ñ: ${currentName}\n\nÏÉàÎ°úÏö¥ ÍµêÏÇ¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî:`, currentName);
            if (newName && newName.trim()) {
                localStorage.setItem('teacherName', newName.trim());
                alert(`‚úÖ ÍµêÏÇ¨ Ïù¥Î¶ÑÏù¥ "${newName.trim()}"Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
            }
        }

        // =========================
        // Firebase ÏÑ§Ï†ï Í¥ÄÎ†® Ìï®ÏàòÎì§
        // =========================

        // ÏÇ¨Ïö©Ïûê Firebase ÏÑ§Ï†ï Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞
        function loadUserFirebaseConfig() {
            const savedConfig = {
                apiKey: localStorage.getItem('user_firebase_apiKey'),
                projectId: localStorage.getItem('user_firebase_projectId')
            };
            
            if (savedConfig.apiKey && savedConfig.projectId) {
                userFirebaseConfig = {
                    apiKey: savedConfig.apiKey,
                    authDomain: `${savedConfig.projectId}.firebaseapp.com`,
                    databaseURL: `https://${savedConfig.projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: savedConfig.projectId,
                    storageBucket: `${savedConfig.projectId}.appspot.com`
                };
                return userFirebaseConfig;
            }
            
            return null;
        }

        function saveUserFirebaseConfigToStorage(apiKey, projectId) {
            localStorage.setItem('user_firebase_apiKey', apiKey);
            localStorage.setItem('user_firebase_projectId', projectId);
            localStorage.setItem('user_firebase_databaseURL', `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`);
        }

        // Firebase ÏÑ§Ï†ï Î™®Îã¨ Í¥ÄÎ†®
        function openFirebaseSettings() {
            document.getElementById('firebaseSettingsModal').style.display = 'block';
            
            // Í∏∞Ï°¥ ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞
            const savedApiKey = localStorage.getItem('user_firebase_apiKey');
            const savedProjectId = localStorage.getItem('user_firebase_projectId');
            
            if (savedApiKey && savedProjectId) {
                document.getElementById('userApiKey').value = savedApiKey;
                document.getElementById('userProjectId').value = savedProjectId;
                updateAutoUrl();
            }
        }

        function closeFirebaseModal() {
            document.getElementById('firebaseSettingsModal').style.display = 'none';
            document.getElementById('testResult').style.display = 'none';
        }

        function updateAutoUrl() {
            // Project ID ÏûÖÎ†• Ïãú Ï≤òÎ¶¨ - UI ÏóÖÎç∞Ïù¥Ìä∏Îäî Ï†úÍ±∞Îê®
        }

        // ÏÇ¨Ïö©Ïûê Firebase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        async function testUserFirebaseConnection() {
            const apiKey = document.getElementById('userApiKey').value.trim();
            const projectId = document.getElementById('userProjectId').value.trim();
            
            if (!apiKey || !projectId) {
                showTestResult('error', '‚ùå API KeyÏôÄ Project IDÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            showTestResult('info', 'üîç Firebase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...');
            addLog('üß™ ÏÇ¨Ïö©Ïûê Firebase ÏÑ§Ï†ï ÌÖåÏä§Ìä∏ ÏãúÏûë', 'warning');
            addLog(`   ÌîÑÎ°úÏ†ùÌä∏ ID: ${projectId}`, 'info');
            
            try {
                const testConfig = {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`
                };
                
                // Firebase SDKÍ∞Ä Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                if (typeof firebase === 'undefined') {
                    showTestResult('error', '‚ùå Firebase SDKÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Î®ºÏ†Ä 2Îã®Í≥ÑÎ•º ÏôÑÎ£åÌïòÏÑ∏Ïöî.');
                    addLog('‚ùå Firebase SDK ÎØ∏Î°úÎìú - 2Îã®Í≥Ñ Î®ºÏ†Ä ÏôÑÎ£å ÌïÑÏöî', 'error');
                    return;
                }
                
                const testApp = firebase.initializeApp(testConfig, 'userTestApp-' + Date.now());
                const testDatabase = testApp.database();
                
                // ÌÉÄÏûÑÏïÑÏõÉÍ≥º Ìï®Íªò Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Ïó∞Í≤∞ ÏãúÍ∞Ñ Ï¥àÍ≥º (10Ï¥à)')), 10000)
                );
                
                const connectionPromise = new Promise((resolve, reject) => {
                    const connectedRef = testDatabase.ref('.info/connected');
                    connectedRef.once('value', (snapshot) => {
                        if (snapshot.val() === true) {
                            resolve(true);
                        } else {
                            reject(new Error('Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§'));
                        }
                    }, (error) => {
                        reject(error);
                    });
                });
                
                await Promise.race([connectionPromise, timeoutPromise]);
                
                showTestResult('success', '‚úÖ Firebase Ïó∞Í≤∞ ÏÑ±Í≥µ! Ïù¥Ï†ú "Ï†ÄÏû• Î∞è Ï†ÅÏö©" Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî.');
                addLog('‚úÖ ÏÇ¨Ïö©Ïûê Firebase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ', 'success');
                
                // ÌÖåÏä§Ìä∏ Ïï± Ï†ïÎ¶¨
                setTimeout(() => {
                    try {
                        testApp.delete();
                    } catch(e) {
                        console.log('ÌÖåÏä§Ìä∏ Ïï± Ï†ïÎ¶¨ ÏôÑÎ£å');
                    }
                }, 1000);
                
            } catch (error) {
                let errorMsg = '‚ùå Ïó∞Í≤∞ Ïã§Ìå®: ';
                if (error.message.includes('ÏãúÍ∞Ñ Ï¥àÍ≥º')) {
                    errorMsg += 'Ïó∞Í≤∞ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§. Database URLÍ≥º ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ïÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.';
                } else if (error.code === 'app/invalid-api-key') {
                    errorMsg += 'API KeyÍ∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.';
                } else if (error.message.includes('permission') || error.message.includes('PERMISSION_DENIED')) {
                    errorMsg += 'Database Í∂åÌïúÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî. Realtime Database Í∑úÏπôÏùÑ ÌÖåÏä§Ìä∏ Î™®ÎìúÎ°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.';
                } else {
                    errorMsg += error.message;
                }
                
                showTestResult('error', errorMsg);
                addLog('‚ùå ÏÇ¨Ïö©Ïûê Firebase Ïó∞Í≤∞ Ïã§Ìå®: ' + error.message, 'error');
            }
        }

        function showTestResult(type, message) {
            const testResult = document.getElementById('testResult');
            testResult.className = `test-result test-${type}`;
            testResult.textContent = message;
            testResult.style.display = 'block';
        }

        // ÏÇ¨Ïö©Ïûê Firebase ÏÑ§Ï†ï Ï†ÄÏû• Î∞è ÏôÑÏ†Ñ ÏûêÎèô Ïó∞Í≤∞
        async function saveUserFirebaseConfig() {
            try {
                addLog('üöÄ Ï†ÄÏû• Î∞è ÏûêÎèôÏó∞Í≤∞ Î≤ÑÌäº ÌÅ¥Î¶≠Îê®', 'info');
                
                const apiKey = document.getElementById('userApiKey').value.trim();
                const projectId = document.getElementById('userProjectId').value.trim();
                
                addLog(`üìù ÏûÖÎ†•Í∞í ÌôïÏù∏ - API Key: ${apiKey ? 'ÏûÖÎ†•Îê®' : 'ÎπÑÏñ¥ÏûàÏùå'}, Project ID: ${projectId ? 'ÏûÖÎ†•Îê®' : 'ÎπÑÏñ¥ÏûàÏùå'}`, 'info');
                
                if (!apiKey || !projectId) {
                    showTestResult('error', '‚ùå API KeyÏôÄ Project IDÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    addLog('‚ùå ÌïÑÏàò ÏûÖÎ†•Í∞íÏù¥ ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§', 'error');
                    return;
                }
                
                showTestResult('info', 'üíæ ÏÑ§Ï†ï Ï†ÄÏû• Ï§ë...');
                addLog('üíæ Firebase ÏÑ§Ï†ï Ï†ÄÏû• ÏãúÏûë', 'info');
                
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                saveUserFirebaseConfigToStorage(apiKey, projectId);
                
                // Í∏ÄÎ°úÎ≤å ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
                userFirebaseConfig = {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`
                };
                
                addLog(`üíæ ÏÇ¨Ïö©Ïûê Firebase ÏÑ§Ï†ï Ï†ÄÏû•: ${projectId}`, 'success');
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏ (projectInfoBtn Ï†úÍ±∞Îê®)
                
                // Firebase SDKÍ∞Ä Î°úÎìúÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                if (typeof firebase === 'undefined') {
                    showTestResult('info', 'üì¶ Firebase SDK ÏûêÎèô Î°úÎìú Ï§ë...');
                    addLog('üì¶ Firebase SDKÍ∞Ä ÏóÜÏäµÎãàÎã§. ÏûêÎèô Î°úÎìú ÏãúÏûë...', 'info');
                    
                    // Firebase SDK ÏûêÎèô Î°úÎìú
                    await loadFirebaseSDKAuto();
                    
                    // 2Îã®Í≥Ñ UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateCurrentStep(2, 'Firebase SDK Î°úÎìúÎê®');
                    updateProgress(1, 'success', 'Firebase SDK ÏûêÎèô Î°úÎìú ÏôÑÎ£å');
                }
                
                // Firebase ÏûêÎèô Ïó∞Í≤∞
                showTestResult('info', 'üîó Firebase ÏûêÎèô Ïó∞Í≤∞ Ï§ë...');
                addLog('üöÄ Ï†ÄÏû•Îêú ÏÑ§Ï†ïÏúºÎ°ú Firebase ÏûêÎèô Ïó∞Í≤∞ ÏãúÏûë', 'info');
                
                await autoConnectFirebase();
                showTestResult('success', '‚úÖ Firebase ÏÑ§Ï†ï Ï†ÄÏû• Î∞è Ïó∞Í≤∞ ÏôÑÎ£å!');
                
                // Î™®Îã¨ Îã´Í≥† ÏÑ±Í≥µ Î°úÍ∑∏
                closeFirebaseModal();
                addLog(`üéâ Firebase Ïó∞Í≤∞ ÏÑ±Í≥µ! ÏûêÎèôÏúºÎ°ú 3Îã®Í≥Ñ ÏßÑÌñâ`, 'success');
                
                // 3Îã®Í≥Ñ ÏûêÎèô ÏãúÏûë
                updateCurrentStep(3, 'Î∞ò Í¥ÄÎ¶¨');
                updateProgress(1, 'success', 'Firebase Ïó∞Í≤∞ ÏôÑÎ£å');
                updateProgress(2, 'warning', 'Î∞ò Í¥ÄÎ¶¨ Í∏∞Îä• ÏãúÏûë Ï§ë');
                
                // 1Ï¥à ÌõÑ 3Îã®Í≥Ñ ÏûêÎèô ÏãúÏûë
                setTimeout(() => {
                    startStep3();
                }, 1000);
                
            } catch (error) {
                showTestResult('error', '‚ùå ÏûêÎèô ÏÑ§Ï†ï Ïã§Ìå®: ' + error.message);
                addLog('‚ùå Firebase ÏûêÎèô ÏÑ§Ï†ï Ïã§Ìå®: ' + error.message, 'error');
                console.error('Firebase ÏÑ§Ï†ï ÏóêÎü¨:', error);
                
                // Íµ¨Ï≤¥Ï†ÅÏù∏ Ìï¥Í≤∞ Î∞©Î≤ï Ï†úÍ≥µ
                let solutionSteps = '';
                if (error.message.includes('Í∂åÌïú Ïò§Î•ò') || error.message.includes('Permission denied')) {
                    solutionSteps = `
üìã Realtime Database Í∑úÏπô ÏÑ§Ï†ï Î∞©Î≤ï:
1. https://console.firebase.google.com Ï†ëÏÜç
2. ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù
3. ÏôºÏ™Ω Î©îÎâ¥ "Realtime Database" ÌÅ¥Î¶≠
4. "Í∑úÏπô" ÌÉ≠ ÌÅ¥Î¶≠
5. Îã§Ïùå Í∑úÏπôÏúºÎ°ú Î≥ÄÍ≤Ω:
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
6. "Í≤åÏãú" Î≤ÑÌäº ÌÅ¥Î¶≠

‚ö†Ô∏è Ï£ºÏùò: Í∞úÎ∞ú/ÌÖåÏä§Ìä∏ Ïö©ÎèÑÎ°úÎßå ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.`;
                } else if (error.message.includes('Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ')) {
                    solutionSteps = `
üìã Realtime Database ÌôúÏÑ±Ìôî Î∞©Î≤ï:
1. https://console.firebase.google.com Ï†ëÏÜç
2. ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù
3. ÏôºÏ™Ω Î©îÎâ¥ "Realtime Database" ÌÅ¥Î¶≠
4. "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎßåÎì§Í∏∞" Î≤ÑÌäº ÌÅ¥Î¶≠
5. ÏúÑÏπò: ÏïÑÏãúÏïÑ ÎÇ®ÎèôÎ∂Ä (singapore) ÏÑ†ÌÉù
6. Î≥¥Ïïà Í∑úÏπô: ÌÖåÏä§Ìä∏ Î™®ÎìúÎ°ú ÏãúÏûë ÏÑ†ÌÉù
7. "ÏôÑÎ£å" ÌÅ¥Î¶≠`;
                } else {
                    solutionSteps = `
üìã ÏùºÎ∞òÏ†ÅÏù∏ Ìï¥Í≤∞ Î∞©Î≤ï:
1. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÌôïÏù∏
2. API KeyÏôÄ Project ID Ïû¨ÌôïÏù∏
3. Firebase ÌîÑÎ°úÏ†ùÌä∏ ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÌôïÏù∏
4. Realtime Database ÌôúÏÑ±Ìôî ÌôïÏù∏
5. Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãú ÏÇ≠Ï†ú ÌõÑ Ïû¨ÏãúÎèÑ`;
                }
                
                // Ïã§Ìå®Ìïú Í≤ΩÏö∞ ÏÉÅÏÑ∏Ìïú ÏïàÎÇ¥
                setTimeout(() => {
                    closeFirebaseModal();
                    alert(`‚ö†Ô∏è Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\n‚ùå Ïò§Î•ò: ${error.message}\n\n${solutionSteps}\n\nÌï¥Í≤∞ ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
                }, 2000);
            }
        }

        // Firebase SDK ÏûêÎèô Î°úÎìú Ìï®Ïàò
        function loadFirebaseSDKAuto() {
            return new Promise((resolve, reject) => {
                addLog('üì¶ Firebase App SDK Î°úÎìú Ï§ë...', 'info');
                
                // Firebase App SDK Î°úÎìú
                const script1 = document.createElement('script');
                script1.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
                script1.onload = () => {
                    addLog('‚úÖ Firebase App SDK Î°úÎìú ÏôÑÎ£å', 'success');
                    
                    // Firebase Database SDK Î°úÎìú
                    const script2 = document.createElement('script');
                    script2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
                    script2.onload = () => {
                        addLog('‚úÖ Firebase Database SDK Î°úÎìú ÏôÑÎ£å', 'success');
                        addLog('üéØ Firebase SDK ÏûêÎèô Î°úÎìú ÏÑ±Í≥µ!', 'success');
                        resolve();
                    };
                    script2.onerror = () => {
                        reject(new Error('Firebase Database SDK Î°úÎìú Ïã§Ìå®'));
                    };
                    document.head.appendChild(script2);
                };
                script1.onerror = () => {
                    reject(new Error('Firebase App SDK Î°úÎìú Ïã§Ìå®'));
                };
                document.head.appendChild(script1);
            });
        }

        // Firebase ÏûêÎèô Ïó∞Í≤∞ Ìï®Ïàò
        async function autoConnectFirebase() {
            const firebaseConfig = getFirebaseConfig();
            
            addLog(`üìã ÌîÑÎ°úÏ†ùÌä∏ ID: ${firebaseConfig.projectId}`, 'info');
            addLog(`üåê Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ URL: ${firebaseConfig.databaseURL}`, 'info');
            addLog('üåè Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏßÄÏó≠: ÏïÑÏãúÏïÑ ÎÇ®ÎèôÎ∂Ä', 'info');
            
            try {
                // Í∏∞Ï°¥ Firebase Ïï±Ïù¥ ÏûàÏúºÎ©¥ ÏÇ≠Ï†ú
                if (firebase.apps.length > 0) {
                    firebase.apps.forEach(app => {
                        app.delete();
                    });
                    addLog('üóëÔ∏è Í∏∞Ï°¥ Firebase Ïï± ÏÇ≠Ï†úÎê®', 'info');
                }
                
                // Firebase Í∏∞Î≥∏ Ïï±ÏúºÎ°ú Ï¥àÍ∏∞Ìôî
                const app = firebase.initializeApp(firebaseConfig);
                const database = app.database();
                addLog('üöÄ Firebase Í∏∞Î≥∏ Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å', 'success');
                
                // Î®ºÏ†Ä Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏ Ïì∞Í∏∞Î°ú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ëÍ∑º ÌôïÏù∏
                const testRef = database.ref('test');
                await testRef.set({ timestamp: Date.now(), test: true });
                addLog('‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïì∞Í∏∞ ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ', 'success');
                
                // ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                await testRef.remove();
                addLog('üóëÔ∏è ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨ ÏôÑÎ£å', 'success');
                
                addLog('üü¢ Firebase ÏûêÎèô Ïó∞Í≤∞ ÏÑ±Í≥µ!', 'success');
                updateConnectionStatus('connected', 'üü¢ Firebase Ïó∞Í≤∞Îê®');
                
                // Í∏ÄÎ°úÎ≤å database Í∞ùÏ≤¥ ÏÑ§Ï†ï
                window.database = database;
                
                // Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ Îã§Ïãú ÏãúÏûë
                startConnectionMonitoring();
                
                return true;
                
            } catch (error) {
                addLog(`‚ùå Firebase Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}`, 'error');
                
                // Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÍ≥µ
                let detailedError = 'Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                
                if (error.message.includes('Permission denied')) {
                    detailedError = 'Í∂åÌïú Ïò§Î•ò: Realtime Database Í∑úÏπôÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.';
                } else if (error.message.includes('not found')) {
                    detailedError = 'Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§. Realtime DatabaseÎ•º ÌôúÏÑ±ÌôîÌïòÏÑ∏Ïöî.';
                } else if (error.message.includes('network')) {
                    detailedError = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.';
                }
                
                throw new Error(detailedError);
            }
        }

        // Firebase ÎèÑÏõÄÎßê ÌëúÏãú
        function showFirebaseHelp() {
            const helpContent = `
üî• Firebase ÏÑ§Ï†ï ÎèÑÏõÄÎßê

üìã 1Îã®Í≥Ñ: Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
‚Ä¢ https://console.firebase.google.com Ï†ëÏÜç
‚Ä¢ "ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä" ÌÅ¥Î¶≠
‚Ä¢ ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ ÏûÖÎ†• ÌõÑ ÏÉùÏÑ±

üìã 2Îã®Í≥Ñ: API Key Ï∞æÍ∏∞
‚Ä¢ ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï (‚öôÔ∏è ÏïÑÏù¥ÏΩò) ÌÅ¥Î¶≠
‚Ä¢ "ÏùºÎ∞ò" ÌÉ≠ÏóêÏÑú "Ïõπ API ÌÇ§" Î≥µÏÇ¨

üìã 3Îã®Í≥Ñ: Realtime Database ÌôúÏÑ±Ìôî
‚Ä¢ ÏôºÏ™Ω Î©îÎâ¥ "Realtime Database" ÌÅ¥Î¶≠
‚Ä¢ "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎßåÎì§Í∏∞" ÌÅ¥Î¶≠
‚Ä¢ ÏúÑÏπò: ÏïÑÏãúÏïÑ ÎÇ®ÎèôÎ∂Ä (singapore) ÏÑ†ÌÉù
‚Ä¢ Î≥¥Ïïà Í∑úÏπô: "ÌÖåÏä§Ìä∏ Î™®ÎìúÎ°ú ÏãúÏûë" ÏÑ†ÌÉù

üìã 4Îã®Í≥Ñ: Î≥¥Ïïà Í∑úÏπô ÏÑ§Ï†ï
‚Ä¢ "Í∑úÏπô" ÌÉ≠ÏóêÏÑú Îã§ÏùåÏúºÎ°ú Î≥ÄÍ≤Ω:
{
  "rules": {
    ".read": true,
    ".write": true
  }
}

‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠:
‚Ä¢ Ïù¥ Í∑úÏπôÏùÄ Í∞úÎ∞ú/ÌÖåÏä§Ìä∏Ïö©ÏûÖÎãàÎã§
‚Ä¢ Ïã§Ï†ú ÏÑúÎπÑÏä§ÏóêÏÑúÎäî Îçî ÏóÑÍ≤©Ìïú Í∑úÏπô ÏÇ¨Ïö© ÌïÑÏöî
‚Ä¢ API KeyÎäî ÏïàÏ†ÑÌïòÍ≤å Î≥¥Í¥ÄÌïòÏÑ∏Ïöî

üÜò Î¨∏Ï†ú Ìï¥Í≤∞:
‚Ä¢ Permission denied: Î≥¥Ïïà Í∑úÏπô ÌôïÏù∏
‚Ä¢ Database not found: Realtime Database ÌôúÏÑ±Ìôî
‚Ä¢ Network error: Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ ÌôïÏù∏
            `;
            
            alert(helpContent);
        }

        // ÎÇ¥ Î∞ò Î™©Î°ù Î°úÎìú Ìï®Ïàò
        async function loadMyClassesList() {
            try {
                const config = loadUserFirebaseConfig();
                if (!config) return;
                
                // Firebase SDK ÌôïÏù∏
                if (typeof firebase === 'undefined') {
                    addLog('Firebase SDKÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§', 'warning');
                    const errorHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 20px;">
                            ‚ö†Ô∏è Firebase SDK Î°úÎìú ÌïÑÏöî<br><br>
                            "üöÄ Ï†ÄÏû• Î∞è ÏûêÎèôÏó∞Í≤∞" Î≤ÑÌäºÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî
                        </div>
                    `;
                    document.getElementById('myClassesListModal').innerHTML = errorHTML;
                    return;
                }
                
                // Firebase Ïï± Ï¥àÍ∏∞Ìôî (Ïù¥ÎØ∏ ÎêòÏñ¥ÏûàÏùÑ Ïàò ÏûàÏùå)
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                
                const database = firebase.database();
                const classesRef = database.ref('classes');
                
                // Î™®Îì† Î∞ò Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const snapshot = await classesRef.once('value');
                const classes = snapshot.val() || {};
                
                const myClassesListModal = document.getElementById('myClassesListModal');
                const myClassesList = document.getElementById('myClassesList');
                
                if (Object.keys(classes).length === 0) {
                    const noClassesHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            üìÇ ÏÉùÏÑ±Îêú Î∞òÏù¥ ÏóÜÏäµÎãàÎã§<br><br>
                            ÏÉà Î∞òÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                    `;
                    myClassesListModal.innerHTML = noClassesHTML;
                    if (myClassesList) myClassesList.innerHTML = noClassesHTML;
                    return;
                }
                
                // Î∞ò Î™©Î°ù HTML ÏÉùÏÑ± (Ï†ïÏÇ¨Í∞ÅÌòï Ïπ¥Îìú Í∑∏Î¶¨Îìú)
                let classListHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">';
                Object.entries(classes).forEach(([classId, classData]) => {
                    const createdDate = new Date(classData.createdAt).toLocaleDateString('ko-KR');
                    const studentCount = classData.students ? Object.keys(classData.students).length : 0;
                    const discussionCount = classData.discussions ? Object.keys(classData.discussions).length : 0;
                    
                    classListHTML += `
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between;" 
                             onclick="selectClass('${classId}', '${classData.className}')"
                             onmouseover="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 12px rgba(0,123,255,0.2); this.style.transform='translateY(-2px)'"
                             onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)'">
                            
                            <div style="text-align: center; margin-bottom: 12px;">
                                <h4 style="color: #374151; font-size: 16px; font-weight: 600; margin: 0 0 8px 0; line-height: 1.2; word-break: keep-all;">${classData.className}</h4>
                                <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${classId}</span>
                            </div>
                            
                            <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                ${classData.description ? 
                                    `<p style="color: #6b7280; font-size: 12px; text-align: center; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">${classData.description}</p>` : 
                                    `<div style="color: #9ca3af; font-size: 32px;">üìö</div>`
                                }
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #6b7280; text-align: center;">
                                <div>üë• ${studentCount}Î™Ö</div>
                                <div>üí≠ ${discussionCount}Í∞ú</div>
                                <div>üìÖ ${createdDate}</div>
                            </div>
                        </div>
                    `;
                });
                classListHTML += '</div>';
                
                myClassesListModal.innerHTML = classListHTML;
                if (myClassesList) myClassesList.innerHTML = classListHTML;
                
            } catch (error) {
                console.error('Î∞ò Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                const errorHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        ‚ùå Î∞ò Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§<br><br>
                        Firebase ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî
                    </div>
                `;
                document.getElementById('myClassesListModal').innerHTML = errorHTML;
            }
        }
        
        // Î∞ò ÏÑ†ÌÉù Ìï®Ïàò
        function selectClass(classId, className) {
            if (confirm(`"${className}" Î∞òÏùÑ Í¥ÄÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÎ∞ò ÏΩîÎìú: ${classId}`)) {
                // ÏÑ†ÌÉùÎêú Î∞òÏúºÎ°ú Ïù¥Îèô
                window.location.hash = `class=${classId}`;
                closeFirebaseModal();
                // Ïó¨Í∏∞Ïóê Î∞ò Í¥ÄÎ¶¨ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôòÌïòÎäî Î°úÏßÅ Ï∂îÍ∞Ä Í∞ÄÎä•
                alert(`"${className}" Î∞òÏù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§!\nÎ∞ò ÏΩîÎìú: ${classId}`);
            }
        }

        // Firebase ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
        function resetToDefault() {
            if (confirm('üóëÔ∏è Firebase ÏÑ§Ï†ïÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏ¥àÍ∏∞Ìôî ÌõÑÏóêÎäî ÏÉàÎ°úÏö¥ Firebase ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ§Ï†ïÌï¥Ïïº Ìï©ÎãàÎã§.')) {
                localStorage.removeItem('user_firebase_apiKey');
                localStorage.removeItem('user_firebase_projectId');
                localStorage.removeItem('user_firebase_databaseURL');
                userFirebaseConfig = null;
                
                document.getElementById('userApiKey').value = '';
                document.getElementById('userProjectId').value = '';
                updateAutoUrl();
                // projectInfoBtn Ï†úÍ±∞Îê®
                
                
                addLog('üóëÔ∏è Firebase ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî', 'warning');
                closeFirebaseModal();
                alert('‚úÖ Firebase ÏÑ§Ï†ïÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.\n\nÏù¥Ï†ú ÏÉàÎ°úÏö¥ Firebase ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÌëúÏãú
        function showProjectInfo() {
            const config = loadUserFirebaseConfig();
            if (config) {
                alert(`üìã ÌòÑÏû¨ Firebase ÏÑ§Ï†ï\n\nÌîÑÎ°úÏ†ùÌä∏ ID: ${config.projectId}\nDatabase URL: ${config.databaseURL}\n\n‚öôÔ∏è Firebase ÏÑ§Ï†ï Î≤ÑÌäºÏúºÎ°ú Î≥ÄÍ≤Ω Í∞ÄÎä•Ìï©ÎãàÎã§.`);
            } else {
                alert('‚ùå Firebase ÏÑ§Ï†ïÏù¥ ÏóÜÏäµÎãàÎã§!\n\n‚öôÔ∏è Ìó§ÎçîÏùò "Firebase ÏÑ§Ï†ï" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨\nÎ≥∏Ïù∏Ïùò Firebase ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.\n\nüìã ÌïÑÏöîÌïú Ï†ïÎ≥¥:\n- API Key\n- Project ID\n- Database Í∑úÏπô ÏÑ§Ï†ï');
            }
        }

        // Firebase ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞ - ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÌïÑÏàò
        function getFirebaseConfig() {
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                addLog(`üéØ ÏÇ¨Ïö©Ïûê Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÇ¨Ïö©: ${userConfig.projectId}`, 'info');
                return userConfig;
            } else {
                addLog('‚ùå Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Ìó§ÎçîÏùò "‚öôÔ∏è Firebase ÏÑ§Ï†ï" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.', 'error');
                throw new Error('Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î®ºÏ†Ä Firebase ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÌôïÏù∏
        document.addEventListener('DOMContentLoaded', function() {
            // Í∏∞Ï°¥ Ï¥àÍ∏∞Ìôî ÏΩîÎìú...
            
            // ÏÇ¨Ïö©Ïûê Firebase ÏÑ§Ï†ï ÌôïÏù∏
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                // projectInfoBtn Ï†úÍ±∞Îê®
                addLog(`üéØ ÏÇ¨Ïö©Ïûê Firebase ÌîÑÎ°úÏ†ùÌä∏ Í∞êÏßÄ: ${userConfig.projectId}`, 'info');
            }
        });

        // =========================
        // Î∞ò Í¥ÄÎ¶¨ Í∏∞Îä• Ìï®ÏàòÎì§
        // =========================
        
        // Ï†ÑÏó≠ Î≥ÄÏàòÎì§
        let globalDatabase = null;
        let currentUser = null;
        let currentClassId = null;
        let myClasses = [];
        
        // Firebase Ï†ÑÏó≠ Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function initGlobalDatabase() {
            if (globalDatabase) {
                return globalDatabase; // Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎê®
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                
                // Í∏∞Ï°¥ Ïï±Ïù¥ ÏûàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                if (firebase.apps.length > 0) {
                    console.log('üîÑ Í∏∞Ï°¥ Firebase Ïï± Ïû¨ÏÇ¨Ïö©');
                    globalDatabase = firebase.app().database();
                    updateConnectionStatus('connected', 'üü¢ Firebase Ïó∞Í≤∞Îê®');
                    return globalDatabase;
                }
                
                // ÏÉà Firebase Ïï± ÏÉùÏÑ±
                const app = firebase.initializeApp(firebaseConfig);
                globalDatabase = app.database();
                
                console.log('‚úÖ Firebase Ï†ÑÏó≠ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                updateConnectionStatus('connected', 'üü¢ Firebase Ïó∞Í≤∞Îê®');
                return globalDatabase;
                
            } catch (error) {
                console.error('‚ùå Firebase Ï†ÑÏó≠ Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                return null;
            }
        }
        
        // ÏÉà Î∞ò ÏÉùÏÑ± Ìèº ÌëúÏãú
        function showCreateClassForm() {
            // ÏÉà Î∞ò ÎßåÎì§Í∏∞ Î™®Îã¨ Ïó¥Í∏∞
            document.getElementById('createClassModal').style.display = 'block';
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassDescription').value = '';
            document.getElementById('createClassResult').style.display = 'none';
        }

        // ÏÉà Î∞ò ÎßåÎì§Í∏∞ Î™®Îã¨ Îã´Í∏∞
        function closeCreateClassModal() {
            document.getElementById('createClassModal').style.display = 'none';
            document.getElementById('createClassResult').style.display = 'none';
        }

        // ÏÉà Î∞ò ÏÉùÏÑ± Ìï®Ïàò
        async function createNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            const classDescription = document.getElementById('newClassDescription').value.trim();
            
            if (!className) {
                showCreateClassResult('error', '‚ùå Î∞ò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Firebase ÏÑ§Ï†ï ÌôïÏù∏
            const config = loadUserFirebaseConfig();
            if (!config) {
                showCreateClassResult('error', '‚ùå Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Firebase ÏÑ§Ï†ïÏùÑ Î®ºÏ†Ä ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Firebase SDK ÌôïÏù∏
            if (typeof firebase === 'undefined') {
                showCreateClassResult('error', '‚ùå Firebase SDKÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.<br><br>Ìï¥Í≤∞ Î∞©Î≤ï:<br>1. "‚öôÔ∏è Firebase ÏÑ§Ï†ï" Î≤ÑÌäº ÌÅ¥Î¶≠<br>2. API KeyÏôÄ Project ID ÏûÖÎ†•<br>3. "üîó Ïó∞Í≤∞ Î∞è Ï†ÄÏû•" Î≤ÑÌäº ÌÅ¥Î¶≠');
                return;
            }
            
            try {
                showCreateClassResult('info', 'üîÑ Î∞òÏùÑ ÏÉùÏÑ±ÌïòÎäî Ï§ë...');
                
                // Firebase Ïï± ÏÇ¨Ïö© (Ïù¥ÎØ∏ autoConnectFirebaseÏóêÏÑú Ï¥àÍ∏∞ÌôîÎê®)
                let app;
                let database;
                
                if (firebase.apps.length > 0) {
                    // Í∏∞Ï°¥ Í∏∞Î≥∏ Ïï± ÏÇ¨Ïö©
                    app = firebase.app();
                    database = app.database();
                    addLog('üîß Í∏∞Ï°¥ Firebase Í∏∞Î≥∏ Ïï± ÏÇ¨Ïö©', 'info');
                } else {
                    // Firebase Ïï±Ïù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Ïï±ÏúºÎ°ú ÏÉàÎ°ú Ï¥àÍ∏∞Ìôî
                    app = firebase.initializeApp(config);
                    database = app.database();
                    addLog('üîß Firebase Í∏∞Î≥∏ Ïï± ÏÉàÎ°ú Ï¥àÍ∏∞ÌôîÎê®', 'info');
                }
                
                // Í≥†Ïú†Ìïú Î∞ò ÏΩîÎìú ÏÉùÏÑ± (6ÏûêÎ¶¨)
                const classCode = generateClassCode();
                const classId = `class_${classCode.toLowerCase()}_${Date.now()}`;
                
                // Î∞ò Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const classData = {
                    id: classCode,
                    className: className,
                    description: classDescription || '',
                    createdAt: Date.now(),
                    createdBy: 'teacher',
                    status: 'active',
                    students: {},
                    discussions: {},
                    settings: {
                        allowAnonymous: false,
                        moderationEnabled: true
                    }
                };
                
                // FirebaseÏóê Ï†ÄÏû•
                await database.ref(`classes/${classCode}`).set(classData);
                
                // localStorageÏóêÎèÑ Ï†ÄÏû• (ÎÇ¥ Î∞ò Î™©Î°ùÏóê ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï¥)
                const myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
                myClasses.push({
                    id: classCode,
                    code: classCode,
                    name: className,
                    description: classDescription || '',
                    role: 'teacher',
                    joinedAt: Date.now(),
                    createdAt: Date.now()
                });
                localStorage.setItem('myClasses', JSON.stringify(myClasses));
                
                addLog(`‚úÖ ÏÉà Î∞ò ÏÉùÏÑ± ÏôÑÎ£å: ${className} (${classCode})`, 'success');
                showCreateClassResult('success', `‚úÖ Î∞òÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!<br><strong>Î∞ò ÏΩîÎìú: ${classCode}</strong><br>Ïù¥ ÏΩîÎìúÎ•º ÌïôÏÉùÎì§ÏóêÍ≤å Í≥µÏú†Ìï¥Ï£ºÏÑ∏Ïöî.`);
                
                // 3Ï¥à ÌõÑ Î™®Îã¨ Îã´Í∏∞
                setTimeout(() => {
                    closeCreateClassModal();
                    // Î©îÏù∏ ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ® (Î∞ò Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥)
                    startStep3();
                }, 3000);
                
            } catch (error) {
                console.error('Î∞ò ÏÉùÏÑ± Ïò§Î•ò:', error);
                addLog(`‚ùå Î∞ò ÏÉùÏÑ± Ïã§Ìå®: ${error.message}`, 'error');
                
                let errorMessage = '‚ùå Î∞ò ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                
                if (error.message.includes('No Firebase App')) {
                    errorMessage = `‚ùå Firebase Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.<br><br>Ìï¥Í≤∞ Î∞©Î≤ï:<br>1. "‚öôÔ∏è Firebase ÏÑ§Ï†ï" Î≤ÑÌäº ÌÅ¥Î¶≠<br>2. API KeyÏôÄ Project ID ÏûÖÎ†•<br>3. "üîó Ïó∞Í≤∞ Î∞è Ï†ÄÏû•" Î≤ÑÌäº ÌÅ¥Î¶≠`;
                } else if (error.message.includes('PERMISSION_DENIED')) {
                    errorMessage = `‚ùå Firebase Í∂åÌïú ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.<br><br>Ìï¥Í≤∞ Î∞©Î≤ï:<br>1. Firebase Console Ï†ëÏÜç<br>2. Realtime Database ‚Üí Í∑úÏπô ÌÉ≠<br>3. ÌÖåÏä§Ìä∏ Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω`;
                } else {
                    errorMessage += `<br><br>Ïò§Î•ò ÎÇ¥Ïö©: ${error.message}`;
                }
                
                showCreateClassResult('error', errorMessage);
            }
        }
        
        // Î∞ò ÏΩîÎìú ÏÉùÏÑ± Ìï®Ïàò (6ÏûêÎ¶¨ ÎûúÎç§)
        function generateClassCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Î∞ò ÏÉùÏÑ± Í≤∞Í≥º ÌëúÏãú
        function showCreateClassResult(type, message) {
            const resultDiv = document.getElementById('createClassResult');
            const colors = {
                'success': { bg: '#d4edda', color: '#155724', border: '#c3e6cb' },
                'error': { bg: '#f8d7da', color: '#721c24', border: '#f5c6cb' },
                'info': { bg: '#d1ecf1', color: '#0c5460', border: '#bee5eb' }
            };
            
            if (colors[type]) {
                resultDiv.style.background = colors[type].bg;
                resultDiv.style.color = colors[type].color;
                resultDiv.style.border = `1px solid ${colors[type].border}`;
                resultDiv.innerHTML = message;
                resultDiv.style.display = 'block';
            }
        }

        
        // Í∏∞Ï°¥ Î∞ò Ï∞∏Í∞Ä Ìèº ÌëúÏãú
        function showJoinClassForm() {
            addLog('üîç Í∏∞Ï°¥ Î∞ò Ï∞∏Í∞Ä Ìèº ÌëúÏãú', 'info');
            const formContainer = document.getElementById('classFormContainer');
            formContainer.style.display = 'block';
            
            formContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #007bff; margin: 0;">üîç Í∏∞Ï°¥ Î∞ò Ï∞∏Í∞ÄÌïòÍ∏∞</h4>
                    <button class="btn btn-secondary" onclick="hideClassForm()" style="padding: 4px 8px; font-size: 12px;">‚úñÔ∏è</button>
                </div>
                
                <div class="form-group">
                    <label for="joinClassCode">üî¢ Î∞ò ÏΩîÎìú</label>
                    <input type="text" id="joinClassCode" placeholder="ABC123" maxlength="10" style="text-transform: uppercase;" />
                    <div class="form-text">Îã¥ÏûÑ ÏÑ†ÏÉùÎãòÏù¥ ÏïåÎ†§Ï£ºÏã† 6ÏûêÎ¶¨ Î∞ò ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</div>
                </div>
                
                <div class="form-group">
                    <label for="studentName">üë®‚Äçüéì ÌïôÏÉù Ïù¥Î¶Ñ</label>
                    <input type="text" id="studentName" placeholder="ÍπÄÎØºÏàò" maxlength="20" />
                </div>
                
                <div style="background: #d1ecf1; padding: 10px; border-radius: 6px; border-left: 3px solid #17a2b8; margin: 15px 0;">
                    <p style="margin: 0; font-size: 12px; color: #0c5460;">
                        <strong>üéØ Ï∞∏Í≥†:</strong> Î∞ò ÏΩîÎìúÎäî Îã¥ÏûÑ ÏÑ†ÏÉùÎãòÏù¥ Ï†úÍ≥µÌï©ÎãàÎã§.<br>
                        ÏòàÏãú: ABC123, DEF456 Îì±Ïùò 6ÏûêÎ¶¨ ÏΩîÎìú
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="hideClassForm()">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="joinExistingClass()" id="joinClassBtn">üöÄ Î∞ò Ï∞∏Í∞ÄÌïòÍ∏∞</button>
                </div>
            `;
            
            // Ï≤´ Î≤àÏß∏ ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§
            setTimeout(() => {
                document.getElementById('joinClassCode').focus();
            }, 100);
        }
        
        // Ìèº Ïà®Í∏∞Í∏∞
        function hideClassForm() {
            document.getElementById('classFormContainer').style.display = 'none';
        }
        
        // Í∏∞Ï°¥ Î∞ò Ï∞∏Í∞ÄÌïòÍ∏∞
        async function joinExistingClass() {
            const classCode = document.getElementById('joinClassCode').value.trim().toUpperCase();
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!classCode || !studentName) {
                alert('‚ö†Ô∏è Î∞ò ÏΩîÎìúÏôÄ ÌïôÏÉù Ïù¥Î¶ÑÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (classCode.length !== 6) {
                alert('‚ö†Ô∏è Î∞ò ÏΩîÎìúÎäî 6ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            const joinBtn = document.getElementById('joinClassBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = '‚è≥ Ï∞∏Í∞Ä Ï§ë...';
            
            try {
                // Ï†ÑÏó≠ Firebase ÏÇ¨Ïö©
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                addLog(`üîç Î∞ò ÏΩîÎìú Í≤ÄÏÉâ Ï§ë: ${classCode}`, 'info');
                
                // Î∞ò ÏΩîÎìúÎ°ú Î∞ò ID Ï∞æÍ∏∞
                const classIdSnapshot = await database.ref('classCodes/' + classCode).once('value');
                
                if (!classIdSnapshot.exists()) {
                    throw new Error('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Î∞ò ÏΩîÎìúÏûÖÎãàÎã§.');
                }
                
                const classId = classIdSnapshot.val();
                addLog(`‚úÖ Î∞ò Ï∞æÏùå: ${classId}`, 'success');
                
                // Î∞ò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const classSnapshot = await database.ref('classes/' + classId).once('value');
                
                if (!classSnapshot.exists()) {
                    throw new Error('Î∞ò Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                const classData = classSnapshot.val();
                addLog(`üìö Î∞ò Ï†ïÎ≥¥ Î°úÎìú: ${classData.name}`, 'success');
                
                // Ï§ëÎ≥µ Ï∞∏Í∞Ä ÌôïÏù∏
                if (classData.members && classData.members[studentName]) {
                    throw new Error('Ïù¥ÎØ∏ Ïù¥ Î∞òÏóê Í∞ôÏùÄ Ïù¥Î¶ÑÏúºÎ°ú Ï∞∏Í∞ÄÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                }
                
                // ÏÉà Î©§Î≤Ñ Ï∂îÍ∞Ä
                const memberData = {
                    name: studentName,
                    role: 'student',
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`classes/${classId}/members/${studentName}`).set(memberData);
                
                // Î©§Î≤Ñ Ïàò Ï¶ùÍ∞Ä
                await database.ref(`classes/${classId}/memberCount`).transaction(count => {
                    return (count || 0) + 1;
                });
                
                addLog(`‚úÖ Î∞ò Ï∞∏Í∞Ä ÏôÑÎ£å: ${classData.name}`, 'success');
                
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÎÇ¥ Î∞ò Î™©Î°ù Ï†ÄÏû•
                const myClassData = {
                    id: classId,
                    name: classData.name,
                    code: classCode,
                    role: 'student',
                    studentName: studentName,
                    joinedAt: Date.now()
                };
                
                saveMyClass(myClassData);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                hideClassForm();
                loadMyClasses();
                
                // ÏÑ±Í≥µ ÏïåÎ¶º
                alert(`üéâ Î∞ò Ï∞∏Í∞ÄÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!\n\nüìö Î∞ò Ïù¥Î¶Ñ: ${classData.name}\nüë©‚Äçüè´ Îã¥Îãπ ÍµêÏÇ¨: ${classData.teacherName}\nüë®‚Äçüéì ÌïôÏÉù Ïù¥Î¶Ñ: ${studentName}\n\nÏù¥Ï†ú ÌÜ†Î°†Ïóê Ï∞∏Ïó¨Ìï† Ïàò ÏûàÏäµÎãàÎã§!`);
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå Î∞ò Ï∞∏Í∞Ä Ïã§Ìå®: ${error.message}`, 'error');
                
                let errorMsg = '‚ùå Î∞ò Ï∞∏Í∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\n';
                if (error.message.includes('PERMISSION_DENIED')) {
                    errorMsg += `üìã Firebase Database Í∂åÌïú ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§!\n\nüîß Ìï¥Í≤∞ Î∞©Î≤ï:\n1. Firebase Console Ï†ëÏÜç\n2. Realtime Database ‚Üí Í∑úÏπô ÌÉ≠\n3. Îã§Ïùå Í∑úÏπôÏúºÎ°ú Î≥ÄÍ≤Ω:\n\n{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}\n\n‚ö†Ô∏è Í∞úÎ∞ú/ÌÖåÏä§Ìä∏Ïö© ÏÑ§Ï†ïÏûÖÎãàÎã§.`;
                } else {
                    errorMsg += `Ïò§Î•ò: ${error.message}\n\nÎ∞ò ÏΩîÎìúÎ•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`;
                }
                
                alert(errorMsg);
                
                // Î≤ÑÌäº Î≥µÏõê
                joinBtn.disabled = false;
                joinBtn.textContent = 'üöÄ Î∞ò Ï∞∏Í∞ÄÌïòÍ∏∞';
            }
        }
        
        
        // ÎÇ¥ Î∞ò Ï†ïÎ≥¥ Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
        function saveMyClass(classData) {
            let myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
            
            // Ï§ëÎ≥µ Ï†úÍ±∞
            myClasses = myClasses.filter(c => c.id !== classData.id);
            
            // ÏÉà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
            myClasses.unshift(classData);
            
            // ÏµúÎåÄ 10Í∞úÎßå Î≥¥Í¥Ä
            if (myClasses.length > 10) {
                myClasses = myClasses.slice(0, 10);
            }
            
            localStorage.setItem('myClasses', JSON.stringify(myClasses));
            addLog(`üíæ ÎÇ¥ Î∞ò Î™©Î°ù Ï†ÄÏû•: ${classData.name}`, 'success');
        }
        
        // ÎÇ¥ Î∞ò Î™©Î°ù Î°úÎìú Î∞è ÌëúÏãú
        function loadMyClasses() {
            const myClassesList = document.getElementById('myClassesList');
            const savedClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
            
            if (savedClasses.length === 0) {
                myClassesList.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        üìÇ ÏïÑÏßÅ Ï∞∏Í∞ÄÌïú Î∞òÏù¥ ÏóÜÏäµÎãàÎã§<br><br>
                        ÏúÑ Î≤ÑÌäºÏúºÎ°ú ÏÉà Î∞òÏùÑ ÎßåÎì§Í±∞ÎÇò Í∏∞Ï°¥ Î∞òÏóê Ï∞∏Í∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!
                    </div>
                `;
                return;
            }
            
            let classListHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
            
            savedClasses.forEach(classData => {
                const joinedDate = new Date(classData.joinedAt).toLocaleDateString();
                const createdDate = new Date(classData.createdAt).toLocaleDateString();
                
                // Î∞ò ÏÑ§Î™Ö ÌëúÏãú (ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Î©îÏãúÏßÄ)
                const description = classData.description || 'Î∞òÏóê ÎåÄÌïú ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.';
                const truncatedDesc = description.length > 50 ? description.substring(0, 50) + '...' : description;
                
                classListHTML += `
                    <div class="class-card" style="
                        background: white; 
                        border: 1px solid #dee2e6; 
                        border-radius: 12px; 
                        padding: 20px; 
                        height: 240px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        transition: transform 0.2s, box-shadow 0.2s;
                        cursor: pointer;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #343a40; margin-bottom: 16px; line-height: 1.3;">
                                üìö ${classData.name}
                            </div>
                            <div style="font-size: 17px; color: #6c757d; margin-bottom: 12px; line-height: 1.4;">
                                ${truncatedDesc}
                            </div>
                            <div style="font-size: 15px; color: #6c757d; margin-bottom: 10px;">
                                ÏΩîÎìú: <strong style="color: #007bff; font-size: 16px;">${classData.code}</strong>
                            </div>
                            <div style="font-size: 14px; color: #999;">
                                ÏÉùÏÑ±Ïùº: ${createdDate} | Ï∞∏Í∞ÄÏùº: ${joinedDate}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); enterClass('${classData.id}', '${classData.name}', '${classData.role}')" style="flex: 1; padding: 8px 12px; font-size: 17px; border-radius: 6px; font-weight: bold;">
                                üö™ ÏûÖÏû•ÌïòÍ∏∞
                            </button>
                            <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); removeMyClass('${classData.id}', '${classData.name}')" style="padding: 8px 12px; font-size: 17px; border-radius: 6px;" title="Î∞ò ÏÇ≠Ï†ú">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            classListHTML += '</div>';
            myClassesList.innerHTML = classListHTML;
            addLog(`üìã ÎÇ¥ Î∞ò Î™©Î°ù ÌëúÏãú: ${savedClasses.length}Í∞ú`, 'info');
        }
        
        // Î∞ò ÏûÖÏû•ÌïòÍ∏∞
        function enterClass(classId, className, role) {
            addLog(`üö™ Î∞ò ÏûÖÏû•: ${className} (${role})`, 'success');
            
            currentClassId = classId;
            
            // ÌòÑÏû¨ Î∞òÏùò ÏΩîÎìú Ï∞æÍ∏∞ Î∞è ÌëúÏãú
            const myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
            const currentClass = myClasses.find(c => c.id === classId);
            if (currentClass) {
                window.currentClassCodeValue = currentClass.code;
                window.currentClassName = className;
            }

            // 2Îã®Í≥Ñ(ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨) Ìó§ÎçîÎ°ú Î≥ÄÍ≤Ω
            updateHeaderForTopicsManagement();
            
            // 5Îã®Í≥ÑÎ°ú Î∞îÎ°ú ÏßÑÌñâ
            updateCurrentStep(5, `Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† Í¥ÄÎ¶¨ - ${className}`);
            updateProgress(2, 'success', 'Î∞ò Í¥ÄÎ¶¨ ÏôÑÎ£å');
            addLog('üîÑ ÏûêÎèô ÏßÑÌñâ: 5Îã®Í≥Ñ ÌÜ†Î°† ÏßÑÌñâ Í¥ÄÎ¶¨ ÏãúÏûë', 'info');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div class="topics-management-container" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #495057;">üìã ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨</h3>
                        <div>
                            <button onclick="showCreateTopicForm()" class="btn" style="background: #28a745; color: white; margin-right: 10px;">
                                üìù ÏÉà ÌÜ†Î°†Î∞© ÎßåÎì§Í∏∞
                            </button>
                            <button onclick="shareStudentLink()" class="btn" style="background: #17a2b8; color: white;">
                                üîó ÌïôÏÉù ÎßÅÌÅ¨ Í≥µÏú†
                            </button>
                        </div>
                    </div>
                    <div id="topicsGridList" style="min-height: 200px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            üìù ÌÜ†Î°†Î∞©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                        </div>
                    </div>
                </div>
            `;
            
            // ÌÜ†Î°†Î∞© Î™©Î°ù Î°úÎìú
            loadTopicsList();
        }
        
        // ÌÜ†Î°†Î∞© Î™©Î°ù Î°úÎìú (FirebaseÏóêÏÑú)
        async function loadTopicsList() {
            const topicsGrid = document.getElementById('topicsGridList');
            
            try {
                // FirebaseÏóêÏÑú ÌÜ†Î°†Î∞© Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
                if (!firebase.apps.length > 0) {
                    topicsGrid.innerHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 40px;">
                            ‚ùå Firebase Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§<br><br>
                            "üîô Î∞ò Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞" ÌõÑ Firebase ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.
                        </div>
                    `;
                    return;
                }
                
                const database = firebase.app().database();
                const topicsRef = database.ref(`classes/${currentClassId}/discussions`);
                
                // Î°úÎî© ÌëúÏãú
                topicsGrid.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        üîÑ ÌÜ†Î°†Î∞© Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                    </div>
                `;
                
                const snapshot = await topicsRef.once('value');
                const topicsData = snapshot.val();
                
                if (!topicsData || Object.keys(topicsData).length === 0) {
                    topicsGrid.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            üìù ÏïÑÏßÅ ÏÉùÏÑ±Îêú ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§<br><br>
                            Ìó§ÎçîÏùò "üìù ÌÜ†Î°† Ï£ºÏ†ú ÎßåÎì§Í∏∞" Î≤ÑÌäºÏúºÎ°ú ÏÉà ÌÜ†Î°†ÏùÑ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                    `;
                    return;
                }
                
                // Firebase Îç∞Ïù¥ÌÑ∞Î•º Î∞∞Ïó¥Î°ú Î≥ÄÌôò
                const classTopics = Object.keys(topicsData).map(key => ({
                    id: key,
                    ...topicsData[key]
                }));
                
                addLog(`üìã FirebaseÏóêÏÑú ÌÜ†Î°†Î∞© ${classTopics.length}Í∞ú Î°úÎìúÎê®`, 'success');
                
                // ÌÜ†Î°†Î∞© Î™©Î°ù Î†åÎçîÎßÅ
                let topicsListHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
                
                classTopics.forEach(topicData => {
                const createdDate = new Date(topicData.createdAt).toLocaleDateString();
                const statusColor = topicData.status === 'active' ? '#28a745' : topicData.status === 'ended' ? '#6c757d' : '#ffc107';
                const statusText = topicData.status === 'active' ? 'ÏßÑÌñâ Ï§ë' : topicData.status === 'ended' ? 'Ï¢ÖÎ£åÎê®' : 'ÎåÄÍ∏∞ Ï§ë';
                const statusIcon = topicData.status === 'active' ? 'üü¢' : topicData.status === 'ended' ? '‚ö´' : 'üü°';
                
                // ÌÜ†Î°† ÏÑ§Î™Ö ÌëúÏãú (ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Î©îÏãúÏßÄ)
                const description = topicData.description || 'ÌÜ†Î°†Ïóê ÎåÄÌïú ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.';
                const truncatedDesc = description.length > 60 ? description.substring(0, 60) + '...' : description;
                
                // Ï∞∏Ïó¨Ïûê Ïàò (ÏûÑÏãú)
                const participantCount = Math.floor(Math.random() * 15) + 3; // 3-18Î™Ö
                
                // ÏãúÍ∞Ñ Ï†úÌïú ÌëúÏãú ÌòïÏãù ÏÉùÏÑ±
                let timeLimitText = '';
                if (topicData.timeLimit === 0 || !topicData.timeLimit) {
                    timeLimitText = '‚è∞ Ï†úÌïú ÏóÜÏùå';
                } else if (topicData.timeLimit < 60) {
                    timeLimitText = `‚è∞ ${topicData.timeLimit}Î∂Ñ`;
                } else {
                    const hours = Math.floor(topicData.timeLimit / 60);
                    const minutes = topicData.timeLimit % 60;
                    if (minutes === 0) {
                        timeLimitText = `‚è∞ ${hours}ÏãúÍ∞Ñ`;
                    } else {
                        timeLimitText = `‚è∞ ${hours}ÏãúÍ∞Ñ ${minutes}Î∂Ñ`;
                    }
                }
                
                topicsListHTML += `
                    <div class="topic-card" style="
                        background: white; 
                        border: 1px solid #dee2e6; 
                        border-radius: 12px; 
                        padding: 20px; 
                        height: 240px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        transition: transform 0.2s, box-shadow 0.2s;
                        cursor: pointer;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
                        <div>
                            <div style="font-size: 22px; font-weight: bold; color: #343a40; margin-bottom: 12px; line-height: 1.3;">
                                üí¨ ${topicData.title}
                            </div>
                            <div style="font-size: 16px; color: #6c757d; margin-bottom: 12px; line-height: 1.4;">
                                ${truncatedDesc}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 14px; color: ${statusColor}; font-weight: bold;">
                                    ${statusIcon} ${statusText}
                                </div>
                                <div style="font-size: 14px; color: #6f42c1; font-weight: bold;">
                                    ${topicData.type === 'chat' ? 'üí¨ Ï±ÑÌåÖÌòï' : topicData.type === 'postit' ? 'üìù Ìè¨Ïä§Ìä∏Ïûá' : topicData.type === 'debate' ? '‚öñÔ∏è Ï∞¨Î∞òÌÜ†Î°†' : 'üó£Ô∏è ÏùºÎ∞òÌÜ†Î°†'}
                                </div>
                            </div>
                            <div style="font-size: 13px; color: #28a745; margin-bottom: 0px; font-weight: bold;">
                                ${timeLimitText} / ÏÉùÏÑ±Ïùº: ${createdDate}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); enterTopic('${topicData.id}', '${topicData.title}')" style="flex: 1; padding: 8px 12px; font-size: 13px; border-radius: 6px; font-weight: bold;">
                                üö™ ÌÜ†Î°† ÏûÖÏû•
                            </button>
                            <button class="btn btn-success" onclick="event.stopPropagation(); downloadTopicCSV('${topicData.id}', '${topicData.title}')" style="padding: 8px 12px; font-size: 13px; border-radius: 6px;" title="CSV Îã§Ïö¥Î°úÎìú">
                                üìä
                            </button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteTopic('${topicData.id}', '${topicData.title}')" style="padding: 8px 12px; font-size: 13px; border-radius: 6px;" title="ÌÜ†Î°†Î∞© ÏÇ≠Ï†ú">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
                });
                
                topicsListHTML += '</div>';
                topicsGrid.innerHTML = topicsListHTML;
                addLog(`üìã ÌÜ†Î°†Î∞© Î™©Î°ù ÌëúÏãú: ${classTopics.length}Í∞ú`, 'info');
                
            } catch (error) {
                console.error('ÌÜ†Î°†Î∞© Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                topicsGrid.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 40px;">
                        ‚ùå ÌÜ†Î°†Î∞© Î™©Î°ù Î°úÎìú Ïã§Ìå®<br><br>
                        ${error.message}<br><br>
                        Firebase ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.
                    </div>
                `;
            }
        }
        
        // [ÏÇ¨Ïö© ÏïàÌï®] ÏûêÎèôÏúºÎ°ú ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ±ÌïòÍ≥† 5Îã®Í≥Ñ ÏãúÏûë (ÍµêÏÇ¨Í∞Ä ÏßÅÏ†ë ÏÑ†ÌÉùÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω)
        /*
        async function autoCreateTopicAndStartDiscussion() {
            try {
                addLog('üîÑ ÏûêÎèô ÏßÑÌñâ: ÌÜ†Î°† Ï£ºÏ†ú ÏûêÎèô ÏÉùÏÑ± ÏãúÏûë', 'info');
                updateProgress(3, 'warning', 'ÌÜ†Î°† Ï£ºÏ†ú ÏûêÎèô ÏÉùÏÑ± Ï§ë...');
                
                // Í∏∞Î≥∏ ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ±
                const defaultTopic = {
                    title: 'ÏÉòÌîå ÌÜ†Î°†: ÌôòÍ≤Ω Î≥¥Ìò∏Ïùò Ï§ëÏöîÏÑ±',
                    description: 'ÏùºÌöåÏö©Ìíà ÏÇ¨Ïö©ÏùÑ Ï§ÑÏù¥Îäî Î∞©Î≤ïÏóê ÎåÄÌï¥ ÌÜ†Î°†Ìï¥Î≥¥ÏÑ∏Ïöî',
                    type: 'general',
                    maxParticipants: 30,
                    timeLimit: 300
                };
                
                // FirebaseÏóê ÌÜ†Î°† Ï£ºÏ†ú Ï†ÄÏû•
                const topicId = 'auto-topic-' + Date.now();
                await database.ref(`topics/${currentClassId}/${topicId}`).set({
                    ...defaultTopic,
                    id: topicId,
                    classId: currentClassId,
                    createdAt: Date.now(),
                    status: 'active'
                });
                
                addLog('‚úÖ ÌÜ†Î°† Ï£ºÏ†ú ÏûêÎèô ÏÉùÏÑ± ÏôÑÎ£å', 'success');
                updateProgress(3, 'success', 'ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± ÏôÑÎ£å');
                
                // 1Ï¥à ÌõÑ 5Îã®Í≥ÑÎ°ú ÏûêÎèô ÏßÑÌñâ
                setTimeout(() => {
                    addLog('üîÑ ÏûêÎèô ÏßÑÌñâ: 5Îã®Í≥Ñ Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† ÏãúÏûë', 'info');
                    enterDiscussion(topicId, defaultTopic.title);
                }, 1000);
                
            } catch (error) {
                addLog('‚ùå ÏûêÎèô ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Ïã§Ìå®: ' + error.message, 'error');
                console.error(error);
            }
        }
        */
        
        // Î∞ò ÏΩîÎìú Î≥µÏÇ¨ÌïòÍ∏∞
        function copyClassCode() {
            const classCode = window.currentClassCodeValue;
            if (!classCode) {
                alert('Î∞ò ÏΩîÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
            if (navigator.clipboard) {
                navigator.clipboard.writeText(classCode).then(() => {
                    alert(`üìã Î∞ò ÏΩîÎìúÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\nÏΩîÎìú: ${classCode}\n\nÌïôÏÉùÎì§ÏóêÍ≤å Ïù¥ ÏΩîÎìúÎ•º ÏïåÎ†§Ï£ºÏÑ∏Ïöî.`);
                }).catch(() => {
                    fallbackCopyTextToClipboard(classCode);
                });
            } else {
                fallbackCopyTextToClipboard(classCode);
            }
        }
        
        // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ ÎåÄÏ≤¥ Î∞©Î≤ï
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert(`üìã Î∞ò ÏΩîÎìúÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\nÏΩîÎìú: ${text}\n\nÌïôÏÉùÎì§ÏóêÍ≤å Ïù¥ ÏΩîÎìúÎ•º ÏïåÎ†§Ï£ºÏÑ∏Ïöî.`);
                } else {
                    alert(`Î∞ò ÏΩîÎìú: ${text}\n\nÏàòÎèôÏúºÎ°ú Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.`);
                }
            } catch (err) {
                alert(`Î∞ò ÏΩîÎìú: ${text}\n\nÏàòÎèôÏúºÎ°ú Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.`);
            }
            
            document.body.removeChild(textArea);
        }
        
        // ÌïôÏÉùÏö© ÎßÅÌÅ¨ ÏÉùÏÑ± Î∞è Í≥µÏú†
        function shareStudentLink() {
            const classCode = window.currentClassCodeValue;
            if (!classCode) {
                alert('Î∞ò ÏΩîÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÌòÑÏû¨ URLÏùò Í∏∞Î≥∏ Í≤ΩÎ°úÏóêÏÑú ÌïôÏÉùÏö© ÌååÏùºÎ°ú ÎßÅÌÅ¨ ÏÉùÏÑ±
            const currentUrl = window.location.href;
            const basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
            const studentUrl = `${basePath}/student.html?class=${classCode}`;
            
            // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
            if (navigator.clipboard) {
                navigator.clipboard.writeText(studentUrl).then(() => {
                    alert(`üîó ÌïôÏÉùÏö© ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\n${studentUrl}\n\nÌïôÏÉùÎì§ÏùÄ Ïù¥ ÎßÅÌÅ¨Î•º ÌÅ¥Î¶≠ÌïòÎ©¥ Î∞îÎ°ú Î∞ò Ï∞∏Ïó¨ ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.`);
                }).catch(() => {
                    fallbackCopyTextToClipboard(studentUrl);
                });
            } else {
                alert(`üîó ÌïôÏÉùÏö© ÎßÅÌÅ¨:\n\n${studentUrl}\n\nÌïôÏÉùÎì§ÏùÄ Ïù¥ ÎßÅÌÅ¨Î•º ÌÅ¥Î¶≠ÌïòÎ©¥ Î∞îÎ°ú Î∞ò Ï∞∏Ïó¨ ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.`);
            }
        }
        
        // ÎÇ¥ Î∞ò Î™©Î°ùÏóêÏÑú Ï†úÍ±∞
        function removeMyClass(classId, className) {
            if (confirm(`üóëÔ∏è "${className}" Î∞òÏùÑ Î™©Î°ùÏóêÏÑú Ï†úÍ±∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n(FirebaseÏùò Î∞ò Îç∞Ïù¥ÌÑ∞Îäî ÏÇ≠Ï†úÎêòÏßÄ ÏïäÏäµÎãàÎã§)`)) {
                let myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
                myClasses = myClasses.filter(c => c.id !== classId);
                localStorage.setItem('myClasses', JSON.stringify(myClasses));
                
                loadMyClasses();
                addLog(`üóëÔ∏è ÎÇ¥ Î∞ò Î™©Î°ùÏóêÏÑú Ï†úÍ±∞: ${className}`, 'warning');
            }
        }

        // =========================
        // ÌÜ†Î°†Î∞© ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨ Í∏∞Îä•
        // =========================
        
        let currentTopics = [];
        
        // ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Ìèº ÌëúÏãú
        function showCreateTopicForm() {
            addLog('üìù ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Î™®Îã¨ ÌëúÏãú', 'info');
            const modal = document.getElementById('createTopicModal');
            modal.style.display = 'flex';
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('topicTitle').value = '';
            document.getElementById('topicDescription').value = '';
            document.getElementById('topicType').value = 'chat';
            document.getElementById('topicTimeLimit').value = '15';
            
            // Í≤∞Í≥º Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
            const resultDiv = document.getElementById('createTopicResult');
            resultDiv.style.display = 'none';
        }
        
        // ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Î™®Îã¨ Îã´Í∏∞
        function closeCreateTopicModal() {
            const modal = document.getElementById('createTopicModal');
            modal.style.display = 'none';
        }
        
        // ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Í≤∞Í≥º ÌëúÏãú
        function showCreateTopicResult(type, message) {
            const resultDiv = document.getElementById('createTopicResult');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
        }
        
        // ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ±
        async function createNewTopic() {
            const title = document.getElementById('topicTitle').value.trim();
            const description = document.getElementById('topicDescription').value.trim();
            const type = document.getElementById('topicType').value;
            const timeLimit = parseInt(document.getElementById('topicTimeLimit').value);
            
            if (!title) {
                showCreateTopicResult('error', '‚ùå ÌÜ†Î°† Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                showCreateTopicResult('info', 'üîÑ ÌÜ†Î°†ÏùÑ ÏÉùÏÑ±ÌïòÎäî Ï§ë...');
                
                // Firebase Ïó∞Í≤∞ ÌôïÏù∏
                if (!firebase.apps.length > 0) {
                    showCreateTopicResult('error', '‚ùå Firebase Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                    return;
                }
                
                const database = firebase.app().database();
                const topicId = 'topic_' + Date.now();
                
                // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const topicData = {
                    id: topicId,
                    title: title,
                    description: description,
                    type: type,
                    timeLimit: timeLimit,
                    status: 'active',
                    createdAt: Date.now(),
                    createdBy: 'teacher',
                    classId: currentClassId,
                    participants: {}
                };
                
                // FirebaseÏóê Ï†ÄÏû•
                await database.ref(`classes/${currentClassId}/discussions/${topicId}`).set(topicData);
                
                addLog(`‚úÖ ÏÉà ÌÜ†Î°† ÏÉùÏÑ± ÏôÑÎ£å: ${title}`, 'success');
                showCreateTopicResult('success', `‚úÖ ÌÜ†Î°†Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!<br><strong>Ï†úÎ™©: ${title}</strong>`);
                
                // 3Ï¥à ÌõÑ Î™®Îã¨ Îã´Í∏∞ Î∞è Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                setTimeout(() => {
                    closeCreateTopicModal();
                    loadTopicsList();
                }, 2000);
                
            } catch (error) {
                console.error('ÌÜ†Î°† ÏÉùÏÑ± Ïò§Î•ò:', error);
                addLog(`‚ùå ÌÜ†Î°† ÏÉùÏÑ± Ïã§Ìå®: ${error.message}`, 'error');
                showCreateTopicResult('error', `‚ùå ÌÜ†Î°† ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.<br><br>Ïò§Î•ò: ${error.message}`);
            }
        }
        
        // ÌÜ†Î°†Î∞© ÏûÖÏû• - 5Îã®Í≥ÑÎ°ú Ïù¥Îèô
        function enterTopic(topicId, topicTitle) {
            addLog(`üö™ ÌÜ†Î°†Î∞© ÏûÖÏû•: ${topicTitle}`, 'success');
            
            // ÌòÑÏû¨ ÌÜ†Î°† Ï†ïÎ≥¥ Ï†ÄÏû•
            window.currentTopicId = topicId;
            window.currentTopicTitle = topicTitle;
            
            // ÌÜ†Î°†Î∞© Ìó§ÎçîÎ°ú Î≥ÄÍ≤Ω
            updateHeaderForDiscussion();
            
            // 5Îã®Í≥ÑÎ°ú ÏßÑÌñâ
            updateCurrentStep(5, `ÌÜ†Î°† ÏßÑÌñâ - ${topicTitle}`);
            updateProgress(3, 'success', 'ÌÜ†Î°† Í¥ÄÎ¶¨ ÏôÑÎ£å');
            addLog('üîÑ ÏûêÎèô ÏßÑÌñâ: 5Îã®Í≥Ñ ÌÜ†Î°† ÏßÑÌñâ Í¥ÄÎ¶¨ ÏãúÏûë', 'info');
            
            // 5Îã®Í≥Ñ ÍµêÏÇ¨Ïö© ÌÜ†Î°† Í¥ÄÎ¶¨ ÌôîÎ©¥ ÌëúÏãú
            startStep5(topicId, topicTitle);
        }
        
        // 5Îã®Í≥Ñ Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        function updateHeaderForStep5(topicTitle) {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <button class="btn btn-secondary" onclick="backToTopicsList()" id="backToTopicsBtn">
                    üîô ÌÜ†Î°† Î™©Î°ùÏúºÎ°ú
                </button>
                <button class="btn btn-success" onclick="shareStudentLink()" id="studentLinkBtn">
                    üîó ÌïôÏÉù ÎßÅÌÅ¨
                </button>
                <button class="btn btn-warning" onclick="endTopic()" id="endTopicBtn">
                    ‚èπÔ∏è ÌÜ†Î°† Ï¢ÖÎ£å
                </button>
            `;
            
            // Ìó§Îçî Ï†úÎ™© Î≥ÄÍ≤Ω
            const headerTitle = document.querySelector('.header h1');
            headerTitle.textContent = `üí¨ ${topicTitle} - ÏßÑÌñâ Ï§ë`;
        }
        
        // ÌÜ†Î°† Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        function backToTopicsList() {
            addLog('üîô ÌÜ†Î°† Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞', 'info');
            
            // ÌÜ†Î°† Í¥ÄÎ¶¨ ÌôîÎ©¥ÏúºÎ°ú ÎêòÎèåÎ¶¨Í∏∞
            updateCurrentStep(5, 'ÌÜ†Î°† Í¥ÄÎ¶¨');
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div class="topics-list-container" style="margin-top: 20px;">
                    <div id="topicsGridList" style="min-height: 200px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            üîÑ ÌÜ†Î°†Î∞© Î™©Î°ùÏùÑ Îã§Ïãú Î∂àÎü¨Ïò§Îäî Ï§ë...
                        </div>
                    </div>
                </div>
            `;
            
            // ÌÜ†Î°† Î™©Î°ù Îã§Ïãú Î°úÎìú
            loadTopicsList();
        }
        
        // 5Îã®Í≥Ñ ÏãúÏûë - ÍµêÏÇ¨Ïö© Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† Í¥ÄÎ¶¨
        async function startStep5(topicId, topicTitle) {
            // Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ§Ï†ï
            currentTopicId = topicId;
            
            // FirebaseÏóêÏÑú ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            await loadDiscussionDataForTeacher(topicId);
            
            // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            if (!currentTopicData) {
                addLog('‚ùå ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'error');
                alert('ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            addLog(`üìã ÌÜ†Î°† ÌÉÄÏûÖ: ${currentTopicData.type}`, 'info');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div style="background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%); color: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                    <h3 style="color: white; margin: 0; font-size: 18px;">üí¨ ${topicTitle}</h3>
                    <p style="color: #f8f9fa; margin: 0; font-size: 13px;">ÍµêÏÇ¨ Î™®Îìú - Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† Í¥ÄÎ¶¨ (${currentTopicData.type})</p>
                </div>
                
                <!-- ÌÜ†Î°† ÏòÅÏó≠ -->
                <div id="discussionArea">
                    ${getDiscussionUIByType(currentTopicData.type)}
                </div>
            `;
            
            // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÏãúÏûë
            setupRealTimeListeners();
            
            // ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê Ï¥àÍ∏∞Ìôî
            initializeTeacherControls();
            
            addLog(`üöÄ 5Îã®Í≥Ñ ÏãúÏûë: ${topicTitle} ÍµêÏÇ¨Ïö© Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† Í¥ÄÎ¶¨`, 'success');
        }
        
        // ÌÜ†Î°† ÌÉÄÏûÖÏóê Îî∞Î•∏ UI ÏÉùÏÑ±
        function getDiscussionUIByType(type) {
            addLog(`üé® UI ÏÉùÏÑ± Ï§ë - ÌÜ†Î°† ÌÉÄÏûÖ: ${type}`, 'info');
            
            switch(type) {
                case 'chat':
                    return createDiscussionUI();
                case 'postit':
                    return createPostitUI();
                case 'debate':
                    return createDebateUI();
                case 'general':
                    return createDiscussionUI();
                default:
                    addLog(`‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî ÌÜ†Î°† ÌÉÄÏûÖ: ${type}, Í∏∞Î≥∏ UI ÏÇ¨Ïö©`, 'warning');
                    return createDiscussionUI();
            }
        }
        
        // ÍµêÏÇ¨Ïö© ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadDiscussionDataForTeacher(topicId) {
            try {
                if (!firebase.apps.length > 0) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                }
                
                const database = firebase.app().database();
                const topicSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}`).once('value');
                
                if (topicSnapshot.exists()) {
                    currentTopicData = topicSnapshot.val();
                    addLog(`‚úÖ ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú: ${currentTopicData.title}`, 'success');
                } else {
                    throw new Error('ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                addLog(`‚ùå ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
            }
        }
        
        // ÌÜ†Î°† Í¥ÄÎ¶¨
        function manageTopic(topicId, topicTitle) {
            addLog(`‚öôÔ∏è ÌÜ†Î°† Í¥ÄÎ¶¨: ${topicTitle}`, 'info');
            
            // ÌÜ†Î°† Í¥ÄÎ¶¨ Î™®Îã¨Ïù¥ÎÇò ÌéòÏù¥ÏßÄÎ•º Ïó¨Îäî Í∏∞Îä• (Ìñ•ÌõÑ Íµ¨ÌòÑ)
            alert(`ÌÜ†Î°† Í¥ÄÎ¶¨ Í∏∞Îä•\n\nÌÜ†Î°†Î™Ö: ${topicTitle}\nID: ${topicId}\n\nÍ≥ß Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.`);
        }
        
        // ÌÜ†Î°† Î™©Î°ù Î≥¥Í∏∞
        function showTopicsList() {
            addLog('üìã ÌÜ†Î°† Î™©Î°ù ÌëúÏãú', 'info');
            hideAllForms();
            
            // 4Îã®Í≥Ñ ÌÜ†Î°† Í¥ÄÎ¶¨ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (!welcomeMsg) {
                addLog('‚ùå welcomeMessage ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            // 4Îã®Í≥Ñ UI Îã§Ïãú ÌëúÏãú
            welcomeMsg.innerHTML = `
                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h2 style="color: white; margin: 0 0 8px 0;">üìö Î∞ò Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h2>
                    <p style="color: #f8f9fa; margin: 0;">Ïó≠Ìï†: ÍµêÏÇ¨/ÌïôÏÉù</p>
                </div>
                
                <h3 style="color: #495057; margin-bottom: 15px;">üìä ÌÜ†Î°†Î∞© Í¥ÄÎ¶¨</h3>
                <p>ÌÜ†Î°†Î∞©ÏùÑ ÏÉùÏÑ±ÌïòÍ≥† Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                
                <div class="grid-container" style="margin-top: 25px;">
                    <div class="grid-item" onclick="showCreateTopicForm()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white;">
                        <h4 style="color: white; margin-bottom: 8px;">üìù ÌÜ†Î°† Ï£ºÏ†ú ÎßåÎì§Í∏∞</h4>
                        <p style="font-size: 13px; color: #f8f9fa;">ÏÉàÎ°úÏö¥ ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ±</p>
                    </div>
                    <div class="grid-item" onclick="showTopicsListModal()" style="background: linear-gradient(135deg, #a55eea 0%, #8e44ad 100%); color: white;">
                        <h4 style="color: white; margin-bottom: 8px;">üìã ÌÜ†Î°† Î™©Î°ù Î≥¥Í∏∞</h4>
                        <p style="font-size: 13px; color: #f8f9fa;">ÏßÑÌñâ Ï§ëÏù∏ ÌÜ†Î°† ÌôïÏù∏</p>
                    </div>
                </div>
                
                <div id="topicFormContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #ff6b6b; border-radius: 8px; padding: 20px;">
                    <!-- ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± ÌèºÏù¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
                
                <div id="topicsListContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #a55eea; border-radius: 8px; padding: 20px;">
                    <!-- ÌÜ†Î°† Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 3px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ 4Îã®Í≥Ñ Íµ¨ÌòÑ ÏôÑÎ£å Í∏∞Îä•</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #155724;">
                        <li>‚úì ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨</li>
                        <li>‚úì Îã§ÏñëÌïú ÌÜ†Î°† Ïú†Ìòï ÏßÄÏõê</li>
                        <li>‚úì ÌÜ†Î°† Î™©Î°ù Î∞è ÏÉÅÌÉú Í¥ÄÎ¶¨</li>
                        <li>‚úì Firebase Ïó∞Îèô Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•</li>
                    </ul>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #007bff;">
                    <h4 style="color: #495057; margin-bottom: 10px;">üöÄ 5Îã®Í≥Ñ Í∞úÎ∞ú ÏôÑÎ£å Í∏∞Îä•</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                        <li>‚úì Ïã§ÏãúÍ∞Ñ Î©îÏã†Ï†Ä ÌÜ†Î°†</li>
                        <li>‚úì Ìè¨Ïä§Ìä∏Ïûá Ïä§ÌÉÄÏùº ÌÜ†Î°†</li>
                        <li>‚úì Ï∞¨Î∞ò ÌÜ†Î°† ÏãúÏä§ÌÖú</li>
                        <li>‚úì ÌÜ†Î°† ÏãúÍ∞Ñ Í¥ÄÎ¶¨ Î∞è ÌÜµÍ≥Ñ</li>
                    </ul>
                </div>
                
                <button class="btn btn-secondary" onclick="startStep3()" style="margin-top: 15px;">
                    üîô Î∞ò Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </button>
            `;
        }
        
        // ÌÜ†Î°† Î™©Î°ù Î™®Îã¨ ÌëúÏãú
        function showTopicsListModal() {
            addLog('üìã ÌÜ†Î°† Î™©Î°ù Î™®Îã¨ ÌëúÏãú', 'info');
            hideAllForms();
            const listContainer = document.getElementById('topicsListContainer');
            if (!listContainer) {
                addLog('‚ùå topicsListContainer ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            listContainer.style.display = 'block';
            listContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #a55eea; margin: 0;">üìã ÌÜ†Î°† Ï£ºÏ†ú Î™©Î°ù</h4>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="loadTopicsFromFirebase()" style="padding: 6px 10px; font-size: 11px;">
                            üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                        <button class="btn btn-secondary" onclick="hideAllForms()" style="padding: 4px 8px; font-size: 12px;">‚úñÔ∏è</button>
                    </div>
                </div>
                
                <div id="topicsListContent" style="min-height: 200px;">
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        üîç ÌÜ†Î°† Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                    </div>
                </div>
            `;
            
            // FirebaseÏóêÏÑú ÌÜ†Î°† Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
            loadTopicsFromFirebase();
        }
        
        // Î™®Îì† Ìèº Ïà®Í∏∞Í∏∞
        function hideAllForms() {
            const topicForm = document.getElementById('topicFormContainer');
            const topicsList = document.getElementById('topicsListContainer');
            
            if (topicForm) topicForm.style.display = 'none';
            if (topicsList) topicsList.style.display = 'none';
        }
        
        // ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ±ÌïòÍ∏∞
        async function createDiscussionTopic() {
            const title = document.getElementById('topicTitle').value.trim();
            const description = document.getElementById('topicDescription').value.trim();
            const type = document.getElementById('topicType').value;
            const duration = parseInt(document.getElementById('topicDuration').value);
            const allowAnonymous = document.getElementById('allowAnonymous').checked;
            const allowStudentPost = document.getElementById('allowStudentPost').checked;
            
            if (!title) {
                alert('‚ö†Ô∏è ÌÜ†Î°† Ï£ºÏ†ú Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentClassId) {
                alert('‚ö†Ô∏è ÏÑ†ÌÉùÎêú Î∞òÏù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Î∞òÏóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            const createBtn = document.getElementById('createTopicBtn');
            createBtn.disabled = true;
            createBtn.textContent = '‚è≥ ÏÉùÏÑ± Ï§ë...';
            
            try {
                // Ï†ÑÏó≠ Firebase ÏÇ¨Ïö©
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                // Í≥†Ïú† ÌÜ†Î°† ID ÏÉùÏÑ±
                const topicId = `topic_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const topicData = {
                    id: topicId,
                    title: title,
                    description: description,
                    type: type,
                    duration: duration,
                    settings: {
                        allowAnonymous: allowAnonymous,
                        allowStudentPost: allowStudentPost
                    },
                    status: 'active',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    startedAt: firebase.database.ServerValue.TIMESTAMP,
                    endTime: Date.now() + (duration * 60 * 1000),
                    classId: currentClassId,
                    participantCount: 0,
                    messageCount: 0,
                    participants: {},
                    messages: {},
                    votes: {},
                    results: {}
                };
                
                addLog(`üí¨ ÏÉà ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Ï§ë: ${title}`, 'info');
                addLog(`üìÅ ÌÜ†Î°† Ïú†Ìòï: ${type}`, 'info');
                
                // FirebaseÏóê ÌÜ†Î°† Ï£ºÏ†ú Ï†ÄÏû•
                await database.ref(`classes/${currentClassId}/discussions/${topicId}`).set(topicData);
                
                // Ï†ÑÏ≤¥ ÌÜ†Î°† Ïù∏Îç±Ïä§ÏóêÎèÑ Ï†ÄÏû•
                await database.ref('discussions/' + topicId).set({
                    ...topicData,
                    classId: currentClassId
                });
                
                addLog(`‚úÖ ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± ÏôÑÎ£å: ${title}`, 'success');
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                hideAllForms();
                showTopicsList();
                
                // ÏÑ±Í≥µ ÏïåÎ¶º
                const typeNames = {
                    'debate': 'Ï∞¨Î∞ò ÌÜ†Î°†',
                    'discussion': 'ÏûêÏú† ÌÜ†Î°†',
                    'postit': 'Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†',
                    'survey': 'ÏÑ§Î¨∏ Ï°∞ÏÇ¨'
                };
                
                alert(`üéâ ÌÜ†Î°† Ï£ºÏ†úÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nüéØ Ï£ºÏ†ú: ${title}\nüìÅ Ïú†Ìòï: ${typeNames[type]}\n‚è∞ ÏãúÍ∞Ñ: ${duration}Î∂Ñ\n\nÌïôÏÉùÎì§Ïù¥ ÏßÄÍ∏à Ï∞∏Ïó¨Ìï† Ïàò ÏûàÏäµÎãàÎã§!`);
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ± Ïã§Ìå®: ${error.message}`, 'error');
                
                let errorMsg = '‚ùå ÌÜ†Î°† Ï£ºÏ†ú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\n';
                if (error.message.includes('PERMISSION_DENIED')) {
                    errorMsg += `üìã Firebase Database Í∂åÌïú ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§!\n\n"üîß DB Í∑úÏπô ÎèÑÏõÄÎßê" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.`;
                } else {
                    errorMsg += `Ïò§Î•ò: ${error.message}`;
                }
                
                alert(errorMsg);
                
                // Î≤ÑÌäº Î≥µÏõê
                createBtn.disabled = false;
                createBtn.textContent = 'üöÄ ÌÜ†Î°† ÏãúÏûëÌïòÍ∏∞';
            }
        }
        
        // FirebaseÏóêÏÑú ÌÜ†Î°† Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
        async function loadTopicsFromFirebase() {
            if (!currentClassId) {
                document.getElementById('topicsListContent').innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        ‚ö†Ô∏è ÏÑ†ÌÉùÎêú Î∞òÏù¥ ÏóÜÏäµÎãàÎã§.<br>Î®ºÏ†Ä Î∞òÏóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.
                    </div>
                `;
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                addLog('üîç ÌÜ†Î°† Î™©Î°ù Î°úÎìú Ï§ë...', 'info');
                
                // Î∞òÏùò ÌÜ†Î°† Ï£ºÏ†úÎì§ Í∞ÄÏ†∏Ïò§Í∏∞
                const topicsSnapshot = await database.ref(`classes/${currentClassId}/discussions`).once('value');
                
                if (!topicsSnapshot.exists()) {
                    document.getElementById('topicsListContent').innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            üìÇ ÏïÑÏßÅ ÏÉùÏÑ±Îêú ÌÜ†Î°† Ï£ºÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.<br><br>
                            "üìù ÌÜ†Î°† Ï£ºÏ†ú ÎßåÎì§Í∏∞" Î≤ÑÌäºÏúºÎ°ú ÏÉà Ï£ºÏ†úÎ•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                    `;
                    return;
                }
                
                const topics = topicsSnapshot.val();
                const topicsList = Object.values(topics).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                addLog(`‚úÖ ÌÜ†Î°† Î™©Î°ù Î°úÎìú ÏôÑÎ£º: ${topicsList.length}Í∞ú`, 'success');
                
                // ÌÜ†Î°† Î™©Î°ù HTML ÏÉùÏÑ±
                let topicsHTML = '';
                topicsList.forEach(topic => {
                    const createdDate = new Date(topic.createdAt).toLocaleString();
                    const endTime = new Date(topic.endTime);
                    const now = new Date();
                    const isActive = now < endTime && topic.status === 'active';
                    
                    const typeIcons = {
                        'debate': 'ü§º',
                        'discussion': 'üí¨',
                        'postit': 'üìù',
                        'survey': 'üìä'
                    };
                    
                    const typeNames = {
                        'debate': 'Ï∞¨Î∞ò ÌÜ†Î°†',
                        'discussion': 'ÏûêÏú† ÌÜ†Î°†',
                        'postit': 'Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†',
                        'survey': 'ÏÑ§Î¨∏ Ï°∞ÏÇ¨'
                    };
                    
                    const statusBadge = isActive ? 
                        '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">LIVE</span>' :
                        '<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">Ï¢ÖÎ£å</span>';
                    
                    topicsHTML += `
                        <div class="topic-item" style="background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin-bottom: 12px; ${isActive ? 'border-left: 4px solid #28a745;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <h5 style="margin: 0 0 4px 0; color: #343a40; display: flex; align-items: center; gap: 8px;">
                                        ${typeIcons[topic.type]} ${topic.title} ${statusBadge}
                                    </h5>
                                    <p style="margin: 0 0 8px 0; font-size: 12px; color: #6c757d;">
                                        ${typeNames[topic.type]} | ÏÉùÏÑ±: ${createdDate} | Ï∞∏Ïó¨: ${topic.participantCount || 0}Î™Ö
                                    </p>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${isActive ? `
                                        <button class="btn btn-success" onclick="enterDiscussion('${topic.id}', '${topic.title}')" style="padding: 6px 10px; font-size: 11px;">
                                            üö™ Ï∞∏Ïó¨
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-info" onclick="viewTopicDetails('${topic.id}')" style="padding: 6px 10px; font-size: 11px;">
                                        üìã ÏÉÅÏÑ∏
                                    </button>
                                    <button class="btn btn-warning" onclick="downloadTopicCSV('${topic.id}')" style="padding: 6px 10px; font-size: 11px;">
                                        üì• CSV
                                    </button>
                                    <button class="btn" onclick="deleteTopic('${topic.id}', '${topic.title}')" style="padding: 6px 10px; font-size: 11px; background: #dc3545; color: white;">
                                        üóëÔ∏è ÏÇ≠Ï†ú
                                    </button>
                                </div>
                            </div>
                            ${topic.description ? `<p style="margin: 0; font-size: 13px; color: #495057; background: #f8f9fa; padding: 8px; border-radius: 4px;">${topic.description}</p>` : ''}
                        </div>
                    `;
                });
                
                document.getElementById('topicsListContent').innerHTML = topicsHTML;
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå ÌÜ†Î°† Î™©Î°ù Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
                document.getElementById('topicsListContent').innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        ‚ùå ÌÜ†Î°† Î™©Î°ù Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.<br>
                        Ïò§Î•ò: ${error.message}
                    </div>
                `;
            }
        }
        
        // ÌÜ†Î°† ÏÉÅÏÑ∏ Î≥¥Í∏∞
        // ÌÜ†Î°† ÏÉÅÏÑ∏ Î≥¥Í∏∞ (Ïù¥Î†•)
        async function viewTopicDetails(topicId) {
            try {
                addLog(`üìã ÌÜ†Î°† ÏÉÅÏÑ∏ Î°úÎìú Ï§ë: ${topicId}`, 'info');
                
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                // ÌÜ†Î°† Í∏∞Î≥∏ Ï†ïÎ≥¥ Î°úÎìú
                const topicSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}`).once('value');
                const topicData = topicSnapshot.val();
                
                if (!topicData) {
                    alert('ÌÜ†Î°† Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                // ÌÜ†Î°† Î©îÏãúÏßÄ/Ìè¨Ïä§Ìä∏Ïûá Î°úÎìú
                const messagesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/messages`).once('value');
                const messages = messagesSnapshot.val() || {};
                
                // Ï∞¨Î∞ò ÌÜ†Î°†Ïù∏ Í≤ΩÏö∞ Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞ÎèÑ Î°úÎìú
                let votes = {};
                if (topicData.type === 'debate') {
                    const votesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/votes`).once('value');
                    votes = votesSnapshot.val() || {};
                }
                
                // Ï∞∏Ïó¨Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const participantsSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                // ÏÉÅÏÑ∏ ÌôîÎ©¥ ÌëúÏãú
                showTopicDetailsModal(topicData, messages, votes, participants);
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                console.error('ÌÜ†Î°† ÏÉÅÏÑ∏ Î°úÎìú Ïò§Î•ò:', error);
                addLog(`‚ùå ÌÜ†Î°† ÏÉÅÏÑ∏ Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
                alert('ÌÜ†Î°† ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // ÌÜ†Î°† ÏÉÅÏÑ∏ Î™®Îã¨ ÌëúÏãú
        function showTopicDetailsModal(topicData, messages, votes, participants) {
            const typeNames = {
                'debate': 'Ï∞¨Î∞ò ÌÜ†Î°†',
                'discussion': 'ÏûêÏú† ÌÜ†Î°†', 
                'postit': 'Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†',
                'survey': 'ÏÑ§Î¨∏ Ï°∞ÏÇ¨'
            };
            
            const createdDate = new Date(topicData.createdAt).toLocaleString();
            const endDate = topicData.endTime ? new Date(topicData.endTime).toLocaleString() : 'ÏßÑÌñâ Ï§ë';
            const participantCount = Object.keys(participants).length;
            const messageCount = Object.keys(messages).length;
            
            // Î™®Îã¨ HTML ÏÉùÏÑ±
            const modalHTML = `
                <div id="topicDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <!-- Ìó§Îçî -->
                        <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0 0 8px 0;">üìã ${topicData.title}</h3>
                                    <p style="margin: 0; opacity: 0.9;">${typeNames[topicData.type] || 'ÌÜ†Î°†'} ‚Ä¢ ${createdDate}</p>
                                </div>
                                <button onclick="closeTopicDetailsModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">√ó</button>
                            </div>
                        </div>
                        
                        <!-- ÎÇ¥Ïö© -->
                        <div style="padding: 20px;">
                            <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div>
                                        <strong>üìÖ ÏÉùÏÑ± ÏãúÍ∞Ñ</strong><br>
                                        <span style="color: #6c757d;">${createdDate}</span>
                                    </div>
                                    <div>
                                        <strong>‚è∞ Ï¢ÖÎ£å ÏãúÍ∞Ñ</strong><br>
                                        <span style="color: #6c757d;">${endDate}</span>
                                    </div>
                                    <div>
                                        <strong>üë• Ï∞∏Ïó¨Ïûê Ïàò</strong><br>
                                        <span style="color: #6c757d;">${participantCount}Î™Ö</span>
                                    </div>
                                    <div>
                                        <strong>üí¨ Î©îÏãúÏßÄ Ïàò</strong><br>
                                        <span style="color: #6c757d;">${messageCount}Í∞ú</span>
                                    </div>
                                </div>
                                ${topicData.description ? `
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                        <strong>üìù ÏÑ§Î™Ö</strong><br>
                                        <span style="color: #6c757d;">${topicData.description}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- ÌÜ†Î°† ÎÇ¥Ïö© -->
                            <div id="topicContent">
                                ${generateTopicContent(topicData.type, messages, votes, participants)}
                            </div>
                        </div>
                        
                        <!-- Ìë∏ÌÑ∞ -->
                        <div style="padding: 15px 20px; border-top: 1px solid #dee2e6; text-align: right;">
                            <button class="btn btn-secondary" onclick="closeTopicDetailsModal()">Îã´Í∏∞</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Î™®Îã¨ÏùÑ bodyÏóê Ï∂îÍ∞Ä
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ÌÜ†Î°† ÌÉÄÏûÖÎ≥Ñ ÎÇ¥Ïö© ÏÉùÏÑ±
        function generateTopicContent(type, messages, votes, participants) {
            if (type === 'debate') {
                return generateDebateContent(votes, participants);
            } else {
                return generateDiscussionContent(messages, participants);
            }
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† ÎÇ¥Ïö© ÏÉùÏÑ±
        function generateDebateContent(votes, participants) {
            const agreeVotes = [];
            const disagreeVotes = [];
            
            Object.values(votes).forEach(vote => {
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            const agreeCount = agreeVotes.length;
            const disagreeCount = disagreeVotes.length;
            const total = agreeCount + disagreeCount;
            
            const agreePercent = total > 0 ? (agreeCount / total * 100).toFixed(1) : 0;
            const disagreePercent = total > 0 ? (disagreeCount / total * 100).toFixed(1) : 0;
            
            return `
                <!-- Ìà¨Ìëú Í≤∞Í≥º -->
                <div style="margin-bottom: 25px;">
                    <h5 style="margin-bottom: 15px;">üìä ÏµúÏ¢Ö Ìà¨Ìëú Í≤∞Í≥º</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
                            <div style="flex: 1; background: #d4edda; height: 30px; border-radius: 15px; position: relative; overflow: hidden;">
                                <div style="background: #28a745; height: 100%; width: ${agreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 12px;">
                                    Ï∞¨ÏÑ± ${agreeCount}Î™Ö (${agreePercent}%)
                                </span>
                            </div>
                            <div style="flex: 1; background: #f8d7da; height: 30px; border-radius: 15px; position: relative; overflow: hidden;">
                                <div style="background: #dc3545; height: 100%; width: ${disagreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 12px;">
                                    Î∞òÎåÄ ${disagreeCount}Î™Ö (${disagreePercent}%)
                                </span>
                            </div>
                        </div>
                        <div style="text-align: center; color: #6c757d; font-size: 12px;">
                            Ï¥ù ${total}Î™ÖÏù¥ Ìà¨ÌëúÏóê Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§
                        </div>
                    </div>
                </div>
                
                <!-- ÏùòÍ≤¨ Î™©Î°ù -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h6 style="color: #28a745; margin-bottom: 10px;">‚úÖ Ï∞¨ÏÑ± ÏùòÍ≤¨ (${agreeCount}Í∞ú)</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${agreeVotes.map(vote => `
                                <div style="background: #d4edda; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-size: 11px; color: #155724; margin-bottom: 5px;">
                                        ${vote.participantName || vote.participantId || 'ÏùµÎ™Ö'} ‚Ä¢ ${new Date(vote.timestamp).toLocaleTimeString()}
                                    </div>
                                    <div style="font-size: 13px; color: #155724;">
                                        ${vote.opinion}${vote.isEdited ? ' <small>(ÏàòÏ†ïÎê®)</small>' : ''}
                                    </div>
                                </div>
                            `).join('') || '<div style="text-align: center; color: #6c757d; padding: 20px;">Ï∞¨ÏÑ± ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§</div>'}
                        </div>
                    </div>
                    <div>
                        <h6 style="color: #dc3545; margin-bottom: 10px;">‚ùå Î∞òÎåÄ ÏùòÍ≤¨ (${disagreeCount}Í∞ú)</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${disagreeVotes.map(vote => `
                                <div style="background: #f8d7da; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-size: 11px; color: #721c24; margin-bottom: 5px;">
                                        ${vote.participantName || vote.participantId || 'ÏùµÎ™Ö'} ‚Ä¢ ${new Date(vote.timestamp).toLocaleTimeString()}
                                    </div>
                                    <div style="font-size: 13px; color: #721c24;">
                                        ${vote.opinion}${vote.isEdited ? ' <small>(ÏàòÏ†ïÎê®)</small>' : ''}
                                    </div>
                                </div>
                            `).join('') || '<div style="text-align: center; color: #6c757d; padding: 20px;">Î∞òÎåÄ ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // ÏûêÏú† ÌÜ†Î°†/Ìè¨Ïä§Ìä∏Ïûá ÎÇ¥Ïö© ÏÉùÏÑ±
        function generateDiscussionContent(messages, participants) {
            const messageArray = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
            const postits = messageArray.filter(msg => msg.type === 'postit');
            const chatMessages = messageArray.filter(msg => msg.type !== 'postit');
            
            return `
                <!-- Ìè¨Ïä§Ìä∏Ïûá -->
                ${postits.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h5 style="margin-bottom: 15px;">üìù Ìè¨Ïä§Ìä∏Ïûá ÏùòÍ≤¨ (${postits.length}Í∞ú)</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            ${postits.map(postit => `
                                <div style="background: ${getPostitColor(postit.color)}; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                                    <div style="font-size: 13px; line-height: 1.4; margin-bottom: 8px;">
                                        ${postit.content}${postit.isEdited ? ' <small style="opacity: 0.7;">(ÏàòÏ†ïÎê®)</small>' : ''}
                                    </div>
                                    <div style="font-size: 10px; opacity: 0.7; position: absolute; bottom: 5px; right: 8px;">
                                        ${postit.participantName}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Ï±ÑÌåÖ Î©îÏãúÏßÄ -->
                ${chatMessages.length > 0 ? `
                    <div>
                        <h5 style="margin-bottom: 15px;">üí¨ ÌÜ†Î°† Î©îÏãúÏßÄ (${chatMessages.length}Í∞ú)</h5>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            ${chatMessages.map(msg => `
                                <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 5px;">
                                        ${msg.participantName} ‚Ä¢ ${new Date(msg.timestamp).toLocaleTimeString()}
                                    </div>
                                    <div style="font-size: 13px; color: #495057;">
                                        ${msg.content || msg.text}${msg.isEdited ? ' <small style="opacity: 0.7;">(ÏàòÏ†ïÎê®)</small>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${postits.length === 0 && chatMessages.length === 0 ? `
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        üí≠ Ïù¥ ÌÜ†Î°†ÏóêÎäî ÏïÑÏßÅ Î©îÏãúÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§
                    </div>
                ` : ''}
                
                <!-- Ï∞∏Ïó¨Ïûê Î™©Î°ù -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                    <h6 style="margin-bottom: 10px;">üë• Ï∞∏Ïó¨Ïûê Î™©Î°ù</h6>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${Object.values(participants).map(participant => `
                            <span style="background: #e7f3ff; color: #0056b3; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                                ${participant.name}
                            </span>
                        `).join('') || '<span style="color: #6c757d;">Ï∞∏Ïó¨ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</span>'}
                    </div>
                </div>
            `;
        }

        // Ìè¨Ïä§Ìä∏Ïûá ÏÉâÏÉÅ Î≥ÄÌôò
        function getPostitColor(color) {
            const colors = {
                'yellow': '#ffeb3b',
                'blue': '#2196f3', 
                'green': '#4caf50',
                'pink': '#e91e63'
            };
            return colors[color] || '#ffeb3b';
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeTopicDetailsModal() {
            const modal = document.getElementById('topicDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ÌÜ†Î°†Ïóê Ï∞∏Ïó¨ÌïòÍ∏∞
        async function enterDiscussion(topicId, topicTitle) {
            addLog(`üö™ ÌÜ†Î°† Ï∞∏Ïó¨: ${topicTitle}`, 'success');
            
            // 5Îã®Í≥ÑÎ°ú ÏßÑÌñâ
            updateCurrentStep(5, `Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† - ${topicTitle}`);
            currentTopicId = topicId;
            
            // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            await loadDiscussionData(topicId);
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="color: white; margin: 0 0 5px 0;">üéâ ${topicTitle}</h3>
                    <p style="color: #f8f9fa; margin: 0; font-size: 13px;">5Îã®Í≥Ñ: Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† ÏßÑÌñâ Ï§ë</p>
                </div>
                
                <!-- Ï∞∏Ïó¨Ïûê Ï†ïÎ≥¥ ÏûÖÎ†• -->
                <div id="participantForm" style="background: white; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="color: #007bff; margin: 0 0 10px 0;">üë§ Ï∞∏Ïó¨Ïûê Ï†ïÎ≥¥</h4>
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div style="flex: 1;">
                            <label for="participantName" style="display: block; margin-bottom: 5px; font-size: 12px; color: #495057;">Ïù¥Î¶Ñ</label>
                            <input type="text" id="participantName" placeholder="ÍπÄÎØºÏàò" maxlength="20" 
                                style="width: 100%; padding: 8px; border: 2px solid #dee2e6; border-radius: 4px; font-size: 14px;" />
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; margin-bottom: 5px;">
                                <input type="checkbox" id="isAnonymous"> ÏùµÎ™Ö Ï∞∏Ïó¨
                            </label>
                            <button class="btn btn-primary" onclick="joinDiscussion()" style="padding: 8px 15px; font-size: 13px;">
                                üöÄ Ï∞∏Ïó¨ÌïòÍ∏∞
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ÌÜ†Î°† ÏòÅÏó≠ (Ï¥àÍ∏∞ÏóêÎäî ÎπÑÌôúÏÑ±Ìôî) -->
                <div id="discussionArea" style="display: none;">
                    <!-- Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† UIÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê® -->
                </div>
            `;
            
            // Ïù¥Î¶Ñ ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§
            setTimeout(() => {
                document.getElementById('participantName').focus();
            }, 100);
        }
        
        // =========================
        // 5Îã®Í≥Ñ: Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† Í∏∞Îä•
        // =========================
        
        let currentTopicId = null;
        let currentTopicData = null;
        let currentParticipantId = null;
        let discussionListener = null;
        
        // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadDiscussionData(topicId) {
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                const topicSnapshot = await database.ref('discussions/' + topicId).once('value');
                if (topicSnapshot.exists()) {
                    currentTopicData = topicSnapshot.val();
                    addLog(`‚úÖ ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú: ${currentTopicData.title}`, 'success');
                } else {
                    throw new Error('ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
            }
        }
        
        // ÌÜ†Î°†Ïóê Ï∞∏Ïó¨ÌïòÍ∏∞
        async function joinDiscussion() {
            const participantName = document.getElementById('participantName').value.trim();
            const isAnonymous = document.getElementById('isAnonymous').checked;
            
            if (!participantName && !isAnonymous) {
                alert('‚ö†Ô∏è Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏùµÎ™Ö Ï∞∏Ïó¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                const displayName = isAnonymous ? `ÏùµÎ™Ö${Math.floor(Math.random() * 1000)}` : participantName;
                
                // Ï∞∏Ïó¨Ïûê IDÎ•º Ïù¥Î¶Ñ Í∏∞Î∞òÏúºÎ°ú ÏÉùÏÑ± (Ï§ëÎ≥µ Ï∞∏Ïó¨ Î∞©ÏßÄ)
                const participantNameForId = displayName.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, ''); // ÌäπÏàòÎ¨∏Ïûê Ï†úÍ±∞
                currentParticipantId = `participant_${participantNameForId}_${currentClassId}_${currentTopicId}`;
                
                // Í∏∞Ï°¥ Ï∞∏Ïó¨ÏûêÏù∏ÏßÄ ÌôïÏù∏
                const existingParticipant = await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}`).once('value');
                
                if (existingParticipant.exists()) {
                    // Í∏∞Ï°¥ Ï∞∏Ïó¨ÏûêÎùºÎ©¥ Ïû¨Ï∞∏Ïó¨ Ï≤òÎ¶¨
                    addLog(`üîÑ Í∏∞Ï°¥ Ï∞∏Ïó¨ÏûêÎ°ú Ïû¨Ï∞∏Ïó¨: ${displayName}`, 'info');
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}/lastActive`).set(firebase.database.ServerValue.TIMESTAMP);
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}/rejoined`).set(true);
                } else {
                    // ÏÉà Ï∞∏Ïó¨ÏûêÎùºÎ©¥ Ï∞∏Ïó¨Ïûê Ïàò Ï¶ùÍ∞Ä
                    await database.ref(`discussions/${currentTopicId}/participantCount`).transaction(count => {
                        return (count || 0) + 1;
                    });
                    addLog(`‚ú® ÏÉà Ï∞∏Ïó¨Ïûê Îì±Î°ù: ${displayName}`, 'success');
                }
                
                // Ï∞∏Ïó¨Ïûê Ï†ïÎ≥¥ Îì±Î°ù
                const participantData = {
                    id: currentParticipantId,
                    name: displayName,
                    isAnonymous: isAnonymous,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}`).set(participantData);
                
                // Ï∞∏Ïó¨Ïûê Ïàò Ï¶ùÍ∞Ä
                await database.ref(`discussions/${currentTopicId}/participantCount`).transaction(count => {
                    return (count || 0) + 1;
                });
                
                addLog(`‚úÖ ÌÜ†Î°† Ï∞∏Ïó¨ ÏôÑÎ£å: ${displayName}`, 'success');
                
                // Ï∞∏Ïó¨ Ìèº Ïà®Í∏∞Í≥† ÌÜ†Î°† UI ÌëúÏãú
                document.getElementById('participantForm').style.display = 'none';
                document.getElementById('discussionArea').style.display = 'block';
                
                // Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† UI Ï¥àÍ∏∞Ìôî
                initializeDiscussionUI();
                
                // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÏãúÏûë
                setupRealTimeListeners();
                
                // ÌÜ†Î°† ÏãúÍ∞Ñ ÌÉÄÏù¥Î®∏ ÏãúÏûë
                startDiscussionTimer();
                
                // ÌÜ†Î°†Î∞© Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏ (ÎèåÏïÑÍ∞ÄÍ∏∞ Î≤ÑÌäº)
                updateHeaderForDiscussion();
                
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå ÌÜ†Î°† Ï∞∏Ïó¨ Ïã§Ìå®: ${error.message}`, 'error');
                alert(`‚ùå ÌÜ†Î°† Ï∞∏Ïó¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
            }
        }
        
        // Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† UI Ï¥àÍ∏∞Ìôî
        function initializeDiscussionUI() {
            const discussionArea = document.getElementById('discussionArea');
            
            const typeUIMap = {
                'discussion': createDiscussionUI,
                'postit': createPostitUI,
                'debate': createDebateUI,
                'survey': createSurveyUI
            };
            
            const createUI = typeUIMap[currentTopicData.type] || createDiscussionUI;
            discussionArea.innerHTML = createUI();
            
            // ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê Ï¥àÍ∏∞Ìôî
            initializeTeacherControls();
        }
        
        // Í≥µÌÜµ ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê HTML ÏÉùÏÑ±
        function createTeacherControlPanel() {
            return `
                <!-- ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê -->
                <div style="background: white; border: 2px solid #007bff; border-radius: 8px; margin-bottom: 10px;">
                    <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <h6 style="margin: 0;">üéõÔ∏è ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê</h6>
                    </div>
                    <div style="padding: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; margin-bottom: 8px;">
                            <input type="checkbox" id="allowStudentPostToggle" checked onchange="toggleStudentPost()"> 
                            <span>üìù ÌïôÏÉù Í≤åÏãúÍ∏Ä ÌóàÏö©</span>
                        </label>
                        <div style="font-size: 11px; color: #6c757d; padding-left: 24px; margin-bottom: 15px;">
                            Ï≤¥ÌÅ¨ Ìï¥Ï†ú Ïãú ÌïôÏÉùÎì§Ïùò Î©îÏãúÏßÄ ÏûëÏÑ±ÏùÑ Ï†úÌïúÌï©ÎãàÎã§
                        </div>
                        
                        <!-- Ïã§ÏãúÍ∞Ñ Î©îÏãúÏßÄ Ï†ÑÏÜ° -->
                        <div style="border-top: 1px solid #dee2e6; padding-top: 15px;">
                            <h6 style="margin: 0 0 10px 0; font-size: 13px; color: #495057;">üí¨ ÌïôÏÉùÎì§ÏóêÍ≤å Î©îÏãúÏßÄ Ï†ÑÏÜ°</h6>
                            <textarea id="teacherMessageInput" placeholder="ÌïôÏÉùÎì§ÏóêÍ≤å Ï†ÑÎã¨Ìï† Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                                style="width: 100%; height: 60px; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; resize: none; font-size: 12px;"></textarea>
                            <button onclick="sendTeacherMessage()" style="margin-top: 8px; background: #28a745; color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 12px; cursor: pointer;">
                                üì§ Î©îÏãúÏßÄ Ï†ÑÏÜ°
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê Ï¥àÍ∏∞Ìôî
        function initializeTeacherControls() {
            const toggle = document.getElementById('allowStudentPostToggle');
            if (toggle && currentTopicData && currentTopicData.settings) {
                toggle.checked = currentTopicData.settings.allowStudentPost !== false;
            }
        }
        
        // ÌïôÏÉù Í≤åÏãúÍ∏Ä ÌóàÏö©/Ï∞®Îã® ÌÜ†Í∏Ä
        async function toggleStudentPost() {
            const toggle = document.getElementById('allowStudentPostToggle');
            const allowStudentPost = toggle.checked;
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                // FirebaseÏóê ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/settings/allowStudentPost`).set(allowStudentPost);
                await database.ref(`discussions/${currentTopicId}/settings/allowStudentPost`).set(allowStudentPost);
                
                // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (currentTopicData.settings) {
                    currentTopicData.settings.allowStudentPost = allowStudentPost;
                }
                
                const status = allowStudentPost ? 'ÌóàÏö©' : 'Ï∞®Îã®';
                addLog(`üìù ÌïôÏÉù Í≤åÏãúÍ∏Ä ${status}ÏúºÎ°ú Î≥ÄÍ≤ΩÎê®`, allowStudentPost ? 'success' : 'warning');
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå ÏÑ§Ï†ï Î≥ÄÍ≤Ω Ïã§Ìå®: ${error.message}`, 'error');
                // Ïã§Ìå® Ïãú ÌÜ†Í∏Ä ÏÉÅÌÉú ÎêòÎèåÎ¶¨Í∏∞
                toggle.checked = !allowStudentPost;
            }
        }
        
        // ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï†ÑÏÜ° Ìï®Ïàò
        async function sendTeacherMessage() {
            const messageInput = document.getElementById('teacherMessageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                addLog('‚ùå Ï†ÑÏÜ°Ìï† Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            if (!currentTopicId) {
                addLog('‚ùå Î®ºÏ†Ä ÌÜ†Î°†ÏùÑ ÏãúÏûëÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                const teacherMessage = {
                    message: message,
                    timestamp: Date.now(),
                    sender: 'teacher',
                    teacherName: getTeacherName(),
                    type: 'teacher_message', // ÍµêÏÇ¨ Î©îÏãúÏßÄ ÌÉÄÏûÖ Íµ¨Î∂Ñ
                    topicId: currentTopicId
                };
                
                // FirebaseÏóê ÍµêÏÇ¨ Î©îÏãúÏßÄÎ•º Î≥ÑÎèÑ Í≤ΩÎ°úÏóê Ï†ÄÏû• (Ï±ÑÌåÖÍ≥º Î∂ÑÎ¶¨)
                console.log('ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï†ïÎ≥¥:', {
                    currentTopicId: currentTopicId,
                    message: message,
                    path: `classes/${currentClassId}/discussions/${currentTopicId}/teacherMessages`
                });
                
                // teacherMessagesÏôÄ ÏùºÎ∞ò messagesÏóê Î™®Îëê Ï†ÄÏû•
                console.log('üí¨ ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï†ÄÏû• Ï§ë:', teacherMessage);
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/teacherMessages`).push(teacherMessage);
                console.log('üì§ teacherMessages Ï†ÄÏû• ÏôÑÎ£å');
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages`).push(teacherMessage);
                console.log('üì§ messages Ï†ÄÏû• ÏôÑÎ£å');
                
                addLog(`üí¨ Î©îÏãúÏßÄ Ï†ÑÏÜ°Îê® (ÌÜ†Î°†Î∞©: ${currentTopicId}): ${message}`, 'success');
                messageInput.value = '';
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: ${error.message}`, 'error');
            }
        }
        
        // ÏûêÏú† ÌÜ†Î°† UI ÏÉùÏÑ±
        function createDiscussionUI() {
            return `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 500px;">
                    <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; display: flex; flex-direction: column;">
                        <div style="padding: 10px 15px; border-bottom: 1px solid #dee2e6; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                            <h5 style="margin: 0; color: #495057;">üí¨ ÌÜ†Î°† Î©îÏãúÏßÄ</h5>
                            <button onclick="clearAllMessages()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" title="Î™®Îì† Î©îÏãúÏßÄ ÏÇ≠Ï†ú">
                                üóëÔ∏è Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
                            </button>
                        </div>
                        <div id="messagesContainer" style="flex: 1; padding: 10px; overflow-y: auto; max-height: 380px;">
                            <div style="text-align: center; color: #6c757d; padding: 20px;">
                                üí¨ ÌÜ†Î°†ÏùÑ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!
                            </div>
                        </div>
                        <div style="padding: 10px; border-top: 1px solid #dee2e6;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="messageInput" placeholder="ÎÇ¥ ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                                    style="flex: 1; padding: 8px; border: 2px solid #dee2e6; border-radius: 4px; font-size: 14px;" 
                                    onkeypress="if(event.key==='Enter') sendMessage()" />
                                <button class="btn btn-primary" onclick="sendMessage()" style="padding: 8px 12px;">
                                    üì¢ Ï†ÑÏÜ°
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ï∞∏Ïó¨Ïûê Î∞è Ï†ïÎ≥¥ ÏòÅÏó≠ -->
                    <div>
                        ${createTeacherControlPanel()}
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">üë§ Ï∞∏Ïó¨Ïûê (<span id="participantCount">0</span>Î™Ö)</h6>
                            </div>
                            <div id="participantsList" style="padding: 10px; max-height: 120px; overflow-y: auto;">
                                Î°úÎî© Ï§ë...
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">üìã Îã§Î•∏ ÌÜ†Î°†Î∞©</h6>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 10px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="transform: scale(0.8);">
                                    <span>Ï¢ÖÎ£å</span>
                                </label>
                            </div>
                            <div id="otherRoomsList" style="padding: 10px; max-height: 200px; overflow-y: auto;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">
                                    Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Ìè¨Ïä§Ìä∏Ïûá UI ÏÉùÏÑ±
        function createPostitUI() {
            return `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                    <!-- Î©îÏù∏ Ìè¨Ïä§Ìä∏Ïûá ÏòÅÏó≠ -->
                    <div>
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            <h5 style="color: #495057; margin: 0 0 15px 0;">üìù Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†</h5>
                            
                            <div style="margin-bottom: 15px;">
                                <textarea id="postitInput" placeholder="ÎÇ¥ ÏùòÍ≤¨ÏùÑ ÏûêÏú†Î°≠Í≤å Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî..." 
                                    style="width: 100%; height: 80px; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; resize: vertical;"></textarea>
                                <button class="btn btn-success" onclick="addPostit()" style="margin-top: 8px;">
                                    üìù Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞Ä
                                </button>
                            </div>
                            
                            <div id="postitBoard" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; min-height: 300px; background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; grid-column: 1 / -1;">
                                    üìù ÏïÑÏßÅ ÏûëÏÑ±Îêú Ìè¨Ïä§Ìä∏ÏûáÏù¥ ÏóÜÏäµÎãàÎã§.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê Î∞è Ï†ïÎ≥¥ ÏòÅÏó≠ -->
                    <div>
                        ${createTeacherControlPanel()}
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">üë§ Ï∞∏Ïó¨Ïûê (<span id="participantCount">0</span>Î™Ö)</h6>
                            </div>
                            <div id="participantsList" style="padding: 10px; max-height: 120px; overflow-y: auto;">
                                Î°úÎî© Ï§ë...
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">üìã Îã§Î•∏ ÌÜ†Î°†Î∞©</h6>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 10px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="transform: scale(0.8);">
                                    <span>Ï¢ÖÎ£å</span>
                                </label>
                            </div>
                            <div id="otherRoomsList" style="padding: 10px; max-height: 200px; overflow-y: auto;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">
                                    Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Ï∞¨Î∞ò ÌÜ†Î°† UI ÏÉùÏÑ±
        function createDebateUI() {
            return `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                    <!-- Î©îÏù∏ Ï∞¨Î∞ò ÌÜ†Î°† ÏòÅÏó≠ -->
                    <div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 15px;">
                        <h5 style="color: #155724; margin: 0 0 10px 0;">‚úÖ Ï∞¨ÏÑ± ÏùòÍ≤¨</h5>
                        <div id="agreeSection" style="min-height: 300px;">
                            <textarea id="agreeInput" placeholder="Ï∞¨ÏÑ± ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                                style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #c3e6cb; border-radius: 4px;"></textarea>
                            <button class="btn btn-success" onclick="submitDebateVote('agree')" style="width: 100%; margin-bottom: 10px;">
                                ‚úÖ Ï∞¨ÏÑ± ÏùòÍ≤¨ Îì±Î°ù
                            </button>
                            <div id="agreeList">
                                Î°úÎî© Ï§ë...
                            </div>
                        </div>
                    </div>
                    
                            <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 15px;">
                                <h5 style="color: #721c24; margin: 0 0 10px 0;">‚ùå Î∞òÎåÄ ÏùòÍ≤¨</h5>
                                <div id="disagreeSection" style="min-height: 300px;">
                                    <textarea id="disagreeInput" placeholder="Î∞òÎåÄ ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                                        style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #f5c6cb; border-radius: 4px;"></textarea>
                                    <button class="btn" onclick="submitDebateVote('disagree')" 
                                        style="width: 100%; margin-bottom: 10px; background: #dc3545; color: white;">
                                        ‚ùå Î∞òÎåÄ ÏùòÍ≤¨ Îì±Î°ù
                                    </button>
                                    <div id="disagreeList">
                                        Î°úÎî© Ï§ë...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h6 style="margin: 0; color: #495057;">üìä Ïã§ÏãúÍ∞Ñ Í≤∞Í≥º</h6>
                                <button onclick="clearAllMessages()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" title="Î™®Îì† ÏùòÍ≤¨ ÏÇ≠Ï†ú">
                                    üóëÔ∏è Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; background: #d4edda; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="agreeBar" style="background: #28a745; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        Ï∞¨ÏÑ± <span id="agreeCount">0</span>
                                    </span>
                                </div>
                                <div style="flex: 1; background: #f8d7da; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="disagreeBar" style="background: #dc3545; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        Î∞òÎåÄ <span id="disagreeCount">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÍµêÏÇ¨ Ï†úÏñ¥ Ìå®ÎÑê Î∞è Ï†ïÎ≥¥ ÏòÅÏó≠ -->
                    <div>
                        ${createTeacherControlPanel()}
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">üë§ Ï∞∏Ïó¨Ïûê (<span id="participantCount">0</span>Î™Ö)</h6>
                            </div>
                            <div id="participantsList" style="padding: 10px; max-height: 120px; overflow-y: auto;">
                                Î°úÎî© Ï§ë...
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">üìã Îã§Î•∏ ÌÜ†Î°†Î∞©</h6>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 10px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="transform: scale(0.8);">
                                    <span>Ï¢ÖÎ£å</span>
                                </label>
                            </div>
                            <div id="otherRoomsList" style="padding: 10px; max-height: 200px; overflow-y: auto;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">
                                    Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ÏÑ§Î¨∏ UI ÏÉùÏÑ±
        function createSurveyUI() {
            return `
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h5 style="color: #495057; margin: 0 0 15px 0;">üìä ÏÑ§Î¨∏ Ï°∞ÏÇ¨</h5>
                    <p style="color: #6c757d; margin-bottom: 20px;">Í∏∞Îä• Í∞úÎ∞ú ÏòàÏ†ï: Îã§Ï§ë ÏÑ†ÌÉù, Îã®ÎãµÌòï, Ï†êÏàò ÌèâÍ∞Ä Îì±</p>
                    
                    <div style="text-align: center; color: #6c757d; padding: 40px; background: #f8f9fa; border-radius: 6px;">
                        üöÄ ÏÑ§Î¨∏ Ï°∞ÏÇ¨ Í∏∞Îä•ÏùÄ Ìñ•ÌõÑ Î≤ÑÏ†ÑÏóêÏÑú Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.
                    </div>
                </div>
            `;
        }
        
        // Îã§Î•∏ ÌÜ†Î°†Î∞© Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateOtherRoomsList() {
            const database = initGlobalDatabase();
            if (!database || !currentClassId) return;
            
            const showClosed = document.getElementById('showClosedRoomsCheckbox').checked;
            
            database.ref(`classes/${currentClassId}/discussions`).once('value', (snapshot) => {
                const discussions = snapshot.val() || {};
                const otherRoomsEl = document.getElementById('otherRoomsList');
                if (!otherRoomsEl) return;
                
                const rooms = Object.entries(discussions)
                    .filter(([id, discussion]) => {
                        if (id === currentTopicId) return false; // ÌòÑÏû¨ Î∞© Ï†úÏô∏
                        return showClosed || discussion.status === 'active';
                    })
                    .map(([id, discussion]) => ({
                        id: id,
                        title: discussion.title || 'Ï†úÎ™© ÏóÜÏùå',
                        status: discussion.status || 'active',
                        participants: discussion.participants || {},
                        type: discussion.type || 'general'
                    }));
                
                if (rooms.length === 0) {
                    const message = showClosed ? 'Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§' : 'ÏßÑÌñâ Ï§ëÏù∏ Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§';
                    otherRoomsEl.innerHTML = `<div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">${message}</div>`;
                    return;
                }
                
                const roomsHtml = rooms.map(room => {
                    const typeEmoji = getTypeEmoji(room.type);
                    const statusText = room.status === 'active' ? 'ÏßÑÌñâÏ§ë' : 'Ï¢ÖÎ£åÎê®';
                    const statusClass = room.status === 'active' ? 'style="color: #28a745;"' : 'style="color: #6c757d;"';
                    
                    return `
                        <div class="room-item-mini" onclick="switchToRoom('${room.id}', '${room.title}', '${room.status}')" 
                             style="padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 11px; border: 1px solid #e9ecef;" 
                             onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                            <div style="font-weight: bold; margin-bottom: 2px;">${typeEmoji} ${room.title}</div>
                            <div ${statusClass}>${statusText} ‚Ä¢ ${Object.keys(room.participants || {}).length}Î™Ö</div>
                        </div>
                    `;
                }).join('');
                
                otherRoomsEl.innerHTML = roomsHtml;
            });
        }
        
        // Ï¢ÖÎ£åÎêú Î∞© Î≥¥Í∏∞ ÌÜ†Í∏Ä
        function toggleClosedRooms() {
            updateOtherRoomsList();
        }
        
        // ÌÜ†Î°†Î∞© Ï†ÑÌôò
        function switchToRoom(roomId, roomTitle, status) {
            if (status !== 'active') {
                alert('ÏßÑÌñâ Ï§ëÏù∏ ÌÜ†Î°†Îßå Ï∞∏Ïó¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            if (confirm(`ÌòÑÏû¨ ÌÜ†Î°†ÏùÑ ÎÇòÍ∞ÄÍ≥† "${roomTitle}" ÌÜ†Î°†ÏúºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                addLog(`üîÑ ÌÜ†Î°†Î∞© Ï†ÑÌôò: ${roomTitle}`, 'info');
                
                // Firebase Ïó∞Í≤∞ÏùÑ Ïú†ÏßÄÌïòÎ©¥ÏÑú ÌÜ†Î°†Î∞© ÏßÅÏ†ë Ï†ÑÌôò
                currentTopicId = roomId;
                window.currentTopicTitle = roomTitle;
                
                // 3Îã®Í≥Ñ(Ïã§ÏãúÍ∞Ñ ÌÜ†Î°†Í¥ÄÎ¶¨) Ìó§ÎçîÎ°ú Î≥ÄÍ≤Ω
                updateHeaderForDiscussion();
                
                // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÌõÑ UI ÏóÖÎç∞Ïù¥Ìä∏
                loadDiscussionDataForTeacher(roomId).then(() => {
                    if (currentTopicData) {
                        // ÌÜ†Î°† Ïú†ÌòïÏóê Îî∞Îùº Ï†ÅÏ†àÌïú UI ÌëúÏãú
                        initializeDiscussionUI();
                        setupRealTimeListeners();
                        startDiscussionTimer();
                        addLog(`‚úÖ "${roomTitle}" ÌÜ†Î°† Ï∞∏Ïó¨ ÏôÑÎ£å`, 'success');
                    } else {
                        addLog(`‚ùå "${roomTitle}" ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®`, 'error');
                        alert('ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                    }
                }).catch(error => {
                    addLog(`‚ùå ÌÜ†Î°†Î∞© Ï†ÑÌôò Ïã§Ìå®: ${error.message}`, 'error');
                    alert(`ÌÜ†Î°†Î∞© Ï†ÑÌôòÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
                });
            }
        }
        
        // ÌÜ†Î°† ÌÉÄÏûÖÎ≥Ñ Ïù¥Î™®ÏßÄ Î∞òÌôò
        function getTypeEmoji(type) {
            switch(type) {
                case 'general': return 'üí¨';
                case 'postit': return 'üìù';
                case 'debate': return '‚öñÔ∏è';
                case 'survey': return 'üìä';
                default: return 'üí¨';
            }
        }
        
        // Database Í∑úÏπô ÎèÑÏõÄÎßê Î≤ÑÌäº Ï∂îÍ∞Ä
        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendMessage() {
            const messageText = document.getElementById('messageInput').value.trim();
            if (!messageText) return;
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const messageData = {
                    id: messageId,
                    text: messageText,
                    participantId: currentParticipantId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'message'
                };
                
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages/${messageId}`).set(messageData);
                
                // Î©îÏãúÏßÄ Ïàò Ï¶ùÍ∞Ä
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messageCount`).transaction(count => {
                    return (count || 0) + 1;
                });
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('messageInput').value = '';
                document.getElementById('messageInput').focus();
                
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: ${error.message}`, 'error');
            }
        }
        
        // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÏÑ§Ï†ï
        function setupRealTimeListeners() {
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                // Î©îÏãúÏßÄ ÏàòÏã†
                database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages`).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    displayMessage(message);
                });
                
                // Ï∞∏Ïó¨Ïûê ÏàòÏã†
                database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants`).on('value', (snapshot) => {
                    const participants = snapshot.val() || {};
                    updateParticipantsList(participants);
                });
                
                // Îã§Î•∏ ÌÜ†Î°†Î∞© Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                updateOtherRoomsList();
                
                // Ï∞¨Î∞ò ÌÜ†Î°† Ìà¨Ìëú Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                if (currentTopicData && currentTopicData.type === 'debate') {
                    database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes`).on('value', (snapshot) => {
                        const votes = snapshot.val() || {};
                        updateDebateResults(votes);
                    });
                }
                
                // Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°† Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏  
                if (currentTopicData && currentTopicData.type === 'postit') {
                    database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/postits`).on('child_added', (snapshot) => {
                        const postit = snapshot.val();
                        displayPostit(postit);
                    });
                }
                
                addLog('‚úÖ Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÏãúÏûë', 'success');
                
            } catch (error) {
                addLog(`‚ùå Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÏÑ§Ï†ï Ïã§Ìå®: ${error.message}`, 'error');
            }
        }
        
        // Î©îÏãúÏßÄ ÌëúÏãú
        function displayMessage(message) {
            // DOMÏù¥ Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
            setTimeout(() => {
                // ÌÜ†Î°† ÌÉÄÏûÖÏóê Îî∞Îùº Î©îÏãúÏßÄ Ïª®ÌÖåÏù¥ÎÑà Ï∞æÍ∏∞
                let messagesContainer = document.getElementById('messagesContainer'); // Ï±ÑÌåÖÌòï, ÏùºÎ∞òÌòï
                
                if (!messagesContainer) {
                    // Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†Ïùò Í≤ΩÏö∞
                    messagesContainer = document.getElementById('postitBoard');
                }
                
                if (!messagesContainer) {
                    // Ï∞¨Î∞òÌÜ†Î°†Ïùò Í≤ΩÏö∞ - Ï∞¨ÏÑ±/Î∞òÎåÄÏóê Îî∞Îùº Îã§Î•¥Í≤å Ï≤òÎ¶¨
                    if (message.position === 'agree') {
                        messagesContainer = document.getElementById('agreeList');
                    } else if (message.position === 'disagree') {
                        messagesContainer = document.getElementById('disagreeList');
                    } else if (message.sender === 'teacher' || message.type === 'teacher_message') {
                        // ÍµêÏÇ¨ Î©îÏãúÏßÄÎäî Ï∞¨Î∞òÌÜ†Î°†Ïóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå - Î≥ÑÎèÑ Ï≤òÎ¶¨ ÌïÑÏöî
                        console.log('‚ö†Ô∏è ÍµêÏÇ¨ Î©îÏãúÏßÄÎäî Ï∞¨Î∞òÌÜ†Î°† UIÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏäµÎãàÎã§:', message);
                        return; // ÍµêÏÇ¨ Î©îÏãúÏßÄÎäî Ï∞¨Î∞òÌÜ†Î°† UIÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå
                    } else {
                        // Í∏∞ÌÉÄ ÏùºÎ∞ò Î©îÏãúÏßÄÎßå Ï∞¨ÏÑ± ÏòÅÏó≠Ïóê ÌëúÏãú
                        messagesContainer = document.getElementById('agreeList');
                    }
                }
                
                // Ïó¨Ï†ÑÌûà Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏúºÎ©¥
                if (!messagesContainer) {
                    console.warn('Î©îÏãúÏßÄ ÌëúÏãú ÏòÅÏó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌÜ†Î°† ÌÉÄÏûÖ:', currentTopicData?.type);
                    addLog('‚ùå Î©îÏãúÏßÄ ÌëúÏãú ÏòÅÏó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                    return;
                }
                
                // Ïã§Ï†ú Î©îÏãúÏßÄ ÌëúÏãú Î°úÏßÅ
                renderMessageInContainer(message, messagesContainer);
            }, 100);
        }
        
        // Ïã§Ï†ú Î©îÏãúÏßÄ Î†åÎçîÎßÅ Ìï®Ïàò
        function renderMessageInContainer(message, messagesContainer) {
            
            // Ï≤òÏùå Î©îÏãúÏßÄÏùº Í≤ΩÏö∞ ÏïàÎÇ¥ Î©îÏãúÏßÄ Ï†úÍ±∞
            const welcomeMsg = messagesContainer.querySelector('[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            console.log('üìù Î©îÏãúÏßÄ Î†åÎçîÎßÅ:', message);
            console.log('üìç Ïª®ÌÖåÏù¥ÎÑà:', messagesContainer.id);
            
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                margin-bottom: 10px; 
                padding: 8px 12px; 
                background: ${message.sender === 'teacher' ? '#fff3cd' : '#f8f9fa'};
                border-radius: 8px;
                border-left: 3px solid ${message.sender === 'teacher' ? '#ffc107' : '#6c757d'};
            `;
            
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            const senderName = message.sender === 'teacher' ? (message.teacherName || getTeacherName()) : (message.participantName || message.participantId || message.name || message.sender || 'ÌïôÏÉù');
            
            messageEl.innerHTML = `
                <div style="font-size: 11px; color: #6c757d; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>${senderName}</strong> - ${timestamp}</span>
                    <button onclick="deleteMessage('${message.id || message.messageId}', '${message.type || 'message'}')" 
                            style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="Î©îÏãúÏßÄ ÏÇ≠Ï†ú">üóëÔ∏è</button>
                </div>
                <div style="font-size: 14px; color: #343a40;">${message.content || message.message || message.text || 'ÎÇ¥Ïö© ÏóÜÏùå'}${message.isEdited ? ' <small style="opacity: 0.6;">(ÏàòÏ†ïÎê®)</small>' : ''}</div>
            `;
            
            // Î©îÏãúÏßÄ ID Ï†ÄÏû•
            messageEl.setAttribute('data-message-id', message.id || message.messageId);
            
            addLog(`‚úÖ Î©îÏãúÏßÄ ÌëúÏãúÎê®: ${senderName} - ${message.content || message.message || message.text}`, 'success');
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Î©îÏãúÏßÄ ÏÇ≠Ï†ú (ÍµêÏÇ¨Ïö© - Î™®Îì† Î©îÏãúÏßÄ ÏÇ≠Ï†ú Í∞ÄÎä•)
        async function deleteMessage(messageId, messageType = 'message') {
            if (!confirm('Ïù¥ Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                if (messageType === 'postit' || messageType === 'message') {
                    // ÏùºÎ∞ò Î©îÏãúÏßÄ/Ìè¨Ïä§Ìä∏Ïûá ÏÇ≠Ï†ú
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages/${messageId}`).remove();
                } else if (messageType === 'vote') {
                    // Ï∞¨Î∞ò ÌÜ†Î°† Ìà¨Ìëú ÏÇ≠Ï†ú
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes/${messageId}`).remove();
                }
                
                // UIÏóêÏÑú Î©îÏãúÏßÄ Ï†úÍ±∞
                const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageEl) {
                    messageEl.style.animation = 'fadeOut 0.3s ease-in-out';
                    setTimeout(() => {
                        messageEl.remove();
                    }, 300);
                }
                
                addLog(`‚úÖ Î©îÏãúÏßÄ ÏÇ≠Ï†ú ÏôÑÎ£å: ${messageId}`, 'success');
                
                // Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                console.error('Î©îÏãúÏßÄ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                addLog(`‚ùå Î©îÏãúÏßÄ ÏÇ≠Ï†ú Ïã§Ìå®: ${error.message}`, 'error');
                alert('Î©îÏãúÏßÄ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Î™®Îì† Î©îÏãúÏßÄ ÏÇ≠Ï†ú (ÍµêÏÇ¨Ïö© Ï†ÑÏö©)
        async function clearAllMessages() {
            if (!confirm('Î™®Îì† Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                return;
            }
            
            if (!confirm('Ï†ïÎßêÎ°ú Î™®Îì† Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                // Î™®Îì† Î©îÏãúÏßÄ ÏÇ≠Ï†ú - ÏÉàÎ°úÏö¥ Í≤ΩÎ°ú Íµ¨Ï°∞ ÏÇ¨Ïö©
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages`).remove();
                
                // Ï∞¨Î∞ò ÌÜ†Î°†Ïù∏ Í≤ΩÏö∞ Ìà¨ÌëúÎèÑ ÏÇ≠Ï†ú
                if (currentTopicData && currentTopicData.type === 'debate') {
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes`).remove();
                    console.log('üóëÔ∏è Ï∞¨Î∞òÌÜ†Î°† Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å');
                }
                
                // ÍµêÏÇ¨ Î©îÏãúÏßÄÎèÑ ÏÇ≠Ï†ú
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/teacherMessages`).remove();
                
                // Î©îÏãúÏßÄ Ïπ¥Ïö¥Ìä∏ Î¶¨ÏÖã
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messageCount`).set(0);
                
                // UI Ï¥àÍ∏∞Ìôî
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            üí¨ ÌÜ†Î°†ÏùÑ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                    `;
                }
                
                // Ï∞¨Î∞òÌÜ†Î°† UI Ï¥àÍ∏∞Ìôî
                const agreeList = document.getElementById('agreeList');
                const disagreeList = document.getElementById('disagreeList');
                if (agreeList) {
                    agreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ÏïÑÏßÅ Ï∞¨ÏÑ± ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                }
                if (disagreeList) {
                    disagreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ÏïÑÏßÅ Î∞òÎåÄ ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                }
                
                // Ìà¨Ìëú Í≤∞Í≥º Ï¥àÍ∏∞Ìôî
                const agreeCount = document.getElementById('agreeCount');
                const disagreeCount = document.getElementById('disagreeCount');
                const agreeBar = document.getElementById('agreeBar');
                const disagreeBar = document.getElementById('disagreeBar');
                if (agreeCount) agreeCount.textContent = '0';
                if (disagreeCount) disagreeCount.textContent = '0';
                if (agreeBar) agreeBar.style.width = '0%';
                if (disagreeBar) disagreeBar.style.width = '0%';
                
                addLog('‚úÖ Î™®Îì† Î©îÏãúÏßÄ ÏÇ≠Ï†ú ÏôÑÎ£å', 'success');
                
                // Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                console.error('Ï†ÑÏ≤¥ Î©îÏãúÏßÄ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                addLog(`‚ùå Ï†ÑÏ≤¥ Î©îÏãúÏßÄ ÏÇ≠Ï†ú Ïã§Ìå®: ${error.message}`, 'error');
                alert('Î©îÏãúÏßÄ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Ï∞∏Ïó¨Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantCount = document.getElementById('participantCount');
            
            const participantsArray = Object.values(participants);
            
            // ÏûêÏú†ÌÜ†Î°†/Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†Ïùò Í≤ΩÏö∞ Ï∞∏Ïó¨Ïûê Î™©Î°ù ÌëúÏãú
            if (participantsList && participantCount) {
                participantCount.textContent = participantsArray.length;
            
                if (participantsArray.length === 0) {
                    participantsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px;">Ï∞∏Ïó¨ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                    return;
                }
                
                let participantsHTML = '<div style="display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 6px;">';
                participantsArray.forEach((participant, index) => {
                    const isMe = participant.id === currentParticipantId;
                    const displayName = participant.name || participant.participantName || participant.participantId || `Ï∞∏Ïó¨Ïûê${index + 1}`;
                    console.log('üë§ Ï∞∏Ïó¨Ïûê Îç∞Ïù¥ÌÑ∞:', participant, 'ÌëúÏãúÎ™Ö:', displayName);
                    participantsHTML += `
                        <span style="background: ${isMe ? '#007bff' : '#e9ecef'}; color: ${isMe ? 'white' : '#495057'}; padding: 3px 8px; border-radius: 12px; font-size: 11px; white-space: nowrap; font-weight: ${isMe ? 'bold' : 'normal'};">
                            ${isMe ? 'üë§' : 'üë•'} ${displayName} ${isMe ? '(ÎÇò)' : ''}
                        </span>
                    `;
                });
                participantsHTML += '</div>';
                
                participantsList.innerHTML = participantsHTML;
                addLog(`üë• Ï∞∏Ïó¨Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏: ${participantsArray.length}Î™Ö`, 'info');
            } else if (currentTopicData && currentTopicData.type === 'debate') {
                // Ï∞¨Î∞ò ÌÜ†Î°†Ïùò Í≤ΩÏö∞ Ï∞∏Ïó¨Ïûê ÏàòÎßå Î°úÍ∑∏Ïóê Í∏∞Î°ù
                addLog(`üë• Ï∞¨Î∞òÌÜ†Î°† Ï∞∏Ïó¨Ïûê Ïàò: ${participantsArray.length}Î™Ö`, 'info');
            } else {
                // Îã§Î•∏ ÌÜ†Î°† Ïú†ÌòïÏùò Í≤ΩÏö∞ (Ìè¨Ïä§Ìä∏Ïûá Îì±)
                addLog(`üë• ÌÜ†Î°† Ï∞∏Ïó¨Ïûê Ïàò: ${participantsArray.length}Î™Ö`, 'info');
            }
        }
        
        
        // Ï∞¨Î∞ò ÌÜ†Î°† Ìà¨Ìëú Ï†úÏ∂ú
        async function submitDebateVote(position) {
            const inputId = position === 'agree' ? 'agreeInput' : 'disagreeInput';
            const inputEl = document.getElementById(inputId);
            
            if (!inputEl) {
                alert('‚ö†Ô∏è ÏûÖÎ†• ÏòÅÏó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const opinion = inputEl.value.trim();
            if (!opinion) {
                alert(`‚ö†Ô∏è ${position === 'agree' ? 'Ï∞¨ÏÑ±' : 'Î∞òÎåÄ'} ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.`);
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const voteData = {
                    id: voteId,
                    position: position,
                    opinion: opinion,
                    participantId: currentParticipantId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes/${voteId}`).set(voteData);
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                inputEl.value = '';
                
                addLog(`‚úÖ ${position === 'agree' ? 'Ï∞¨ÏÑ±' : 'Î∞òÎåÄ'} ÏùòÍ≤¨ Îì±Î°ù ÏôÑÎ£å`, 'success');
                
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå Ìà¨Ìëú Îì±Î°ù Ïã§Ìå®: ${error.message}`, 'error');
                alert(`‚ùå ÏùòÍ≤¨ Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
            }
        }
        
        // Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞Ä
        async function addPostit() {
            const postitInput = document.getElementById('postitInput');
            
            if (!postitInput) {
                alert('‚ö†Ô∏è Ìè¨Ïä§Ìä∏Ïûá ÏûÖÎ†• ÏòÅÏó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const text = postitInput.value.trim();
            if (!text) {
                alert('‚ö†Ô∏è Ìè¨Ïä§Ìä∏Ïûá ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                const postitId = `postit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const postitData = {
                    id: postitId,
                    text: text,
                    participantId: currentParticipantId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    color: getRandomPostitColor()
                };
                
                await database.ref(`discussions/${currentTopicId}/postits/${postitId}`).set(postitData);
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                postitInput.value = '';
                
                addLog('‚úÖ Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞Ä ÏôÑÎ£å', 'success');
                
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞Ä Ïã§Ìå®: ${error.message}`, 'error');
                alert(`‚ùå Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
            }
        }
        
        // ÎûúÎç§ Ìè¨Ïä§Ìä∏Ïûá ÏÉâÏÉÅ
        function getRandomPostitColor() {
            const colors = ['#ffeb3b', '#ff9800', '#4caf50', '#2196f3', '#9c27b0', '#f44336', '#00bcd4'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Ï∞¨Î∞ò ÌÜ†Î°† Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
        function updateDebateResults(votes) {
            const agreeVotesObj = {};
            const disagreeVotesObj = {};
            let agreeCount = 0;
            let disagreeCount = 0;
            
            // Í∞ùÏ≤¥Î•º Î∂ÑÎ¶¨ÌïòÎ©¥ÏÑú Ïã§Ï†ú Firebase ÌÇ§Î•º Î≥¥Ï°¥
            Object.entries(votes).forEach(([voteId, vote]) => {
                if (vote.position === 'agree') {
                    agreeVotesObj[voteId] = vote;
                    agreeCount++;
                } else if (vote.position === 'disagree') {
                    disagreeVotesObj[voteId] = vote;
                    disagreeCount++;
                }
            });
            
            const total = agreeCount + disagreeCount;
            
            // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            const agreeCountEl = document.getElementById('agreeCount');
            const disagreeCountEl = document.getElementById('disagreeCount');
            if (agreeCountEl) agreeCountEl.textContent = agreeCount;
            if (disagreeCountEl) disagreeCountEl.textContent = disagreeCount;
            
            // ÏßÑÌñâÎ∞î ÏóÖÎç∞Ïù¥Ìä∏
            const agreeBar = document.getElementById('agreeBar');
            const disagreeBar = document.getElementById('disagreeBar');
            if (agreeBar && disagreeBar && total > 0) {
                const agreePercent = (agreeCount / total) * 100;
                const disagreePercent = (disagreeCount / total) * 100;
                
                agreeBar.style.width = agreePercent + '%';
                disagreeBar.style.width = disagreePercent + '%';
            }
            
            // ÏùòÍ≤¨ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ - Ïù¥Ï†ú Ïã§Ï†ú Firebase ÌÇ§Í∞Ä Ìè¨Ìï®Îêú Í∞ùÏ≤¥Î•º Ï†ÑÎã¨
            updateDebateOpinionsList(agreeVotesObj, disagreeVotesObj);
            
            addLog(`üìä Ï∞¨Î∞òÌÜ†Î°† Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏: Ï∞¨ÏÑ± ${agreeCount}, Î∞òÎåÄ ${disagreeCount}`, 'info');
        }
        
        // Ï∞¨Î∞ò ÌÜ†Î°† ÏùòÍ≤¨ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateDebateOpinionsList(agreeVotesObj, disagreeVotesObj) {
            const agreeList = document.getElementById('agreeList');
            const disagreeList = document.getElementById('disagreeList');
            
            // Í∞ùÏ≤¥Î•º Î∞∞Ïó¥Î°ú Î≥ÄÌôòÌïòÎ©¥ÏÑú ID Ï†ïÎ≥¥ Ïú†ÏßÄ
            const agreeVotes = Object.entries(agreeVotesObj || {}).map(([id, vote]) => ({...vote, voteId: id}));
            const disagreeVotes = Object.entries(disagreeVotesObj || {}).map(([id, vote]) => ({...vote, voteId: id}));
            
            if (agreeList) {
                if (agreeVotes.length === 0) {
                    agreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ÏïÑÏßÅ Ï∞¨ÏÑ± ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                } else {
                    let agreeHTML = '';
                    agreeVotes.forEach((vote, index) => {
                        const isMe = vote.participantId === currentParticipantId;
                        const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                        const displayName = isMe ? 'ÎÇò' : (vote.participantName || vote.participantId || `Ï∞∏Ïó¨Ïûê${index + 1}`);
                        agreeHTML += `
                            <div style="background: white; border: 1px solid #c3e6cb; border-radius: 4px; padding: 8px; margin-bottom: 8px; font-size: 12px; position: relative;">
                                <button onclick="deleteDebateVote('${vote.voteId}')" data-vote-id="${vote.voteId}"
                                        style="position: absolute; top: 4px; right: 4px; background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                                        title="ÏùòÍ≤¨ ÏÇ≠Ï†ú (ID: ${vote.voteId})">üóëÔ∏è</button>
                                <div style="font-weight: bold; color: #155724; margin-bottom: 4px; padding-right: 25px;">
                                    ${displayName} - ${timestamp}
                                </div>
                                <div style="color: #495057; padding-right: 25px;">${vote.opinion}</div>
                            </div>
                        `;
                    });
                    agreeList.innerHTML = agreeHTML;
                }
            }
            
            if (disagreeList) {
                if (disagreeVotes.length === 0) {
                    disagreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ÏïÑÏßÅ Î∞òÎåÄ ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                } else {
                    let disagreeHTML = '';
                    disagreeVotes.forEach((vote, index) => {
                        const isMe = vote.participantId === currentParticipantId;
                        const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                        const displayName = isMe ? 'ÎÇò' : (vote.participantName || vote.participantId || `Ï∞∏Ïó¨Ïûê${index + 1}`);
                        disagreeHTML += `
                            <div style="background: white; border: 1px solid #f5c6cb; border-radius: 4px; padding: 8px; margin-bottom: 8px; font-size: 12px; position: relative;">
                                <button onclick="deleteDebateVote('${vote.voteId}')" data-vote-id="${vote.voteId}"
                                        style="position: absolute; top: 4px; right: 4px; background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                                        title="ÏùòÍ≤¨ ÏÇ≠Ï†ú (ID: ${vote.voteId})">üóëÔ∏è</button>
                                <div style="font-weight: bold; color: #721c24; margin-bottom: 4px; padding-right: 25px;">
                                    ${displayName} - ${timestamp}
                                </div>
                                <div style="color: #495057; padding-right: 25px;">${vote.opinion}</div>
                            </div>
                        `;
                    });
                    disagreeList.innerHTML = disagreeHTML;
                }
            }
        }
        
        // Í∞úÎ≥Ñ Ï∞¨Î∞òÌÜ†Î°† Ìà¨Ìëú ÏÇ≠Ï†ú (ÍµêÏÇ¨Ïö© Ï†ÑÏö©)
        async function deleteDebateVote(voteId) {
            console.log('üóëÔ∏è Ìà¨Ìëú ÏÇ≠Ï†ú ÏãúÎèÑ:', {
                voteId,
                currentClassId,
                currentTopicId,
                path: `classes/${currentClassId}/discussions/${currentTopicId}/votes/${voteId}`
            });
            
            // voteId Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Í∞ïÌôî
            if (!voteId || voteId === 'undefined' || voteId === 'null' || typeof voteId !== 'string') {
                console.error('‚ùå Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ìà¨Ìëú ID:', voteId, typeof voteId);
                addLog('‚ùå Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ìà¨Ìëú IDÏûÖÎãàÎã§.', 'error');
                return;
            }
            
            // ÌïÑÏàò Ï†ÑÏó≠ Î≥ÄÏàò ÌôïÏù∏
            if (!currentClassId || !currentTopicId) {
                console.error('‚ùå ÌïÑÏàò Ï†ïÎ≥¥ ÎàÑÎùΩ:', { currentClassId, currentTopicId });
                addLog('‚ùå ÌÜ†Î°† Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            if (!confirm('Ïù¥ ÏùòÍ≤¨ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                // Ï†ÑÏó≠ database Ïù∏Ïä§ÌÑ¥Ïä§ ÏÇ¨Ïö©
                const database = initGlobalDatabase();
                if (!database) {
                    console.error('‚ùå Firebase database Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§.');
                    addLog('‚ùå Firebase Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
                    return;
                }
                const deletePath = `classes/${currentClassId}/discussions/${currentTopicId}/votes/${voteId}`;
                console.log('üóëÔ∏è ÏÇ≠Ï†ú Í≤ΩÎ°ú:', deletePath);
                
                // ÏÇ≠Ï†ú Ï†ÑÏóê Îç∞Ïù¥ÌÑ∞ Ï°¥Ïû¨ ÌôïÏù∏
                const snapshot = await database.ref(deletePath).once('value');
                console.log('üîç ÏÇ≠Ï†ú Ï†Ñ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:', snapshot.exists(), snapshot.val());
                
                if (!snapshot.exists()) {
                    console.warn('‚ö†Ô∏è ÏÇ≠Ï†úÌïòÎ†§Îäî Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                    addLog('‚ö†Ô∏è Ìï¥Îãπ Ìà¨ÌëúÍ∞Ä Ïù¥ÎØ∏ ÏÇ≠Ï†úÎêòÏóàÍ±∞ÎÇò Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.', 'warning');
                    return;
                }
                
                // ÏÇ≠Ï†ú Ïã§Ìñâ
                await database.ref(deletePath).remove();
                
                // ÏÇ≠Ï†ú ÌõÑ ÌôïÏù∏
                const afterSnapshot = await database.ref(deletePath).once('value');
                console.log('‚úÖ ÏÇ≠Ï†ú ÌõÑ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:', afterSnapshot.exists());
                
                if (!afterSnapshot.exists()) {
                    console.log('üóëÔ∏è Ï∞¨Î∞òÌÜ†Î°† Ìà¨Ìëú ÏÇ≠Ï†ú ÏôÑÎ£å:', voteId);
                    addLog(`üóëÔ∏è ÏùòÍ≤¨ ÏÇ≠Ï†ú ÏôÑÎ£å`, 'success');
                    
                    // Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑàÍ∞Ä ÏûêÎèôÏúºÎ°ú UI ÏóÖÎç∞Ïù¥Ìä∏Ìï† Í≤ÉÏûÑ
                } else {
                    throw new Error('ÏÇ≠Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('Ìà¨Ìëú ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                addLog(`‚ùå ÏùòÍ≤¨ ÏÇ≠Ï†ú Ïã§Ìå®: ${error.message}`, 'error');
                alert(`ÏùòÍ≤¨ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`);
            }
        }
        
        // Ìè¨Ïä§Ìä∏Ïûá ÌëúÏãú
        function displayPostit(postit) {
            const postitBoard = document.getElementById('postitBoard');
            if (!postitBoard) return;
            
            // Ï≤´ Î≤àÏß∏ Ìè¨Ïä§Ìä∏ÏûáÏù∏ Í≤ΩÏö∞ ÏïàÎÇ¥ Î©îÏãúÏßÄ Ï†úÍ±∞
            const welcomeMsg = postitBoard.querySelector('[style*="grid-column: 1 / -1"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const postitEl = document.createElement('div');
            const isMe = postit.participantId === currentParticipantId;
            const timestamp = new Date(postit.timestamp).toLocaleTimeString();
            
            postitEl.style.cssText = `
                background: ${postit.color || '#ffeb3b'};
                border-radius: 8px;
                padding: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                font-size: 13px;
                min-height: 80px;
                transform: rotate(${Math.random() * 6 - 3}deg);
                transition: transform 0.2s;
            `;
            
            postitEl.innerHTML = `
                <div style="font-size: 10px; color: #333; margin-bottom: 5px; font-weight: bold;">
                    ${isMe ? 'ÎÇò' : (postit.participantName || postit.participantId || 'ÏùµÎ™Ö')} - ${timestamp}
                </div>
                <div style="color: #333; line-height: 1.3;">
                    ${postit.text}
                </div>
            `;
            
            // Ìò∏Î≤Ñ Ìö®Í≥º
            postitEl.addEventListener('mouseenter', () => {
                postitEl.style.transform = 'rotate(0deg) scale(1.05)';
                postitEl.style.zIndex = '10';
            });
            
            postitEl.addEventListener('mouseleave', () => {
                postitEl.style.transform = `rotate(${Math.random() * 6 - 3}deg) scale(1)`;
                postitEl.style.zIndex = '1';
            });
            
            postitBoard.appendChild(postitEl);
            
            addLog(`üìù ÏÉà Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞Ä: ${postit.text.substring(0, 20)}...`, 'info');
        }
        
        // ÌÜ†Î°† ÏãúÍ∞Ñ ÌÉÄÏù¥Î®∏ ÏãúÏûë
        let discussionTimer = null;
        
        function startDiscussionTimer() {
            if (!currentTopicData || !currentTopicData.endTime) return;
            
            // Í∏∞Ï°¥ ÌÉÄÏù¥Î®∏Í∞Ä ÏûàÏúºÎ©¥ Ï†ïÎ¶¨
            if (discussionTimer) {
                clearInterval(discussionTimer);
            }
            
            discussionTimer = setInterval(() => {
                const now = Date.now();
                const endTime = currentTopicData.endTime;
                const timeLeft = endTime - now;
                
                const timeRemainingEl = document.getElementById('timeRemaining');
                if (!timeRemainingEl) return;
                
                if (timeLeft <= 0) {
                    timeRemainingEl.textContent = '‚è∞ Ï¢ÖÎ£åÎê®';
                    timeRemainingEl.style.color = '#dc3545';
                    clearInterval(discussionTimer);
                    
                    // ÌÜ†Î°† Ï¢ÖÎ£å ÏïåÎ¶º
                    setTimeout(() => {
                        alert('‚è∞ ÌÜ†Î°† ÏãúÍ∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§!\n\nÌÜ†Î°† Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.');
                    }, 1000);
                    
                    addLog('‚è∞ ÌÜ†Î°† ÏãúÍ∞Ñ Ï¢ÖÎ£å', 'warning');
                } else {
                    const minutes = Math.floor(timeLeft / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    timeRemainingEl.textContent = `${minutes}Î∂Ñ ${seconds}Ï¥à`;
                    
                    // 1Î∂Ñ ÎÇ®ÏïòÏùÑ Îïå Í≤ΩÍ≥†ÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
                    if (timeLeft <= 60000) {
                        timeRemainingEl.style.color = '#dc3545';
                    } else if (timeLeft <= 300000) { // 5Î∂Ñ ÎÇ®Ïùå
                        timeRemainingEl.style.color = '#ffc107';
                    } else {
                        timeRemainingEl.style.color = '#28a745';
                    }
                }
            }, 1000);
            
            addLog('‚è∞ ÌÜ†Î°† ÌÉÄÏù¥Î®∏ ÏãúÏûë', 'info');
        }
        
        
        function showDatabaseRulesHelp() {
            const helpText = `üîß Firebase Realtime Database Í∑úÏπô ÏÑ§Ï†ï Î∞©Î≤ï\n\nüîç Îã®Í≥Ñ:\n1. https://console.firebase.google.com Ï†ëÏÜç\n2. ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù\n3. ÏôºÏ™Ω Î©îÎâ¥ÏóêÏÑú "Realtime Database" ÌÅ¥Î¶≠\n4. "Í∑úÏπô" ÌÉ≠ ÌÅ¥Î¶≠\n5. Í∏∞Î≥∏ Í∑úÏπôÏùÑ Îã§ÏùåÏúºÎ°ú Î≥ÄÍ≤Ω:\n\n{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}\n\n6. "Í≤åÏãú" Î≤ÑÌäº ÌÅ¥Î¶≠\n\n‚ö†Ô∏è Ï£ºÏùò: Ïù¥ ÏÑ§Ï†ïÏùÄ Î™®Îì† ÏÇ¨Ïö©ÏûêÍ∞Ä Îç∞Ïù¥ÌÑ∞Î•º ÏùΩÍ≥† Ïì∏ Ïàò ÏûàÍ≤å ÌïòÎØÄÎ°ú Í∞úÎ∞ú/ÌÖåÏä§Ìä∏ Ïö©ÎèÑÎ°úÎßå ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.`;
            
            if (confirm(helpText + '\n\nüîó Firebase ConsoleÏùÑ Ïó¥ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.open('https://console.firebase.google.com', '_blank');
            }
        }

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // ÌÜ†Î°† Ï£ºÏ†ú ÏÇ≠Ï†ú
        async function deleteTopic(topicId, topicTitle) {
            if (!confirm(`Ï†ïÎßêÎ°ú ÌÜ†Î°† Ï£ºÏ†ú "${topicTitle}"Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏúºÎ©∞, Î™®Îì† ÌÜ†Î°† ÎÇ¥Ïö©Í≥º Ï∞∏Ïó¨Ïûê Îç∞Ïù¥ÌÑ∞Í∞Ä Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.`)) {
                return;
            }
            
            try {
                addLog(`üóëÔ∏è ÌÜ†Î°† Ï£ºÏ†ú ÏÇ≠Ï†ú Ï§ë: ${topicTitle}`, 'warning');
                
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                // ÌÅ¥ÎûòÏä§ ÎÇ¥ ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                await database.ref(`classes/${currentClassId}/discussions/${topicId}`).remove();
                
                // Ï†ÑÏ≤¥ ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                await database.ref(`discussions/${topicId}`).remove();
                
                addLog(`‚úÖ ÌÜ†Î°† Ï£ºÏ†ú ÏÇ≠Ï†ú ÏôÑÎ£å: ${topicTitle}`, 'success');
                alert(`üóëÔ∏è ÌÜ†Î°† Ï£ºÏ†ú "${topicTitle}"Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                
                // ÌÜ†Î°† Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                loadTopicsFromFirebase();
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå ÌÜ†Î°† Ï£ºÏ†ú ÏÇ≠Ï†ú Ïã§Ìå®: ${error.message}`, 'error');
                alert(`‚ùå ÌÜ†Î°† Ï£ºÏ†ú ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
            }
        }
        
        // ÌÜ†Î°† ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÑ CSVÎ°ú Îã§Ïö¥Î°úÎìú
        async function downloadTopicCSV(topicId) {
            try {
                addLog(`üì• CSV Îã§Ïö¥Î°úÎìú Ï§ë: ${topicId}`, 'info');
                
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
                // ÌÜ†Î°† Í∏∞Î≥∏ Ï†ïÎ≥¥
                const topicSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}`).once('value');
                const topicData = topicSnapshot.val();
                
                if (!topicData) {
                    alert('ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const messagesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/messages`).once('value');
                const messages = messagesSnapshot.val() || {};
                
                const votesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/votes`).once('value');
                const votes = votesSnapshot.val() || {};
                
                const participantsSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                // CSV Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                let csvContent = '';
                
                // Ìó§Îçî Ï†ïÎ≥¥
                csvContent += `ÌÜ†Î°† Ï£ºÏ†ú,${topicData.title}\n`;
                csvContent += `ÌÜ†Î°† Ïú†Ìòï,${getTypeName(topicData.type)}\n`;
                csvContent += `ÏÉùÏÑ± ÏùºÏãú,${new Date(topicData.createdAt).toLocaleString()}\n`;
                csvContent += `Ï¢ÖÎ£å ÏùºÏãú,${new Date(topicData.endTime).toLocaleString()}\n`;
                csvContent += `Ï∞∏Ïó¨Ïûê Ïàò,${Object.keys(participants).length}Î™Ö\n`;
                csvContent += `ÏÑ§Î™Ö,${topicData.description || 'ÏóÜÏùå'}\n`;
                csvContent += `\n`;
                
                // Ï∞∏Ïó¨Ïûê Î™©Î°ù
                csvContent += `=== Ï∞∏Ïó¨Ïûê Î™©Î°ù ===\n`;
                csvContent += `Î≤àÌò∏,Ïù¥Î¶Ñ,Ï∞∏Ïó¨ ÏãúÍ∞Ñ\n`;
                let participantIndex = 1;
                Object.entries(participants).forEach(([id, participant]) => {
                    csvContent += `${participantIndex},${participant.name},${new Date(participant.joinedAt).toLocaleString()}\n`;
                    participantIndex++;
                });
                csvContent += `\n`;
                
                // Î©îÏãúÏßÄ/Ï±ÑÌåÖ ÎÇ¥Ïö©
                if (Object.keys(messages).length > 0) {
                    csvContent += `=== Î©îÏãúÏßÄ/Ï±ÑÌåÖ ÎÇ¥Ïö© ===\n`;
                    csvContent += `Î≤àÌò∏,ÏûëÏÑ±Ïûê,ÎÇ¥Ïö©,Ïú†Ìòï,ÏÉâÏÉÅ,ÏûëÏÑ±ÏãúÍ∞Ñ\n`;
                    let messageIndex = 1;
                    Object.entries(messages).forEach(([msgId, message]) => {
                        const content = (message.content || message.text || '').replace(/"/g, '""').replace(/\n/g, ' ');
                        const type = message.type === 'postit' ? 'Ìè¨Ïä§Ìä∏Ïûá' : 'Î©îÏãúÏßÄ';
                        const color = message.color || '';
                        csvContent += `${messageIndex},"${message.participantName || message.participantId}","${content}",${type},${color},${new Date(message.timestamp).toLocaleString()}\n`;
                        messageIndex++;
                    });
                    csvContent += `\n`;
                }
                
                // Ìà¨Ìëú Í≤∞Í≥º (Ï∞¨Î∞ò ÌÜ†Î°†Ïùò Í≤ΩÏö∞)
                if (topicData.type === 'debate' && Object.keys(votes).length > 0) {
                    csvContent += `=== Ï∞¨Î∞ò Ìà¨Ìëú Í≤∞Í≥º ===\n`;
                    csvContent += `Î≤àÌò∏,Ìà¨ÌëúÏûê,ÏûÖÏû•,ÏùòÍ≤¨,Ìà¨ÌëúÏãúÍ∞Ñ\n`;
                    let voteIndex = 1;
                    Object.entries(votes).forEach(([voteId, vote]) => {
                        const opinion = (vote.opinion || '').replace(/"/g, '""').replace(/\n/g, ' ');
                        const position = vote.position === 'agree' ? 'Ï∞¨ÏÑ±' : 'Î∞òÎåÄ';
                        csvContent += `${voteIndex},"${vote.participantName || vote.participantId}",${position},"${opinion}",${new Date(vote.timestamp).toLocaleString()}\n`;
                        voteIndex++;
                    });
                }
                
                // CSV ÌååÏùº Îã§Ïö¥Î°úÎìú
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                const fileName = `ÌÜ†Î°†_${topicData.title}_${new Date().toISOString().slice(0, 10)}.csv`;
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog(`‚úÖ CSV Îã§Ïö¥Î°úÎìú ÏôÑÎ£å: ${fileName}`, 'success');
                
                // Firebase Ïï± Ï†ïÎ¶¨
                // Firebase Ïï± Ï†ïÎ¶¨ Î∂àÌïÑÏöî (Ï†ÑÏó≠ ÏÇ¨Ïö©)
                
            } catch (error) {
                addLog(`‚ùå CSV Îã§Ïö¥Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
                alert(`‚ùå CSV Îã§Ïö¥Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
            }
        }
        
        // ÌÜ†Î°† Ïú†Ìòï Ïù¥Î¶Ñ Î∞òÌôò
        function getTypeName(type) {
            const typeNames = {
                'debate': 'Ï∞¨Î∞ò ÌÜ†Î°†',
                'discussion': 'ÏûêÏú† ÌÜ†Î°†', 
                'postit': 'Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†',
                'survey': 'ÏÑ§Î¨∏ Ï°∞ÏÇ¨'
            };
            return typeNames[type] || type;
        }

    </script>
</body>
</html>
