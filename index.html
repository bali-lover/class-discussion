<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP removed for GitHub Pages compatibility -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: https://api.qrserver.com; connect-src 'self' https: wss: https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com; frame-src 'self' https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com; child-src 'self' https://*.firebasedatabase.app https://*.firebaseapp.com;"> -->
    <title>í•™ê¸‰ í† ë¡  ê²Œì‹œíŒ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            zoom: 0.8;
            margin: 5px;
            padding: 0;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background-color: white;
            color: #333;
            padding: 6px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .header h1::before {
            content: "ğŸ’¬";
            margin-right: 10px;
            font-size: 24px;
        }

        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* ì™¼ìª½ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            width: 280px;
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .content-area {
            flex: 1;
            background-color: white;
            border-radius: 6px;
            padding: 3px 15px 8px 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .welcome-section {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }

        .welcome-section h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #343a40;
        }

        .welcome-section p {
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* ìƒíƒœ í‘œì‹œ */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        /* ë¡œê·¸ ì˜ì—­ */
        .log-container {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #007bff;
        }

        .log-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }

        .log-content {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-warning {
            color: #ffc107;
        }

        .log-info {
            color: #17a2b8;
        }

        /* ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .grid-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.2s;
        }

        .grid-item:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 480px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-step {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .auto-url-display {
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 13px;
            color: #495057;
            font-family: 'Courier New', monospace;
        }

        .test-result {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-weight: bold;
            display: none;
        }

        .test-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            body {
                zoom: 0.9;
            }
            
            .main-container {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                order: 2;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>í•™ê¸‰ í† ë¡  ê²Œì‹œíŒ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        <div class="header-buttons">
            <div id="connectionStatus" class="status-indicator status-connecting">
                ğŸ”„ ì—°ê²° ì¤‘...
            </div>
            <button class="btn btn-success" onclick="showCreateClassForm()" id="createClassBtn">
                â• ìƒˆ ë°˜ ë§Œë“¤ê¸°
            </button>
            <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                âš™ï¸ Firebase ì„¤ì •
            </button>
        </div>
    </div>

    <div class="main-container">

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div class="content-area">
            <div class="welcome-section" id="welcomeMessage">
                <h2>ğŸ“š í•™ê¸‰ í† ë¡  ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
                <p>í•™ê¸‰ í† ë¡ ì„ íš¨ê³¼ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ì†Œí†µí•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</p>
                
                <div style="margin-top: 10px; padding: 20px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">âš™ï¸ ì‹œì‘í•˜ê¸°</h4>
                    <p style="color: #856404; margin: 0; font-size: 14px;">
                        <strong>Firebase ì„¤ì • í›„ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”!</strong><br><br>
                        1ï¸âƒ£ í—¤ë”ì˜ "âš™ï¸ Firebase ì„¤ì •" ë²„íŠ¼ í´ë¦­<br>
                        2ï¸âƒ£ Firebase í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥<br>
                        3ï¸âƒ£ ë°˜ ìƒì„± ë˜ëŠ” ê¸°ì¡´ ë°˜ ê´€ë¦¬ ì‹œì‘!
                    </p>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">ğŸ¯ ì™„ì„±ëœ ê¸°ëŠ¥ë“¤</h4>
                    <ul style="text-align: left; list-style: none; padding: 0;">
                        <li style="margin: 8px 0; color: #155724;">âœ… 1ë‹¨ê³„: HTML êµ¬ì¡° ë° ìŠ¤íƒ€ì¼ë§</li>
                        <li style="margin: 8px 0; color: #155724;">âœ… 2ë‹¨ê³„: Firebase SDK ì—°ê²°</li>
                        <li style="margin: 8px 0; color: #155724;">âœ… 3ë‹¨ê³„: ë°˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</li>
                        <li style="margin: 8px 0; color: #155724;">âœ… 4ë‹¨ê³„: ì‹¤ì‹œê°„ í† ë¡  ê´€ë¦¬</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="firebaseSettingsModal" style="display: none;">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">âš™ï¸ Firebase í”„ë¡œì íŠ¸ ì„¤ì •</h3>
                <button class="close-btn" onclick="closeFirebaseModal()">&times;</button>
            </div>

            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label">ğŸ“– ì„¤ì • ë°©ë²•</label>
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; line-height: 1.6;">
                        <p><strong>1.</strong> <a href="https://console.firebase.google.com/" target="_blank" style="color: #3b82f6;">Firebase Console</a>ì—ì„œ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</p>
                        <p><strong>2.</strong> Realtime Database í™œì„±í™” (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)</p>
                        <p><strong>3.</strong> í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì›¹ ì•± ì¶”ê°€ â†’ êµ¬ì„± ì •ë³´ ë³µì‚¬</p>
                        <p><strong>4.</strong> ì•„ë˜ ì…ë ¥ë€ì— ì •ë³´ ì…ë ¥ í›„ ì €ì¥</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="text" class="form-input" id="userApiKey" placeholder="AIzaSyB...">
                </div>

                <div class="form-group">
                    <label class="form-label">Project ID</label>
                    <input type="text" class="form-input" id="userProjectId" placeholder="your-project-id" oninput="updateAutoUrl()">
                </div>

                <div class="form-group">
                    <p style="font-size: 14px; color: #6b7280; background: #f0fdf4; padding: 10px; border-radius: 6px; border-left: 4px solid #22c55e;">
                        âœ… <strong>ìë™ ì„¤ì • í•­ëª©:</strong><br>
                        â€¢ Database URL: Project IDë¡œ ìë™ ìƒì„±<br>
                        â€¢ Auth Domain: Project IDë¡œ ìë™ ìƒì„±<br>
                        â€¢ Storage Bucket: Project IDë¡œ ìë™ ìƒì„±
                    </p>
                </div>

                <div class="form-group">
                    <p style="font-size: 14px; color: #dc2626; background: #fef2f2; padding: 10px; border-radius: 6px; border-left: 4px solid #dc2626;">
                        âš ï¸ <strong>Firebase í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ì¤‘ìš”:</strong><br>
                        <strong>Realtime Database ì§€ì—­ì„ ë°˜ë“œì‹œ "ì•„ì‹œì•„ ë‚¨ë™ë¶€(asia-southeast1)"ë¡œ ì„ íƒí•˜ì„¸ìš”!</strong><br>
                        ë‹¤ë¥¸ ì§€ì—­ ì„ íƒ ì‹œ ìë™ ìƒì„±ëœ URLì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>

                <div id="testResult" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeFirebaseModal()">ì·¨ì†Œ</button>
                <button class="btn btn-info" onclick="resetTeacherName()" style="margin-right: 10px;">ğŸ‘¤ êµì‚¬ ì´ë¦„ ì¬ì„¤ì •</button>
                <button class="btn btn-primary" onclick="saveUserFirebaseConfig()">ğŸ”— ì—°ê²° ë° ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ë°˜ ë§Œë“¤ê¸° ëª¨ë‹¬ -->
    <div class="modal-overlay" id="createClassModal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">â• ìƒˆ ë°˜ ë§Œë“¤ê¸°</h3>
                <button class="close-btn" onclick="closeCreateClassModal()">&times;</button>
            </div>

            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label">ë°˜ ì´ë¦„</label>
                    <input type="text" class="form-input" id="newClassName" placeholder="ì˜ˆ: 3í•™ë…„ 1ë°˜, ìˆ˜í•™ ì‹¬í™”ë°˜">
                </div>

                <div class="form-group">
                    <label class="form-label">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                    <textarea class="form-input" id="newClassDescription" placeholder="ë°˜ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." style="min-height: 80px; resize: vertical;"></textarea>
                </div>

                <div id="createClassResult" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeCreateClassModal()">ì·¨ì†Œ</button>
                <button class="btn btn-success" onclick="createNewClass()">âœ… ë°˜ ìƒì„±</button>
            </div>
        </div>
    </div>

    <!-- í† ë¡  ì£¼ì œ ìƒì„± ëª¨ë‹¬ -->
    <div class="modal-overlay" id="createTopicModal" style="display: none;">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“ ìƒˆ í† ë¡  ì£¼ì œ ë§Œë“¤ê¸°</h3>
                <button class="close-btn" onclick="closeCreateTopicModal()">&times;</button>
            </div>

            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label">í† ë¡  ì œëª©</label>
                    <input type="text" id="topicTitle" class="form-input" placeholder="ì˜ˆ: í™˜ê²½ ë³´í˜¸ì˜ ì¤‘ìš”ì„±" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">í† ë¡  ì„¤ëª…</label>
                    <textarea id="topicDescription" class="form-input" placeholder="í† ë¡  ì£¼ì œì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" rows="3" maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">í† ë¡  ìœ í˜•</label>
                    <select id="topicType" class="form-input">
                        <option value="chat">ğŸ’¬ ì±„íŒ…í˜• í† ë¡  (ì‹¤ì‹œê°„ ëŒ€í™”)</option>
                        <option value="postit">ğŸ“ í¬ìŠ¤íŠ¸ì‡ í† ë¡  (ì˜ê²¬ ê²Œì‹œ)</option>
                        <option value="debate">âš–ï¸ ì°¬ë°˜í† ë¡  (ì°¬ì„±/ë°˜ëŒ€ íˆ¬í‘œ)</option>
                        <option value="general">ğŸ—£ï¸ ì¼ë°˜ í† ë¡ </option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ì œí•œ ì‹œê°„ (ë¶„)</label>
                    <select id="topicTimeLimit" class="form-input">
                        <option value="0">ì œí•œ ì—†ìŒ</option>
                        <option value="5">5ë¶„</option>
                        <option value="10">10ë¶„</option>
                        <option value="15">15ë¶„</option>
                        <option value="30">30ë¶„</option>
                        <option value="60">1ì‹œê°„</option>
                    </select>
                </div>
                
                <div id="createTopicResult" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateTopicModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="createNewTopic()">ğŸš€ í† ë¡  ìƒì„±</button>
            </div>
        </div>
    </div>

    <script>
        // ê¸€ë¡œë²Œ ë³€ìˆ˜
        let currentStep = 1;
        let userFirebaseConfig = null;
        
        // ë¡œê·¸ í•¨ìˆ˜ - ì½˜ì†”ë§Œ ì¶œë ¥ (UI ë¡œê·¸ ì œê±°ë¨)
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.className = `status-indicator status-${status}`;
                statusEl.textContent = message;
            }
            // connectionStatus ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ
        }

        // í˜„ì¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸ (UI íŒ¨ë„ ì œê±°ë¡œ ë¹ˆ í•¨ìˆ˜)
        function updateCurrentStep(step, description) {
            currentStep = step;
            addLog(`ë‹¨ê³„ ì—…ë°ì´íŠ¸: ${step}ë‹¨ê³„ - ${description}`, 'info');
        }

        // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (UI íŒ¨ë„ ì œê±°ë¡œ ë¹ˆ í•¨ìˆ˜)
        function updateProgress(stepIndex, status, message) {
            addLog(`ì§„í–‰ ìƒí™©: ${message}`, status);
        }

        // Firebase ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
        function startConnectionMonitoring() {
            // Firebaseê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
            if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                console.log('ğŸ”„ Firebaseê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ - ëª¨ë‹ˆí„°ë§ ê±´ë„ˆëœ€');
                return;
            }
            
            try {
                const database = firebase.app().database();
                const connectedRef = database.ref('.info/connected');
                
                connectedRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        updateConnectionStatus('connected', 'ğŸŸ¢ Firebase ì—°ê²°ë¨');
                        addLog('ğŸŸ¢ Firebase ì‹¤ì‹œê°„ ì—°ê²° í™•ì¸ë¨', 'success');
                    } else {
                        updateConnectionStatus('connecting', 'ğŸ”„ ì—°ê²° ì¤‘...');
                        addLog('ğŸ”„ Firebase ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
                    }
                });
            } catch (error) {
                console.log('ğŸš¨ Firebase ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜:', error);
                updateConnectionStatus('disconnected', 'âŒ ì—°ê²° ì˜¤ë¥˜');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ í† ë¡  ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ
        document.addEventListener('DOMContentLoaded', function() {
            // ë°”ë¡œ í† ë¡  ê´€ë¦¬ ì‹œìŠ¤í…œ ì‹œì‘
            initMainInterface();
        });
        
        // ë©”ì¸ ì¸í„°í˜ì´ìŠ¤ ì´ˆê¸°í™”
        async function initMainInterface() {
            // Firebase ì„¤ì •ì´ ìˆìœ¼ë©´ ìë™ ì—°ê²°
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                if (typeof firebase !== 'undefined') {
                    // Firebase SDKê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ë°”ë¡œ ì—°ê²°
                    const database = initGlobalDatabase();
                    if (database) {
                        console.log('ğŸš€ Firebase ìë™ ì—°ê²° ì„±ê³µ');
                    }
                } else {
                    // Firebase SDK ìë™ ë¡œë“œ í›„ ì—°ê²°
                    console.log('ğŸ“¦ Firebase SDK ìë™ ë¡œë“œ ì¤‘...');
                    updateConnectionStatus('connecting', 'ğŸ“¦ SDK ë¡œë“œ ì¤‘...');
                    try {
                        await loadFirebaseSDKAuto();
                        const database = initGlobalDatabase();
                        if (database) {
                            console.log('ğŸš€ Firebase SDK ë¡œë“œ ë° ìë™ ì—°ê²° ì„±ê³µ');
                        }
                    } catch (error) {
                        console.log('âŒ Firebase SDK ìë™ ë¡œë“œ ì‹¤íŒ¨:', error);
                        updateConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                    }
                }
            } else {
                console.log('âš™ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. í—¤ë”ì˜ Firebase ì„¤ì • ë²„íŠ¼ì„ ì´ìš©í•˜ì„¸ìš”.');
            }
            
            // ë°”ë¡œ í† ë¡  ê´€ë¦¬ í™”ë©´ í‘œì‹œ
            showMainInterface();
        }
        
        // ë©”ì¸ í† ë¡  ê´€ë¦¬ í™”ë©´ í‘œì‹œ
        function showMainInterface() {
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>ğŸ“š ë°˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
                <p>ìƒì„±í•œ ë°˜ ëª©ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒˆ ë°˜ì„ ë§Œë“¤ë ¤ë©´ í—¤ë”ì˜ "â• ìƒˆ ë°˜ ë§Œë“¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                
                <div class="class-list-container" style="margin-top: 10px;">
                    <div id="myClassesList" style="min-height: 100px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            ğŸ“‚ ì•„ì§ ì°¸ê°€í•œ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤<br><br>
                            ìœ„ ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ë°˜ì„ ë§Œë“¤ê±°ë‚˜ ê¸°ì¡´ ë°˜ì— ì°¸ê°€í•´ë³´ì„¸ìš”!
                        </div>
                    </div>
                </div>
                
                <div id="classFormContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #007bff; border-radius: 8px; padding: 20px;">
                    <!-- ë™ì ìœ¼ë¡œ í¼ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            `;
            
            // ë°˜ ëª©ë¡ ë¡œë“œ
            loadMyClasses();
        }

        // 1ë‹¨ê³„ í‘œì‹œ
        // showStep1 í•¨ìˆ˜ ì œê±°ë¨ (ë¯¸ì‚¬ìš©)

        // 2ë‹¨ê³„ë¡œ ì§„í–‰
        function startStep2() {
            addLog('ğŸ”¥ 2ë‹¨ê³„ ì§„í–‰: Firebase SDK ì—°ê²° í…ŒìŠ¤íŠ¸', 'warning');
            updateCurrentStep(2, 'Firebase ì—°ê²°');
            updateProgress(1, 'warning', 'Firebase SDK ë¡œë“œ ì¤‘...');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>ğŸ”¥ 2ë‹¨ê³„: Firebase SDK ì—°ê²°</h2>
                <p>Firebase ì‹¤ì‹œê°„ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°í•˜ì—¬ í† ë¡  ë°ì´í„°ë¥¼ ì €ì¥/ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                
                <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 8px;">âš™ï¸ Firebase ì„¤ì •</h4>
                    <p style="font-size: 14px; color: #856404; margin: 0;">í”„ë¡œì íŠ¸: class-discussion-ac0f6<br>
                    ì§€ì—­: ì•„ì‹œì•„ ë‚¨ë™ë¶€ (singapore)</p>
                </div>
                
                <button class="btn btn-primary" onclick="loadFirebaseSDK()" id="loadFirebaseBtn">
                    ğŸ”¥ Firebase SDK ë¡œë“œ ì‹œì‘
                </button>
            `;
        }

        // Firebase SDK ë¡œë“œ
        function loadFirebaseSDK() {
            try {
                addLog('ğŸ“¦ Firebase SDK ë™ì  ë¡œë“œ ì‹œì‘...', 'info');
                
                // Firebase ì„¤ì • ë¯¸ë¦¬ í™•ì¸
                const firebaseConfig = getFirebaseConfig();
                addLog(`ğŸ” Firebase ì„¤ì • í™•ì¸: ${firebaseConfig.projectId}`, 'info');
                addLog(`ğŸ”— Database URL: ${firebaseConfig.databaseURL}`, 'info');
                
                updateConnectionStatus('connecting', 'ğŸ“¦ SDK ë¡œë“œ ì¤‘...');
                
                document.getElementById('loadFirebaseBtn').disabled = true;
                document.getElementById('loadFirebaseBtn').textContent = 'â³ ë¡œë“œ ì¤‘...';
                
                // Firebase App SDK ë¡œë“œ
                const script1 = document.createElement('script');
            script1.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
            script1.onload = () => {
                addLog('âœ… Firebase App SDK (v10.13.0) ë¡œë“œ ì™„ë£Œ', 'success');
                
                // Firebase Database SDK ë¡œë“œ
                const script2 = document.createElement('script');
                script2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
                script2.onload = () => {
                    addLog('âœ… Firebase Database SDK ë¡œë“œ ì™„ë£Œ', 'success');
                    updateProgress(1, 'warning', 'Firebase SDK ë¡œë“œë¨ - ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘');
                    setTimeout(() => testFirebaseConnection(), 1000);
                };
                script2.onerror = (event) => {
                    addLog('âŒ Firebase Database SDK ë¡œë“œ ì‹¤íŒ¨', 'error');
                    console.error('Database SDK ë¡œë“œ ì˜¤ë¥˜:', event);
                    updateConnectionStatus('disconnected', 'âŒ Database SDK ì‹¤íŒ¨');
                    updateProgress(1, 'error', 'Firebase Database SDK ë¡œë“œ ì‹¤íŒ¨');
                    
                    // ë‹¤ì‹œ í™œì„±í™”
                    document.getElementById('loadFirebaseBtn').disabled = false;
                    document.getElementById('loadFirebaseBtn').textContent = 'ğŸ”¥ Firebase SDK ë¡œë“œ ì‹œì‘';
                };
                document.head.appendChild(script2);
            };
            script1.onerror = (event) => {
                addLog('âŒ Firebase App SDK ë¡œë“œ ì‹¤íŒ¨', 'error');
                console.error('App SDK ë¡œë“œ ì˜¤ë¥˜:', event);
                updateConnectionStatus('disconnected', 'âŒ App SDK ì‹¤íŒ¨');
                updateProgress(1, 'error', 'Firebase App SDK ë¡œë“œ ì‹¤íŒ¨');
                
                // ë‹¤ì‹œ í™œì„±í™”
                document.getElementById('loadFirebaseBtn').disabled = false;
                document.getElementById('loadFirebaseBtn').textContent = 'ğŸ”¥ Firebase SDK ë¡œë“œ ì‹œì‘';
            };
            document.head.appendChild(script1);
            
            } catch (error) {
                addLog('âŒ Firebase SDK ë¡œë“œ ì¤€ë¹„ ì‹¤íŒ¨: ' + error.message, 'error');
                console.error('SDK ë¡œë“œ ì¤€ë¹„ ì˜¤ë¥˜:', error);
                updateConnectionStatus('disconnected', 'âŒ ë¡œë“œ ì¤€ë¹„ ì‹¤íŒ¨');
                
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                document.getElementById('loadFirebaseBtn').disabled = false;
                document.getElementById('loadFirebaseBtn').textContent = 'ğŸ”¥ Firebase SDK ë¡œë“œ ì‹œì‘';
            }
        }

        // Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
        function testFirebaseConnection() {
            addLog('ğŸ”— Firebase ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
            
            try {
                // Firebase ì„¤ì • - ì‚¬ìš©ì ì„¤ì • ìš°ì„  ì‚¬ìš©
                const firebaseConfig = getFirebaseConfig();
                
                addLog(`ğŸ“‹ í”„ë¡œì íŠ¸ ID: ${firebaseConfig.projectId}`, 'info');
                addLog('ğŸŒ ë°ì´í„°ë² ì´ìŠ¤ ì§€ì—­: ì•„ì‹œì•„ ë‚¨ë™ë¶€', 'info');
                
                // Firebase ì•± ì´ˆê¸°í™”
                const app = firebase.initializeApp(firebaseConfig, 'testApp-' + Date.now());
                const database = app.database();
                addLog('ğŸš€ Firebase ì•± ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                
                // ì—°ê²° ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        addLog('ğŸŸ¢ Firebase Realtime Database ì—°ê²° ì„±ê³µ!', 'success');
                        updateConnectionStatus('connected', 'ğŸŸ¢ Firebase ì—°ê²°ë¨');
                        updateProgress(1, 'success', 'Firebase ì—°ê²° ì™„ë£Œ');
                        showStep3Options();
                    } else {
                        addLog('ğŸŸ¡ Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...', 'warning');
                        updateConnectionStatus('connecting', 'ğŸŸ¡ ì—°ê²° ëŒ€ê¸° ì¤‘...');
                    }
                });
                
                // 5ì´ˆ í›„ì—ë„ ì—°ê²°ì´ ì•ˆë˜ë©´ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬
                setTimeout(() => {
                    const status = document.getElementById('connectionStatus');
                    if (status.textContent.includes('ëŒ€ê¸° ì¤‘')) {
                        addLog('âš ï¸ Firebase ì—°ê²° ì‹œê°„ ì´ˆê³¼ - ë„¤íŠ¸ì›Œí¬ í™•ì¸ í•„ìš”', 'warning');
                        updateConnectionStatus('disconnected', 'âš ï¸ ì—°ê²° ì‹œê°„ ì´ˆê³¼');
                        updateProgress(1, 'error', 'Firebase ì—°ê²° ì‹œê°„ ì´ˆê³¼');
                    }
                }, 5000);
                
            } catch (error) {
                addLog('âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message, 'error');
                console.error('Firebase ìƒì„¸ ì˜¤ë¥˜:', error);
                
                // ë” êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€
                let errorDetail = '';
                if (error.message.includes('Permission denied')) {
                    errorDetail = 'ë°ì´í„°ë² ì´ìŠ¤ ê·œì¹™ í™•ì¸ í•„ìš”';
                } else if (error.message.includes('Network')) {
                    errorDetail = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸ í•„ìš”';
                } else if (error.message.includes('Project')) {
                    errorDetail = 'Firebase í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸ í•„ìš”';
                } else {
                    errorDetail = error.message;
                }
                
                updateConnectionStatus('disconnected', `âŒ ${errorDetail}`);
                updateProgress(1, 'error', `Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${errorDetail}`);
                
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                document.getElementById('loadFirebaseBtn').disabled = false;
                document.getElementById('loadFirebaseBtn').textContent = 'ğŸ”¥ Firebase SDK ë¡œë“œ ì‹œì‘';
            }
        }

        // 3ë‹¨ê³„ ì˜µì…˜ í‘œì‹œ
        function showStep3Options() {
            updateProgress(2, 'warning', 'ë°˜ ê´€ë¦¬ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>ğŸ‰ Firebase ì—°ê²° ì„±ê³µ!</h2>
                <p>ì‹¤ì‹œê°„ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ í•™ê¸‰ ê´€ë¦¬ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                
                <div class="grid-container" style="margin-top: 25px;">
                    <div class="grid-item" onclick="startStep3()">
                        <h4 style="color: #155724; margin-bottom: 8px;">ğŸ“š 3ë‹¨ê³„: ë°˜ ê´€ë¦¬</h4>
                        <p style="font-size: 13px; color: #6c757d;">ë°˜ ìƒì„±, ì„ íƒ, ê´€ë¦¬ ê¸°ëŠ¥</p>
                    </div>
                    <div class="grid-item" onclick="alert('4ë‹¨ê³„ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤!')">
                        <h4 style="color: #856404; margin-bottom: 8px;">ğŸ’¬ 4ë‹¨ê³„: í† ë¡  ì£¼ì œ</h4>
                        <p style="font-size: 13px; color: #6c757d;">í† ë¡  ì£¼ì œ ìƒì„± ë° ê´€ë¦¬</p>
                    </div>
                    <div class="grid-item" onclick="alert('5ë‹¨ê³„ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤!')">
                        <h4 style="color: #721c24; margin-bottom: 8px;">ğŸ—¨ï¸ 5ë‹¨ê³„: ì‹¤ì‹œê°„ í† ë¡ </h4>
                        <p style="font-size: 13px; color: #6c757d;">ë©”ì‹ ì €/í¬ìŠ¤íŠ¸ì‡ í† ë¡ </p>
                    </div>
                </div>
            `;
        }

        // 3ë‹¨ê³„ ì‹œì‘
        function startStep3() {
            addLog('ğŸ“š 3ë‹¨ê³„ ì‹œì‘: ë°˜ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„', 'success');
            updateCurrentStep(3, 'ë°˜ ê´€ë¦¬ ì‹œìŠ¤í…œ');
            updateProgress(2, 'success', 'ë°˜ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„ ì¤‘');
            
            // 3ë‹¨ê³„ í—¤ë”ë¡œ ë³€ê²½
            updateHeaderForStep3();
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <h2>ğŸ“š ë°˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
                <p>ìƒì„±í•œ ë°˜ ëª©ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒˆ ë°˜ì„ ë§Œë“¤ë ¤ë©´ í—¤ë”ì˜ "â• ìƒˆ ë°˜ ë§Œë“¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                
                
                <div class="class-list-container" style="margin-top: 10px;">
                    <div id="myClassesList" style="min-height: 100px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            ğŸ“‚ ì•„ì§ ì°¸ê°€í•œ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤<br><br>
                            ìœ„ ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ë°˜ì„ ë§Œë“¤ê±°ë‚˜ ê¸°ì¡´ ë°˜ì— ì°¸ê°€í•´ë³´ì„¸ìš”!
                        </div>
                    </div>
                </div>
                
                <div id="classFormContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #007bff; border-radius: 8px; padding: 20px;">
                    <!-- ë™ì ìœ¼ë¡œ í¼ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            `;
            
            // ê¸°ì¡´ ë°˜ ëª©ë¡ ë¡œë“œ
            loadMyClasses();
        }

        // 3ë‹¨ê³„ í—¤ë” ì—…ë°ì´íŠ¸
        function updateHeaderForStep3() {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <div id="connectionStatus" class="status-indicator status-connecting">
                    ğŸ”„ ì—°ê²° ì¤‘...
                </div>
                <button class="btn btn-success" onclick="showCreateClassForm()" id="createClassBtn">
                    â• ìƒˆ ë°˜ ë§Œë“¤ê¸°
                </button>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    âš™ï¸ Firebase ì„¤ì •
                </button>
            `;
            
            // í—¤ë” ì—…ë°ì´íŠ¸ í›„ ì—°ê²° ìƒíƒœ ë‹¤ì‹œ ëª¨ë‹ˆí„°ë§
            setTimeout(() => {
                startConnectionMonitoring();
            }, 100);
        }
        
        // 2ë‹¨ê³„(í† ë¡ ë°© ê´€ë¦¬) í—¤ë” ì—…ë°ì´íŠ¸
        function updateHeaderForTopicsManagement() {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <div id="connectionStatus" class="status-indicator status-connecting">
                    ğŸ”„ ì—°ê²° ì¤‘...
                </div>
                <button class="btn btn-primary" onclick="goBackToClassList()" id="backToClassBtn">
                    â† ë°˜ ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    âš™ï¸ Firebase ì„¤ì •
                </button>
            `;
            
            // í—¤ë” ì—…ë°ì´íŠ¸ í›„ ì—°ê²° ìƒíƒœ ë‹¤ì‹œ ëª¨ë‹ˆí„°ë§
            setTimeout(() => {
                startConnectionMonitoring();
            }, 100);
        }

        // 3ë‹¨ê³„(ì‹¤ì‹œê°„ í† ë¡ ê´€ë¦¬) í—¤ë” ì—…ë°ì´íŠ¸
        function updateHeaderForDiscussion() {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <div id="connectionStatus" class="status-indicator status-connecting">
                    ğŸ”„ ì—°ê²° ì¤‘...
                </div>
                <button class="btn btn-primary" onclick="goBackToClassList()" id="backToClassBtn">
                    â† ë°˜ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <button class="btn btn-info" onclick="backToTopicsManagement()" id="backToTopicsBtn">
                    â† í† ë¡ ë°©ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    âš™ï¸ Firebase ì„¤ì •
                </button>
            `;
            
            // í—¤ë” ì—…ë°ì´íŠ¸ í›„ ì—°ê²° ìƒíƒœ ë‹¤ì‹œ ëª¨ë‹ˆí„°ë§
            setTimeout(() => {
                startConnectionMonitoring();
            }, 100);
        }
        
        // ë°˜ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° í•¨ìˆ˜
        function goBackToClassList() {
            // URLì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°í•˜ê³  ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
            const currentUrl = window.location.href.split('?')[0];
            window.location.href = currentUrl;
        }

        // í† ë¡ ë°© ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸° í•¨ìˆ˜ (3ë‹¨ê³„ â†’ 2ë‹¨ê³„)
        function backToTopicsManagement() {
            addLog('ğŸ”™ í† ë¡ ë°© ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°', 'info');
            
            // 2ë‹¨ê³„(í† ë¡ ë°© ê´€ë¦¬) í—¤ë”ë¡œ ë³€ê²½
            updateHeaderForTopicsManagement();
            
            // 2ë‹¨ê³„(í† ë¡ ë°© ê´€ë¦¬) í™”ë©´ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
            updateCurrentStep(5, `ì‹¤ì‹œê°„ í† ë¡  ê´€ë¦¬ - ${window.currentClassName || 'í† ë¡ ë°©'}`);
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div class="topics-management-container" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #495057;">ğŸ“‹ í† ë¡ ë°© ê´€ë¦¬</h3>
                        <div>
                            <button onclick="showCreateTopicForm()" class="btn" style="background: #28a745; color: white; margin-right: 10px;">
                                ğŸ“ ìƒˆ í† ë¡ ë°© ë§Œë“¤ê¸°
                            </button>
                            <button onclick="shareStudentLink()" class="btn" style="background: #17a2b8; color: white;">
                                ğŸ”— í•™ìƒ ë§í¬ ê³µìœ 
                            </button>
                        </div>
                    </div>
                    <div id="topicsGridList" style="min-height: 200px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            ğŸ“ í† ë¡ ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            `;
            
            // í† ë¡ ë°© ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            loadTopicsList();
        }

        // =========================
        // êµì‚¬ ì´ë¦„ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // =========================
        
        // êµì‚¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getTeacherName() {
            let teacherName = localStorage.getItem('teacherName');
            if (!teacherName) {
                teacherName = prompt('êµì‚¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:', 'ì„ ìƒë‹˜');
                if (teacherName && teacherName.trim()) {
                    localStorage.setItem('teacherName', teacherName.trim());
                } else {
                    teacherName = 'ì„ ìƒë‹˜'; // ê¸°ë³¸ê°’
                }
            }
            return teacherName;
        }

        // êµì‚¬ ì´ë¦„ ì¬ì„¤ì •
        function resetTeacherName() {
            const currentName = localStorage.getItem('teacherName') || 'ì„ ìƒë‹˜';
            const newName = prompt(`í˜„ì¬ êµì‚¬ ì´ë¦„: ${currentName}\n\nìƒˆë¡œìš´ êµì‚¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:`, currentName);
            if (newName && newName.trim()) {
                localStorage.setItem('teacherName', newName.trim());
                alert(`âœ… êµì‚¬ ì´ë¦„ì´ "${newName.trim()}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }

        // =========================
        // Firebase ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
        // =========================

        // ì‚¬ìš©ì Firebase ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function loadUserFirebaseConfig() {
            const savedConfig = {
                apiKey: localStorage.getItem('user_firebase_apiKey'),
                projectId: localStorage.getItem('user_firebase_projectId')
            };
            
            if (savedConfig.apiKey && savedConfig.projectId) {
                userFirebaseConfig = {
                    apiKey: savedConfig.apiKey,
                    authDomain: `${savedConfig.projectId}.firebaseapp.com`,
                    databaseURL: `https://${savedConfig.projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: savedConfig.projectId,
                    storageBucket: `${savedConfig.projectId}.appspot.com`
                };
                return userFirebaseConfig;
            }
            
            return null;
        }

        function saveUserFirebaseConfigToStorage(apiKey, projectId) {
            localStorage.setItem('user_firebase_apiKey', apiKey);
            localStorage.setItem('user_firebase_projectId', projectId);
            localStorage.setItem('user_firebase_databaseURL', `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`);
        }

        // Firebase ì„¤ì • ëª¨ë‹¬ ê´€ë ¨
        function openFirebaseSettings() {
            document.getElementById('firebaseSettingsModal').style.display = 'block';
            
            // ê¸°ì¡´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            const savedApiKey = localStorage.getItem('user_firebase_apiKey');
            const savedProjectId = localStorage.getItem('user_firebase_projectId');
            
            if (savedApiKey && savedProjectId) {
                document.getElementById('userApiKey').value = savedApiKey;
                document.getElementById('userProjectId').value = savedProjectId;
                updateAutoUrl();
            }
        }

        function closeFirebaseModal() {
            document.getElementById('firebaseSettingsModal').style.display = 'none';
            document.getElementById('testResult').style.display = 'none';
        }

        function updateAutoUrl() {
            // Project ID ì…ë ¥ ì‹œ ì²˜ë¦¬ - UI ì—…ë°ì´íŠ¸ëŠ” ì œê±°ë¨
        }

        // ì‚¬ìš©ì Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testUserFirebaseConnection() {
            const apiKey = document.getElementById('userApiKey').value.trim();
            const projectId = document.getElementById('userProjectId').value.trim();
            
            if (!apiKey || !projectId) {
                showTestResult('error', 'âŒ API Keyì™€ Project IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            showTestResult('info', 'ğŸ” Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            addLog('ğŸ§ª ì‚¬ìš©ì Firebase ì„¤ì • í…ŒìŠ¤íŠ¸ ì‹œì‘', 'warning');
            addLog(`   í”„ë¡œì íŠ¸ ID: ${projectId}`, 'info');
            
            try {
                const testConfig = {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`
                };
                
                // Firebase SDKê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof firebase === 'undefined') {
                    showTestResult('error', 'âŒ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € 2ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”.');
                    addLog('âŒ Firebase SDK ë¯¸ë¡œë“œ - 2ë‹¨ê³„ ë¨¼ì € ì™„ë£Œ í•„ìš”', 'error');
                    return;
                }
                
                const testApp = firebase.initializeApp(testConfig, 'userTestApp-' + Date.now());
                const testDatabase = testApp.database();
                
                // íƒ€ì„ì•„ì›ƒê³¼ í•¨ê»˜ ì—°ê²° í…ŒìŠ¤íŠ¸
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('ì—°ê²° ì‹œê°„ ì´ˆê³¼ (10ì´ˆ)')), 10000)
                );
                
                const connectionPromise = new Promise((resolve, reject) => {
                    const connectedRef = testDatabase.ref('.info/connected');
                    connectedRef.once('value', (snapshot) => {
                        if (snapshot.val() === true) {
                            resolve(true);
                        } else {
                            reject(new Error('ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
                        }
                    }, (error) => {
                        reject(error);
                    });
                });
                
                await Promise.race([connectionPromise, timeoutPromise]);
                
                showTestResult('success', 'âœ… Firebase ì—°ê²° ì„±ê³µ! ì´ì œ "ì €ì¥ ë° ì ìš©" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.');
                addLog('âœ… ì‚¬ìš©ì Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ', 'success');
                
                // í…ŒìŠ¤íŠ¸ ì•± ì •ë¦¬
                setTimeout(() => {
                    try {
                        testApp.delete();
                    } catch(e) {
                        console.log('í…ŒìŠ¤íŠ¸ ì•± ì •ë¦¬ ì™„ë£Œ');
                    }
                }, 1000);
                
            } catch (error) {
                let errorMsg = 'âŒ ì—°ê²° ì‹¤íŒ¨: ';
                if (error.message.includes('ì‹œê°„ ì´ˆê³¼')) {
                    errorMsg += 'ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. Database URLê³¼ í”„ë¡œì íŠ¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
                } else if (error.code === 'app/invalid-api-key') {
                    errorMsg += 'API Keyê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.message.includes('permission') || error.message.includes('PERMISSION_DENIED')) {
                    errorMsg += 'Database ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”. Realtime Database ê·œì¹™ì„ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì„¤ì •í•˜ì„¸ìš”.';
                } else {
                    errorMsg += error.message;
                }
                
                showTestResult('error', errorMsg);
                addLog('âŒ ì‚¬ìš©ì Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function showTestResult(type, message) {
            const testResult = document.getElementById('testResult');
            testResult.className = `test-result test-${type}`;
            testResult.textContent = message;
            testResult.style.display = 'block';
        }

        // ì‚¬ìš©ì Firebase ì„¤ì • ì €ì¥ ë° ì™„ì „ ìë™ ì—°ê²°
        async function saveUserFirebaseConfig() {
            try {
                addLog('ğŸš€ ì €ì¥ ë° ìë™ì—°ê²° ë²„íŠ¼ í´ë¦­ë¨', 'info');
                
                const apiKey = document.getElementById('userApiKey').value.trim();
                const projectId = document.getElementById('userProjectId').value.trim();
                
                addLog(`ğŸ“ ì…ë ¥ê°’ í™•ì¸ - API Key: ${apiKey ? 'ì…ë ¥ë¨' : 'ë¹„ì–´ìˆìŒ'}, Project ID: ${projectId ? 'ì…ë ¥ë¨' : 'ë¹„ì–´ìˆìŒ'}`, 'info');
                
                if (!apiKey || !projectId) {
                    showTestResult('error', 'âŒ API Keyì™€ Project IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    addLog('âŒ í•„ìˆ˜ ì…ë ¥ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                showTestResult('info', 'ğŸ’¾ ì„¤ì • ì €ì¥ ì¤‘...');
                addLog('ğŸ’¾ Firebase ì„¤ì • ì €ì¥ ì‹œì‘', 'info');
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                saveUserFirebaseConfigToStorage(apiKey, projectId);
                
                // ê¸€ë¡œë²Œ ì„¤ì • ì—…ë°ì´íŠ¸
                userFirebaseConfig = {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`
                };
                
                addLog(`ğŸ’¾ ì‚¬ìš©ì Firebase ì„¤ì • ì €ì¥: ${projectId}`, 'success');
                
                // UI ì—…ë°ì´íŠ¸ (projectInfoBtn ì œê±°ë¨)
                
                // Firebase SDKê°€ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (typeof firebase === 'undefined') {
                    showTestResult('info', 'ğŸ“¦ Firebase SDK ìë™ ë¡œë“œ ì¤‘...');
                    addLog('ğŸ“¦ Firebase SDKê°€ ì—†ìŠµë‹ˆë‹¤. ìë™ ë¡œë“œ ì‹œì‘...', 'info');
                    
                    // Firebase SDK ìë™ ë¡œë“œ
                    await loadFirebaseSDKAuto();
                    
                    // 2ë‹¨ê³„ UI ì—…ë°ì´íŠ¸
                    updateCurrentStep(2, 'Firebase SDK ë¡œë“œë¨');
                    updateProgress(1, 'success', 'Firebase SDK ìë™ ë¡œë“œ ì™„ë£Œ');
                }
                
                // Firebase ìë™ ì—°ê²°
                showTestResult('info', 'ğŸ”— Firebase ìë™ ì—°ê²° ì¤‘...');
                addLog('ğŸš€ ì €ì¥ëœ ì„¤ì •ìœ¼ë¡œ Firebase ìë™ ì—°ê²° ì‹œì‘', 'info');
                
                await autoConnectFirebase();
                showTestResult('success', 'âœ… Firebase ì„¤ì • ì €ì¥ ë° ì—°ê²° ì™„ë£Œ!');
                
                // ëª¨ë‹¬ ë‹«ê³  ì„±ê³µ ë¡œê·¸
                closeFirebaseModal();
                addLog(`ğŸ‰ Firebase ì—°ê²° ì„±ê³µ! ìë™ìœ¼ë¡œ 3ë‹¨ê³„ ì§„í–‰`, 'success');
                
                // 3ë‹¨ê³„ ìë™ ì‹œì‘
                updateCurrentStep(3, 'ë°˜ ê´€ë¦¬');
                updateProgress(1, 'success', 'Firebase ì—°ê²° ì™„ë£Œ');
                updateProgress(2, 'warning', 'ë°˜ ê´€ë¦¬ ê¸°ëŠ¥ ì‹œì‘ ì¤‘');
                
                // 1ì´ˆ í›„ 3ë‹¨ê³„ ìë™ ì‹œì‘
                setTimeout(() => {
                    startStep3();
                }, 1000);
                
            } catch (error) {
                showTestResult('error', 'âŒ ìë™ ì„¤ì • ì‹¤íŒ¨: ' + error.message);
                addLog('âŒ Firebase ìë™ ì„¤ì • ì‹¤íŒ¨: ' + error.message, 'error');
                console.error('Firebase ì„¤ì • ì—ëŸ¬:', error);
                
                // êµ¬ì²´ì ì¸ í•´ê²° ë°©ë²• ì œê³µ
                let solutionSteps = '';
                if (error.message.includes('ê¶Œí•œ ì˜¤ë¥˜') || error.message.includes('Permission denied')) {
                    solutionSteps = `
ğŸ“‹ Realtime Database ê·œì¹™ ì„¤ì • ë°©ë²•:
1. https://console.firebase.google.com ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ
3. ì™¼ìª½ ë©”ë‰´ "Realtime Database" í´ë¦­
4. "ê·œì¹™" íƒ­ í´ë¦­
5. ë‹¤ìŒ ê·œì¹™ìœ¼ë¡œ ë³€ê²½:
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
6. "ê²Œì‹œ" ë²„íŠ¼ í´ë¦­

âš ï¸ ì£¼ì˜: ê°œë°œ/í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.`;
                } else if (error.message.includes('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¡´ì¬í•˜ì§€')) {
                    solutionSteps = `
ğŸ“‹ Realtime Database í™œì„±í™” ë°©ë²•:
1. https://console.firebase.google.com ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ
3. ì™¼ìª½ ë©”ë‰´ "Realtime Database" í´ë¦­
4. "ë°ì´í„°ë² ì´ìŠ¤ ë§Œë“¤ê¸°" ë²„íŠ¼ í´ë¦­
5. ìœ„ì¹˜: ì•„ì‹œì•„ ë‚¨ë™ë¶€ (singapore) ì„ íƒ
6. ë³´ì•ˆ ê·œì¹™: í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹œì‘ ì„ íƒ
7. "ì™„ë£Œ" í´ë¦­`;
                } else {
                    solutionSteps = `
ğŸ“‹ ì¼ë°˜ì ì¸ í•´ê²° ë°©ë²•:
1. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
2. API Keyì™€ Project ID ì¬í™•ì¸
3. Firebase í”„ë¡œì íŠ¸ í™œì„±í™” ìƒíƒœ í™•ì¸
4. Realtime Database í™œì„±í™” í™•ì¸
5. ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ í›„ ì¬ì‹œë„`;
                }
                
                // ì‹¤íŒ¨í•œ ê²½ìš° ìƒì„¸í•œ ì•ˆë‚´
                setTimeout(() => {
                    closeFirebaseModal();
                    alert(`âš ï¸ Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nâŒ ì˜¤ë¥˜: ${error.message}\n\n${solutionSteps}\n\ní•´ê²° í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                }, 2000);
            }
        }

        // Firebase SDK ìë™ ë¡œë“œ í•¨ìˆ˜
        function loadFirebaseSDKAuto() {
            return new Promise((resolve, reject) => {
                addLog('ğŸ“¦ Firebase App SDK ë¡œë“œ ì¤‘...', 'info');
                
                // Firebase App SDK ë¡œë“œ
                const script1 = document.createElement('script');
                script1.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
                script1.onload = () => {
                    addLog('âœ… Firebase App SDK ë¡œë“œ ì™„ë£Œ', 'success');
                    
                    // Firebase Database SDK ë¡œë“œ
                    const script2 = document.createElement('script');
                    script2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
                    script2.onload = () => {
                        addLog('âœ… Firebase Database SDK ë¡œë“œ ì™„ë£Œ', 'success');
                        addLog('ğŸ¯ Firebase SDK ìë™ ë¡œë“œ ì„±ê³µ!', 'success');
                        resolve();
                    };
                    script2.onerror = () => {
                        reject(new Error('Firebase Database SDK ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    document.head.appendChild(script2);
                };
                script1.onerror = () => {
                    reject(new Error('Firebase App SDK ë¡œë“œ ì‹¤íŒ¨'));
                };
                document.head.appendChild(script1);
            });
        }

        // Firebase ìë™ ì—°ê²° í•¨ìˆ˜
        async function autoConnectFirebase() {
            const firebaseConfig = getFirebaseConfig();
            
            addLog(`ğŸ“‹ í”„ë¡œì íŠ¸ ID: ${firebaseConfig.projectId}`, 'info');
            addLog(`ğŸŒ ë°ì´í„°ë² ì´ìŠ¤ URL: ${firebaseConfig.databaseURL}`, 'info');
            addLog('ğŸŒ ë°ì´í„°ë² ì´ìŠ¤ ì§€ì—­: ì•„ì‹œì•„ ë‚¨ë™ë¶€', 'info');
            
            try {
                // ê¸°ì¡´ Firebase ì•±ì´ ìˆìœ¼ë©´ ì‚­ì œ
                if (firebase.apps.length > 0) {
                    firebase.apps.forEach(app => {
                        app.delete();
                    });
                    addLog('ğŸ—‘ï¸ ê¸°ì¡´ Firebase ì•± ì‚­ì œë¨', 'info');
                }
                
                // Firebase ê¸°ë³¸ ì•±ìœ¼ë¡œ ì´ˆê¸°í™”
                const app = firebase.initializeApp(firebaseConfig);
                const database = app.database();
                addLog('ğŸš€ Firebase ê¸°ë³¸ ì•± ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                
                // ë¨¼ì € ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì“°ê¸°ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ í™•ì¸
                const testRef = database.ref('test');
                await testRef.set({ timestamp: Date.now(), test: true });
                addLog('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì“°ê¸° í…ŒìŠ¤íŠ¸ ì„±ê³µ', 'success');
                
                // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
                await testRef.remove();
                addLog('ğŸ—‘ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ', 'success');
                
                addLog('ğŸŸ¢ Firebase ìë™ ì—°ê²° ì„±ê³µ!', 'success');
                updateConnectionStatus('connected', 'ğŸŸ¢ Firebase ì—°ê²°ë¨');
                
                // ê¸€ë¡œë²Œ database ê°ì²´ ì„¤ì •
                window.database = database;
                
                // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë‹¤ì‹œ ì‹œì‘
                startConnectionMonitoring();
                
                return true;
                
            } catch (error) {
                addLog(`âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                
                // êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ
                let detailedError = 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                
                if (error.message.includes('Permission denied')) {
                    detailedError = 'ê¶Œí•œ ì˜¤ë¥˜: Realtime Database ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.';
                } else if (error.message.includes('not found')) {
                    detailedError = 'ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Realtime Databaseë¥¼ í™œì„±í™”í•˜ì„¸ìš”.';
                } else if (error.message.includes('network')) {
                    detailedError = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
                }
                
                throw new Error(detailedError);
            }
        }

        // Firebase ë„ì›€ë§ í‘œì‹œ
        function showFirebaseHelp() {
            const helpContent = `
ğŸ”¥ Firebase ì„¤ì • ë„ì›€ë§

ğŸ“‹ 1ë‹¨ê³„: Firebase í”„ë¡œì íŠ¸ ìƒì„±
â€¢ https://console.firebase.google.com ì ‘ì†
â€¢ "í”„ë¡œì íŠ¸ ì¶”ê°€" í´ë¦­
â€¢ í”„ë¡œì íŠ¸ ì´ë¦„ ì…ë ¥ í›„ ìƒì„±

ğŸ“‹ 2ë‹¨ê³„: API Key ì°¾ê¸°
â€¢ í”„ë¡œì íŠ¸ ì„¤ì • (âš™ï¸ ì•„ì´ì½˜) í´ë¦­
â€¢ "ì¼ë°˜" íƒ­ì—ì„œ "ì›¹ API í‚¤" ë³µì‚¬

ğŸ“‹ 3ë‹¨ê³„: Realtime Database í™œì„±í™”
â€¢ ì™¼ìª½ ë©”ë‰´ "Realtime Database" í´ë¦­
â€¢ "ë°ì´í„°ë² ì´ìŠ¤ ë§Œë“¤ê¸°" í´ë¦­
â€¢ ìœ„ì¹˜: ì•„ì‹œì•„ ë‚¨ë™ë¶€ (singapore) ì„ íƒ
â€¢ ë³´ì•ˆ ê·œì¹™: "í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹œì‘" ì„ íƒ

ğŸ“‹ 4ë‹¨ê³„: ë³´ì•ˆ ê·œì¹™ ì„¤ì •
â€¢ "ê·œì¹™" íƒ­ì—ì„œ ë‹¤ìŒìœ¼ë¡œ ë³€ê²½:
{
  "rules": {
    ".read": true,
    ".write": true
  }
}

âš ï¸ ì£¼ì˜ì‚¬í•­:
â€¢ ì´ ê·œì¹™ì€ ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©ì…ë‹ˆë‹¤
â€¢ ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë” ì—„ê²©í•œ ê·œì¹™ ì‚¬ìš© í•„ìš”
â€¢ API KeyëŠ” ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”

ğŸ†˜ ë¬¸ì œ í•´ê²°:
â€¢ Permission denied: ë³´ì•ˆ ê·œì¹™ í™•ì¸
â€¢ Database not found: Realtime Database í™œì„±í™”
â€¢ Network error: ì¸í„°ë„· ì—°ê²° í™•ì¸
            `;
            
            alert(helpContent);
        }

        // ë‚´ ë°˜ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
        async function loadMyClassesList() {
            try {
                const config = loadUserFirebaseConfig();
                if (!config) return;
                
                // Firebase SDK í™•ì¸
                if (typeof firebase === 'undefined') {
                    addLog('Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'warning');
                    const errorHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 20px;">
                            âš ï¸ Firebase SDK ë¡œë“œ í•„ìš”<br><br>
                            "ğŸš€ ì €ì¥ ë° ìë™ì—°ê²°" ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”
                        </div>
                    `;
                    document.getElementById('myClassesListModal').innerHTML = errorHTML;
                    return;
                }
                
                // Firebase ì•± ì´ˆê¸°í™” (ì´ë¯¸ ë˜ì–´ìˆì„ ìˆ˜ ìˆìŒ)
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                
                const database = firebase.database();
                const classesRef = database.ref('classes');
                
                // ëª¨ë“  ë°˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const snapshot = await classesRef.once('value');
                const classes = snapshot.val() || {};
                
                const myClassesListModal = document.getElementById('myClassesListModal');
                const myClassesList = document.getElementById('myClassesList');
                
                if (Object.keys(classes).length === 0) {
                    const noClassesHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            ğŸ“‚ ìƒì„±ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤<br><br>
                            ìƒˆ ë°˜ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!
                        </div>
                    `;
                    myClassesListModal.innerHTML = noClassesHTML;
                    if (myClassesList) myClassesList.innerHTML = noClassesHTML;
                    return;
                }
                
                // ë°˜ ëª©ë¡ HTML ìƒì„± (ì •ì‚¬ê°í˜• ì¹´ë“œ ê·¸ë¦¬ë“œ)
                let classListHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">';
                Object.entries(classes).forEach(([classId, classData]) => {
                    const createdDate = new Date(classData.createdAt).toLocaleDateString('ko-KR');
                    const studentCount = classData.students ? Object.keys(classData.students).length : 0;
                    const discussionCount = classData.discussions ? Object.keys(classData.discussions).length : 0;
                    
                    classListHTML += `
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between;" 
                             onclick="selectClass('${classId}', '${classData.className}')"
                             onmouseover="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 12px rgba(0,123,255,0.2); this.style.transform='translateY(-2px)'"
                             onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)'">
                            
                            <div style="text-align: center; margin-bottom: 12px;">
                                <h4 style="color: #374151; font-size: 16px; font-weight: 600; margin: 0 0 8px 0; line-height: 1.2; word-break: keep-all;">${classData.className}</h4>
                                <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${classId}</span>
                            </div>
                            
                            <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                ${classData.description ? 
                                    `<p style="color: #6b7280; font-size: 12px; text-align: center; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">${classData.description}</p>` : 
                                    `<div style="color: #9ca3af; font-size: 32px;">ğŸ“š</div>`
                                }
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #6b7280; text-align: center;">
                                <div>ğŸ‘¥ ${studentCount}ëª…</div>
                                <div>ğŸ’­ ${discussionCount}ê°œ</div>
                                <div>ğŸ“… ${createdDate}</div>
                            </div>
                        </div>
                    `;
                });
                classListHTML += '</div>';
                
                myClassesListModal.innerHTML = classListHTML;
                if (myClassesList) myClassesList.innerHTML = classListHTML;
                
            } catch (error) {
                console.error('ë°˜ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                const errorHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        âŒ ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br><br>
                        Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”
                    </div>
                `;
                document.getElementById('myClassesListModal').innerHTML = errorHTML;
            }
        }
        
        // ë°˜ ì„ íƒ í•¨ìˆ˜
        function selectClass(classId, className) {
            if (confirm(`"${className}" ë°˜ì„ ê´€ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në°˜ ì½”ë“œ: ${classId}`)) {
                // ì„ íƒëœ ë°˜ìœ¼ë¡œ ì´ë™
                window.location.hash = `class=${classId}`;
                closeFirebaseModal();
                // ì—¬ê¸°ì— ë°˜ ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
                alert(`"${className}" ë°˜ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!\në°˜ ì½”ë“œ: ${classId}`);
            }
        }

        // Firebase ì„¤ì • ì´ˆê¸°í™”
        function resetToDefault() {
            if (confirm('ğŸ—‘ï¸ Firebase ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ˆê¸°í™” í›„ì—ëŠ” ìƒˆë¡œìš´ Firebase í”„ë¡œì íŠ¸ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.')) {
                localStorage.removeItem('user_firebase_apiKey');
                localStorage.removeItem('user_firebase_projectId');
                localStorage.removeItem('user_firebase_databaseURL');
                userFirebaseConfig = null;
                
                document.getElementById('userApiKey').value = '';
                document.getElementById('userProjectId').value = '';
                updateAutoUrl();
                // projectInfoBtn ì œê±°ë¨
                
                
                addLog('ğŸ—‘ï¸ Firebase ì„¤ì • ì´ˆê¸°í™”', 'warning');
                closeFirebaseModal();
                alert('âœ… Firebase ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì´ì œ ìƒˆë¡œìš´ Firebase í”„ë¡œì íŠ¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
            }
        }

        // í”„ë¡œì íŠ¸ ì •ë³´ í‘œì‹œ
        function showProjectInfo() {
            const config = loadUserFirebaseConfig();
            if (config) {
                alert(`ğŸ“‹ í˜„ì¬ Firebase ì„¤ì •\n\ní”„ë¡œì íŠ¸ ID: ${config.projectId}\nDatabase URL: ${config.databaseURL}\n\nâš™ï¸ Firebase ì„¤ì • ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            } else {
                alert('âŒ Firebase ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤!\n\nâš™ï¸ í—¤ë”ì˜ "Firebase ì„¤ì •" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬\në³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.\n\nğŸ“‹ í•„ìš”í•œ ì •ë³´:\n- API Key\n- Project ID\n- Database ê·œì¹™ ì„¤ì •');
            }
        }

        // Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸° - ì‚¬ìš©ì ì„¤ì • í•„ìˆ˜
        function getFirebaseConfig() {
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                addLog(`ğŸ¯ ì‚¬ìš©ì Firebase í”„ë¡œì íŠ¸ ì‚¬ìš©: ${userConfig.projectId}`, 'info');
                return userConfig;
            } else {
                addLog('âŒ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. í—¤ë”ì˜ "âš™ï¸ Firebase ì„¤ì •" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'error');
                throw new Error('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € Firebase í”„ë¡œì íŠ¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì„¤ì • í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ì¡´ ì´ˆê¸°í™” ì½”ë“œ...
            
            // ì‚¬ìš©ì Firebase ì„¤ì • í™•ì¸
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                // projectInfoBtn ì œê±°ë¨
                addLog(`ğŸ¯ ì‚¬ìš©ì Firebase í”„ë¡œì íŠ¸ ê°ì§€: ${userConfig.projectId}`, 'info');
            }
        });

        // =========================
        // ë°˜ ê´€ë¦¬ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
        // =========================
        
        // ì „ì—­ ë³€ìˆ˜ë“¤
        let globalDatabase = null;
        let currentUser = null;
        let currentClassId = null;
        let myClasses = [];
        
        // Firebase ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜
        function initGlobalDatabase() {
            if (globalDatabase) {
                return globalDatabase; // ì´ë¯¸ ì´ˆê¸°í™”ë¨
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                
                // ê¸°ì¡´ ì•±ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                if (firebase.apps.length > 0) {
                    console.log('ğŸ”„ ê¸°ì¡´ Firebase ì•± ì¬ì‚¬ìš©');
                    globalDatabase = firebase.app().database();
                    updateConnectionStatus('connected', 'ğŸŸ¢ Firebase ì—°ê²°ë¨');
                    return globalDatabase;
                }
                
                // ìƒˆ Firebase ì•± ìƒì„±
                const app = firebase.initializeApp(firebaseConfig);
                globalDatabase = app.database();
                
                console.log('âœ… Firebase ì „ì—­ ì´ˆê¸°í™” ì™„ë£Œ');
                updateConnectionStatus('connected', 'ğŸŸ¢ Firebase ì—°ê²°ë¨');
                return globalDatabase;
                
            } catch (error) {
                console.error('âŒ Firebase ì „ì—­ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                return null;
            }
        }
        
        // ìƒˆ ë°˜ ìƒì„± í¼ í‘œì‹œ
        function showCreateClassForm() {
            // ìƒˆ ë°˜ ë§Œë“¤ê¸° ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('createClassModal').style.display = 'block';
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassDescription').value = '';
            document.getElementById('createClassResult').style.display = 'none';
        }

        // ìƒˆ ë°˜ ë§Œë“¤ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closeCreateClassModal() {
            document.getElementById('createClassModal').style.display = 'none';
            document.getElementById('createClassResult').style.display = 'none';
        }

        // ìƒˆ ë°˜ ìƒì„± í•¨ìˆ˜
        async function createNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            const classDescription = document.getElementById('newClassDescription').value.trim();
            
            if (!className) {
                showCreateClassResult('error', 'âŒ ë°˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Firebase ì„¤ì • í™•ì¸
            const config = loadUserFirebaseConfig();
            if (!config) {
                showCreateClassResult('error', 'âŒ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. Firebase ì„¤ì •ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Firebase SDK í™•ì¸
            if (typeof firebase === 'undefined') {
                showCreateClassResult('error', 'âŒ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br><br>í•´ê²° ë°©ë²•:<br>1. "âš™ï¸ Firebase ì„¤ì •" ë²„íŠ¼ í´ë¦­<br>2. API Keyì™€ Project ID ì…ë ¥<br>3. "ğŸ”— ì—°ê²° ë° ì €ì¥" ë²„íŠ¼ í´ë¦­');
                return;
            }
            
            try {
                showCreateClassResult('info', 'ğŸ”„ ë°˜ì„ ìƒì„±í•˜ëŠ” ì¤‘...');
                
                // Firebase ì•± ì‚¬ìš© (ì´ë¯¸ autoConnectFirebaseì—ì„œ ì´ˆê¸°í™”ë¨)
                let app;
                let database;
                
                if (firebase.apps.length > 0) {
                    // ê¸°ì¡´ ê¸°ë³¸ ì•± ì‚¬ìš©
                    app = firebase.app();
                    database = app.database();
                    addLog('ğŸ”§ ê¸°ì¡´ Firebase ê¸°ë³¸ ì•± ì‚¬ìš©', 'info');
                } else {
                    // Firebase ì•±ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì•±ìœ¼ë¡œ ìƒˆë¡œ ì´ˆê¸°í™”
                    app = firebase.initializeApp(config);
                    database = app.database();
                    addLog('ğŸ”§ Firebase ê¸°ë³¸ ì•± ìƒˆë¡œ ì´ˆê¸°í™”ë¨', 'info');
                }
                
                // ê³ ìœ í•œ ë°˜ ì½”ë“œ ìƒì„± (6ìë¦¬)
                const classCode = generateClassCode();
                const classId = `class_${classCode.toLowerCase()}_${Date.now()}`;
                
                // ë°˜ ë°ì´í„° ìƒì„±
                const classData = {
                    id: classCode,
                    className: className,
                    description: classDescription || '',
                    createdAt: Date.now(),
                    createdBy: 'teacher',
                    status: 'active',
                    students: {},
                    discussions: {},
                    settings: {
                        allowAnonymous: false,
                        moderationEnabled: true
                    }
                };
                
                // Firebaseì— ì €ì¥
                await database.ref(`classes/${classCode}`).set(classData);
                
                // localStorageì—ë„ ì €ì¥ (ë‚´ ë°˜ ëª©ë¡ì— í‘œì‹œí•˜ê¸° ìœ„í•´)
                const myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
                myClasses.push({
                    id: classCode,
                    code: classCode,
                    name: className,
                    description: classDescription || '',
                    role: 'teacher',
                    joinedAt: Date.now(),
                    createdAt: Date.now()
                });
                localStorage.setItem('myClasses', JSON.stringify(myClasses));
                
                addLog(`âœ… ìƒˆ ë°˜ ìƒì„± ì™„ë£Œ: ${className} (${classCode})`, 'success');
                showCreateClassResult('success', `âœ… ë°˜ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!<br><strong>ë°˜ ì½”ë“œ: ${classCode}</strong><br>ì´ ì½”ë“œë¥¼ í•™ìƒë“¤ì—ê²Œ ê³µìœ í•´ì£¼ì„¸ìš”.`);
                
                // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeCreateClassModal();
                    // ë©”ì¸ í™”ë©´ ìƒˆë¡œê³ ì¹¨ (ë°˜ ëª©ë¡ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
                    startStep3();
                }, 3000);
                
            } catch (error) {
                console.error('ë°˜ ìƒì„± ì˜¤ë¥˜:', error);
                addLog(`âŒ ë°˜ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                
                let errorMessage = 'âŒ ë°˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                
                if (error.message.includes('No Firebase App')) {
                    errorMessage = `âŒ Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.<br><br>í•´ê²° ë°©ë²•:<br>1. "âš™ï¸ Firebase ì„¤ì •" ë²„íŠ¼ í´ë¦­<br>2. API Keyì™€ Project ID ì…ë ¥<br>3. "ğŸ”— ì—°ê²° ë° ì €ì¥" ë²„íŠ¼ í´ë¦­`;
                } else if (error.message.includes('PERMISSION_DENIED')) {
                    errorMessage = `âŒ Firebase ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.<br><br>í•´ê²° ë°©ë²•:<br>1. Firebase Console ì ‘ì†<br>2. Realtime Database â†’ ê·œì¹™ íƒ­<br>3. í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ë³€ê²½`;
                } else {
                    errorMessage += `<br><br>ì˜¤ë¥˜ ë‚´ìš©: ${error.message}`;
                }
                
                showCreateClassResult('error', errorMessage);
            }
        }
        
        // ë°˜ ì½”ë“œ ìƒì„± í•¨ìˆ˜ (6ìë¦¬ ëœë¤)
        function generateClassCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // ë°˜ ìƒì„± ê²°ê³¼ í‘œì‹œ
        function showCreateClassResult(type, message) {
            const resultDiv = document.getElementById('createClassResult');
            const colors = {
                'success': { bg: '#d4edda', color: '#155724', border: '#c3e6cb' },
                'error': { bg: '#f8d7da', color: '#721c24', border: '#f5c6cb' },
                'info': { bg: '#d1ecf1', color: '#0c5460', border: '#bee5eb' }
            };
            
            if (colors[type]) {
                resultDiv.style.background = colors[type].bg;
                resultDiv.style.color = colors[type].color;
                resultDiv.style.border = `1px solid ${colors[type].border}`;
                resultDiv.innerHTML = message;
                resultDiv.style.display = 'block';
            }
        }

        
        // ê¸°ì¡´ ë°˜ ì°¸ê°€ í¼ í‘œì‹œ
        function showJoinClassForm() {
            addLog('ğŸ” ê¸°ì¡´ ë°˜ ì°¸ê°€ í¼ í‘œì‹œ', 'info');
            const formContainer = document.getElementById('classFormContainer');
            formContainer.style.display = 'block';
            
            formContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #007bff; margin: 0;">ğŸ” ê¸°ì¡´ ë°˜ ì°¸ê°€í•˜ê¸°</h4>
                    <button class="btn btn-secondary" onclick="hideClassForm()" style="padding: 4px 8px; font-size: 12px;">âœ–ï¸</button>
                </div>
                
                <div class="form-group">
                    <label for="joinClassCode">ğŸ”¢ ë°˜ ì½”ë“œ</label>
                    <input type="text" id="joinClassCode" placeholder="ABC123" maxlength="10" style="text-transform: uppercase;" />
                    <div class="form-text">ë‹´ì„ ì„ ìƒë‹˜ì´ ì•Œë ¤ì£¼ì‹  6ìë¦¬ ë°˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                
                <div class="form-group">
                    <label for="studentName">ğŸ‘¨â€ğŸ“ í•™ìƒ ì´ë¦„</label>
                    <input type="text" id="studentName" placeholder="ê¹€ë¯¼ìˆ˜" maxlength="20" />
                </div>
                
                <div style="background: #d1ecf1; padding: 10px; border-radius: 6px; border-left: 3px solid #17a2b8; margin: 15px 0;">
                    <p style="margin: 0; font-size: 12px; color: #0c5460;">
                        <strong>ğŸ¯ ì°¸ê³ :</strong> ë°˜ ì½”ë“œëŠ” ë‹´ì„ ì„ ìƒë‹˜ì´ ì œê³µí•©ë‹ˆë‹¤.<br>
                        ì˜ˆì‹œ: ABC123, DEF456 ë“±ì˜ 6ìë¦¬ ì½”ë“œ
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="hideClassForm()">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="joinExistingClass()" id="joinClassBtn">ğŸš€ ë°˜ ì°¸ê°€í•˜ê¸°</button>
                </div>
            `;
            
            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('joinClassCode').focus();
            }, 100);
        }
        
        // í¼ ìˆ¨ê¸°ê¸°
        function hideClassForm() {
            document.getElementById('classFormContainer').style.display = 'none';
        }
        
        // ê¸°ì¡´ ë°˜ ì°¸ê°€í•˜ê¸°
        async function joinExistingClass() {
            const classCode = document.getElementById('joinClassCode').value.trim().toUpperCase();
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!classCode || !studentName) {
                alert('âš ï¸ ë°˜ ì½”ë“œì™€ í•™ìƒ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (classCode.length !== 6) {
                alert('âš ï¸ ë°˜ ì½”ë“œëŠ” 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const joinBtn = document.getElementById('joinClassBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = 'â³ ì°¸ê°€ ì¤‘...';
            
            try {
                // ì „ì—­ Firebase ì‚¬ìš©
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                addLog(`ğŸ” ë°˜ ì½”ë“œ ê²€ìƒ‰ ì¤‘: ${classCode}`, 'info');
                
                // ë°˜ ì½”ë“œë¡œ ë°˜ ID ì°¾ê¸°
                const classIdSnapshot = await database.ref('classCodes/' + classCode).once('value');
                
                if (!classIdSnapshot.exists()) {
                    throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°˜ ì½”ë“œì…ë‹ˆë‹¤.');
                }
                
                const classId = classIdSnapshot.val();
                addLog(`âœ… ë°˜ ì°¾ìŒ: ${classId}`, 'success');
                
                // ë°˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const classSnapshot = await database.ref('classes/' + classId).once('value');
                
                if (!classSnapshot.exists()) {
                    throw new Error('ë°˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const classData = classSnapshot.val();
                addLog(`ğŸ“š ë°˜ ì •ë³´ ë¡œë“œ: ${classData.name}`, 'success');
                
                // ì¤‘ë³µ ì°¸ê°€ í™•ì¸
                if (classData.members && classData.members[studentName]) {
                    throw new Error('ì´ë¯¸ ì´ ë°˜ì— ê°™ì€ ì´ë¦„ìœ¼ë¡œ ì°¸ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                }
                
                // ìƒˆ ë©¤ë²„ ì¶”ê°€
                const memberData = {
                    name: studentName,
                    role: 'student',
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`classes/${classId}/members/${studentName}`).set(memberData);
                
                // ë©¤ë²„ ìˆ˜ ì¦ê°€
                await database.ref(`classes/${classId}/memberCount`).transaction(count => {
                    return (count || 0) + 1;
                });
                
                addLog(`âœ… ë°˜ ì°¸ê°€ ì™„ë£Œ: ${classData.name}`, 'success');
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë‚´ ë°˜ ëª©ë¡ ì €ì¥
                const myClassData = {
                    id: classId,
                    name: classData.name,
                    code: classCode,
                    role: 'student',
                    studentName: studentName,
                    joinedAt: Date.now()
                };
                
                saveMyClass(myClassData);
                
                // UI ì—…ë°ì´íŠ¸
                hideClassForm();
                loadMyClasses();
                
                // ì„±ê³µ ì•Œë¦¼
                alert(`ğŸ‰ ë°˜ ì°¸ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ“š ë°˜ ì´ë¦„: ${classData.name}\nğŸ‘©â€ğŸ« ë‹´ë‹¹ êµì‚¬: ${classData.teacherName}\nğŸ‘¨â€ğŸ“ í•™ìƒ ì´ë¦„: ${studentName}\n\nì´ì œ í† ë¡ ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`);
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ ë°˜ ì°¸ê°€ ì‹¤íŒ¨: ${error.message}`, 'error');
                
                let errorMsg = 'âŒ ë°˜ ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                if (error.message.includes('PERMISSION_DENIED')) {
                    errorMsg += `ğŸ“‹ Firebase Database ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!\n\nğŸ”§ í•´ê²° ë°©ë²•:\n1. Firebase Console ì ‘ì†\n2. Realtime Database â†’ ê·œì¹™ íƒ­\n3. ë‹¤ìŒ ê·œì¹™ìœ¼ë¡œ ë³€ê²½:\n\n{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}\n\nâš ï¸ ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© ì„¤ì •ì…ë‹ˆë‹¤.`;
                } else {
                    errorMsg += `ì˜¤ë¥˜: ${error.message}\n\në°˜ ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                }
                
                alert(errorMsg);
                
                // ë²„íŠ¼ ë³µì›
                joinBtn.disabled = false;
                joinBtn.textContent = 'ğŸš€ ë°˜ ì°¸ê°€í•˜ê¸°';
            }
        }
        
        
        // ë‚´ ë°˜ ì •ë³´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
        function saveMyClass(classData) {
            let myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
            
            // ì¤‘ë³µ ì œê±°
            myClasses = myClasses.filter(c => c.id !== classData.id);
            
            // ìƒˆ ë°ì´í„° ì¶”ê°€
            myClasses.unshift(classData);
            
            // ìµœëŒ€ 10ê°œë§Œ ë³´ê´€
            if (myClasses.length > 10) {
                myClasses = myClasses.slice(0, 10);
            }
            
            localStorage.setItem('myClasses', JSON.stringify(myClasses));
            addLog(`ğŸ’¾ ë‚´ ë°˜ ëª©ë¡ ì €ì¥: ${classData.name}`, 'success');
        }
        
        // ë‚´ ë°˜ ëª©ë¡ ë¡œë“œ ë° í‘œì‹œ
        function loadMyClasses() {
            const myClassesList = document.getElementById('myClassesList');
            const savedClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
            
            if (savedClasses.length === 0) {
                myClassesList.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        ğŸ“‚ ì•„ì§ ì°¸ê°€í•œ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤<br><br>
                        ìœ„ ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ë°˜ì„ ë§Œë“¤ê±°ë‚˜ ê¸°ì¡´ ë°˜ì— ì°¸ê°€í•´ë³´ì„¸ìš”!
                    </div>
                `;
                return;
            }
            
            let classListHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
            
            savedClasses.forEach(classData => {
                const joinedDate = new Date(classData.joinedAt).toLocaleDateString();
                const createdDate = new Date(classData.createdAt).toLocaleDateString();
                
                // ë°˜ ì„¤ëª… í‘œì‹œ (ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€)
                const description = classData.description || 'ë°˜ì— ëŒ€í•œ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
                const truncatedDesc = description.length > 50 ? description.substring(0, 50) + '...' : description;
                
                classListHTML += `
                    <div class="class-card" style="
                        background: white; 
                        border: 1px solid #dee2e6; 
                        border-radius: 12px; 
                        padding: 20px; 
                        height: 240px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        transition: transform 0.2s, box-shadow 0.2s;
                        cursor: pointer;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #343a40; margin-bottom: 16px; line-height: 1.3;">
                                ğŸ“š ${classData.name}
                            </div>
                            <div style="font-size: 17px; color: #6c757d; margin-bottom: 12px; line-height: 1.4;">
                                ${truncatedDesc}
                            </div>
                            <div style="font-size: 15px; color: #6c757d; margin-bottom: 10px;">
                                ì½”ë“œ: <strong style="color: #007bff; font-size: 16px;">${classData.code}</strong>
                            </div>
                            <div style="font-size: 14px; color: #999;">
                                ìƒì„±ì¼: ${createdDate} | ì°¸ê°€ì¼: ${joinedDate}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); enterClass('${classData.id}', '${classData.name}', '${classData.role}')" style="flex: 1; padding: 8px 12px; font-size: 17px; border-radius: 6px; font-weight: bold;">
                                ğŸšª ì…ì¥í•˜ê¸°
                            </button>
                            <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); removeMyClass('${classData.id}', '${classData.name}')" style="padding: 8px 12px; font-size: 17px; border-radius: 6px;" title="ë°˜ ì‚­ì œ">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            });
            
            classListHTML += '</div>';
            myClassesList.innerHTML = classListHTML;
            addLog(`ğŸ“‹ ë‚´ ë°˜ ëª©ë¡ í‘œì‹œ: ${savedClasses.length}ê°œ`, 'info');
        }
        
        // ë°˜ ì…ì¥í•˜ê¸°
        function enterClass(classId, className, role) {
            addLog(`ğŸšª ë°˜ ì…ì¥: ${className} (${role})`, 'success');
            
            currentClassId = classId;
            
            // í˜„ì¬ ë°˜ì˜ ì½”ë“œ ì°¾ê¸° ë° í‘œì‹œ
            const myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
            const currentClass = myClasses.find(c => c.id === classId);
            if (currentClass) {
                window.currentClassCodeValue = currentClass.code;
                window.currentClassName = className;
            }

            // 2ë‹¨ê³„(í† ë¡ ë°© ê´€ë¦¬) í—¤ë”ë¡œ ë³€ê²½
            updateHeaderForTopicsManagement();
            
            // 5ë‹¨ê³„ë¡œ ë°”ë¡œ ì§„í–‰
            updateCurrentStep(5, `ì‹¤ì‹œê°„ í† ë¡  ê´€ë¦¬ - ${className}`);
            updateProgress(2, 'success', 'ë°˜ ê´€ë¦¬ ì™„ë£Œ');
            addLog('ğŸ”„ ìë™ ì§„í–‰: 5ë‹¨ê³„ í† ë¡  ì§„í–‰ ê´€ë¦¬ ì‹œì‘', 'info');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div class="topics-management-container" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #495057;">ğŸ“‹ í† ë¡ ë°© ê´€ë¦¬</h3>
                        <div>
                            <button onclick="showCreateTopicForm()" class="btn" style="background: #28a745; color: white; margin-right: 10px;">
                                ğŸ“ ìƒˆ í† ë¡ ë°© ë§Œë“¤ê¸°
                            </button>
                            <button onclick="shareStudentLink()" class="btn" style="background: #17a2b8; color: white;">
                                ğŸ”— í•™ìƒ ë§í¬ ê³µìœ 
                            </button>
                        </div>
                    </div>
                    <div id="topicsGridList" style="min-height: 200px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            ğŸ“ í† ë¡ ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            `;
            
            // í† ë¡ ë°© ëª©ë¡ ë¡œë“œ
            loadTopicsList();
        }
        
        // í† ë¡ ë°© ëª©ë¡ ë¡œë“œ (Firebaseì—ì„œ)
        async function loadTopicsList() {
            const topicsGrid = document.getElementById('topicsGridList');
            
            try {
                // Firebaseì—ì„œ í† ë¡ ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                if (!firebase.apps.length > 0) {
                    topicsGrid.innerHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 40px;">
                            âŒ Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤<br><br>
                            "ğŸ”™ ë°˜ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°" í›„ Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                        </div>
                    `;
                    return;
                }
                
                const database = firebase.app().database();
                const topicsRef = database.ref(`classes/${currentClassId}/discussions`);
                
                // ë¡œë”© í‘œì‹œ
                topicsGrid.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        ğŸ”„ í† ë¡ ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                `;
                
                const snapshot = await topicsRef.once('value');
                const topicsData = snapshot.val();
                
                if (!topicsData || Object.keys(topicsData).length === 0) {
                    topicsGrid.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            ğŸ“ ì•„ì§ ìƒì„±ëœ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤<br><br>
                            í—¤ë”ì˜ "ğŸ“ í† ë¡  ì£¼ì œ ë§Œë“¤ê¸°" ë²„íŠ¼ìœ¼ë¡œ ìƒˆ í† ë¡ ì„ ì‹œì‘í•´ë³´ì„¸ìš”!
                        </div>
                    `;
                    return;
                }
                
                // Firebase ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
                const classTopics = Object.keys(topicsData).map(key => ({
                    id: key,
                    ...topicsData[key]
                }));
                
                addLog(`ğŸ“‹ Firebaseì—ì„œ í† ë¡ ë°© ${classTopics.length}ê°œ ë¡œë“œë¨`, 'success');
                
                // í† ë¡ ë°© ëª©ë¡ ë Œë”ë§
                let topicsListHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
                
                classTopics.forEach(topicData => {
                const createdDate = new Date(topicData.createdAt).toLocaleDateString();
                const statusColor = topicData.status === 'active' ? '#28a745' : topicData.status === 'ended' ? '#6c757d' : '#ffc107';
                const statusText = topicData.status === 'active' ? 'ì§„í–‰ ì¤‘' : topicData.status === 'ended' ? 'ì¢…ë£Œë¨' : 'ëŒ€ê¸° ì¤‘';
                const statusIcon = topicData.status === 'active' ? 'ğŸŸ¢' : topicData.status === 'ended' ? 'âš«' : 'ğŸŸ¡';
                
                // í† ë¡  ì„¤ëª… í‘œì‹œ (ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€)
                const description = topicData.description || 'í† ë¡ ì— ëŒ€í•œ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
                const truncatedDesc = description.length > 60 ? description.substring(0, 60) + '...' : description;
                
                // ì°¸ì—¬ì ìˆ˜ (ì„ì‹œ)
                const participantCount = Math.floor(Math.random() * 15) + 3; // 3-18ëª…
                
                // ì‹œê°„ ì œí•œ í‘œì‹œ í˜•ì‹ ìƒì„±
                let timeLimitText = '';
                if (topicData.timeLimit === 0 || !topicData.timeLimit) {
                    timeLimitText = 'â° ì œí•œ ì—†ìŒ';
                } else if (topicData.timeLimit < 60) {
                    timeLimitText = `â° ${topicData.timeLimit}ë¶„`;
                } else {
                    const hours = Math.floor(topicData.timeLimit / 60);
                    const minutes = topicData.timeLimit % 60;
                    if (minutes === 0) {
                        timeLimitText = `â° ${hours}ì‹œê°„`;
                    } else {
                        timeLimitText = `â° ${hours}ì‹œê°„ ${minutes}ë¶„`;
                    }
                }
                
                topicsListHTML += `
                    <div class="topic-card" style="
                        background: white; 
                        border: 1px solid #dee2e6; 
                        border-radius: 12px; 
                        padding: 20px; 
                        height: 240px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        transition: transform 0.2s, box-shadow 0.2s;
                        cursor: pointer;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
                        <div>
                            <div style="font-size: 22px; font-weight: bold; color: #343a40; margin-bottom: 12px; line-height: 1.3;">
                                ğŸ’¬ ${topicData.title}
                            </div>
                            <div style="font-size: 16px; color: #6c757d; margin-bottom: 12px; line-height: 1.4;">
                                ${truncatedDesc}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 14px; color: ${statusColor}; font-weight: bold;">
                                    ${statusIcon} ${statusText}
                                </div>
                                <div style="font-size: 14px; color: #6f42c1; font-weight: bold;">
                                    ${topicData.type === 'chat' ? 'ğŸ’¬ ì±„íŒ…í˜•' : topicData.type === 'postit' ? 'ğŸ“ í¬ìŠ¤íŠ¸ì‡' : topicData.type === 'debate' ? 'âš–ï¸ ì°¬ë°˜í† ë¡ ' : 'ğŸ—£ï¸ ì¼ë°˜í† ë¡ '}
                                </div>
                            </div>
                            <div style="font-size: 13px; color: #28a745; margin-bottom: 0px; font-weight: bold;">
                                ${timeLimitText} / ìƒì„±ì¼: ${createdDate}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); enterTopic('${topicData.id}', '${topicData.title}')" style="flex: 1; padding: 8px 12px; font-size: 13px; border-radius: 6px; font-weight: bold;">
                                ğŸšª í† ë¡  ì…ì¥
                            </button>
                            <button class="btn btn-success" onclick="event.stopPropagation(); downloadTopicCSV('${topicData.id}', '${topicData.title}')" style="padding: 8px 12px; font-size: 13px; border-radius: 6px;" title="CSV ë‹¤ìš´ë¡œë“œ">
                                ğŸ“Š
                            </button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteTopic('${topicData.id}', '${topicData.title}')" style="padding: 8px 12px; font-size: 13px; border-radius: 6px;" title="í† ë¡ ë°© ì‚­ì œ">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
                });
                
                topicsListHTML += '</div>';
                topicsGrid.innerHTML = topicsListHTML;
                addLog(`ğŸ“‹ í† ë¡ ë°© ëª©ë¡ í‘œì‹œ: ${classTopics.length}ê°œ`, 'info');
                
            } catch (error) {
                console.error('í† ë¡ ë°© ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                topicsGrid.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 40px;">
                        âŒ í† ë¡ ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨<br><br>
                        ${error.message}<br><br>
                        Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </div>
                `;
            }
        }
        
        // [ì‚¬ìš© ì•ˆí•¨] ìë™ìœ¼ë¡œ í† ë¡  ì£¼ì œ ìƒì„±í•˜ê³  5ë‹¨ê³„ ì‹œì‘ (êµì‚¬ê°€ ì§ì ‘ ì„ íƒí•˜ë„ë¡ ë³€ê²½)
        /*
        async function autoCreateTopicAndStartDiscussion() {
            try {
                addLog('ğŸ”„ ìë™ ì§„í–‰: í† ë¡  ì£¼ì œ ìë™ ìƒì„± ì‹œì‘', 'info');
                updateProgress(3, 'warning', 'í† ë¡  ì£¼ì œ ìë™ ìƒì„± ì¤‘...');
                
                // ê¸°ë³¸ í† ë¡  ì£¼ì œ ìƒì„±
                const defaultTopic = {
                    title: 'ìƒ˜í”Œ í† ë¡ : í™˜ê²½ ë³´í˜¸ì˜ ì¤‘ìš”ì„±',
                    description: 'ì¼íšŒìš©í’ˆ ì‚¬ìš©ì„ ì¤„ì´ëŠ” ë°©ë²•ì— ëŒ€í•´ í† ë¡ í•´ë³´ì„¸ìš”',
                    type: 'general',
                    maxParticipants: 30,
                    timeLimit: 300
                };
                
                // Firebaseì— í† ë¡  ì£¼ì œ ì €ì¥
                const topicId = 'auto-topic-' + Date.now();
                await database.ref(`topics/${currentClassId}/${topicId}`).set({
                    ...defaultTopic,
                    id: topicId,
                    classId: currentClassId,
                    createdAt: Date.now(),
                    status: 'active'
                });
                
                addLog('âœ… í† ë¡  ì£¼ì œ ìë™ ìƒì„± ì™„ë£Œ', 'success');
                updateProgress(3, 'success', 'í† ë¡  ì£¼ì œ ìƒì„± ì™„ë£Œ');
                
                // 1ì´ˆ í›„ 5ë‹¨ê³„ë¡œ ìë™ ì§„í–‰
                setTimeout(() => {
                    addLog('ğŸ”„ ìë™ ì§„í–‰: 5ë‹¨ê³„ ì‹¤ì‹œê°„ í† ë¡  ì‹œì‘', 'info');
                    enterDiscussion(topicId, defaultTopic.title);
                }, 1000);
                
            } catch (error) {
                addLog('âŒ ìë™ í† ë¡  ì£¼ì œ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
                console.error(error);
            }
        }
        */
        
        // ë°˜ ì½”ë“œ ë³µì‚¬í•˜ê¸°
        function copyClassCode() {
            const classCode = window.currentClassCodeValue;
            if (!classCode) {
                alert('ë°˜ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            if (navigator.clipboard) {
                navigator.clipboard.writeText(classCode).then(() => {
                    alert(`ğŸ“‹ ë°˜ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì½”ë“œ: ${classCode}\n\ní•™ìƒë“¤ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.`);
                }).catch(() => {
                    fallbackCopyTextToClipboard(classCode);
                });
            } else {
                fallbackCopyTextToClipboard(classCode);
            }
        }
        
        // í´ë¦½ë³´ë“œ ë³µì‚¬ ëŒ€ì²´ ë°©ë²•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert(`ğŸ“‹ ë°˜ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì½”ë“œ: ${text}\n\ní•™ìƒë“¤ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.`);
                } else {
                    alert(`ë°˜ ì½”ë“œ: ${text}\n\nìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.`);
                }
            } catch (err) {
                alert(`ë°˜ ì½”ë“œ: ${text}\n\nìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.`);
            }
            
            document.body.removeChild(textArea);
        }
        
        // í•™ìƒìš© ë§í¬ ìƒì„± ë° ê³µìœ 
        function shareStudentLink() {
            const classCode = window.currentClassCodeValue;
            if (!classCode) {
                alert('ë°˜ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í˜„ì¬ URLì˜ ê¸°ë³¸ ê²½ë¡œì—ì„œ í•™ìƒìš© íŒŒì¼ë¡œ ë§í¬ ìƒì„±
            const currentUrl = window.location.href;
            const basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
            const studentUrl = `${basePath}/student.html?class=${classCode}`;
            
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            if (navigator.clipboard) {
                navigator.clipboard.writeText(studentUrl).then(() => {
                    alert(`ğŸ”— í•™ìƒìš© ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${studentUrl}\n\ní•™ìƒë“¤ì€ ì´ ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ë°”ë¡œ ë°˜ ì°¸ì—¬ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                }).catch(() => {
                    fallbackCopyTextToClipboard(studentUrl);
                });
            } else {
                alert(`ğŸ”— í•™ìƒìš© ë§í¬:\n\n${studentUrl}\n\ní•™ìƒë“¤ì€ ì´ ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ë°”ë¡œ ë°˜ ì°¸ì—¬ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
            }
        }
        
        // ë‚´ ë°˜ ëª©ë¡ì—ì„œ ì œê±°
        function removeMyClass(classId, className) {
            if (confirm(`ğŸ—‘ï¸ "${className}" ë°˜ì„ ëª©ë¡ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(Firebaseì˜ ë°˜ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)`)) {
                let myClasses = JSON.parse(localStorage.getItem('myClasses') || '[]');
                myClasses = myClasses.filter(c => c.id !== classId);
                localStorage.setItem('myClasses', JSON.stringify(myClasses));
                
                loadMyClasses();
                addLog(`ğŸ—‘ï¸ ë‚´ ë°˜ ëª©ë¡ì—ì„œ ì œê±°: ${className}`, 'warning');
            }
        }

        // =========================
        // í† ë¡ ë°© ìƒì„± ë° ê´€ë¦¬ ê¸°ëŠ¥
        // =========================
        
        let currentTopics = [];
        
        // í† ë¡  ì£¼ì œ ìƒì„± í¼ í‘œì‹œ
        function showCreateTopicForm() {
            addLog('ğŸ“ í† ë¡  ì£¼ì œ ìƒì„± ëª¨ë‹¬ í‘œì‹œ', 'info');
            const modal = document.getElementById('createTopicModal');
            modal.style.display = 'flex';
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('topicTitle').value = '';
            document.getElementById('topicDescription').value = '';
            document.getElementById('topicType').value = 'chat';
            document.getElementById('topicTimeLimit').value = '15';
            
            // ê²°ê³¼ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            const resultDiv = document.getElementById('createTopicResult');
            resultDiv.style.display = 'none';
        }
        
        // í† ë¡  ì£¼ì œ ìƒì„± ëª¨ë‹¬ ë‹«ê¸°
        function closeCreateTopicModal() {
            const modal = document.getElementById('createTopicModal');
            modal.style.display = 'none';
        }
        
        // í† ë¡  ì£¼ì œ ìƒì„± ê²°ê³¼ í‘œì‹œ
        function showCreateTopicResult(type, message) {
            const resultDiv = document.getElementById('createTopicResult');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
        }
        
        // í† ë¡  ì£¼ì œ ìƒì„±
        async function createNewTopic() {
            const title = document.getElementById('topicTitle').value.trim();
            const description = document.getElementById('topicDescription').value.trim();
            const type = document.getElementById('topicType').value;
            const timeLimit = parseInt(document.getElementById('topicTimeLimit').value);
            
            if (!title) {
                showCreateTopicResult('error', 'âŒ í† ë¡  ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                showCreateTopicResult('info', 'ğŸ”„ í† ë¡ ì„ ìƒì„±í•˜ëŠ” ì¤‘...');
                
                // Firebase ì—°ê²° í™•ì¸
                if (!firebase.apps.length > 0) {
                    showCreateTopicResult('error', 'âŒ Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
                
                const database = firebase.app().database();
                const topicId = 'topic_' + Date.now();
                
                // í† ë¡  ë°ì´í„° ìƒì„±
                const topicData = {
                    id: topicId,
                    title: title,
                    description: description,
                    type: type,
                    timeLimit: timeLimit,
                    status: 'active',
                    createdAt: Date.now(),
                    createdBy: 'teacher',
                    classId: currentClassId,
                    participants: {}
                };
                
                // Firebaseì— ì €ì¥
                await database.ref(`classes/${currentClassId}/discussions/${topicId}`).set(topicData);
                
                addLog(`âœ… ìƒˆ í† ë¡  ìƒì„± ì™„ë£Œ: ${title}`, 'success');
                showCreateTopicResult('success', `âœ… í† ë¡ ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!<br><strong>ì œëª©: ${title}</strong>`);
                
                // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    closeCreateTopicModal();
                    loadTopicsList();
                }, 2000);
                
            } catch (error) {
                console.error('í† ë¡  ìƒì„± ì˜¤ë¥˜:', error);
                addLog(`âŒ í† ë¡  ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                showCreateTopicResult('error', `âŒ í† ë¡  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br><br>ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // í† ë¡ ë°© ì…ì¥ - 5ë‹¨ê³„ë¡œ ì´ë™
        function enterTopic(topicId, topicTitle) {
            addLog(`ğŸšª í† ë¡ ë°© ì…ì¥: ${topicTitle}`, 'success');
            
            // í˜„ì¬ í† ë¡  ì •ë³´ ì €ì¥
            window.currentTopicId = topicId;
            window.currentTopicTitle = topicTitle;
            
            // í† ë¡ ë°© í—¤ë”ë¡œ ë³€ê²½
            updateHeaderForDiscussion();
            
            // 5ë‹¨ê³„ë¡œ ì§„í–‰
            updateCurrentStep(5, `í† ë¡  ì§„í–‰ - ${topicTitle}`);
            updateProgress(3, 'success', 'í† ë¡  ê´€ë¦¬ ì™„ë£Œ');
            addLog('ğŸ”„ ìë™ ì§„í–‰: 5ë‹¨ê³„ í† ë¡  ì§„í–‰ ê´€ë¦¬ ì‹œì‘', 'info');
            
            // 5ë‹¨ê³„ êµì‚¬ìš© í† ë¡  ê´€ë¦¬ í™”ë©´ í‘œì‹œ
            startStep5(topicId, topicTitle);
        }
        
        // 5ë‹¨ê³„ í—¤ë” ì—…ë°ì´íŠ¸
        function updateHeaderForStep5(topicTitle) {
            const headerButtons = document.querySelector('.header-buttons');
            headerButtons.innerHTML = `
                <button class="btn btn-secondary" onclick="backToTopicsList()" id="backToTopicsBtn">
                    ğŸ”™ í† ë¡  ëª©ë¡ìœ¼ë¡œ
                </button>
                <button class="btn btn-success" onclick="shareStudentLink()" id="studentLinkBtn">
                    ğŸ”— í•™ìƒ ë§í¬
                </button>
                <button class="btn btn-warning" onclick="endTopic()" id="endTopicBtn">
                    â¹ï¸ í† ë¡  ì¢…ë£Œ
                </button>
            `;
            
            // í—¤ë” ì œëª© ë³€ê²½
            const headerTitle = document.querySelector('.header h1');
            headerTitle.textContent = `ğŸ’¬ ${topicTitle} - ì§„í–‰ ì¤‘`;
        }
        
        // í† ë¡  ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function backToTopicsList() {
            addLog('ğŸ”™ í† ë¡  ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°', 'info');
            
            // í† ë¡  ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
            updateCurrentStep(5, 'í† ë¡  ê´€ë¦¬');
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div class="topics-list-container" style="margin-top: 20px;">
                    <div id="topicsGridList" style="min-height: 200px; background: #f8f9fa; border-radius: 6px; padding: 20px;">
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            ğŸ”„ í† ë¡ ë°© ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            `;
            
            // í† ë¡  ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            loadTopicsList();
        }
        
        // 5ë‹¨ê³„ ì‹œì‘ - êµì‚¬ìš© ì‹¤ì‹œê°„ í† ë¡  ê´€ë¦¬
        async function startStep5(topicId, topicTitle) {
            // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
            currentTopicId = topicId;
            
            // Firebaseì—ì„œ í† ë¡  ë°ì´í„° ë¡œë“œ
            await loadDiscussionDataForTeacher(topicId);
            
            // í† ë¡  ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!currentTopicData) {
                addLog('âŒ í† ë¡  ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                alert('í† ë¡  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            addLog(`ğŸ“‹ í† ë¡  íƒ€ì…: ${currentTopicData.type}`, 'info');
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div style="background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%); color: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                    <h3 style="color: white; margin: 0; font-size: 18px;">ğŸ’¬ ${topicTitle}</h3>
                    <p style="color: #f8f9fa; margin: 0; font-size: 13px;">êµì‚¬ ëª¨ë“œ - ì‹¤ì‹œê°„ í† ë¡  ê´€ë¦¬ (${currentTopicData.type})</p>
                </div>
                
                <!-- í† ë¡  ì˜ì—­ -->
                <div id="discussionArea">
                    ${getDiscussionUIByType(currentTopicData.type)}
                </div>
            `;
            
            // ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì‹œì‘
            setupRealTimeListeners();
            
            // êµì‚¬ ì œì–´ íŒ¨ë„ ì´ˆê¸°í™”
            initializeTeacherControls();
            
            addLog(`ğŸš€ 5ë‹¨ê³„ ì‹œì‘: ${topicTitle} êµì‚¬ìš© ì‹¤ì‹œê°„ í† ë¡  ê´€ë¦¬`, 'success');
        }
        
        // í† ë¡  íƒ€ì…ì— ë”°ë¥¸ UI ìƒì„±
        function getDiscussionUIByType(type) {
            addLog(`ğŸ¨ UI ìƒì„± ì¤‘ - í† ë¡  íƒ€ì…: ${type}`, 'info');
            
            switch(type) {
                case 'chat':
                    return createDiscussionUI();
                case 'postit':
                    return createPostitUI();
                case 'debate':
                    return createDebateUI();
                case 'general':
                    return createDiscussionUI();
                default:
                    addLog(`âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” í† ë¡  íƒ€ì…: ${type}, ê¸°ë³¸ UI ì‚¬ìš©`, 'warning');
                    return createDiscussionUI();
            }
        }
        
        // êµì‚¬ìš© í† ë¡  ë°ì´í„° ë¡œë“œ
        async function loadDiscussionDataForTeacher(topicId) {
            try {
                if (!firebase.apps.length > 0) {
                    throw new Error('Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }
                
                const database = firebase.app().database();
                const topicSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}`).once('value');
                
                if (topicSnapshot.exists()) {
                    currentTopicData = topicSnapshot.val();
                    addLog(`âœ… í† ë¡  ë°ì´í„° ë¡œë“œ: ${currentTopicData.title}`, 'success');
                } else {
                    throw new Error('í† ë¡  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                addLog(`âŒ í† ë¡  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // í† ë¡  ê´€ë¦¬
        function manageTopic(topicId, topicTitle) {
            addLog(`âš™ï¸ í† ë¡  ê´€ë¦¬: ${topicTitle}`, 'info');
            
            // í† ë¡  ê´€ë¦¬ ëª¨ë‹¬ì´ë‚˜ í˜ì´ì§€ë¥¼ ì—¬ëŠ” ê¸°ëŠ¥ (í–¥í›„ êµ¬í˜„)
            alert(`í† ë¡  ê´€ë¦¬ ê¸°ëŠ¥\n\ní† ë¡ ëª…: ${topicTitle}\nID: ${topicId}\n\nê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.`);
        }
        
        // í† ë¡  ëª©ë¡ ë³´ê¸°
        function showTopicsList() {
            addLog('ğŸ“‹ í† ë¡  ëª©ë¡ í‘œì‹œ', 'info');
            hideAllForms();
            
            // 4ë‹¨ê³„ í† ë¡  ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (!welcomeMsg) {
                addLog('âŒ welcomeMessage ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // 4ë‹¨ê³„ UI ë‹¤ì‹œ í‘œì‹œ
            welcomeMsg.innerHTML = `
                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h2 style="color: white; margin: 0 0 8px 0;">ğŸ“š ë°˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
                    <p style="color: #f8f9fa; margin: 0;">ì—­í• : êµì‚¬/í•™ìƒ</p>
                </div>
                
                <h3 style="color: #495057; margin-bottom: 15px;">ğŸ“Š í† ë¡ ë°© ê´€ë¦¬</h3>
                <p>í† ë¡ ë°©ì„ ìƒì„±í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                
                <div class="grid-container" style="margin-top: 25px;">
                    <div class="grid-item" onclick="showCreateTopicForm()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white;">
                        <h4 style="color: white; margin-bottom: 8px;">ğŸ“ í† ë¡  ì£¼ì œ ë§Œë“¤ê¸°</h4>
                        <p style="font-size: 13px; color: #f8f9fa;">ìƒˆë¡œìš´ í† ë¡  ì£¼ì œ ìƒì„±</p>
                    </div>
                    <div class="grid-item" onclick="showTopicsListModal()" style="background: linear-gradient(135deg, #a55eea 0%, #8e44ad 100%); color: white;">
                        <h4 style="color: white; margin-bottom: 8px;">ğŸ“‹ í† ë¡  ëª©ë¡ ë³´ê¸°</h4>
                        <p style="font-size: 13px; color: #f8f9fa;">ì§„í–‰ ì¤‘ì¸ í† ë¡  í™•ì¸</p>
                    </div>
                </div>
                
                <div id="topicFormContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #ff6b6b; border-radius: 8px; padding: 20px;">
                    <!-- í† ë¡  ì£¼ì œ ìƒì„± í¼ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                
                <div id="topicsListContainer" style="display: none; margin-top: 20px; background: white; border: 2px solid #a55eea; border-radius: 8px; padding: 20px;">
                    <!-- í† ë¡  ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 3px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">âœ… 4ë‹¨ê³„ êµ¬í˜„ ì™„ë£Œ ê¸°ëŠ¥</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #155724;">
                        <li>âœ“ í† ë¡  ì£¼ì œ ìƒì„± ë° ê´€ë¦¬</li>
                        <li>âœ“ ë‹¤ì–‘í•œ í† ë¡  ìœ í˜• ì§€ì›</li>
                        <li>âœ“ í† ë¡  ëª©ë¡ ë° ìƒíƒœ ê´€ë¦¬</li>
                        <li>âœ“ Firebase ì—°ë™ ì‹¤ì‹œê°„ ë°ì´í„° ì €ì¥</li>
                    </ul>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #007bff;">
                    <h4 style="color: #495057; margin-bottom: 10px;">ğŸš€ 5ë‹¨ê³„ ê°œë°œ ì™„ë£Œ ê¸°ëŠ¥</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                        <li>âœ“ ì‹¤ì‹œê°„ ë©”ì‹ ì € í† ë¡ </li>
                        <li>âœ“ í¬ìŠ¤íŠ¸ì‡ ìŠ¤íƒ€ì¼ í† ë¡ </li>
                        <li>âœ“ ì°¬ë°˜ í† ë¡  ì‹œìŠ¤í…œ</li>
                        <li>âœ“ í† ë¡  ì‹œê°„ ê´€ë¦¬ ë° í†µê³„</li>
                    </ul>
                </div>
                
                <button class="btn btn-secondary" onclick="startStep3()" style="margin-top: 15px;">
                    ğŸ”™ ë°˜ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            `;
        }
        
        // í† ë¡  ëª©ë¡ ëª¨ë‹¬ í‘œì‹œ
        function showTopicsListModal() {
            addLog('ğŸ“‹ í† ë¡  ëª©ë¡ ëª¨ë‹¬ í‘œì‹œ', 'info');
            hideAllForms();
            const listContainer = document.getElementById('topicsListContainer');
            if (!listContainer) {
                addLog('âŒ topicsListContainer ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            listContainer.style.display = 'block';
            listContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #a55eea; margin: 0;">ğŸ“‹ í† ë¡  ì£¼ì œ ëª©ë¡</h4>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="loadTopicsFromFirebase()" style="padding: 6px 10px; font-size: 11px;">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button class="btn btn-secondary" onclick="hideAllForms()" style="padding: 4px 8px; font-size: 12px;">âœ–ï¸</button>
                    </div>
                </div>
                
                <div id="topicsListContent" style="min-height: 200px;">
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        ğŸ” í† ë¡  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            `;
            
            // Firebaseì—ì„œ í† ë¡  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            loadTopicsFromFirebase();
        }
        
        // ëª¨ë“  í¼ ìˆ¨ê¸°ê¸°
        function hideAllForms() {
            const topicForm = document.getElementById('topicFormContainer');
            const topicsList = document.getElementById('topicsListContainer');
            
            if (topicForm) topicForm.style.display = 'none';
            if (topicsList) topicsList.style.display = 'none';
        }
        
        // í† ë¡  ì£¼ì œ ìƒì„±í•˜ê¸°
        async function createDiscussionTopic() {
            const title = document.getElementById('topicTitle').value.trim();
            const description = document.getElementById('topicDescription').value.trim();
            const type = document.getElementById('topicType').value;
            const duration = parseInt(document.getElementById('topicDuration').value);
            const allowAnonymous = document.getElementById('allowAnonymous').checked;
            const allowStudentPost = document.getElementById('allowStudentPost').checked;
            
            if (!title) {
                alert('âš ï¸ í† ë¡  ì£¼ì œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!currentClassId) {
                alert('âš ï¸ ì„ íƒëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°˜ì— ì…ì¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const createBtn = document.getElementById('createTopicBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'â³ ìƒì„± ì¤‘...';
            
            try {
                // ì „ì—­ Firebase ì‚¬ìš©
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ê³ ìœ  í† ë¡  ID ìƒì„±
                const topicId = `topic_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // í† ë¡  ë°ì´í„° ìƒì„±
                const topicData = {
                    id: topicId,
                    title: title,
                    description: description,
                    type: type,
                    duration: duration,
                    settings: {
                        allowAnonymous: allowAnonymous,
                        allowStudentPost: allowStudentPost
                    },
                    status: 'active',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    startedAt: firebase.database.ServerValue.TIMESTAMP,
                    endTime: Date.now() + (duration * 60 * 1000),
                    classId: currentClassId,
                    participantCount: 0,
                    messageCount: 0,
                    participants: {},
                    messages: {},
                    votes: {},
                    results: {}
                };
                
                addLog(`ğŸ’¬ ìƒˆ í† ë¡  ì£¼ì œ ìƒì„± ì¤‘: ${title}`, 'info');
                addLog(`ğŸ“ í† ë¡  ìœ í˜•: ${type}`, 'info');
                
                // Firebaseì— í† ë¡  ì£¼ì œ ì €ì¥
                await database.ref(`classes/${currentClassId}/discussions/${topicId}`).set(topicData);
                
                // ì „ì²´ í† ë¡  ì¸ë±ìŠ¤ì—ë„ ì €ì¥
                await database.ref('discussions/' + topicId).set({
                    ...topicData,
                    classId: currentClassId
                });
                
                addLog(`âœ… í† ë¡  ì£¼ì œ ìƒì„± ì™„ë£Œ: ${title}`, 'success');
                
                // UI ì—…ë°ì´íŠ¸
                hideAllForms();
                showTopicsList();
                
                // ì„±ê³µ ì•Œë¦¼
                const typeNames = {
                    'debate': 'ì°¬ë°˜ í† ë¡ ',
                    'discussion': 'ììœ  í† ë¡ ',
                    'postit': 'í¬ìŠ¤íŠ¸ì‡ í† ë¡ ',
                    'survey': 'ì„¤ë¬¸ ì¡°ì‚¬'
                };
                
                alert(`ğŸ‰ í† ë¡  ì£¼ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ¯ ì£¼ì œ: ${title}\nğŸ“ ìœ í˜•: ${typeNames[type]}\nâ° ì‹œê°„: ${duration}ë¶„\n\ní•™ìƒë“¤ì´ ì§€ê¸ˆ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`);
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ í† ë¡  ì£¼ì œ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                
                let errorMsg = 'âŒ í† ë¡  ì£¼ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                if (error.message.includes('PERMISSION_DENIED')) {
                    errorMsg += `ğŸ“‹ Firebase Database ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!\n\n"ğŸ”§ DB ê·œì¹™ ë„ì›€ë§" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„¤ì •í•´ì£¼ì„¸ìš”.`;
                } else {
                    errorMsg += `ì˜¤ë¥˜: ${error.message}`;
                }
                
                alert(errorMsg);
                
                // ë²„íŠ¼ ë³µì›
                createBtn.disabled = false;
                createBtn.textContent = 'ğŸš€ í† ë¡  ì‹œì‘í•˜ê¸°';
            }
        }
        
        // Firebaseì—ì„œ í† ë¡  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadTopicsFromFirebase() {
            if (!currentClassId) {
                document.getElementById('topicsListContent').innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        âš ï¸ ì„ íƒëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € ë°˜ì— ì…ì¥í•´ì£¼ì„¸ìš”.
                    </div>
                `;
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                addLog('ğŸ” í† ë¡  ëª©ë¡ ë¡œë“œ ì¤‘...', 'info');
                
                // ë°˜ì˜ í† ë¡  ì£¼ì œë“¤ ê°€ì ¸ì˜¤ê¸°
                const topicsSnapshot = await database.ref(`classes/${currentClassId}/discussions`).once('value');
                
                if (!topicsSnapshot.exists()) {
                    document.getElementById('topicsListContent').innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            ğŸ“‚ ì•„ì§ ìƒì„±ëœ í† ë¡  ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.<br><br>
                            "ğŸ“ í† ë¡  ì£¼ì œ ë§Œë“¤ê¸°" ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ì£¼ì œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!
                        </div>
                    `;
                    return;
                }
                
                const topics = topicsSnapshot.val();
                const topicsList = Object.values(topics).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                addLog(`âœ… í† ë¡  ëª©ë¡ ë¡œë“œ ì™„ë£¼: ${topicsList.length}ê°œ`, 'success');
                
                // í† ë¡  ëª©ë¡ HTML ìƒì„±
                let topicsHTML = '';
                topicsList.forEach(topic => {
                    const createdDate = new Date(topic.createdAt).toLocaleString();
                    const endTime = new Date(topic.endTime);
                    const now = new Date();
                    const isActive = now < endTime && topic.status === 'active';
                    
                    const typeIcons = {
                        'debate': 'ğŸ¤¼',
                        'discussion': 'ğŸ’¬',
                        'postit': 'ğŸ“',
                        'survey': 'ğŸ“Š'
                    };
                    
                    const typeNames = {
                        'debate': 'ì°¬ë°˜ í† ë¡ ',
                        'discussion': 'ììœ  í† ë¡ ',
                        'postit': 'í¬ìŠ¤íŠ¸ì‡ í† ë¡ ',
                        'survey': 'ì„¤ë¬¸ ì¡°ì‚¬'
                    };
                    
                    const statusBadge = isActive ? 
                        '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">LIVE</span>' :
                        '<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">ì¢…ë£Œ</span>';
                    
                    topicsHTML += `
                        <div class="topic-item" style="background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin-bottom: 12px; ${isActive ? 'border-left: 4px solid #28a745;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <h5 style="margin: 0 0 4px 0; color: #343a40; display: flex; align-items: center; gap: 8px;">
                                        ${typeIcons[topic.type]} ${topic.title} ${statusBadge}
                                    </h5>
                                    <p style="margin: 0 0 8px 0; font-size: 12px; color: #6c757d;">
                                        ${typeNames[topic.type]} | ìƒì„±: ${createdDate} | ì°¸ì—¬: ${topic.participantCount || 0}ëª…
                                    </p>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${isActive ? `
                                        <button class="btn btn-success" onclick="enterDiscussion('${topic.id}', '${topic.title}')" style="padding: 6px 10px; font-size: 11px;">
                                            ğŸšª ì°¸ì—¬
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-info" onclick="viewTopicDetails('${topic.id}')" style="padding: 6px 10px; font-size: 11px;">
                                        ğŸ“‹ ìƒì„¸
                                    </button>
                                    <button class="btn btn-warning" onclick="downloadTopicCSV('${topic.id}')" style="padding: 6px 10px; font-size: 11px;">
                                        ğŸ“¥ CSV
                                    </button>
                                    <button class="btn" onclick="deleteTopic('${topic.id}', '${topic.title}')" style="padding: 6px 10px; font-size: 11px; background: #dc3545; color: white;">
                                        ğŸ—‘ï¸ ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                            ${topic.description ? `<p style="margin: 0; font-size: 13px; color: #495057; background: #f8f9fa; padding: 8px; border-radius: 4px;">${topic.description}</p>` : ''}
                        </div>
                    `;
                });
                
                document.getElementById('topicsListContent').innerHTML = topicsHTML;
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ í† ë¡  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                document.getElementById('topicsListContent').innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        âŒ í† ë¡  ëª©ë¡ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                        ì˜¤ë¥˜: ${error.message}
                    </div>
                `;
            }
        }
        
        // í† ë¡  ìƒì„¸ ë³´ê¸°
        // í† ë¡  ìƒì„¸ ë³´ê¸° (ì´ë ¥)
        async function viewTopicDetails(topicId) {
            try {
                addLog(`ğŸ“‹ í† ë¡  ìƒì„¸ ë¡œë“œ ì¤‘: ${topicId}`, 'info');
                
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // í† ë¡  ê¸°ë³¸ ì •ë³´ ë¡œë“œ
                const topicSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}`).once('value');
                const topicData = topicSnapshot.val();
                
                if (!topicData) {
                    alert('í† ë¡  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // í† ë¡  ë©”ì‹œì§€/í¬ìŠ¤íŠ¸ì‡ ë¡œë“œ
                const messagesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/messages`).once('value');
                const messages = messagesSnapshot.val() || {};
                
                // ì°¬ë°˜ í† ë¡ ì¸ ê²½ìš° íˆ¬í‘œ ë°ì´í„°ë„ ë¡œë“œ
                let votes = {};
                if (topicData.type === 'debate') {
                    const votesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/votes`).once('value');
                    votes = votesSnapshot.val() || {};
                }
                
                // ì°¸ì—¬ì ë°ì´í„° ë¡œë“œ
                const participantsSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                // ìƒì„¸ í™”ë©´ í‘œì‹œ
                showTopicDetailsModal(topicData, messages, votes, participants);
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                console.error('í† ë¡  ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                addLog(`âŒ í† ë¡  ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert('í† ë¡  ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // í† ë¡  ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
        function showTopicDetailsModal(topicData, messages, votes, participants) {
            const typeNames = {
                'debate': 'ì°¬ë°˜ í† ë¡ ',
                'discussion': 'ììœ  í† ë¡ ', 
                'postit': 'í¬ìŠ¤íŠ¸ì‡ í† ë¡ ',
                'survey': 'ì„¤ë¬¸ ì¡°ì‚¬'
            };
            
            const createdDate = new Date(topicData.createdAt).toLocaleString();
            const endDate = topicData.endTime ? new Date(topicData.endTime).toLocaleString() : 'ì§„í–‰ ì¤‘';
            const participantCount = Object.keys(participants).length;
            const messageCount = Object.keys(messages).length;
            
            // ëª¨ë‹¬ HTML ìƒì„±
            const modalHTML = `
                <div id="topicDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <!-- í—¤ë” -->
                        <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0 0 8px 0;">ğŸ“‹ ${topicData.title}</h3>
                                    <p style="margin: 0; opacity: 0.9;">${typeNames[topicData.type] || 'í† ë¡ '} â€¢ ${createdDate}</p>
                                </div>
                                <button onclick="closeTopicDetailsModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">Ã—</button>
                            </div>
                        </div>
                        
                        <!-- ë‚´ìš© -->
                        <div style="padding: 20px;">
                            <!-- ê¸°ë³¸ ì •ë³´ -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div>
                                        <strong>ğŸ“… ìƒì„± ì‹œê°„</strong><br>
                                        <span style="color: #6c757d;">${createdDate}</span>
                                    </div>
                                    <div>
                                        <strong>â° ì¢…ë£Œ ì‹œê°„</strong><br>
                                        <span style="color: #6c757d;">${endDate}</span>
                                    </div>
                                    <div>
                                        <strong>ğŸ‘¥ ì°¸ì—¬ì ìˆ˜</strong><br>
                                        <span style="color: #6c757d;">${participantCount}ëª…</span>
                                    </div>
                                    <div>
                                        <strong>ğŸ’¬ ë©”ì‹œì§€ ìˆ˜</strong><br>
                                        <span style="color: #6c757d;">${messageCount}ê°œ</span>
                                    </div>
                                </div>
                                ${topicData.description ? `
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                        <strong>ğŸ“ ì„¤ëª…</strong><br>
                                        <span style="color: #6c757d;">${topicData.description}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- í† ë¡  ë‚´ìš© -->
                            <div id="topicContent">
                                ${generateTopicContent(topicData.type, messages, votes, participants)}
                            </div>
                        </div>
                        
                        <!-- í‘¸í„° -->
                        <div style="padding: 15px 20px; border-top: 1px solid #dee2e6; text-align: right;">
                            <button class="btn btn-secondary" onclick="closeTopicDetailsModal()">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // í† ë¡  íƒ€ì…ë³„ ë‚´ìš© ìƒì„±
        function generateTopicContent(type, messages, votes, participants) {
            if (type === 'debate') {
                return generateDebateContent(votes, participants);
            } else {
                return generateDiscussionContent(messages, participants);
            }
        }

        // ì°¬ë°˜ í† ë¡  ë‚´ìš© ìƒì„±
        function generateDebateContent(votes, participants) {
            const agreeVotes = [];
            const disagreeVotes = [];
            
            Object.values(votes).forEach(vote => {
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            const agreeCount = agreeVotes.length;
            const disagreeCount = disagreeVotes.length;
            const total = agreeCount + disagreeCount;
            
            const agreePercent = total > 0 ? (agreeCount / total * 100).toFixed(1) : 0;
            const disagreePercent = total > 0 ? (disagreeCount / total * 100).toFixed(1) : 0;
            
            return `
                <!-- íˆ¬í‘œ ê²°ê³¼ -->
                <div style="margin-bottom: 25px;">
                    <h5 style="margin-bottom: 15px;">ğŸ“Š ìµœì¢… íˆ¬í‘œ ê²°ê³¼</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
                            <div style="flex: 1; background: #d4edda; height: 30px; border-radius: 15px; position: relative; overflow: hidden;">
                                <div style="background: #28a745; height: 100%; width: ${agreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 12px;">
                                    ì°¬ì„± ${agreeCount}ëª… (${agreePercent}%)
                                </span>
                            </div>
                            <div style="flex: 1; background: #f8d7da; height: 30px; border-radius: 15px; position: relative; overflow: hidden;">
                                <div style="background: #dc3545; height: 100%; width: ${disagreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 12px;">
                                    ë°˜ëŒ€ ${disagreeCount}ëª… (${disagreePercent}%)
                                </span>
                            </div>
                        </div>
                        <div style="text-align: center; color: #6c757d; font-size: 12px;">
                            ì´ ${total}ëª…ì´ íˆ¬í‘œì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤
                        </div>
                    </div>
                </div>
                
                <!-- ì˜ê²¬ ëª©ë¡ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h6 style="color: #28a745; margin-bottom: 10px;">âœ… ì°¬ì„± ì˜ê²¬ (${agreeCount}ê°œ)</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${agreeVotes.map(vote => `
                                <div style="background: #d4edda; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-size: 11px; color: #155724; margin-bottom: 5px;">
                                        ${vote.participantName || vote.participantId || 'ìµëª…'} â€¢ ${new Date(vote.timestamp).toLocaleTimeString()}
                                    </div>
                                    <div style="font-size: 13px; color: #155724;">
                                        ${vote.opinion}${vote.isEdited ? ' <small>(ìˆ˜ì •ë¨)</small>' : ''}
                                    </div>
                                </div>
                            `).join('') || '<div style="text-align: center; color: #6c757d; padding: 20px;">ì°¬ì„± ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                        </div>
                    </div>
                    <div>
                        <h6 style="color: #dc3545; margin-bottom: 10px;">âŒ ë°˜ëŒ€ ì˜ê²¬ (${disagreeCount}ê°œ)</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${disagreeVotes.map(vote => `
                                <div style="background: #f8d7da; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-size: 11px; color: #721c24; margin-bottom: 5px;">
                                        ${vote.participantName || vote.participantId || 'ìµëª…'} â€¢ ${new Date(vote.timestamp).toLocaleTimeString()}
                                    </div>
                                    <div style="font-size: 13px; color: #721c24;">
                                        ${vote.opinion}${vote.isEdited ? ' <small>(ìˆ˜ì •ë¨)</small>' : ''}
                                    </div>
                                </div>
                            `).join('') || '<div style="text-align: center; color: #6c757d; padding: 20px;">ë°˜ëŒ€ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // ììœ  í† ë¡ /í¬ìŠ¤íŠ¸ì‡ ë‚´ìš© ìƒì„±
        function generateDiscussionContent(messages, participants) {
            const messageArray = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
            const postits = messageArray.filter(msg => msg.type === 'postit');
            const chatMessages = messageArray.filter(msg => msg.type !== 'postit');
            
            return `
                <!-- í¬ìŠ¤íŠ¸ì‡ -->
                ${postits.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h5 style="margin-bottom: 15px;">ğŸ“ í¬ìŠ¤íŠ¸ì‡ ì˜ê²¬ (${postits.length}ê°œ)</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            ${postits.map(postit => `
                                <div style="background: ${getPostitColor(postit.color)}; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                                    <div style="font-size: 13px; line-height: 1.4; margin-bottom: 8px;">
                                        ${postit.content}${postit.isEdited ? ' <small style="opacity: 0.7;">(ìˆ˜ì •ë¨)</small>' : ''}
                                    </div>
                                    <div style="font-size: 10px; opacity: 0.7; position: absolute; bottom: 5px; right: 8px;">
                                        ${postit.participantName}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- ì±„íŒ… ë©”ì‹œì§€ -->
                ${chatMessages.length > 0 ? `
                    <div>
                        <h5 style="margin-bottom: 15px;">ğŸ’¬ í† ë¡  ë©”ì‹œì§€ (${chatMessages.length}ê°œ)</h5>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            ${chatMessages.map(msg => `
                                <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 5px;">
                                        ${msg.participantName} â€¢ ${new Date(msg.timestamp).toLocaleTimeString()}
                                    </div>
                                    <div style="font-size: 13px; color: #495057;">
                                        ${msg.content || msg.text}${msg.isEdited ? ' <small style="opacity: 0.7;">(ìˆ˜ì •ë¨)</small>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${postits.length === 0 && chatMessages.length === 0 ? `
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        ğŸ’­ ì´ í† ë¡ ì—ëŠ” ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤
                    </div>
                ` : ''}
                
                <!-- ì°¸ì—¬ì ëª©ë¡ -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                    <h6 style="margin-bottom: 10px;">ğŸ‘¥ ì°¸ì—¬ì ëª©ë¡</h6>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${Object.values(participants).map(participant => `
                            <span style="background: #e7f3ff; color: #0056b3; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                                ${participant.name}
                            </span>
                        `).join('') || '<span style="color: #6c757d;">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤</span>'}
                    </div>
                </div>
            `;
        }

        // í¬ìŠ¤íŠ¸ì‡ ìƒ‰ìƒ ë³€í™˜
        function getPostitColor(color) {
            const colors = {
                'yellow': '#ffeb3b',
                'blue': '#2196f3', 
                'green': '#4caf50',
                'pink': '#e91e63'
            };
            return colors[color] || '#ffeb3b';
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeTopicDetailsModal() {
            const modal = document.getElementById('topicDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // í† ë¡ ì— ì°¸ì—¬í•˜ê¸°
        async function enterDiscussion(topicId, topicTitle) {
            addLog(`ğŸšª í† ë¡  ì°¸ì—¬: ${topicTitle}`, 'success');
            
            // 5ë‹¨ê³„ë¡œ ì§„í–‰
            updateCurrentStep(5, `ì‹¤ì‹œê°„ í† ë¡  - ${topicTitle}`);
            currentTopicId = topicId;
            
            // í† ë¡  ë°ì´í„° ë¡œë“œ
            await loadDiscussionData(topicId);
            
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="color: white; margin: 0 0 5px 0;">ğŸ‰ ${topicTitle}</h3>
                    <p style="color: #f8f9fa; margin: 0; font-size: 13px;">5ë‹¨ê³„: ì‹¤ì‹œê°„ í† ë¡  ì§„í–‰ ì¤‘</p>
                </div>
                
                <!-- ì°¸ì—¬ì ì •ë³´ ì…ë ¥ -->
                <div id="participantForm" style="background: white; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="color: #007bff; margin: 0 0 10px 0;">ğŸ‘¤ ì°¸ì—¬ì ì •ë³´</h4>
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div style="flex: 1;">
                            <label for="participantName" style="display: block; margin-bottom: 5px; font-size: 12px; color: #495057;">ì´ë¦„</label>
                            <input type="text" id="participantName" placeholder="ê¹€ë¯¼ìˆ˜" maxlength="20" 
                                style="width: 100%; padding: 8px; border: 2px solid #dee2e6; border-radius: 4px; font-size: 14px;" />
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; margin-bottom: 5px;">
                                <input type="checkbox" id="isAnonymous"> ìµëª… ì°¸ì—¬
                            </label>
                            <button class="btn btn-primary" onclick="joinDiscussion()" style="padding: 8px 15px; font-size: 13px;">
                                ğŸš€ ì°¸ì—¬í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- í† ë¡  ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ë¹„í™œì„±í™”) -->
                <div id="discussionArea" style="display: none;">
                    <!-- ì‹¤ì‹œê°„ í† ë¡  UIê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
                </div>
            `;
            
            // ì´ë¦„ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('participantName').focus();
            }, 100);
        }
        
        // =========================
        // 5ë‹¨ê³„: ì‹¤ì‹œê°„ í† ë¡  ê¸°ëŠ¥
        // =========================
        
        let currentTopicId = null;
        let currentTopicData = null;
        let currentParticipantId = null;
        let discussionListener = null;
        
        // í† ë¡  ë°ì´í„° ë¡œë“œ
        async function loadDiscussionData(topicId) {
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const topicSnapshot = await database.ref('discussions/' + topicId).once('value');
                if (topicSnapshot.exists()) {
                    currentTopicData = topicSnapshot.val();
                    addLog(`âœ… í† ë¡  ë°ì´í„° ë¡œë“œ: ${currentTopicData.title}`, 'success');
                } else {
                    throw new Error('í† ë¡  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ í† ë¡  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // í† ë¡ ì— ì°¸ì—¬í•˜ê¸°
        async function joinDiscussion() {
            const participantName = document.getElementById('participantName').value.trim();
            const isAnonymous = document.getElementById('isAnonymous').checked;
            
            if (!participantName && !isAnonymous) {
                alert('âš ï¸ ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜ ìµëª… ì°¸ì—¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const displayName = isAnonymous ? `ìµëª…${Math.floor(Math.random() * 1000)}` : participantName;
                
                // ì°¸ì—¬ì IDë¥¼ ì´ë¦„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„± (ì¤‘ë³µ ì°¸ì—¬ ë°©ì§€)
                const participantNameForId = displayName.replace(/[^a-zA-Z0-9ê°€-í£]/g, ''); // íŠ¹ìˆ˜ë¬¸ì ì œê±°
                currentParticipantId = `participant_${participantNameForId}_${currentClassId}_${currentTopicId}`;
                
                // ê¸°ì¡´ ì°¸ì—¬ìì¸ì§€ í™•ì¸
                const existingParticipant = await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}`).once('value');
                
                if (existingParticipant.exists()) {
                    // ê¸°ì¡´ ì°¸ì—¬ìë¼ë©´ ì¬ì°¸ì—¬ ì²˜ë¦¬
                    addLog(`ğŸ”„ ê¸°ì¡´ ì°¸ì—¬ìë¡œ ì¬ì°¸ì—¬: ${displayName}`, 'info');
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}/lastActive`).set(firebase.database.ServerValue.TIMESTAMP);
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}/rejoined`).set(true);
                } else {
                    // ìƒˆ ì°¸ì—¬ìë¼ë©´ ì°¸ì—¬ì ìˆ˜ ì¦ê°€
                    await database.ref(`discussions/${currentTopicId}/participantCount`).transaction(count => {
                        return (count || 0) + 1;
                    });
                    addLog(`âœ¨ ìƒˆ ì°¸ì—¬ì ë“±ë¡: ${displayName}`, 'success');
                }
                
                // ì°¸ì—¬ì ì •ë³´ ë“±ë¡
                const participantData = {
                    id: currentParticipantId,
                    name: displayName,
                    isAnonymous: isAnonymous,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants/${currentParticipantId}`).set(participantData);
                
                // ì°¸ì—¬ì ìˆ˜ ì¦ê°€
                await database.ref(`discussions/${currentTopicId}/participantCount`).transaction(count => {
                    return (count || 0) + 1;
                });
                
                addLog(`âœ… í† ë¡  ì°¸ì—¬ ì™„ë£Œ: ${displayName}`, 'success');
                
                // ì°¸ì—¬ í¼ ìˆ¨ê¸°ê³  í† ë¡  UI í‘œì‹œ
                document.getElementById('participantForm').style.display = 'none';
                document.getElementById('discussionArea').style.display = 'block';
                
                // ì‹¤ì‹œê°„ í† ë¡  UI ì´ˆê¸°í™”
                initializeDiscussionUI();
                
                // ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì‹œì‘
                setupRealTimeListeners();
                
                // í† ë¡  ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
                startDiscussionTimer();
                
                // í† ë¡ ë°© í—¤ë” ì—…ë°ì´íŠ¸ (ëŒì•„ê°€ê¸° ë²„íŠ¼)
                updateHeaderForDiscussion();
                
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ í† ë¡  ì°¸ì—¬ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert(`âŒ í† ë¡  ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // ì‹¤ì‹œê°„ í† ë¡  UI ì´ˆê¸°í™”
        function initializeDiscussionUI() {
            const discussionArea = document.getElementById('discussionArea');
            
            const typeUIMap = {
                'discussion': createDiscussionUI,
                'postit': createPostitUI,
                'debate': createDebateUI,
                'survey': createSurveyUI
            };
            
            const createUI = typeUIMap[currentTopicData.type] || createDiscussionUI;
            discussionArea.innerHTML = createUI();
            
            // êµì‚¬ ì œì–´ íŒ¨ë„ ì´ˆê¸°í™”
            initializeTeacherControls();
        }
        
        // ê³µí†µ êµì‚¬ ì œì–´ íŒ¨ë„ HTML ìƒì„±
        function createTeacherControlPanel() {
            return `
                <!-- êµì‚¬ ì œì–´ íŒ¨ë„ -->
                <div style="background: white; border: 2px solid #007bff; border-radius: 8px; margin-bottom: 10px;">
                    <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <h6 style="margin: 0;">ğŸ›ï¸ êµì‚¬ ì œì–´ íŒ¨ë„</h6>
                    </div>
                    <div style="padding: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; margin-bottom: 8px;">
                            <input type="checkbox" id="allowStudentPostToggle" checked onchange="toggleStudentPost()"> 
                            <span>ğŸ“ í•™ìƒ ê²Œì‹œê¸€ í—ˆìš©</span>
                        </label>
                        <div style="font-size: 11px; color: #6c757d; padding-left: 24px; margin-bottom: 15px;">
                            ì²´í¬ í•´ì œ ì‹œ í•™ìƒë“¤ì˜ ë©”ì‹œì§€ ì‘ì„±ì„ ì œí•œí•©ë‹ˆë‹¤
                        </div>
                        
                        <!-- ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ -->
                        <div style="border-top: 1px solid #dee2e6; padding-top: 15px;">
                            <h6 style="margin: 0 0 10px 0; font-size: 13px; color: #495057;">ğŸ’¬ í•™ìƒë“¤ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡</h6>
                            <textarea id="teacherMessageInput" placeholder="í•™ìƒë“¤ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                                style="width: 100%; height: 60px; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; resize: none; font-size: 12px;"></textarea>
                            <button onclick="sendTeacherMessage()" style="margin-top: 8px; background: #28a745; color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 12px; cursor: pointer;">
                                ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // êµì‚¬ ì œì–´ íŒ¨ë„ ì´ˆê¸°í™”
        function initializeTeacherControls() {
            const toggle = document.getElementById('allowStudentPostToggle');
            if (toggle && currentTopicData && currentTopicData.settings) {
                toggle.checked = currentTopicData.settings.allowStudentPost !== false;
            }
        }
        
        // í•™ìƒ ê²Œì‹œê¸€ í—ˆìš©/ì°¨ë‹¨ í† ê¸€
        async function toggleStudentPost() {
            const toggle = document.getElementById('allowStudentPostToggle');
            const allowStudentPost = toggle.checked;
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // Firebaseì— ì„¤ì • ì—…ë°ì´íŠ¸
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/settings/allowStudentPost`).set(allowStudentPost);
                await database.ref(`discussions/${currentTopicId}/settings/allowStudentPost`).set(allowStudentPost);
                
                // í˜„ì¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                if (currentTopicData.settings) {
                    currentTopicData.settings.allowStudentPost = allowStudentPost;
                }
                
                const status = allowStudentPost ? 'í—ˆìš©' : 'ì°¨ë‹¨';
                addLog(`ğŸ“ í•™ìƒ ê²Œì‹œê¸€ ${status}ìœ¼ë¡œ ë³€ê²½ë¨`, allowStudentPost ? 'success' : 'warning');
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ ì„¤ì • ë³€ê²½ ì‹¤íŒ¨: ${error.message}`, 'error');
                // ì‹¤íŒ¨ ì‹œ í† ê¸€ ìƒíƒœ ë˜ëŒë¦¬ê¸°
                toggle.checked = !allowStudentPost;
            }
        }
        
        // êµì‚¬ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        async function sendTeacherMessage() {
            const messageInput = document.getElementById('teacherMessageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                addLog('âŒ ì „ì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            if (!currentTopicId) {
                addLog('âŒ ë¨¼ì € í† ë¡ ì„ ì‹œì‘í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const teacherMessage = {
                    message: message,
                    timestamp: Date.now(),
                    sender: 'teacher',
                    teacherName: getTeacherName(),
                    type: 'teacher_message', // êµì‚¬ ë©”ì‹œì§€ íƒ€ì… êµ¬ë¶„
                    topicId: currentTopicId
                };
                
                // Firebaseì— êµì‚¬ ë©”ì‹œì§€ë¥¼ ë³„ë„ ê²½ë¡œì— ì €ì¥ (ì±„íŒ…ê³¼ ë¶„ë¦¬)
                console.log('êµì‚¬ ë©”ì‹œì§€ ì „ì†¡ ì •ë³´:', {
                    currentTopicId: currentTopicId,
                    message: message,
                    path: `classes/${currentClassId}/discussions/${currentTopicId}/teacherMessages`
                });
                
                // teacherMessagesì™€ ì¼ë°˜ messagesì— ëª¨ë‘ ì €ì¥
                console.log('ğŸ’¬ êµì‚¬ ë©”ì‹œì§€ ì €ì¥ ì¤‘:', teacherMessage);
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/teacherMessages`).push(teacherMessage);
                console.log('ğŸ“¤ teacherMessages ì €ì¥ ì™„ë£Œ');
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages`).push(teacherMessage);
                console.log('ğŸ“¤ messages ì €ì¥ ì™„ë£Œ');
                
                addLog(`ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡ë¨ (í† ë¡ ë°©: ${currentTopicId}): ${message}`, 'success');
                messageInput.value = '';
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // ììœ  í† ë¡  UI ìƒì„±
        function createDiscussionUI() {
            return `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 500px;">
                    <!-- ë©”ì‹œì§€ ì˜ì—­ -->
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; display: flex; flex-direction: column;">
                        <div style="padding: 10px 15px; border-bottom: 1px solid #dee2e6; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                            <h5 style="margin: 0; color: #495057;">ğŸ’¬ í† ë¡  ë©”ì‹œì§€</h5>
                            <button onclick="clearAllMessages()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" title="ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ">
                                ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
                            </button>
                        </div>
                        <div id="messagesContainer" style="flex: 1; padding: 10px; overflow-y: auto; max-height: 380px;">
                            <div style="text-align: center; color: #6c757d; padding: 20px;">
                                ğŸ’¬ í† ë¡ ì„ ì‹œì‘í•´ë³´ì„¸ìš”!
                            </div>
                        </div>
                        <div style="padding: 10px; border-top: 1px solid #dee2e6;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="messageInput" placeholder="ë‚´ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                    style="flex: 1; padding: 8px; border: 2px solid #dee2e6; border-radius: 4px; font-size: 14px;" 
                                    onkeypress="if(event.key==='Enter') sendMessage()" />
                                <button class="btn btn-primary" onclick="sendMessage()" style="padding: 8px 12px;">
                                    ğŸ“¢ ì „ì†¡
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì°¸ì—¬ì ë° ì •ë³´ ì˜ì—­ -->
                    <div>
                        ${createTeacherControlPanel()}
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">ğŸ‘¤ ì°¸ì—¬ì (<span id="participantCount">0</span>ëª…)</h6>
                            </div>
                            <div id="participantsList" style="padding: 10px; max-height: 120px; overflow-y: auto;">
                                ë¡œë”© ì¤‘...
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">ğŸ“‹ ë‹¤ë¥¸ í† ë¡ ë°©</h6>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 10px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="transform: scale(0.8);">
                                    <span>ì¢…ë£Œ</span>
                                </label>
                            </div>
                            <div id="otherRoomsList" style="padding: 10px; max-height: 200px; overflow-y: auto;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">
                                    ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // í¬ìŠ¤íŠ¸ì‡ UI ìƒì„±
        function createPostitUI() {
            return `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                    <!-- ë©”ì¸ í¬ìŠ¤íŠ¸ì‡ ì˜ì—­ -->
                    <div>
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            <h5 style="color: #495057; margin: 0 0 15px 0;">ğŸ“ í¬ìŠ¤íŠ¸ì‡ í† ë¡ </h5>
                            
                            <div style="margin-bottom: 15px;">
                                <textarea id="postitInput" placeholder="ë‚´ ì˜ê²¬ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”..." 
                                    style="width: 100%; height: 80px; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; resize: vertical;"></textarea>
                                <button class="btn btn-success" onclick="addPostit()" style="margin-top: 8px;">
                                    ğŸ“ í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€
                                </button>
                            </div>
                            
                            <div id="postitBoard" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; min-height: 300px; background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; grid-column: 1 / -1;">
                                    ğŸ“ ì•„ì§ ì‘ì„±ëœ í¬ìŠ¤íŠ¸ì‡ì´ ì—†ìŠµë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- êµì‚¬ ì œì–´ íŒ¨ë„ ë° ì •ë³´ ì˜ì—­ -->
                    <div>
                        ${createTeacherControlPanel()}
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">ğŸ‘¤ ì°¸ì—¬ì (<span id="participantCount">0</span>ëª…)</h6>
                            </div>
                            <div id="participantsList" style="padding: 10px; max-height: 120px; overflow-y: auto;">
                                ë¡œë”© ì¤‘...
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">ğŸ“‹ ë‹¤ë¥¸ í† ë¡ ë°©</h6>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 10px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="transform: scale(0.8);">
                                    <span>ì¢…ë£Œ</span>
                                </label>
                            </div>
                            <div id="otherRoomsList" style="padding: 10px; max-height: 200px; overflow-y: auto;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">
                                    ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ì°¬ë°˜ í† ë¡  UI ìƒì„±
        function createDebateUI() {
            return `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                    <!-- ë©”ì¸ ì°¬ë°˜ í† ë¡  ì˜ì—­ -->
                    <div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 15px;">
                        <h5 style="color: #155724; margin: 0 0 10px 0;">âœ… ì°¬ì„± ì˜ê²¬</h5>
                        <div id="agreeSection" style="min-height: 300px;">
                            <textarea id="agreeInput" placeholder="ì°¬ì„± ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #c3e6cb; border-radius: 4px;"></textarea>
                            <button class="btn btn-success" onclick="submitDebateVote('agree')" style="width: 100%; margin-bottom: 10px;">
                                âœ… ì°¬ì„± ì˜ê²¬ ë“±ë¡
                            </button>
                            <div id="agreeList">
                                ë¡œë”© ì¤‘...
                            </div>
                        </div>
                    </div>
                    
                            <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 15px;">
                                <h5 style="color: #721c24; margin: 0 0 10px 0;">âŒ ë°˜ëŒ€ ì˜ê²¬</h5>
                                <div id="disagreeSection" style="min-height: 300px;">
                                    <textarea id="disagreeInput" placeholder="ë°˜ëŒ€ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                        style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #f5c6cb; border-radius: 4px;"></textarea>
                                    <button class="btn" onclick="submitDebateVote('disagree')" 
                                        style="width: 100%; margin-bottom: 10px; background: #dc3545; color: white;">
                                        âŒ ë°˜ëŒ€ ì˜ê²¬ ë“±ë¡
                                    </button>
                                    <div id="disagreeList">
                                        ë¡œë”© ì¤‘...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h6 style="margin: 0; color: #495057;">ğŸ“Š ì‹¤ì‹œê°„ ê²°ê³¼</h6>
                                <button onclick="clearAllMessages()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" title="ëª¨ë“  ì˜ê²¬ ì‚­ì œ">
                                    ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; background: #d4edda; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="agreeBar" style="background: #28a745; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        ì°¬ì„± <span id="agreeCount">0</span>
                                    </span>
                                </div>
                                <div style="flex: 1; background: #f8d7da; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="disagreeBar" style="background: #dc3545; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        ë°˜ëŒ€ <span id="disagreeCount">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- êµì‚¬ ì œì–´ íŒ¨ë„ ë° ì •ë³´ ì˜ì—­ -->
                    <div>
                        ${createTeacherControlPanel()}
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">ğŸ‘¤ ì°¸ì—¬ì (<span id="participantCount">0</span>ëª…)</h6>
                            </div>
                            <div id="participantsList" style="padding: 10px; max-height: 120px; overflow-y: auto;">
                                ë¡œë”© ì¤‘...
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                                <h6 style="margin: 0; color: #495057;">ğŸ“‹ ë‹¤ë¥¸ í† ë¡ ë°©</h6>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 10px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="transform: scale(0.8);">
                                    <span>ì¢…ë£Œ</span>
                                </label>
                            </div>
                            <div id="otherRoomsList" style="padding: 10px; max-height: 200px; overflow-y: auto;">
                                <div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">
                                    ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ì„¤ë¬¸ UI ìƒì„±
        function createSurveyUI() {
            return `
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h5 style="color: #495057; margin: 0 0 15px 0;">ğŸ“Š ì„¤ë¬¸ ì¡°ì‚¬</h5>
                    <p style="color: #6c757d; margin-bottom: 20px;">ê¸°ëŠ¥ ê°œë°œ ì˜ˆì •: ë‹¤ì¤‘ ì„ íƒ, ë‹¨ë‹µí˜•, ì ìˆ˜ í‰ê°€ ë“±</p>
                    
                    <div style="text-align: center; color: #6c757d; padding: 40px; background: #f8f9fa; border-radius: 6px;">
                        ğŸš€ ì„¤ë¬¸ ì¡°ì‚¬ ê¸°ëŠ¥ì€ í–¥í›„ ë²„ì „ì—ì„œ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.
                    </div>
                </div>
            `;
        }
        
        // ë‹¤ë¥¸ í† ë¡ ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateOtherRoomsList() {
            const database = initGlobalDatabase();
            if (!database || !currentClassId) return;
            
            const showClosed = document.getElementById('showClosedRoomsCheckbox').checked;
            
            database.ref(`classes/${currentClassId}/discussions`).once('value', (snapshot) => {
                const discussions = snapshot.val() || {};
                const otherRoomsEl = document.getElementById('otherRoomsList');
                if (!otherRoomsEl) return;
                
                const rooms = Object.entries(discussions)
                    .filter(([id, discussion]) => {
                        if (id === currentTopicId) return false; // í˜„ì¬ ë°© ì œì™¸
                        return showClosed || discussion.status === 'active';
                    })
                    .map(([id, discussion]) => ({
                        id: id,
                        title: discussion.title || 'ì œëª© ì—†ìŒ',
                        status: discussion.status || 'active',
                        participants: discussion.participants || {},
                        type: discussion.type || 'general'
                    }));
                
                if (rooms.length === 0) {
                    const message = showClosed ? 'ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤' : 'ì§„í–‰ ì¤‘ì¸ ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤';
                    otherRoomsEl.innerHTML = `<div style="text-align: center; color: #6c757d; padding: 20px; font-size: 12px;">${message}</div>`;
                    return;
                }
                
                const roomsHtml = rooms.map(room => {
                    const typeEmoji = getTypeEmoji(room.type);
                    const statusText = room.status === 'active' ? 'ì§„í–‰ì¤‘' : 'ì¢…ë£Œë¨';
                    const statusClass = room.status === 'active' ? 'style="color: #28a745;"' : 'style="color: #6c757d;"';
                    
                    return `
                        <div class="room-item-mini" onclick="switchToRoom('${room.id}', '${room.title}', '${room.status}')" 
                             style="padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 11px; border: 1px solid #e9ecef;" 
                             onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                            <div style="font-weight: bold; margin-bottom: 2px;">${typeEmoji} ${room.title}</div>
                            <div ${statusClass}>${statusText} â€¢ ${Object.keys(room.participants || {}).length}ëª…</div>
                        </div>
                    `;
                }).join('');
                
                otherRoomsEl.innerHTML = roomsHtml;
            });
        }
        
        // ì¢…ë£Œëœ ë°© ë³´ê¸° í† ê¸€
        function toggleClosedRooms() {
            updateOtherRoomsList();
        }
        
        // í† ë¡ ë°© ì „í™˜
        function switchToRoom(roomId, roomTitle, status) {
            if (status !== 'active') {
                alert('ì§„í–‰ ì¤‘ì¸ í† ë¡ ë§Œ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (confirm(`í˜„ì¬ í† ë¡ ì„ ë‚˜ê°€ê³  "${roomTitle}" í† ë¡ ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                addLog(`ğŸ”„ í† ë¡ ë°© ì „í™˜: ${roomTitle}`, 'info');
                
                // Firebase ì—°ê²°ì„ ìœ ì§€í•˜ë©´ì„œ í† ë¡ ë°© ì§ì ‘ ì „í™˜
                currentTopicId = roomId;
                window.currentTopicTitle = roomTitle;
                
                // 3ë‹¨ê³„(ì‹¤ì‹œê°„ í† ë¡ ê´€ë¦¬) í—¤ë”ë¡œ ë³€ê²½
                updateHeaderForDiscussion();
                
                // í† ë¡  ë°ì´í„° ë¡œë“œ í›„ UI ì—…ë°ì´íŠ¸
                loadDiscussionDataForTeacher(roomId).then(() => {
                    if (currentTopicData) {
                        // í† ë¡  ìœ í˜•ì— ë”°ë¼ ì ì ˆí•œ UI í‘œì‹œ
                        initializeDiscussionUI();
                        setupRealTimeListeners();
                        startDiscussionTimer();
                        addLog(`âœ… "${roomTitle}" í† ë¡  ì°¸ì—¬ ì™„ë£Œ`, 'success');
                    } else {
                        addLog(`âŒ "${roomTitle}" í† ë¡  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨`, 'error');
                        alert('í† ë¡  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }).catch(error => {
                    addLog(`âŒ í† ë¡ ë°© ì „í™˜ ì‹¤íŒ¨: ${error.message}`, 'error');
                    alert(`í† ë¡ ë°© ì „í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.message}`);
                });
            }
        }
        
        // í† ë¡  íƒ€ì…ë³„ ì´ëª¨ì§€ ë°˜í™˜
        function getTypeEmoji(type) {
            switch(type) {
                case 'general': return 'ğŸ’¬';
                case 'postit': return 'ğŸ“';
                case 'debate': return 'âš–ï¸';
                case 'survey': return 'ğŸ“Š';
                default: return 'ğŸ’¬';
            }
        }
        
        // Database ê·œì¹™ ë„ì›€ë§ ë²„íŠ¼ ì¶”ê°€
        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const messageText = document.getElementById('messageInput').value.trim();
            if (!messageText) return;
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const messageData = {
                    id: messageId,
                    text: messageText,
                    participantId: currentParticipantId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'message'
                };
                
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages/${messageId}`).set(messageData);
                
                // ë©”ì‹œì§€ ìˆ˜ ì¦ê°€
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messageCount`).transaction(count => {
                    return (count || 0) + 1;
                });
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('messageInput').value = '';
                document.getElementById('messageInput').focus();
                
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì„¤ì •
        function setupRealTimeListeners() {
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ë©”ì‹œì§€ ìˆ˜ì‹ 
                database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages`).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    displayMessage(message);
                });
                
                // ì°¸ì—¬ì ìˆ˜ì‹ 
                database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/participants`).on('value', (snapshot) => {
                    const participants = snapshot.val() || {};
                    updateParticipantsList(participants);
                });
                
                // ë‹¤ë¥¸ í† ë¡ ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
                updateOtherRoomsList();
                
                // ì°¬ë°˜ í† ë¡  íˆ¬í‘œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                if (currentTopicData && currentTopicData.type === 'debate') {
                    database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes`).on('value', (snapshot) => {
                        const votes = snapshot.val() || {};
                        updateDebateResults(votes);
                    });
                }
                
                // í¬ìŠ¤íŠ¸ì‡ í† ë¡  ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸  
                if (currentTopicData && currentTopicData.type === 'postit') {
                    database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/postits`).on('child_added', (snapshot) => {
                        const postit = snapshot.val();
                        displayPostit(postit);
                    });
                }
                
                addLog('âœ… ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì‹œì‘', 'success');
                
            } catch (error) {
                addLog(`âŒ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì„¤ì • ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function displayMessage(message) {
            // DOMì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            setTimeout(() => {
                // í† ë¡  íƒ€ì…ì— ë”°ë¼ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
                let messagesContainer = document.getElementById('messagesContainer'); // ì±„íŒ…í˜•, ì¼ë°˜í˜•
                
                if (!messagesContainer) {
                    // í¬ìŠ¤íŠ¸ì‡ í† ë¡ ì˜ ê²½ìš°
                    messagesContainer = document.getElementById('postitBoard');
                }
                
                if (!messagesContainer) {
                    // ì°¬ë°˜í† ë¡ ì˜ ê²½ìš° - ì°¬ì„±/ë°˜ëŒ€ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì²˜ë¦¬
                    if (message.position === 'agree') {
                        messagesContainer = document.getElementById('agreeList');
                    } else if (message.position === 'disagree') {
                        messagesContainer = document.getElementById('disagreeList');
                    } else if (message.sender === 'teacher' || message.type === 'teacher_message') {
                        // êµì‚¬ ë©”ì‹œì§€ëŠ” ì°¬ë°˜í† ë¡ ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ - ë³„ë„ ì²˜ë¦¬ í•„ìš”
                        console.log('âš ï¸ êµì‚¬ ë©”ì‹œì§€ëŠ” ì°¬ë°˜í† ë¡  UIì— í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', message);
                        return; // êµì‚¬ ë©”ì‹œì§€ëŠ” ì°¬ë°˜í† ë¡  UIì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    } else {
                        // ê¸°íƒ€ ì¼ë°˜ ë©”ì‹œì§€ë§Œ ì°¬ì„± ì˜ì—­ì— í‘œì‹œ
                        messagesContainer = document.getElementById('agreeList');
                    }
                }
                
                // ì—¬ì „íˆ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´
                if (!messagesContainer) {
                    console.warn('ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í† ë¡  íƒ€ì…:', currentTopicData?.type);
                    addLog('âŒ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // ì‹¤ì œ ë©”ì‹œì§€ í‘œì‹œ ë¡œì§
                renderMessageInContainer(message, messagesContainer);
            }, 100);
        }
        
        // ì‹¤ì œ ë©”ì‹œì§€ ë Œë”ë§ í•¨ìˆ˜
        function renderMessageInContainer(message, messagesContainer) {
            
            // ì²˜ìŒ ë©”ì‹œì§€ì¼ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
            const welcomeMsg = messagesContainer.querySelector('[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            console.log('ğŸ“ ë©”ì‹œì§€ ë Œë”ë§:', message);
            console.log('ğŸ“ ì»¨í…Œì´ë„ˆ:', messagesContainer.id);
            
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                margin-bottom: 10px; 
                padding: 8px 12px; 
                background: ${message.sender === 'teacher' ? '#fff3cd' : '#f8f9fa'};
                border-radius: 8px;
                border-left: 3px solid ${message.sender === 'teacher' ? '#ffc107' : '#6c757d'};
            `;
            
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            const senderName = message.sender === 'teacher' ? (message.teacherName || getTeacherName()) : (message.participantName || message.participantId || message.name || message.sender || 'í•™ìƒ');
            
            messageEl.innerHTML = `
                <div style="font-size: 11px; color: #6c757d; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>${senderName}</strong> - ${timestamp}</span>
                    <button onclick="deleteMessage('${message.id || message.messageId}', '${message.type || 'message'}')" 
                            style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="ë©”ì‹œì§€ ì‚­ì œ">ğŸ—‘ï¸</button>
                </div>
                <div style="font-size: 14px; color: #343a40;">${message.content || message.message || message.text || 'ë‚´ìš© ì—†ìŒ'}${message.isEdited ? ' <small style="opacity: 0.6;">(ìˆ˜ì •ë¨)</small>' : ''}</div>
            `;
            
            // ë©”ì‹œì§€ ID ì €ì¥
            messageEl.setAttribute('data-message-id', message.id || message.messageId);
            
            addLog(`âœ… ë©”ì‹œì§€ í‘œì‹œë¨: ${senderName} - ${message.content || message.message || message.text}`, 'success');
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ë©”ì‹œì§€ ì‚­ì œ (êµì‚¬ìš© - ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ ê°€ëŠ¥)
        async function deleteMessage(messageId, messageType = 'message') {
            if (!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                if (messageType === 'postit' || messageType === 'message') {
                    // ì¼ë°˜ ë©”ì‹œì§€/í¬ìŠ¤íŠ¸ì‡ ì‚­ì œ
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages/${messageId}`).remove();
                } else if (messageType === 'vote') {
                    // ì°¬ë°˜ í† ë¡  íˆ¬í‘œ ì‚­ì œ
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes/${messageId}`).remove();
                }
                
                // UIì—ì„œ ë©”ì‹œì§€ ì œê±°
                const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageEl) {
                    messageEl.style.animation = 'fadeOut 0.3s ease-in-out';
                    setTimeout(() => {
                        messageEl.remove();
                    }, 300);
                }
                
                addLog(`âœ… ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ: ${messageId}`, 'success');
                
                // ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì‚­ì œ ì˜¤ë¥˜:', error);
                addLog(`âŒ ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert('ë©”ì‹œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ (êµì‚¬ìš© ì „ìš©)
        async function clearAllMessages() {
            if (!confirm('ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ - ìƒˆë¡œìš´ ê²½ë¡œ êµ¬ì¡° ì‚¬ìš©
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messages`).remove();
                
                // ì°¬ë°˜ í† ë¡ ì¸ ê²½ìš° íˆ¬í‘œë„ ì‚­ì œ
                if (currentTopicData && currentTopicData.type === 'debate') {
                    await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes`).remove();
                    console.log('ğŸ—‘ï¸ ì°¬ë°˜í† ë¡  íˆ¬í‘œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
                }
                
                // êµì‚¬ ë©”ì‹œì§€ë„ ì‚­ì œ
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/teacherMessages`).remove();
                
                // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¦¬ì…‹
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/messageCount`).set(0);
                
                // UI ì´ˆê¸°í™”
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            ğŸ’¬ í† ë¡ ì„ ì‹œì‘í•´ë³´ì„¸ìš”!
                        </div>
                    `;
                }
                
                // ì°¬ë°˜í† ë¡  UI ì´ˆê¸°í™”
                const agreeList = document.getElementById('agreeList');
                const disagreeList = document.getElementById('disagreeList');
                if (agreeList) {
                    agreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ì•„ì§ ì°¬ì„± ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                if (disagreeList) {
                    disagreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ì•„ì§ ë°˜ëŒ€ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                
                // íˆ¬í‘œ ê²°ê³¼ ì´ˆê¸°í™”
                const agreeCount = document.getElementById('agreeCount');
                const disagreeCount = document.getElementById('disagreeCount');
                const agreeBar = document.getElementById('agreeBar');
                const disagreeBar = document.getElementById('disagreeBar');
                if (agreeCount) agreeCount.textContent = '0';
                if (disagreeCount) disagreeCount.textContent = '0';
                if (agreeBar) agreeBar.style.width = '0%';
                if (disagreeBar) disagreeBar.style.width = '0%';
                
                addLog('âœ… ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ', 'success');
                
                // ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                console.error('ì „ì²´ ë©”ì‹œì§€ ì‚­ì œ ì˜¤ë¥˜:', error);
                addLog(`âŒ ì „ì²´ ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert('ë©”ì‹œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantCount = document.getElementById('participantCount');
            
            const participantsArray = Object.values(participants);
            
            // ììœ í† ë¡ /í¬ìŠ¤íŠ¸ì‡ í† ë¡ ì˜ ê²½ìš° ì°¸ì—¬ì ëª©ë¡ í‘œì‹œ
            if (participantsList && participantCount) {
                participantCount.textContent = participantsArray.length;
            
                if (participantsArray.length === 0) {
                    participantsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px;">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                let participantsHTML = '<div style="display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 6px;">';
                participantsArray.forEach((participant, index) => {
                    const isMe = participant.id === currentParticipantId;
                    const displayName = participant.name || participant.participantName || participant.participantId || `ì°¸ì—¬ì${index + 1}`;
                    console.log('ğŸ‘¤ ì°¸ì—¬ì ë°ì´í„°:', participant, 'í‘œì‹œëª…:', displayName);
                    participantsHTML += `
                        <span style="background: ${isMe ? '#007bff' : '#e9ecef'}; color: ${isMe ? 'white' : '#495057'}; padding: 3px 8px; border-radius: 12px; font-size: 11px; white-space: nowrap; font-weight: ${isMe ? 'bold' : 'normal'};">
                            ${isMe ? 'ğŸ‘¤' : 'ğŸ‘¥'} ${displayName} ${isMe ? '(ë‚˜)' : ''}
                        </span>
                    `;
                });
                participantsHTML += '</div>';
                
                participantsList.innerHTML = participantsHTML;
                addLog(`ğŸ‘¥ ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸: ${participantsArray.length}ëª…`, 'info');
            } else if (currentTopicData && currentTopicData.type === 'debate') {
                // ì°¬ë°˜ í† ë¡ ì˜ ê²½ìš° ì°¸ì—¬ì ìˆ˜ë§Œ ë¡œê·¸ì— ê¸°ë¡
                addLog(`ğŸ‘¥ ì°¬ë°˜í† ë¡  ì°¸ì—¬ì ìˆ˜: ${participantsArray.length}ëª…`, 'info');
            } else {
                // ë‹¤ë¥¸ í† ë¡  ìœ í˜•ì˜ ê²½ìš° (í¬ìŠ¤íŠ¸ì‡ ë“±)
                addLog(`ğŸ‘¥ í† ë¡  ì°¸ì—¬ì ìˆ˜: ${participantsArray.length}ëª…`, 'info');
            }
        }
        
        
        // ì°¬ë°˜ í† ë¡  íˆ¬í‘œ ì œì¶œ
        async function submitDebateVote(position) {
            const inputId = position === 'agree' ? 'agreeInput' : 'disagreeInput';
            const inputEl = document.getElementById(inputId);
            
            if (!inputEl) {
                alert('âš ï¸ ì…ë ¥ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const opinion = inputEl.value.trim();
            if (!opinion) {
                alert(`âš ï¸ ${position === 'agree' ? 'ì°¬ì„±' : 'ë°˜ëŒ€'} ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const voteData = {
                    id: voteId,
                    position: position,
                    opinion: opinion,
                    participantId: currentParticipantId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`classes/${currentClassId}/discussions/${currentTopicId}/votes/${voteId}`).set(voteData);
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                inputEl.value = '';
                
                addLog(`âœ… ${position === 'agree' ? 'ì°¬ì„±' : 'ë°˜ëŒ€'} ì˜ê²¬ ë“±ë¡ ì™„ë£Œ`, 'success');
                
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ íˆ¬í‘œ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert(`âŒ ì˜ê²¬ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€
        async function addPostit() {
            const postitInput = document.getElementById('postitInput');
            
            if (!postitInput) {
                alert('âš ï¸ í¬ìŠ¤íŠ¸ì‡ ì…ë ¥ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const text = postitInput.value.trim();
            if (!text) {
                alert('âš ï¸ í¬ìŠ¤íŠ¸ì‡ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const postitId = `postit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const postitData = {
                    id: postitId,
                    text: text,
                    participantId: currentParticipantId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    color: getRandomPostitColor()
                };
                
                await database.ref(`discussions/${currentTopicId}/postits/${postitId}`).set(postitData);
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                postitInput.value = '';
                
                addLog('âœ… í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€ ì™„ë£Œ', 'success');
                
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert(`âŒ í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // ëœë¤ í¬ìŠ¤íŠ¸ì‡ ìƒ‰ìƒ
        function getRandomPostitColor() {
            const colors = ['#ffeb3b', '#ff9800', '#4caf50', '#2196f3', '#9c27b0', '#f44336', '#00bcd4'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ì°¬ë°˜ í† ë¡  ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateDebateResults(votes) {
            const agreeVotesObj = {};
            const disagreeVotesObj = {};
            let agreeCount = 0;
            let disagreeCount = 0;
            
            // ê°ì²´ë¥¼ ë¶„ë¦¬í•˜ë©´ì„œ ì‹¤ì œ Firebase í‚¤ë¥¼ ë³´ì¡´
            Object.entries(votes).forEach(([voteId, vote]) => {
                if (vote.position === 'agree') {
                    agreeVotesObj[voteId] = vote;
                    agreeCount++;
                } else if (vote.position === 'disagree') {
                    disagreeVotesObj[voteId] = vote;
                    disagreeCount++;
                }
            });
            
            const total = agreeCount + disagreeCount;
            
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const agreeCountEl = document.getElementById('agreeCount');
            const disagreeCountEl = document.getElementById('disagreeCount');
            if (agreeCountEl) agreeCountEl.textContent = agreeCount;
            if (disagreeCountEl) disagreeCountEl.textContent = disagreeCount;
            
            // ì§„í–‰ë°” ì—…ë°ì´íŠ¸
            const agreeBar = document.getElementById('agreeBar');
            const disagreeBar = document.getElementById('disagreeBar');
            if (agreeBar && disagreeBar && total > 0) {
                const agreePercent = (agreeCount / total) * 100;
                const disagreePercent = (disagreeCount / total) * 100;
                
                agreeBar.style.width = agreePercent + '%';
                disagreeBar.style.width = disagreePercent + '%';
            }
            
            // ì˜ê²¬ ëª©ë¡ ì—…ë°ì´íŠ¸ - ì´ì œ ì‹¤ì œ Firebase í‚¤ê°€ í¬í•¨ëœ ê°ì²´ë¥¼ ì „ë‹¬
            updateDebateOpinionsList(agreeVotesObj, disagreeVotesObj);
            
            addLog(`ğŸ“Š ì°¬ë°˜í† ë¡  ê²°ê³¼ ì—…ë°ì´íŠ¸: ì°¬ì„± ${agreeCount}, ë°˜ëŒ€ ${disagreeCount}`, 'info');
        }
        
        // ì°¬ë°˜ í† ë¡  ì˜ê²¬ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateDebateOpinionsList(agreeVotesObj, disagreeVotesObj) {
            const agreeList = document.getElementById('agreeList');
            const disagreeList = document.getElementById('disagreeList');
            
            // ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ë©´ì„œ ID ì •ë³´ ìœ ì§€
            const agreeVotes = Object.entries(agreeVotesObj || {}).map(([id, vote]) => ({...vote, voteId: id}));
            const disagreeVotes = Object.entries(disagreeVotesObj || {}).map(([id, vote]) => ({...vote, voteId: id}));
            
            if (agreeList) {
                if (agreeVotes.length === 0) {
                    agreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ì•„ì§ ì°¬ì„± ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    let agreeHTML = '';
                    agreeVotes.forEach((vote, index) => {
                        const isMe = vote.participantId === currentParticipantId;
                        const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                        const displayName = isMe ? 'ë‚˜' : (vote.participantName || vote.participantId || `ì°¸ì—¬ì${index + 1}`);
                        agreeHTML += `
                            <div style="background: white; border: 1px solid #c3e6cb; border-radius: 4px; padding: 8px; margin-bottom: 8px; font-size: 12px; position: relative;">
                                <button onclick="deleteDebateVote('${vote.voteId}')" data-vote-id="${vote.voteId}"
                                        style="position: absolute; top: 4px; right: 4px; background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                                        title="ì˜ê²¬ ì‚­ì œ (ID: ${vote.voteId})">ğŸ—‘ï¸</button>
                                <div style="font-weight: bold; color: #155724; margin-bottom: 4px; padding-right: 25px;">
                                    ${displayName} - ${timestamp}
                                </div>
                                <div style="color: #495057; padding-right: 25px;">${vote.opinion}</div>
                            </div>
                        `;
                    });
                    agreeList.innerHTML = agreeHTML;
                }
            }
            
            if (disagreeList) {
                if (disagreeVotes.length === 0) {
                    disagreeList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">ì•„ì§ ë°˜ëŒ€ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    let disagreeHTML = '';
                    disagreeVotes.forEach((vote, index) => {
                        const isMe = vote.participantId === currentParticipantId;
                        const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                        const displayName = isMe ? 'ë‚˜' : (vote.participantName || vote.participantId || `ì°¸ì—¬ì${index + 1}`);
                        disagreeHTML += `
                            <div style="background: white; border: 1px solid #f5c6cb; border-radius: 4px; padding: 8px; margin-bottom: 8px; font-size: 12px; position: relative;">
                                <button onclick="deleteDebateVote('${vote.voteId}')" data-vote-id="${vote.voteId}"
                                        style="position: absolute; top: 4px; right: 4px; background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                                        title="ì˜ê²¬ ì‚­ì œ (ID: ${vote.voteId})">ğŸ—‘ï¸</button>
                                <div style="font-weight: bold; color: #721c24; margin-bottom: 4px; padding-right: 25px;">
                                    ${displayName} - ${timestamp}
                                </div>
                                <div style="color: #495057; padding-right: 25px;">${vote.opinion}</div>
                            </div>
                        `;
                    });
                    disagreeList.innerHTML = disagreeHTML;
                }
            }
        }
        
        // ê°œë³„ ì°¬ë°˜í† ë¡  íˆ¬í‘œ ì‚­ì œ (êµì‚¬ìš© ì „ìš©)
        async function deleteDebateVote(voteId) {
            console.log('ğŸ—‘ï¸ íˆ¬í‘œ ì‚­ì œ ì‹œë„:', {
                voteId,
                currentClassId,
                currentTopicId,
                path: `classes/${currentClassId}/discussions/${currentTopicId}/votes/${voteId}`
            });
            
            // voteId ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”
            if (!voteId || voteId === 'undefined' || voteId === 'null' || typeof voteId !== 'string') {
                console.error('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ íˆ¬í‘œ ID:', voteId, typeof voteId);
                addLog('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ íˆ¬í‘œ IDì…ë‹ˆë‹¤.', 'error');
                return;
            }
            
            // í•„ìˆ˜ ì „ì—­ ë³€ìˆ˜ í™•ì¸
            if (!currentClassId || !currentTopicId) {
                console.error('âŒ í•„ìˆ˜ ì •ë³´ ëˆ„ë½:', { currentClassId, currentTopicId });
                addLog('âŒ í† ë¡  ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!confirm('ì´ ì˜ê²¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                // ì „ì—­ database ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
                const database = initGlobalDatabase();
                if (!database) {
                    console.error('âŒ Firebase database ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.');
                    addLog('âŒ Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
                const deletePath = `classes/${currentClassId}/discussions/${currentTopicId}/votes/${voteId}`;
                console.log('ğŸ—‘ï¸ ì‚­ì œ ê²½ë¡œ:', deletePath);
                
                // ì‚­ì œ ì „ì— ë°ì´í„° ì¡´ì¬ í™•ì¸
                const snapshot = await database.ref(deletePath).once('value');
                console.log('ğŸ” ì‚­ì œ ì „ ë°ì´í„° í™•ì¸:', snapshot.exists(), snapshot.val());
                
                if (!snapshot.exists()) {
                    console.warn('âš ï¸ ì‚­ì œí•˜ë ¤ëŠ” íˆ¬í‘œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    addLog('âš ï¸ í•´ë‹¹ íˆ¬í‘œê°€ ì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                // ì‚­ì œ ì‹¤í–‰
                await database.ref(deletePath).remove();
                
                // ì‚­ì œ í›„ í™•ì¸
                const afterSnapshot = await database.ref(deletePath).once('value');
                console.log('âœ… ì‚­ì œ í›„ ë°ì´í„° í™•ì¸:', afterSnapshot.exists());
                
                if (!afterSnapshot.exists()) {
                    console.log('ğŸ—‘ï¸ ì°¬ë°˜í† ë¡  íˆ¬í‘œ ì‚­ì œ ì™„ë£Œ:', voteId);
                    addLog(`ğŸ—‘ï¸ ì˜ê²¬ ì‚­ì œ ì™„ë£Œ`, 'success');
                    
                    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸í•  ê²ƒì„
                } else {
                    throw new Error('ì‚­ì œê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('íˆ¬í‘œ ì‚­ì œ ì˜¤ë¥˜:', error);
                addLog(`âŒ ì˜ê²¬ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert(`ì˜ê²¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
        
        // í¬ìŠ¤íŠ¸ì‡ í‘œì‹œ
        function displayPostit(postit) {
            const postitBoard = document.getElementById('postitBoard');
            if (!postitBoard) return;
            
            // ì²« ë²ˆì§¸ í¬ìŠ¤íŠ¸ì‡ì¸ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
            const welcomeMsg = postitBoard.querySelector('[style*="grid-column: 1 / -1"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const postitEl = document.createElement('div');
            const isMe = postit.participantId === currentParticipantId;
            const timestamp = new Date(postit.timestamp).toLocaleTimeString();
            
            postitEl.style.cssText = `
                background: ${postit.color || '#ffeb3b'};
                border-radius: 8px;
                padding: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                font-size: 13px;
                min-height: 80px;
                transform: rotate(${Math.random() * 6 - 3}deg);
                transition: transform 0.2s;
            `;
            
            postitEl.innerHTML = `
                <div style="font-size: 10px; color: #333; margin-bottom: 5px; font-weight: bold;">
                    ${isMe ? 'ë‚˜' : (postit.participantName || postit.participantId || 'ìµëª…')} - ${timestamp}
                </div>
                <div style="color: #333; line-height: 1.3;">
                    ${postit.text}
                </div>
            `;
            
            // í˜¸ë²„ íš¨ê³¼
            postitEl.addEventListener('mouseenter', () => {
                postitEl.style.transform = 'rotate(0deg) scale(1.05)';
                postitEl.style.zIndex = '10';
            });
            
            postitEl.addEventListener('mouseleave', () => {
                postitEl.style.transform = `rotate(${Math.random() * 6 - 3}deg) scale(1)`;
                postitEl.style.zIndex = '1';
            });
            
            postitBoard.appendChild(postitEl);
            
            addLog(`ğŸ“ ìƒˆ í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€: ${postit.text.substring(0, 20)}...`, 'info');
        }
        
        // í† ë¡  ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
        let discussionTimer = null;
        
        function startDiscussionTimer() {
            if (!currentTopicData || !currentTopicData.endTime) return;
            
            // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì •ë¦¬
            if (discussionTimer) {
                clearInterval(discussionTimer);
            }
            
            discussionTimer = setInterval(() => {
                const now = Date.now();
                const endTime = currentTopicData.endTime;
                const timeLeft = endTime - now;
                
                const timeRemainingEl = document.getElementById('timeRemaining');
                if (!timeRemainingEl) return;
                
                if (timeLeft <= 0) {
                    timeRemainingEl.textContent = 'â° ì¢…ë£Œë¨';
                    timeRemainingEl.style.color = '#dc3545';
                    clearInterval(discussionTimer);
                    
                    // í† ë¡  ì¢…ë£Œ ì•Œë¦¼
                    setTimeout(() => {
                        alert('â° í† ë¡  ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\ní† ë¡  ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.');
                    }, 1000);
                    
                    addLog('â° í† ë¡  ì‹œê°„ ì¢…ë£Œ', 'warning');
                } else {
                    const minutes = Math.floor(timeLeft / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    timeRemainingEl.textContent = `${minutes}ë¶„ ${seconds}ì´ˆ`;
                    
                    // 1ë¶„ ë‚¨ì•˜ì„ ë•Œ ê²½ê³ ìƒ‰ìœ¼ë¡œ ë³€ê²½
                    if (timeLeft <= 60000) {
                        timeRemainingEl.style.color = '#dc3545';
                    } else if (timeLeft <= 300000) { // 5ë¶„ ë‚¨ìŒ
                        timeRemainingEl.style.color = '#ffc107';
                    } else {
                        timeRemainingEl.style.color = '#28a745';
                    }
                }
            }, 1000);
            
            addLog('â° í† ë¡  íƒ€ì´ë¨¸ ì‹œì‘', 'info');
        }
        
        
        function showDatabaseRulesHelp() {
            const helpText = `ğŸ”§ Firebase Realtime Database ê·œì¹™ ì„¤ì • ë°©ë²•\n\nğŸ” ë‹¨ê³„:\n1. https://console.firebase.google.com ì ‘ì†\n2. í”„ë¡œì íŠ¸ ì„ íƒ\n3. ì™¼ìª½ ë©”ë‰´ì—ì„œ "Realtime Database" í´ë¦­\n4. "ê·œì¹™" íƒ­ í´ë¦­\n5. ê¸°ë³¸ ê·œì¹™ì„ ë‹¤ìŒìœ¼ë¡œ ë³€ê²½:\n\n{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}\n\n6. "ê²Œì‹œ" ë²„íŠ¼ í´ë¦­\n\nâš ï¸ ì£¼ì˜: ì´ ì„¤ì •ì€ ëª¨ë“  ì‚¬ìš©ìê°€ ë°ì´í„°ë¥¼ ì½ê³  ì“¸ ìˆ˜ ìˆê²Œ í•˜ë¯€ë¡œ ê°œë°œ/í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.`;
            
            if (confirm(helpText + '\n\nğŸ”— Firebase Consoleì„ ì—´ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.open('https://console.firebase.google.com', '_blank');
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // í† ë¡  ì£¼ì œ ì‚­ì œ
        async function deleteTopic(topicId, topicTitle) {
            if (!confirm(`ì •ë§ë¡œ í† ë¡  ì£¼ì œ "${topicTitle}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ëª¨ë“  í† ë¡  ë‚´ìš©ê³¼ ì°¸ì—¬ì ë°ì´í„°ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                addLog(`ğŸ—‘ï¸ í† ë¡  ì£¼ì œ ì‚­ì œ ì¤‘: ${topicTitle}`, 'warning');
                
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // í´ë˜ìŠ¤ ë‚´ í† ë¡  ë°ì´í„° ì‚­ì œ
                await database.ref(`classes/${currentClassId}/discussions/${topicId}`).remove();
                
                // ì „ì²´ í† ë¡  ë°ì´í„° ì‚­ì œ
                await database.ref(`discussions/${topicId}`).remove();
                
                addLog(`âœ… í† ë¡  ì£¼ì œ ì‚­ì œ ì™„ë£Œ: ${topicTitle}`, 'success');
                alert(`ğŸ—‘ï¸ í† ë¡  ì£¼ì œ "${topicTitle}"ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // í† ë¡  ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadTopicsFromFirebase();
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ í† ë¡  ì£¼ì œ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert(`âŒ í† ë¡  ì£¼ì œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // í† ë¡  ìƒì„¸ ë‚´ìš©ì„ CSVë¡œ ë‹¤ìš´ë¡œë“œ
        async function downloadTopicCSV(topicId) {
            try {
                addLog(`ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ ì¤‘: ${topicId}`, 'info');
                
                const firebaseConfig = getFirebaseConfig();
                const database = initGlobalDatabase();
                if (!database) {
                    throw new Error('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // í† ë¡  ê¸°ë³¸ ì •ë³´
                const topicSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}`).once('value');
                const topicData = topicSnapshot.val();
                
                if (!topicData) {
                    alert('í† ë¡  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // í† ë¡  ë°ì´í„° ìˆ˜ì§‘
                const messagesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/messages`).once('value');
                const messages = messagesSnapshot.val() || {};
                
                const votesSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/votes`).once('value');
                const votes = votesSnapshot.val() || {};
                
                const participantsSnapshot = await database.ref(`classes/${currentClassId}/discussions/${topicId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                // CSV ë°ì´í„° ìƒì„±
                let csvContent = '';
                
                // í—¤ë” ì •ë³´
                csvContent += `í† ë¡  ì£¼ì œ,${topicData.title}\n`;
                csvContent += `í† ë¡  ìœ í˜•,${getTypeName(topicData.type)}\n`;
                csvContent += `ìƒì„± ì¼ì‹œ,${new Date(topicData.createdAt).toLocaleString()}\n`;
                csvContent += `ì¢…ë£Œ ì¼ì‹œ,${new Date(topicData.endTime).toLocaleString()}\n`;
                csvContent += `ì°¸ì—¬ì ìˆ˜,${Object.keys(participants).length}ëª…\n`;
                csvContent += `ì„¤ëª…,${topicData.description || 'ì—†ìŒ'}\n`;
                csvContent += `\n`;
                
                // ì°¸ì—¬ì ëª©ë¡
                csvContent += `=== ì°¸ì—¬ì ëª©ë¡ ===\n`;
                csvContent += `ë²ˆí˜¸,ì´ë¦„,ì°¸ì—¬ ì‹œê°„\n`;
                let participantIndex = 1;
                Object.entries(participants).forEach(([id, participant]) => {
                    csvContent += `${participantIndex},${participant.name},${new Date(participant.joinedAt).toLocaleString()}\n`;
                    participantIndex++;
                });
                csvContent += `\n`;
                
                // ë©”ì‹œì§€/ì±„íŒ… ë‚´ìš©
                if (Object.keys(messages).length > 0) {
                    csvContent += `=== ë©”ì‹œì§€/ì±„íŒ… ë‚´ìš© ===\n`;
                    csvContent += `ë²ˆí˜¸,ì‘ì„±ì,ë‚´ìš©,ìœ í˜•,ìƒ‰ìƒ,ì‘ì„±ì‹œê°„\n`;
                    let messageIndex = 1;
                    Object.entries(messages).forEach(([msgId, message]) => {
                        const content = (message.content || message.text || '').replace(/"/g, '""').replace(/\n/g, ' ');
                        const type = message.type === 'postit' ? 'í¬ìŠ¤íŠ¸ì‡' : 'ë©”ì‹œì§€';
                        const color = message.color || '';
                        csvContent += `${messageIndex},"${message.participantName || message.participantId}","${content}",${type},${color},${new Date(message.timestamp).toLocaleString()}\n`;
                        messageIndex++;
                    });
                    csvContent += `\n`;
                }
                
                // íˆ¬í‘œ ê²°ê³¼ (ì°¬ë°˜ í† ë¡ ì˜ ê²½ìš°)
                if (topicData.type === 'debate' && Object.keys(votes).length > 0) {
                    csvContent += `=== ì°¬ë°˜ íˆ¬í‘œ ê²°ê³¼ ===\n`;
                    csvContent += `ë²ˆí˜¸,íˆ¬í‘œì,ì…ì¥,ì˜ê²¬,íˆ¬í‘œì‹œê°„\n`;
                    let voteIndex = 1;
                    Object.entries(votes).forEach(([voteId, vote]) => {
                        const opinion = (vote.opinion || '').replace(/"/g, '""').replace(/\n/g, ' ');
                        const position = vote.position === 'agree' ? 'ì°¬ì„±' : 'ë°˜ëŒ€';
                        csvContent += `${voteIndex},"${vote.participantName || vote.participantId}",${position},"${opinion}",${new Date(vote.timestamp).toLocaleString()}\n`;
                        voteIndex++;
                    });
                }
                
                // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                const fileName = `í† ë¡ _${topicData.title}_${new Date().toISOString().slice(0, 10)}.csv`;
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog(`âœ… CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${fileName}`, 'success');
                
                // Firebase ì•± ì •ë¦¬
                // Firebase ì•± ì •ë¦¬ ë¶ˆí•„ìš” (ì „ì—­ ì‚¬ìš©)
                
            } catch (error) {
                addLog(`âŒ CSV ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert(`âŒ CSV ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // í† ë¡  ìœ í˜• ì´ë¦„ ë°˜í™˜
        function getTypeName(type) {
            const typeNames = {
                'debate': 'ì°¬ë°˜ í† ë¡ ',
                'discussion': 'ììœ  í† ë¡ ', 
                'postit': 'í¬ìŠ¤íŠ¸ì‡ í† ë¡ ',
                'survey': 'ì„¤ë¬¸ ì¡°ì‚¬'
            };
            return typeNames[type] || type;
        }

    </script>
</body>
</html>
