<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ê¸‰ í† ë¡  ì°¸ì—¬ - í•™ìƒìš© | Real-time Classroom Discussion</title>
    <meta name="description" content="ì‹¤ì‹œê°„ í•™ê¸‰ í† ë¡  ì°¸ì—¬ ì‹œìŠ¤í…œ - í•™ìƒìš© ì¸í„°í˜ì´ìŠ¤">
    <meta name="keywords" content="í•™ê¸‰í† ë¡ , í•™ìƒì°¸ì—¬, ì‹¤ì‹œê°„í† ë¡ , ì˜¨ë¼ì¸êµìœ¡">
    <meta name="author" content="Claude Code">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="í•™ê¸‰ í† ë¡  ì°¸ì—¬ - í•™ìƒìš©">
    <meta property="og:description" content="ì‹¤ì‹œê°„ í•™ê¸‰ í† ë¡ ì— ì°¸ì—¬í•˜ì„¸ìš”">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-username.github.io/classroom-discussion/student.html">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>"
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background-color: white;
            color: #333;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0 0 4px 0;
            font-size: 20px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .header h1::before {
            content: "ğŸ“";
            margin-right: 10px;
            font-size: 24px;
        }

        .header-subtitle {
            font-size: 12px;
            color: #6c757d;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        /* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .main-container {
            width: 100%;
            margin: 0;
            padding: 0 15px;
        }

        /* ìƒíƒœ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .status-section {
            background: white;
            border-radius: 6px;
            padding: 12px 15px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }


        .discussion-info {
            text-align: center;
            color: #495057;
        }

        .discussion-title-box {
            background: #fff3cd;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
        }

        .discussion-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 0;
            text-align: left;
        }

        .discussion-stats {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
        }


        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .content-section {
            background: white;
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            border-color: #007bff;
            outline: none;
        }

        /* í† ë¡ ë°© ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .room-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .room-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .room-item:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .room-item.active {
            border-color: #28a745;
            background: #d4edda;
        }

        .room-item.waiting {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .room-item.closed {
            border-color: #6c757d;
            background: #f8f9fa;
            opacity: 0.7;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .room-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
        }

        .room-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background: #cce7ff;
            color: #004085;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .room-info {
            font-size: 13px;
            color: #6c757d;
            display: flex;
            gap: 15px;
        }

        /* ì±„íŒ… ë° í† ë¡  ì˜ì—­ */
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 500px;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            width: 260px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .student-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .room-info-box {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .time-remaining {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            margin: 8px 0;
        }

        .teacher-messages {
            background: #e7f3ff;
            border: 1px solid #b6d7ff;
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .teacher-message {
            background: white;
            margin: 5px;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .teacher-message-content {
            color: #333;
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .teacher-message-time {
            font-size: 10px;
            color: #6c757d;
            text-align: right;
        }

        .teacher-message {
            cursor: pointer;
            transition: all 0.2s;
        }

        .teacher-message:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* êµì‚¬ ë©”ì‹œì§€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .teacher-message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .teacher-message-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .teacher-message-modal-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .teacher-message-modal-body {
            padding: 20px;
        }

        .teacher-message-item {
            background: #f8f9fa;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .teacher-message-item:last-child {
            margin-bottom: 0;
        }

        .teacher-message-item-content {
            color: #333;
            line-height: 1.5;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .teacher-message-item-time {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
        }

        .chat-message.my-message {
            background: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .chat-message.other-message {
            background: white;
            border: 1px solid #dee2e6;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .message-author {
            font-weight: bold;
        }

        .my-message .message-author,
        .my-message .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .other-message .message-author {
            color: #495057;
        }

        .message-time {
            color: #6c757d;
        }

        .message-content {
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* ì´ëª¨ì§€ í”¼ì»¤ ìŠ¤íƒ€ì¼ */
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 320px;
            max-height: 300px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .emoji-categories {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .emoji-category {
            flex: 1;
            padding: 10px 5px;
            border: none;
            background: none;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .emoji-category:hover {
            background: #e9ecef;
        }

        .emoji-category.active {
            background: #007bff;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            font-size: 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-item:hover {
            background: #f8f9fa;
        }

        .emoji-btn:hover {
            background: #f8f9fa !important;
            border-radius: 50%;
        }

        .other-rooms {
            max-height: 150px;
            overflow-y: auto;
        }

        .room-item-mini {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .room-item-mini:hover {
            background: #e9ecef;
        }

        .room-item-mini.current {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }

        /* í† ë¡  í™”ë©´ ë ˆì´ì•„ì›ƒ ìˆ˜ì • */
        .discussion-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
            align-items: start;
            width: 100%;
        }

        .chat-section {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 5px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message-mine {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message-other {
            background: #e9ecef;
            color: #495057;
        }

        .message-author {
            font-size: 11px;
            margin-bottom: 3px;
            opacity: 0.8;
        }

        .chat-input {
            display: flex;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            font-size: 14px;
        }

        .chat-input button {
            padding: 8px 15px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        /* í¬ìŠ¤íŠ¸ì‡ ë³´ë“œ */
        .postit-board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .postit {
            background: #ffeb3b;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-size: 12px;
            min-height: 20px;
            position: relative;
        }

        .postit.blue {
            background: #2196f3;
            color: white;
        }

        .postit.green {
            background: #4caf50;
            color: white;
        }

        .postit.pink {
            background: #e91e63;
            color: white;
        }

        .postit-author {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 10px;
            opacity: 0.7;
        }

        .postit-actions {
            position: absolute;
            top: 3px;
            right: 3px;
            display: none;
            gap: 3px;
        }

        .postit:hover .postit-actions {
            display: flex;
        }

        .postit-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .postit-edit-btn {
            background: #007bff;
            color: white;
        }

        .postit-delete-btn {
            background: #dc3545;
            color: white;
        }

        .postit-btn:hover {
            transform: scale(1.1);
        }

        /* í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .postit-editing {
            border: 2px solid #007bff !important;
        }

        .postit-edit-textarea {
            width: 100%;
            height: 300px;
            border: none;
            background: transparent;
            font-size: 13px;
            resize: none;
            outline: none;
        }

        .postit-edit-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: flex-end;
        }

        .postit-save-btn {
            padding: 3px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }

        .postit-cancel-btn {
            padding: 3px 8px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .status-section {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }

            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .chat-section {
                height: 300px;
            }

            .discussion-layout {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            #discussionContent {
                order: 1;
            }
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- í—¤ë” -->
        <div class="header">
            <div>
                <h1>í•™ê¸‰ í† ë¡  ì°¸ì—¬</h1>
                <p class="header-subtitle">ì‹¤ì‹œê°„ í† ë¡ ì— ì°¸ì—¬í•´ë³´ì„¸ìš”</p>
            </div>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="leaveDiscussion()" id="backToRoomListBtn" style="display: none;">â† í† ë¡ ë°© ëª©ë¡</button>
                <button class="btn btn-secondary" onclick="goBack()" id="backToLoginBtn" style="display: none;">â† ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                <button class="btn btn-info" onclick="refreshRooms()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn btn-secondary" onclick="exitDiscussion()">ğŸšª ë‚˜ê°€ê¸°</button>
            </div>
        </div>

        <!-- ìƒíƒœ ì˜ì—­ -->
        <div class="status-section" id="statusSection" style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
            <div class="discussion-title-box">
                <div class="discussion-title" id="discussionTitle">í† ë¡ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            </div>
            <div class="discussion-stats" id="discussionStats">â° - | ğŸ‘¥ -</div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="content-section" id="mainContent">
            
            <!-- 1. ì´ˆê¸° ì…ë ¥ í™”ë©´ -->
            <div id="loginScreen" class="fade-in">
                <h2 style="text-align: center; margin-bottom: 20px; color: #495057;">ğŸ“ í† ë¡  ì°¸ì—¬í•˜ê¸°</h2>
                
                <div class="form-group">
                    <label for="nameInput">ğŸ‘¨â€ğŸ“ ì°¸ì—¬ì ì´ë¦„</label>
                    <input type="text" id="nameInput" placeholder="ê¹€ë¯¼ìˆ˜" maxlength="10">
                </div>

                <div class="form-group">
                    <label for="classCodeInput">ğŸ”¢ ë°˜ ì½”ë“œ</label>
                    <input type="text" id="classCodeInput" placeholder="ABC123" maxlength="10" style="text-transform: uppercase;">
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="joinClass()" style="font-size: 16px; padding: 12px 24px;">
                        ğŸš€ í† ë¡  ì°¸ì—¬í•˜ê¸°
                    </button>
                </div>

                <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 3px solid #bee5eb;">
                    <p style="margin: 0; font-size: 13px; color: #0c5460;">
                        <strong>ğŸ’¡ ì•ˆë‚´:</strong> êµì‚¬ê°€ ì œê³µí•œ ë°˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ í•™ê¸‰ì˜ í™œì„± í† ë¡ ë°© ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- 2. í† ë¡ ë°© ëª©ë¡ í™”ë©´ -->
            <div id="roomListScreen" style="display: none;">
                <!-- ì œëª©ê³¼ ì²´í¬ë°•ìŠ¤ê°€ ìˆëŠ” ìƒë‹¨ í—¤ë” -->
                <div style="display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #495057;">
                        ğŸ“š <span id="className">-</span> - í† ë¡ ë°© ëª©ë¡
                    </h2>
                    
                    <!-- ìš°ì¸¡ ì •ë ¬ëœ ì²´í¬ë°•ìŠ¤ -->
                    <div style="position: absolute; right: 0;">
                        <label style="font-size: 14px; color: #6c757d; cursor: pointer;">
                            <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="margin-right: 8px;">
                            ì¢…ë£Œëœ í† ë¡ ë°© ë³´ê¸°
                        </label>
                    </div>
                </div>

                <div id="roomsList" class="room-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        í† ë¡ ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>

            </div>

            <!-- 3. ì‹¤ì‹œê°„ í† ë¡  í™”ë©´ -->
            <div id="discussionScreen" style="display: none;">

                <!-- ì‚¬ì´ë“œë°”ì™€ í† ë¡  ì˜ì—­ -->
                <div class="discussion-layout">
                    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
                    <div class="sidebar">
                        <!-- 1. í•™ìƒ ì •ë³´ -->
                        <div class="sidebar-section">
                            <div class="sidebar-title">ğŸ‘¨â€ğŸ“ ì°¸ì—¬ì ì •ë³´</div>
                            <div class="student-profile">
                                <div class="student-avatar" id="studentAvatar">ê¹€</div>
                                <div>
                                    <div style="font-weight: bold; color: #495057;" id="sidebarStudentName">ê¹€ë¯¼ìˆ˜</div>
                                    <div style="font-size: 11px; color: #6c757d;">í•™ìƒ</div>
                                </div>
                            </div>
                        </div>


                        <!-- 3. êµì‚¬ ë©”ì‹œì§€ -->
                        <div class="sidebar-section">
                            <div class="sidebar-title">ğŸ’¬ êµì‚¬ ë©”ì‹œì§€</div>
                            <div class="teacher-messages" id="teacherMessagesBox">
                                <div style="text-align: center; color: #6c757d; padding: 15px; font-size: 12px;" ondblclick="showTeacherMessagesModal()" title="ë”ë¸”í´ë¦­í•˜ì—¬ ë©”ì‹œì§€ ì´ë ¥ ë³´ê¸°">
                                    ğŸ“¢ êµì‚¬ ë©”ì‹œì§€ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤<br>
                                    <small style="font-size: 10px; color: #007bff;">ë”ë¸”í´ë¦­ìœ¼ë¡œ ì´ì „ ë©”ì‹œì§€ í™•ì¸</small>
                                </div>
                            </div>
                        </div>

                        <!-- 4. ë‹¤ë¥¸ ëŒ€í™” ëª©ë¡ -->
                        <div class="sidebar-section">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div class="sidebar-title" style="margin: 0;">ğŸ“‹ ë‹¤ë¥¸ í† ë¡ ë°©</div>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 9px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsSidebarCheckbox" onchange="toggleClosedRoomsWithRefresh()" style="transform: scale(0.8);">
                                    <span>ì¢…ë£Œ</span>
                                </label>
                            </div>
                            <div class="other-rooms" id="otherRoomsList">
                                <div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">
                                    ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ìš°ì¸¡ í† ë¡  ì»¨í…ì¸  ì˜ì—­ (íƒ€ì…ì— ë”°ë¼ ë‹¬ë¼ì§) -->
                <div id="discussionContent">
                    <!-- ììœ  í† ë¡  UI (ì‹¤ì‹œê°„ ì±„íŒ…) -->
                    <div id="generalDiscussion" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                        <div class="chat-header" style="margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #495057;">ğŸ’¬ ììœ  í† ë¡  ì±„íŒ…</div>
                        
                        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
                        <div id="chatMessages" style="height: 400px; background: #f8f9fa; border-radius: 8px; padding: 15px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #dee2e6;">
                            <div style="text-align: center; color: #6c757d; padding: 40px; font-size: 16px;" id="chatWelcome">
                                ğŸ’¬ ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!
                            </div>
                        </div>

                        <!-- ë‹µì¥ ë¯¸ë¦¬ë³´ê¸° -->
                        <div id="replyPreview" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: bold; color: #495057;">â†©ï¸ ë‹µì¥ ì¤‘</span>
                                <button onclick="cancelReply()" style="background: none; border: none; cursor: pointer; color: #6c757d; font-size: 16px; margin-left: auto;" title="ë‹µì¥ ì·¨ì†Œ">âœ•</button>
                            </div>
                            <div id="replyContent" style="background: white; border-left: 3px solid #007bff; padding: 8px; border-radius: 4px; font-size: 13px; color: #6c757d;">
                                <!-- ë‹µì¥ ëŒ€ìƒ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- ì±„íŒ… ì…ë ¥ ì˜ì—­ -->
                        <div class="chat-input" style="display: flex; gap: 15px; position: relative; align-items: center;">
                            <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleChatEnter(event)" 
                                style="flex: 1; padding: 12px 80px 12px 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px; margin-right: 10px;">
                            <button onclick="toggleEmojiPicker()" class="emoji-btn" style="position: absolute; right: 95px; top: 50%; transform: translateY(-50%); background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 50%; font-size: 18px; cursor: pointer; padding: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;" title="ì´ëª¨ì§€ ì„ íƒ">
                                ğŸ˜Š
                            </button>
                            <button onclick="sendChatMessage()" class="btn btn-primary" style="padding: 12px 20px; border-radius: 25px; margin-left: 5px;">
                                ğŸ“¤ ì „ì†¡
                            </button>
                        </div>

                        <!-- ì´ëª¨ì§€ í”¼ì»¤ -->
                        <div id="emojiPicker" class="emoji-picker" style="display: none;">
                            <div class="emoji-categories">
                                <button class="emoji-category active" onclick="showEmojiCategory('face')" data-category="face">ğŸ˜Š</button>
                                <button class="emoji-category" onclick="showEmojiCategory('gesture')" data-category="gesture">ğŸ‘</button>
                                <button class="emoji-category" onclick="showEmojiCategory('heart')" data-category="heart">â¤ï¸</button>
                                <button class="emoji-category" onclick="showEmojiCategory('nature')" data-category="nature">ğŸŒ¸</button>
                                <button class="emoji-category" onclick="showEmojiCategory('food')" data-category="food">ğŸ</button>
                                <button class="emoji-category" onclick="showEmojiCategory('activity')" data-category="activity">âš½</button>
                            </div>
                            <div class="emoji-grid" id="emojiGrid">
                                <!-- ì´ëª¨ì§€ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                            </div>
                        </div>
                    </div>

                    <!-- í¬ìŠ¤íŠ¸ì‡ í† ë¡  UI -->
                    <div id="postitDiscussion" style="display: none; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                        <div class="chat-header" style="margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #495057;">ğŸ“ í¬ìŠ¤íŠ¸ì‡ ì˜ê²¬ ë³´ë“œ</div>
                        
                        <!-- í¬ìŠ¤íŠ¸ì‡ ì…ë ¥ ì˜ì—­ -->
                        <div class="chat-input" style="margin-bottom: 20px;">
                            <input type="text" id="postitInput" placeholder="ì˜ê²¬ì„ ì ì–´ì£¼ì„¸ìš”..." onkeypress="handlePostitEnter(event)" 
                                style="flex: 1; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px;">
                            <button onclick="addPostit()" class="btn btn-primary" style="margin-left: 10px; padding: 12px 20px; border-radius: 25px;">
                                ğŸ“Œ ë¶™ì´ê¸°
                            </button>
                        </div>

                        <!-- í¬ìŠ¤íŠ¸ì‡ ë³´ë“œ (ë” ë„“ì€ ê³µê°„) -->
                        <div class="postit-board" id="postitBoard" style="min-height: 400px; background: #f8f9fa; border-radius: 8px; padding: 20px;">
                            <div style="text-align: center; color: #6c757d; padding: 40px; font-size: 16px;">
                                ğŸ’­ ì²« ë²ˆì§¸ ì˜ê²¬ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
                            </div>
                        </div>
                    </div>

                    <!-- ì°¬ë°˜ í† ë¡  UI -->
                    <div id="debateDiscussion" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- ì°¬ì„± ì˜ê²¬ -->
                            <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 15px;">
                                <h5 style="color: #155724; margin: 0 0 10px 0;">âœ… ì°¬ì„± ì˜ê²¬</h5>
                                <div id="agreeSection" style="min-height: 300px;">
                                    <textarea id="agreeInput" placeholder="ì°¬ì„± ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                        style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #c3e6cb; border-radius: 4px;"></textarea>
                                    <button class="btn btn-success" onclick="submitDebateVote('agree')" style="width: 100%; margin-bottom: 10px;">
                                        âœ… ì°¬ì„± ì˜ê²¬ ë“±ë¡
                                    </button>
                                    <div id="agreeList">
                                        ë¡œë”© ì¤‘...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ë°˜ëŒ€ ì˜ê²¬ -->
                            <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 15px;">
                                <h5 style="color: #721c24; margin: 0 0 10px 0;">âŒ ë°˜ëŒ€ ì˜ê²¬</h5>
                                <div id="disagreeSection" style="min-height: 300px;">
                                    <textarea id="disagreeInput" placeholder="ë°˜ëŒ€ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                        style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #f5c6cb; border-radius: 4px;"></textarea>
                                    <button class="btn" onclick="submitDebateVote('disagree')" 
                                        style="width: 100%; margin-bottom: 10px; background: #dc3545; color: white;">
                                        âŒ ë°˜ëŒ€ ì˜ê²¬ ë“±ë¡
                                    </button>
                                    <div id="disagreeList">
                                        ë¡œë”© ì¤‘...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì‹¤ì‹œê°„ ê²°ê³¼ -->
                        <div style="margin-top: 15px; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ“Š ì‹¤ì‹œê°„ ê²°ê³¼</h6>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; background: #d4edda; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="agreeBar" style="background: #28a745; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        ì°¬ì„± <span id="agreeCount">0</span>
                                    </span>
                                </div>
                                <div style="flex: 1; background: #f8d7da; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="disagreeBar" style="background: #dc3545; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        ë°˜ëŒ€ <span id="disagreeCount">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentStudent = null;
        let currentClassCode = null;
        let currentClassName = null;
        let currentTopicId = null;
        let currentTopicData = null;
        let currentRooms = [];
        let database = null;
        let tipsIndex = 0;
        
        // í•™ìƒ ê²Œì‹œê¸€ í—ˆìš© ì—¬ë¶€ í™•ì¸
        function isStudentPostAllowed() {
            if (!currentTopicData || !currentTopicData.settings) {
                return true; // ê¸°ë³¸ê°’: í—ˆìš©
            }
            return currentTopicData.settings.allowStudentPost !== false;
        }
        
        // ì…ë ¥ í•„ë“œ í™œì„±í™”/ë¹„í™œì„±í™”
        function updateInputFieldsState() {
            const allowed = isStudentPostAllowed();
            
            // í¬ìŠ¤íŠ¸ì‡ ì…ë ¥ í•„ë“œ
            const postitInput = document.getElementById('postitInput');
            if (postitInput) {
                postitInput.disabled = !allowed;
                postitInput.placeholder = allowed ? 'ì˜ê²¬ì„ ì ì–´ì£¼ì„¸ìš”...' : 'êµì‚¬ê°€ í•™ìƒ ê²Œì‹œê¸€ì„ ì œí•œì¤‘ì…ë‹ˆë‹¤';
                postitInput.style.backgroundColor = allowed ? '' : '#f8f9fa';
                postitInput.style.color = allowed ? '' : '#6c757d';
            }
            
            // ì°¬ë°˜ í† ë¡  ì…ë ¥ í•„ë“œë“¤
            const agreeInput = document.getElementById('agreeInput');
            const disagreeInput = document.getElementById('disagreeInput');
            
            [agreeInput, disagreeInput].forEach(input => {
                if (input) {
                    input.disabled = !allowed;
                    input.placeholder = allowed ? 
                        (input.id === 'agreeInput' ? 'ì°¬ì„± ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”...' : 'ë°˜ëŒ€ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”...') :
                        'êµì‚¬ê°€ í•™ìƒ ì˜ê²¬ ì‘ì„±ì„ ì œí•œì¤‘ì…ë‹ˆë‹¤';
                    input.style.backgroundColor = allowed ? '' : '#f8f9fa';
                    input.style.color = allowed ? '' : '#6c757d';
                }
            });
            
            // ë²„íŠ¼ë“¤ë„ ë¹„í™œì„±í™”
            const buttons = [
                document.querySelector('button[onclick="addPostit()"]'),
                document.querySelector('button[onclick="submitDebateVote(\'agree\')"]'),
                document.querySelector('button[onclick="submitDebateVote(\'disagree\')"]')
            ];
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                }
            });
        }
        
        const tips = [
            "ğŸ’¡ êµ¬ì²´ì ì¸ ì˜ˆì‹œë¥¼ ë“¤ì–´ ì˜ê²¬ì„ í‘œí˜„í•´ë³´ì„¸ìš”",
            "ğŸ¤” ë‹¤ë¥¸ ì¹œêµ¬ë“¤ì˜ ì˜ê²¬ë„ ì¡´ì¤‘í•´ì£¼ì„¸ìš”",
            "âœ¨ ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ë‚˜ëˆ„ì–´ë³´ì„¸ìš”",
            "ğŸ¯ ì£¼ì œì— ë§ëŠ” ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”",
            "ğŸ‘¥ í˜‘ë ¥í•˜ì—¬ ë” ë‚˜ì€ ê²°ë¡ ì„ ì°¾ì•„ë³´ì„¸ìš”"
        ];

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        function getFirebaseConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api');
            const projectId = urlParams.get('project');
            
            if (apiKey && projectId) {
                // localStorageì— ì €ì¥
                localStorage.setItem('user_firebase_apiKey', decodeURIComponent(apiKey));
                localStorage.setItem('user_firebase_projectId', decodeURIComponent(projectId));
                localStorage.setItem('user_firebase_databaseURL', `https://${decodeURIComponent(projectId)}-default-rtdb.asia-southeast1.firebasedatabase.app`);
                
                return {
                    apiKey: decodeURIComponent(apiKey),
                    authDomain: `${decodeURIComponent(projectId)}.firebaseapp.com`,
                    databaseURL: `https://${decodeURIComponent(projectId)}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: decodeURIComponent(projectId),
                    storageBucket: `${decodeURIComponent(projectId)}.appspot.com`
                };
            }
            return null;
        }

        // ì‚¬ìš©ì Firebase ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadUserFirebaseConfig() {
            // ë¨¼ì € URL íŒŒë¼ë¯¸í„° í™•ì¸
            const urlConfig = getFirebaseConfigFromUrl();
            if (urlConfig) {
                return urlConfig;
            }
            
            // localStorageì—ì„œ í™•ì¸
            const apiKey = localStorage.getItem('user_firebase_apiKey');
            const projectId = localStorage.getItem('user_firebase_projectId');
            
            if (apiKey && projectId) {
                return {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`
                };
            }
            return null;
        }

        // Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        function getFirebaseConfig() {
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                return userConfig;
            } else {
                // Firebase ì„¤ì •ì´ ì—†ìœ¼ë©´ ì˜¤ë¥˜ í‘œì‹œ
                showError('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. êµì‚¬ì—ê²Œ ì˜¬ë°”ë¥¸ ë§í¬ë¥¼ ìš”ì²­í•˜ì„¸ìš”.');
                throw new Error('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }
        }

        // Firebase SDK ë¡œë“œ
        async function loadFirebase() {
            if (typeof firebase !== 'undefined') {
                return true;
            }

            try {
                // Firebase ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
                await loadScript('https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js');
                await loadScript('https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js');
                
                // Firebase ì´ˆê¸°í™”
                const config = getFirebaseConfig();
                const app = firebase.initializeApp(config, 'studentApp-' + Date.now());
                database = app.database();
                
                console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                return true;
            } catch (error) {
                console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. êµì‚¬ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                return false;
            }
        }

        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í•¨ìˆ˜
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ë°˜ ì°¸ê°€
        async function joinClass() {
            const name = document.getElementById('nameInput').value.trim();
            const classCode = document.getElementById('classCodeInput').value.trim().toUpperCase();

            if (!name || !classCode) {
                alert('ì´ë¦„ê³¼ ë°˜ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!await loadFirebase()) {
                return;
            }

            try {
                console.log('ë°˜ ì°¸ê°€ ì‹œë„:', { name, classCode });
                
                // ë°˜ ì½”ë“œë¡œ ë°˜ ì •ë³´ ì°¾ê¸° (êµì‚¬ìš©ê³¼ ë™ì¼í•œ êµ¬ì¡° ì‚¬ìš©)
                const classSnapshot = await database.ref(`classes/${classCode}`).once('value');
                const classData = classSnapshot.val();
                
                console.log('ë°˜ ë°ì´í„° ì¡°íšŒ ê²°ê³¼:', classData);

                if (!classData) {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°˜ ì½”ë“œì…ë‹ˆë‹¤. êµì‚¬ì—ê²Œ ì •í™•í•œ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // í•™ìƒ ì •ë³´ë¥¼ ë°˜ì— ë“±ë¡
                await database.ref(`classes/${classCode}/students/${name}`).set({
                    name: name,
                    joinedAt: Date.now(),
                    status: 'active'
                });

                // í•™ìƒ ì •ë³´ ì„¤ì •
                currentStudent = name;
                currentClassCode = classCode; // ë°˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                currentClassName = classData.className || classData.name;

                console.log('ì„¤ì •ëœ ì •ë³´:', { currentStudent, currentClassCode, currentClassName });

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('className').textContent = classData.className || classData.name;

                // í™”ë©´ ì „í™˜
                switchScreen('roomListScreen');
                
                // ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ í‘œì‹œ
                const backToLoginBtn = document.getElementById('backToLoginBtn');
                if (backToLoginBtn) {
                    backToLoginBtn.style.display = 'inline-block';
                }
                
                // í† ë¡ ë°© ëª©ë¡ ë¡œë“œ
                await loadRooms(classCode);

            } catch (error) {
                console.error('ë°˜ ì°¸ê°€ ì˜¤ë¥˜:', error);
                alert('ë°˜ ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í† ë¡ ë°© ëª©ë¡ ë¡œë“œ
        async function loadRooms(classId) {
            try {
                console.log('í† ë¡ ë°© ë¡œë“œ ì‹œì‘:', classId);
                
                // êµì‚¬ìš©ê³¼ ë™ì¼í•œ ê²½ë¡œë¡œ í† ë¡  ì£¼ì œ ì¡°íšŒ
                const roomsSnapshot = await database.ref(`classes/${classId}/discussions`).once('value');
                const roomsData = roomsSnapshot.val() || {};
                
                console.log('í† ë¡ ë°© ë°ì´í„° (classes ê²½ë¡œ):', roomsData);

                currentRooms = Object.keys(roomsData).map(id => {
                    const room = { id: id, ...roomsData[id] };
                    // í† ë¡  ì‹œê°„ ì¢…ë£Œ ì²´í¬ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
                    updateRoomStatus(room);
                    return room;
                });

                console.log('ë³€í™˜ëœ í† ë¡ ë°© ëª©ë¡:', currentRooms);
                
                displayRooms();

                // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì„¤ì • - êµì‚¬ìš©ê³¼ ë™ì¼í•œ ê²½ë¡œ ì‚¬ìš©
                database.ref(`classes/${classId}/discussions`).on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    console.log('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë°ì´í„°:', data);
                    currentRooms = Object.keys(data).map(id => {
                        const room = { id: id, ...data[id] };
                        // í† ë¡  ì‹œê°„ ì¢…ë£Œ ì²´í¬ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
                        updateRoomStatus(room);
                        return room;
                    });
                    displayRooms();
                });

            } catch (error) {
                console.error('í† ë¡ ë°© ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('roomsList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        âŒ í† ë¡ ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // í† ë¡ ë°© ëª©ë¡ í‘œì‹œ
        function displayRooms() {
            const roomsList = document.getElementById('roomsList');
            
            if (currentRooms.length === 0) {
                roomsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #6c757d;">
                        ğŸ“­ ì•„ì§ ì§„í–‰ ì¤‘ì¸ í† ë¡ ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        <small>êµì‚¬ê°€ í† ë¡ ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</small>
                    </div>
                `;
                return;
            }

            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸
            const showClosedCheckbox = document.getElementById('showClosedRoomsCheckbox');
            const showClosed = showClosedCheckbox ? showClosedCheckbox.checked : false;
            
            // í•„í„°ë§ëœ í† ë¡ ë°© ëª©ë¡
            let filteredRooms = currentRooms.filter(room => {
                const status = room.status || 'active';
                if (showClosed) {
                    return true; // ëª¨ë“  ë°© í‘œì‹œ
                } else {
                    return status === 'active' || status === 'waiting'; // ì§„í–‰ì¤‘/ëŒ€ê¸°ì¤‘ë§Œ í‘œì‹œ
                }
            });

            // ìµœì‹  ìƒì„±ìˆœìœ¼ë¡œ ì •ë ¬ (createdAt ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
            filteredRooms.sort((a, b) => {
                const timeA = a.createdAt || 0;
                const timeB = b.createdAt || 0;
                return timeB - timeA;
            });

            if (filteredRooms.length === 0) {
                roomsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #6c757d;">
                        ğŸ“­ í‘œì‹œí•  í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        <small>${showClosed ? 'í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ì§„í–‰ ì¤‘ì¸ í† ë¡ ì´ ì—†ìŠµë‹ˆë‹¤. "ì¢…ë£Œëœ í† ë¡ ë°© ë³´ê¸°"ë¥¼ ì²´í¬í•˜ë©´ ëª¨ë“  í† ë¡ ë°©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'}</small>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredRooms.forEach(room => {
                const status = room.status || 'active';
                const participants = room.participants || {};
                const participantCount = Object.keys(participants).length;
                
                // í† ë¡  í˜•íƒœë¥¼ í•œê¸€ë¡œ ë³€í™˜
                const typeNames = {
                    'debate': 'ì°¬ë°˜ í† ë¡ ',
                    'discussion': 'ììœ  í† ë¡ ',
                    'postit': 'í¬ìŠ¤íŠ¸ì‡ í† ë¡ ',
                    'survey': 'ì„¤ë¬¸ ì¡°ì‚¬',
                    'general': 'ììœ  í† ë¡ '
                };
                const roomType = typeNames[room.type] || 'ììœ  í† ë¡ ';
                
                let statusClass = 'active';
                let statusText = 'ì§„í–‰ì¤‘';
                let statusStyle = 'status-active';
                
                if (status === 'waiting') {
                    statusClass = 'waiting';
                    statusText = 'ëŒ€ê¸°ì¤‘';
                    statusStyle = 'status-waiting';
                } else if (status === 'closed') {
                    statusClass = 'closed';
                    statusText = 'ì¢…ë£Œë¨';
                    statusStyle = 'status-closed';
                }

                const clickAction = status === 'active' ? 
                    `onclick="joinRoom('${room.id}', '${room.title}', '${status}')"` : 
                    `onclick="viewRoomHistory('${room.id}', '${room.title}')"`;
                
                html += `
                    <div class="room-item ${statusClass}" ${clickAction}>
                        <div class="room-header">
                            <div class="room-title">ğŸ’¬ ${room.title}</div>
                            <div class="room-status ${statusStyle}">${statusText}</div>
                        </div>
                        <div class="room-info">
                            <span>ğŸ‘¥ ${participantCount}ëª… ì°¸ì—¬</span>
                            <span>â° ${room.duration || 30}ë¶„</span>
                            <span>ğŸ“ ${roomType}</span>
                        </div>
                        ${room.description ? `<div style="margin-top: 8px; font-size: 12px; color: #6c757d;">${room.description}</div>` : ''}
                        ${status !== 'active' ? `<div style="text-align: center; margin-top: 8px; font-size: 11px; color: #6c757d;">í´ë¦­í•˜ì—¬ í† ë¡  ê²°ê³¼ ë³´ê¸°</div>` : ''}
                    </div>
                `;
            });

            roomsList.innerHTML = html;
        }

        // í† ë¡ ë°© ì°¸ê°€
        async function joinRoom(roomId, roomTitle, status) {
            if (status === 'closed') {
                alert('ì¢…ë£Œëœ í† ë¡ ì…ë‹ˆë‹¤.');
                return;
            }

            if (status === 'waiting') {
                alert('ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì€ í† ë¡ ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                currentTopicId = roomId;
                
                // í† ë¡  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const topicSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}`).once('value');
                currentTopicData = topicSnapshot.val();
                
                console.log('í† ë¡  ë°ì´í„°:', currentTopicData);
                
                // êµì‚¬ìš©ê³¼ ë™ì¼í•œ ê²½ë¡œë¡œ ì°¸ì—¬ì ë“±ë¡
                const participantData = {
                    name: currentStudent,
                    role: 'student',
                    isAnonymous: false,
                    joinedAt: Date.now(),
                    lastActive: Date.now()
                };
                
                await database.ref(`classes/${currentClassCode}/discussions/${roomId}/participants/${currentStudent}`).set(participantData);
                
                // ì°¸ì—¬ì ìˆ˜ ì¦ê°€
                await database.ref(`classes/${currentClassCode}/discussions/${roomId}/participantCount`).transaction(count => {
                    return (count || 0) + 1;
                });

                console.log('ì°¸ì—¬ì ë“±ë¡ ì™„ë£Œ:', currentStudent, roomId);

                // UI ì—…ë°ì´íŠ¸
                const discussionTitleEl = document.getElementById('discussionTitle');
                if (discussionTitleEl) {
                    discussionTitleEl.textContent = roomTitle;
                }
                
                // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
                updateSidebar();
                
                // í† ë¡  íƒ€ì…ì— ë”°ë¼ UI ì„¤ì •
                setupDiscussionUI();
                
                // í™”ë©´ ì „í™˜
                switchScreen('discussionScreen');
                
                // ìƒíƒœ íŒ¨ë„ í‘œì‹œ
                document.getElementById('statusSection').style.display = 'flex';
                
                // í† ë¡ ë°© ëª©ë¡ ë²„íŠ¼ í‘œì‹œ
                const backToRoomListBtn = document.getElementById('backToRoomListBtn');
                if (backToRoomListBtn) {
                    backToRoomListBtn.style.display = 'inline-block';
                }
                
                // ì‹¤ì‹œê°„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupRealtimeListeners();
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
                setTimeout(() => {
                    updateInputFieldsState();
                }, 500);

            } catch (error) {
                console.error('í† ë¡ ë°© ì°¸ê°€ ì˜¤ë¥˜:', error);
                alert('í† ë¡ ë°© ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í† ë¡  UI ì„¤ì •
        function setupDiscussionUI() {
            const debateDiscussion = document.getElementById('debateDiscussion');
            const generalDiscussion = document.getElementById('generalDiscussion');
            const postitDiscussion = document.getElementById('postitDiscussion');
            
            // ëª¨ë“  UI ìˆ¨ê¸°ê¸°
            debateDiscussion.style.display = 'none';
            generalDiscussion.style.display = 'none';
            postitDiscussion.style.display = 'none';
            
            if (currentTopicData && currentTopicData.type === 'debate') {
                // ì°¬ë°˜ í† ë¡  UI í‘œì‹œ
                debateDiscussion.style.display = 'block';
                console.log('ì°¬ë°˜ í† ë¡  UIë¡œ ì „í™˜');
            } else if (currentTopicData && currentTopicData.type === 'postit') {
                // í¬ìŠ¤íŠ¸ì‡ í† ë¡  UI í‘œì‹œ
                postitDiscussion.style.display = 'block';
                console.log('í¬ìŠ¤íŠ¸ì‡ í† ë¡  UIë¡œ ì „í™˜');
                
                // í¬ìŠ¤íŠ¸ì‡ ë³´ë“œ ì´ˆê¸°í™”
                initializePostitBoard();
            } else {
                // ììœ  í† ë¡  UI í‘œì‹œ (ê¸°ë³¸ - ì‹¤ì‹œê°„ ì±„íŒ…)
                generalDiscussion.style.display = 'block';
                console.log('ììœ  í† ë¡ (ì±„íŒ…) UIë¡œ ì „í™˜');
                
                // ì±„íŒ… ì´ˆê¸°í™”
                initializeChatArea();
            }
        }

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupRealtimeListeners() {
            console.log('ğŸ¯ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘:', currentTopicId);
            
            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆë“¤ ëª…ì‹œì ìœ¼ë¡œ ì œê±°
            cleanupListeners();
            
            console.log('ğŸ¯ ìƒˆë¡œìš´ ë¦¬ìŠ¤ë„ˆ ì„¤ì • - í† ë¡ ë°©:', currentTopicId);
            
            // í˜„ì¬ í† ë¡ ë°©ì˜ ë¦¬ìŠ¤ë„ˆë§Œ ì„¤ì •
            
            // í† ë¡  ì„¤ì • ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/settings`).on('value', (snapshot) => {
                if (snapshot.exists() && currentTopicData) {
                    currentTopicData.settings = snapshot.val();
                    updateInputFieldsState(); // ì…ë ¥ í•„ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
                }
            });
            
            if (currentTopicData && currentTopicData.type === 'debate') {
                // ì°¬ë°˜ í† ë¡ ìš© ë¦¬ìŠ¤ë„ˆ
                setupDebateListeners();
            } else if (currentTopicData && currentTopicData.type === 'postit') {
                // í¬ìŠ¤íŠ¸ì‡ í† ë¡ ìš© ë¦¬ìŠ¤ë„ˆ
                setupPostitListeners();
            } else {
                // ììœ  í† ë¡ ìš© ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ì±„íŒ…)
                setupChatListeners();
            }

            // ê³µí†µ ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸
            database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants`).on('value', (snapshot) => {
                const participants = snapshot.val() || {};
                const count = Object.keys(participants).length;
                console.log('ì°¸ì—¬ì ì—…ë°ì´íŠ¸:', count);
                const discussionStatsEl = document.getElementById('discussionStats');
                if (discussionStatsEl) {
                    updateDiscussionStats(count);
                }
                
                // ì‚¬ì´ë“œë°” ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸
                const participantCountEl = document.getElementById('participantCount');
                if (participantCountEl) {
                    participantCountEl.textContent = `ğŸ‘¥ ${count}ëª… ì°¸ì—¬`;
                }
            });
            
            // êµì‚¬ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const teacherMessagesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/teacherMessages`);
            console.log('ğŸ“¢ êµì‚¬ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì„¤ì •:', `classes/${currentClassCode}/discussions/${currentTopicId}/teacherMessages`);
            
            const teacherMessageListener = (snapshot) => {
                const teacherMessage = snapshot.val();
                console.log('ìƒˆ êµì‚¬ ë©”ì‹œì§€ ìˆ˜ì‹  (ì „ì²´ ë°ì´í„°):', teacherMessage);
                console.log('ìƒˆ êµì‚¬ ë©”ì‹œì§€ ìˆ˜ì‹ :', {
                    currentTopicId: currentTopicId,
                    messageTopicId: teacherMessage.topicId,
                    message: teacherMessage.message,
                    timestamp: teacherMessage.timestamp
                });
                
                // ë©”ì‹œì§€ê°€ í˜„ì¬ í† ë¡ ë°©ìš©ì¸ì§€ í™•ì¸
                if (teacherMessage.topicId && teacherMessage.topicId !== currentTopicId) {
                    console.log('âŒ ë‹¤ë¥¸ í† ë¡ ë°© ë©”ì‹œì§€ ë¬´ì‹œ:', teacherMessage.topicId, 'vs', currentTopicId);
                    return;
                }
                
                console.log('âœ… ë©”ì‹œì§€ í‘œì‹œ:', teacherMessage.message);
                displayTeacherMessage(teacherMessage);
            };
            
            // ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ë° ì¶”ì 
            teacherMessagesRef.on('child_added', teacherMessageListener);
            activeListeners.teacherMessages = {
                ref: teacherMessagesRef,
                event: 'child_added',
                listener: teacherMessageListener
            };
            
            // ê¸°ì¡´ êµì‚¬ ë©”ì‹œì§€ë“¤ ë¡œë“œ
            database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/teacherMessages`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    // ê¸°ì¡´ ë©”ì‹œì§€ë“¤ì„ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ ë¡œí…Œì´ì…˜ì— ì¶”ê°€
                    Object.values(messages)
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(message => {
                            // ë©”ì‹œì§€ê°€ í˜„ì¬ í† ë¡ ë°©ìš©ì¸ì§€ í™•ì¸
                            if (message.topicId && message.topicId !== currentTopicId) {
                                console.log('ê¸°ì¡´ ë©”ì‹œì§€ - ë‹¤ë¥¸ í† ë¡ ë°© ë©”ì‹œì§€ ë¬´ì‹œ:', message.topicId, 'vs', currentTopicId);
                                return;
                            }
                            
                            if (!teacherMessages.some(tm => tm.timestamp === message.timestamp)) {
                                displayTeacherMessage(message);
                            }
                        });
                }
            });
        }

        // ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ í•¨ìˆ˜
        function cleanupListeners() {
            console.log('ğŸ§¹ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆë“¤ ì •ë¦¬ ì‹œì‘');
            
            // ì¶”ì ëœ ë¦¬ìŠ¤ë„ˆë“¤ ì œê±°
            Object.keys(activeListeners).forEach(key => {
                const listenerInfo = activeListeners[key];
                if (listenerInfo && listenerInfo.ref) {
                    console.log(`ğŸ—‘ï¸ ${key} ë¦¬ìŠ¤ë„ˆ ì œê±°`);
                    listenerInfo.ref.off(listenerInfo.event, listenerInfo.listener);
                    activeListeners[key] = null;
                }
            });
            
            // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: ì „ì²´ discussions ê²½ë¡œ ë¦¬ìŠ¤ë„ˆ ì œê±°
            database.ref('discussions').off();
            console.log('ğŸ§¹ ì „ì²´ discussions ë¦¬ìŠ¤ë„ˆ ì œê±° ì™„ë£Œ');
        }

        // í¬ìŠ¤íŠ¸ì‡ í† ë¡  ë¦¬ìŠ¤ë„ˆ
        function setupPostitListeners() {
            const messagesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`);
            
            // ğŸ”§ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            messagesRef.off();
            console.log('ğŸ§¹ í¬ìŠ¤íŠ¸ì‡ ë¦¬ìŠ¤ë„ˆ ê¸°ì¡´ ë“±ë¡ í•´ì œ');
            
            const joinTime = Date.now(); // ì°¸ì—¬ ì‹œì  ê¸°ë¡
            
            // ê¸°ì¡´ í¬ìŠ¤íŠ¸ì‡ë“¤ì„ í•œë²ˆì— ë¡œë“œ
            messagesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    Object.values(messages)
                        .filter(msg => msg.type === 'postit')
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(message => {
                            console.log('ê¸°ì¡´ í¬ìŠ¤íŠ¸ì‡ ë¡œë“œ:', message);
                            addPostitToBoard(message);
                        });
                }
            });
            
            // ìƒˆë¡œìš´ í¬ìŠ¤íŠ¸ì‡ë§Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¶”ê°€ (ì°¸ì—¬ ì‹œì  ì´í›„)
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                
                // í¬ìŠ¤íŠ¸ì‡ì´ê³  ì°¸ì—¬ ì‹œì  ì´í›„ì— ì‘ì„±ëœ ê²ƒë§Œ ì²˜ë¦¬
                if (message.type === 'postit' && message.timestamp > joinTime) {
                    console.log('ìƒˆ í¬ìŠ¤íŠ¸ì‡ ì‹¤ì‹œê°„ ì¶”ê°€:', message);
                    addPostitToBoard(message);
                }
            });
            
            console.log('ğŸ¯ í¬ìŠ¤íŠ¸ì‡ ë¦¬ìŠ¤ë„ˆ ìƒˆë¡œ ì„¤ì • ì™„ë£Œ');
        }

        // ììœ  í† ë¡  ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ì±„íŒ…)
        function setupChatListeners() {
            const messagesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`);
            
            // ğŸ”§ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            messagesRef.off();
            console.log('ğŸ§¹ ì±„íŒ… ë¦¬ìŠ¤ë„ˆ ê¸°ì¡´ ë“±ë¡ í•´ì œ');
            
            const joinTime = Date.now(); // ì°¸ì—¬ ì‹œì  ê¸°ë¡
            
            // ê¸°ì¡´ ì±„íŒ… ë©”ì‹œì§€ë“¤ì„ í•œë²ˆì— ë¡œë“œ
            messagesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    Object.values(messages)
                        .filter(msg => msg.type === 'chat')
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(message => {
                            console.log('ê¸°ì¡´ ì±„íŒ… ë©”ì‹œì§€ ë¡œë“œ:', message);
                            addChatMessage(message);
                        });
                }
            });
            
            // ì‹¤ì‹œê°„ ìƒˆ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                
                // ì±„íŒ… ë©”ì‹œì§€ì´ê³  ì°¸ì—¬ ì‹œì  ì´í›„ì— ì‘ì„±ëœ ê²ƒë§Œ ì²˜ë¦¬
                if (message.type === 'chat' && message.timestamp > joinTime) {
                    console.log('ìƒˆ ì±„íŒ… ë©”ì‹œì§€ ì‹¤ì‹œê°„ ì¶”ê°€:', message);
                    addChatMessage(message);
                }
            });
        }

        // ì°¬ë°˜ í† ë¡  ë¦¬ìŠ¤ë„ˆ
        function setupDebateListeners() {
            const votesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes`);
            
            // ğŸ”§ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            votesRef.off();
            console.log('ğŸ§¹ ì°¬ë°˜í† ë¡  ë¦¬ìŠ¤ë„ˆ ê¸°ì¡´ ë“±ë¡ í•´ì œ');
            
            // íˆ¬í‘œ ë¦¬ìŠ¤ë„ˆ
            votesRef.on('value', (snapshot) => {
                const votes = snapshot.val() || {};
                console.log('íˆ¬í‘œ ì—…ë°ì´íŠ¸:', votes);
                updateDebateResults(votes);
                updateDebateOpinions(votes);
            });
        }


        // í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€
        async function addPostit() {
            // í•™ìƒ ê²Œì‹œê¸€ í—ˆìš© ì—¬ë¶€ í™•ì¸
            if (!isStudentPostAllowed()) {
                alert('ğŸ“ í˜„ì¬ êµì‚¬ê°€ í•™ìƒ ê²Œì‹œê¸€ì„ ì œí•œí•˜ê³  ìˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const input = document.getElementById('postitInput');
            const content = input.value.trim();
            
            if (!content) return;

            try {
                const colors = ['yellow', 'blue', 'green', 'pink'];
                const color = colors[Math.floor(Math.random() * colors.length)];

                // ë©”ì‹œì§€ ID ìƒì„±
                const messageRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`).push();
                const messageId = messageRef.key;

                // í¬ìŠ¤íŠ¸ì‡ë„ ë©”ì‹œì§€ í˜•íƒœë¡œ ì €ì¥ (typeìœ¼ë¡œ êµ¬ë¶„)
                await messageRef.set({
                    participantId: currentStudent,
                    participantName: currentStudent,
                    content: content,
                    type: 'postit',
                    color: color,
                    isAnonymous: false,
                    timestamp: Date.now(),
                    messageId: messageId
                });

                console.log('í¬ìŠ¤íŠ¸ì‡ ì „ì†¡ ì™„ë£Œ:', content);
                input.value = '';
            } catch (error) {
                console.error('í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('í¬ìŠ¤íŠ¸ì‡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì°¬ë°˜ í† ë¡  íˆ¬í‘œ ì œì¶œ
        async function submitDebateVote(position) {
            // í•™ìƒ ê²Œì‹œê¸€ í—ˆìš© ì—¬ë¶€ í™•ì¸
            if (!isStudentPostAllowed()) {
                alert('ğŸ“ í˜„ì¬ êµì‚¬ê°€ í•™ìƒ ì˜ê²¬ ì‘ì„±ì„ ì œí•œí•˜ê³  ìˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const inputId = position === 'agree' ? 'agreeInput' : 'disagreeInput';
            const inputEl = document.getElementById(inputId);
            
            if (!inputEl) {
                console.error(`Input element not found: ${inputId}`);
                return;
            }
            
            const opinion = inputEl.value.trim();
            
            if (!opinion) {
                alert('ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const voteData = {
                    participantId: currentStudent,
                    participantName: currentStudent,
                    position: position,
                    opinion: opinion,
                    timestamp: Date.now()
                };
                
                const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes/${voteId}`).set(voteData);
                
                console.log('íˆ¬í‘œ ì œì¶œ ì™„ë£Œ:', voteData);
                inputEl.value = '';
                alert(`${position === 'agree' ? 'ì°¬ì„±' : 'ë°˜ëŒ€'} ì˜ê²¬ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
            } catch (error) {
                console.error('íˆ¬í‘œ ì œì¶œ ì˜¤ë¥˜:', error);
                alert('íˆ¬í‘œ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì°¬ë°˜ í† ë¡  ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateDebateResults(votes) {
            const agreeVotes = [];
            const disagreeVotes = [];
            
            Object.values(votes).forEach(vote => {
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            const agreeCount = agreeVotes.length;
            const disagreeCount = disagreeVotes.length;
            const total = agreeCount + disagreeCount;
            
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const agreeCountEl = document.getElementById('agreeCount');
            const disagreeCountEl = document.getElementById('disagreeCount');
            if (agreeCountEl) agreeCountEl.textContent = agreeCount;
            if (disagreeCountEl) disagreeCountEl.textContent = disagreeCount;
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            const agreeBar = document.getElementById('agreeBar');
            const disagreeBar = document.getElementById('disagreeBar');
            if (total > 0 && agreeBar && disagreeBar) {
                const agreePercent = (agreeCount / total) * 100;
                const disagreePercent = (disagreeCount / total) * 100;
                
                agreeBar.style.width = `${agreePercent}%`;
                disagreeBar.style.width = `${disagreePercent}%`;
            }
            
            console.log(`ì°¬ë°˜í† ë¡  ê²°ê³¼ ì—…ë°ì´íŠ¸: ì°¬ì„± ${agreeCount}, ë°˜ëŒ€ ${disagreeCount}`);
        }

        // ì°¬ë°˜ í† ë¡  ì˜ê²¬ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateDebateOpinions(votes) {
            const agreeList = document.getElementById('agreeList');
            const disagreeList = document.getElementById('disagreeList');
            
            if (!agreeList || !disagreeList) return;
            
            const agreeVotes = [];
            const disagreeVotes = [];
            
            Object.keys(votes).forEach(voteId => {
                const vote = votes[voteId];
                vote.id = voteId; // ID ì¶”ê°€
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            // ì°¬ì„± ì˜ê²¬ ëª©ë¡
            agreeList.innerHTML = agreeVotes.map(vote => {
                const isMe = vote.participantId === currentStudent;
                const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                const actionsHtml = isMe ? `
                    <div style="margin-top: 5px;">
                        <button onclick="editDebateVote('${vote.id}')" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-right: 3px;">âœï¸ ìˆ˜ì •</button>
                        <button onclick="deleteDebateVote('${vote.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                ` : '';
                
                return `
                    <div style="background: ${isMe ? '#c3e6cb' : '#f8f9fa'}; padding: 8px; border-radius: 4px; margin-bottom: 5px; font-size: 12px;" data-vote-id="${vote.id}">
                        <strong>${vote.participantName}</strong> (${timestamp})<br>
                        <div class="vote-opinion">${vote.opinion}${vote.isEdited ? ' <small style="opacity: 0.6;">(ìˆ˜ì •ë¨)</small>' : ''}</div>
                        ${actionsHtml}
                    </div>
                `;
            }).join('') || '<div style="color: #6c757d; text-align: center; padding: 20px;">ì•„ì§ ì°¬ì„± ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            
            // ë°˜ëŒ€ ì˜ê²¬ ëª©ë¡
            disagreeList.innerHTML = disagreeVotes.map(vote => {
                const isMe = vote.participantId === currentStudent;
                const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                const actionsHtml = isMe ? `
                    <div style="margin-top: 5px;">
                        <button onclick="editDebateVote('${vote.id}')" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-right: 3px;">âœï¸ ìˆ˜ì •</button>
                        <button onclick="deleteDebateVote('${vote.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                ` : '';
                
                return `
                    <div style="background: ${isMe ? '#f5c6cb' : '#f8f9fa'}; padding: 8px; border-radius: 4px; margin-bottom: 5px; font-size: 12px;" data-vote-id="${vote.id}">
                        <strong>${vote.participantName}</strong> (${timestamp})<br>
                        <div class="vote-opinion">${vote.opinion}${vote.isEdited ? ' <small style="opacity: 0.6;">(ìˆ˜ì •ë¨)</small>' : ''}</div>
                        ${actionsHtml}
                    </div>
                `;
            }).join('') || '<div style="color: #6c757d; text-align: center; padding: 20px;">ì•„ì§ ë°˜ëŒ€ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        // ì°¬ë°˜ í† ë¡  ì˜ê²¬ ìˆ˜ì •
        function editDebateVote(voteId) {
            const voteDiv = document.querySelector(`[data-vote-id="${voteId}"]`);
            if (!voteDiv) return;
            
            const opinionDiv = voteDiv.querySelector('.vote-opinion');
            const currentOpinion = opinionDiv.textContent.replace(' (ìˆ˜ì •ë¨)', '').trim();
            
            // í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
            opinionDiv.innerHTML = `
                <textarea style="width: 100%; height: 40px; font-size: 11px; border: 1px solid #ccc; border-radius: 3px; padding: 4px;" id="edit-vote-${voteId}">${currentOpinion}</textarea>
                <div style="margin-top: 5px;">
                    <button onclick="saveDebateVote('${voteId}')" style="background: #28a745; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-right: 3px;">ì €ì¥</button>
                    <button onclick="cancelEditDebateVote('${voteId}', '${currentOpinion.replace(/'/g, "\\'")}')" style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">ì·¨ì†Œ</button>
                </div>
            `;
            
            // textareaì— í¬ì»¤ìŠ¤
            const textarea = document.getElementById(`edit-vote-${voteId}`);
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // ì°¬ë°˜ í† ë¡  ì˜ê²¬ ìˆ˜ì • ì €ì¥
        async function saveDebateVote(voteId) {
            const textarea = document.getElementById(`edit-vote-${voteId}`);
            const newOpinion = textarea.value.trim();
            
            if (!newOpinion) {
                alert('ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // Firebaseì—ì„œ íˆ¬í‘œ ì—…ë°ì´íŠ¸
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes/${voteId}`).update({
                    opinion: newOpinion,
                    lastModified: Date.now(),
                    isEdited: true
                });
                
                console.log('íˆ¬í‘œ ìˆ˜ì • ì™„ë£Œ:', voteId);
                
            } catch (error) {
                console.error('íˆ¬í‘œ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì°¬ë°˜ í† ë¡  ì˜ê²¬ ìˆ˜ì • ì·¨ì†Œ
        function cancelEditDebateVote(voteId, originalOpinion) {
            const voteDiv = document.querySelector(`[data-vote-id="${voteId}"]`);
            const opinionDiv = voteDiv.querySelector('.vote-opinion');
            
            // ì›ë˜ ë‚´ìš©ìœ¼ë¡œ ë³µì›
            opinionDiv.innerHTML = originalOpinion;
        }

        // ì°¬ë°˜ í† ë¡  ì˜ê²¬ ì‚­ì œ
        async function deleteDebateVote(voteId) {
            if (!confirm('ì´ ì˜ê²¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                // Firebaseì—ì„œ íˆ¬í‘œ ì‚­ì œ
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes/${voteId}`).remove();
                
                console.log('íˆ¬í‘œ ì‚­ì œ ì™„ë£Œ:', voteId);
                
            } catch (error) {
                console.error('íˆ¬í‘œ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í¬ìŠ¤íŠ¸ì‡ ë³´ë“œì— ì¶”ê°€
        function addPostitToBoard(postitData) {
            const board = document.getElementById('postitBoard');
            
            // ì¤‘ë³µ í¬ìŠ¤íŠ¸ì‡ ì²´í¬ (íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ë‚´ìš©ìœ¼ë¡œ í™•ì¸)
            const existingPostits = board.querySelectorAll('.postit');
            for (let existingPostit of existingPostits) {
                const existingTimestamp = existingPostit.getAttribute('data-timestamp');
                const existingContent = existingPostit.querySelector('.postit-content')?.textContent;
                if (existingTimestamp === String(postitData.timestamp) && 
                    existingContent === postitData.message) {
                    console.log('ì¤‘ë³µ í¬ìŠ¤íŠ¸ì‡ ê°ì§€, ì¶”ê°€í•˜ì§€ ì•ŠìŒ:', postitData.message);
                    return;
                }
            }
            
            // ì²« ë²ˆì§¸ í¬ìŠ¤íŠ¸ì‡ì¼ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
            const welcomeMsg = board.querySelector('[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const postit = document.createElement('div');
            postit.className = `postit ${postitData.color || 'yellow'}`;
            postit.setAttribute('data-message-id', postitData.messageId || postitData.id);
            postit.setAttribute('data-participant-id', postitData.participantId);
            postit.setAttribute('data-timestamp', postitData.timestamp);
            
            const isMyPostit = postitData.participantId === currentStudent;
            const actionsHtml = isMyPostit ? `
                <div class="postit-actions">
                    <button class="postit-btn postit-edit-btn" onclick="editPostit('${postitData.messageId || postitData.id}')" title="ìˆ˜ì •">âœï¸</button>
                    <button class="postit-btn postit-delete-btn" onclick="deletePostit('${postitData.messageId || postitData.id}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                </div>
            ` : '';
            
            postit.innerHTML = `
                ${actionsHtml}
                <div class="postit-content">${postitData.content}</div>
                <div class="postit-author">${postitData.participantName}</div>
            `;

            board.appendChild(postit);
        }

        // í¬ìŠ¤íŠ¸ì‡ ìˆ˜ì •
        function editPostit(messageId) {
            const postit = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!postit) return;
            
            const contentDiv = postit.querySelector('.postit-content');
            const currentContent = contentDiv.textContent;
            
            // í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
            postit.classList.add('postit-editing');
            contentDiv.innerHTML = `
                <textarea class="postit-edit-textarea" placeholder="í¬ìŠ¤íŠ¸ì‡ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">${currentContent}</textarea>
                <div class="postit-edit-actions">
                    <button class="postit-save-btn" onclick="savePostit('${messageId}')">ì €ì¥</button>
                    <button class="postit-cancel-btn" onclick="cancelEditPostit('${messageId}', '${currentContent.replace(/'/g, "\\'")}')">ì·¨ì†Œ</button>
                </div>
            `;
            
            // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
            const actions = postit.querySelector('.postit-actions');
            if (actions) actions.style.display = 'none';
            
            // textareaì— í¬ì»¤ìŠ¤
            const textarea = postit.querySelector('.postit-edit-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // í¬ìŠ¤íŠ¸ì‡ ìˆ˜ì • ì €ì¥
        async function savePostit(messageId) {
            const postit = document.querySelector(`[data-message-id="${messageId}"]`);
            const textarea = postit.querySelector('.postit-edit-textarea');
            const newContent = textarea.value.trim();
            
            if (!newContent) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // Firebaseì—ì„œ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages/${messageId}`).update({
                    content: newContent,
                    lastModified: Date.now(),
                    isEdited: true
                });
                
                // UI ì—…ë°ì´íŠ¸
                const contentDiv = postit.querySelector('.postit-content');
                contentDiv.innerHTML = newContent + ' <small style="opacity: 0.6;">(ìˆ˜ì •ë¨)</small>';
                
                // í¸ì§‘ ëª¨ë“œ í•´ì œ
                postit.classList.remove('postit-editing');
                
                // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
                const actions = postit.querySelector('.postit-actions');
                if (actions) actions.style.display = '';
                
                console.log('í¬ìŠ¤íŠ¸ì‡ ìˆ˜ì • ì™„ë£Œ:', messageId);
                
            } catch (error) {
                console.error('í¬ìŠ¤íŠ¸ì‡ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í¬ìŠ¤íŠ¸ì‡ ìˆ˜ì • ì·¨ì†Œ
        function cancelEditPostit(messageId, originalContent) {
            const postit = document.querySelector(`[data-message-id="${messageId}"]`);
            const contentDiv = postit.querySelector('.postit-content');
            
            // ì›ë˜ ë‚´ìš©ìœ¼ë¡œ ë³µì›
            contentDiv.innerHTML = originalContent;
            
            // í¸ì§‘ ëª¨ë“œ í•´ì œ
            postit.classList.remove('postit-editing');
            
            // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
            const actions = postit.querySelector('.postit-actions');
            if (actions) actions.style.display = '';
        }

        // í¬ìŠ¤íŠ¸ì‡ ì‚­ì œ
        async function deletePostit(messageId) {
            if (!confirm('ì´ í¬ìŠ¤íŠ¸ì‡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                // Firebaseì—ì„œ ë©”ì‹œì§€ ì‚­ì œ
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages/${messageId}`).remove();
                
                // UIì—ì„œ í¬ìŠ¤íŠ¸ì‡ ì œê±°
                const postit = document.querySelector(`[data-message-id="${messageId}"]`);
                if (postit) {
                    postit.style.animation = 'fadeOut 0.3s ease-in-out';
                    setTimeout(() => {
                        postit.remove();
                        
                        // í¬ìŠ¤íŠ¸ì‡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                        const board = document.getElementById('postitBoard');
                        if (board && board.children.length === 0) {
                            board.innerHTML = `
                                <div style="text-align: center; color: #6c757d; padding: 40px; font-size: 16px;">
                                    ğŸ’­ ì²« ë²ˆì§¸ ì˜ê²¬ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
                                </div>
                            `;
                        }
                    }, 300);
                }
                
                console.log('í¬ìŠ¤íŠ¸ì‡ ì‚­ì œ ì™„ë£Œ:', messageId);
                
            } catch (error) {
                console.error('í¬ìŠ¤íŠ¸ì‡ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í‚¤ë³´ë“œ ì—”í„° ì²˜ë¦¬
        function handlePostitEnter(event) {
            if (event.key === 'Enter') {
                addPostit();
            }
        }

        // í™”ë©´ ì „í™˜
        function switchScreen(screenId) {
            const screens = ['loginScreen', 'roomListScreen', 'discussionScreen'];
            screens.forEach(id => {
                document.getElementById(id).style.display = id === screenId ? 'block' : 'none';
            });
        }

        // ë’¤ë¡œ ê°€ê¸°
        function goBack() {
            switchScreen('loginScreen');
            document.getElementById('statusSection').style.display = 'none';
            
            // í† ë¡ ë°© ëª©ë¡ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const backToRoomListBtn = document.getElementById('backToRoomListBtn');
            if (backToRoomListBtn) {
                backToRoomListBtn.style.display = 'none';
            }
            
            // ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            if (backToLoginBtn) {
                backToLoginBtn.style.display = 'none';
            }
            
            // ìƒíƒœ ì´ˆê¸°í™”
            currentStudent = null;
            currentClassCode = null;
            currentClassName = null;
        }

        // í† ë¡  ë‚˜ê°€ê¸°
        function leaveDiscussion() {
            if (currentTopicId && currentStudent) {
                // ì°¸ì—¬ì ëª©ë¡ì—ì„œ ì œê±° - êµì‚¬ìš©ê³¼ ë™ì¼í•œ ê²½ë¡œ ì‚¬ìš©
                database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants/${currentStudent}`).remove();
            }
            
            // êµì‚¬ ë©”ì‹œì§€ ë¡œí…Œì´ì…˜ ì •ë¦¬
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
                messageRotationInterval = null;
            }
            teacherMessages = [];
            currentMessageIndex = 0;
            
            // ëª¨ë“  ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
            cleanupListeners();
            
            switchScreen('roomListScreen');
            currentTopicId = null;
            
            // ìƒíƒœ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            document.getElementById('statusSection').style.display = 'none';
            
            // í† ë¡ ë°© ëª©ë¡ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const backToRoomListBtn = document.getElementById('backToRoomListBtn');
            if (backToRoomListBtn) {
                backToRoomListBtn.style.display = 'none';
            }
            
            // ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ í‘œì‹œ
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            if (backToLoginBtn) {
                backToLoginBtn.style.display = 'inline-block';
            }
        }

        // í”„ë¡œê·¸ë¨ ì¢…ë£Œ
        function exitDiscussion() {
            if (confirm('ì •ë§ í† ë¡ ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (currentTopicId && currentStudent) {
                    // êµì‚¬ìš©ê³¼ ë™ì¼í•œ ê²½ë¡œ ì‚¬ìš©
                    database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants/${currentStudent}`).remove();
                }
                
                // êµì‚¬ ë©”ì‹œì§€ ë¡œí…Œì´ì…˜ ì •ë¦¬
                if (messageRotationInterval) {
                    clearInterval(messageRotationInterval);
                    messageRotationInterval = null;
                }
                teacherMessages = [];
                currentMessageIndex = 0;
                
                goBack();
            }
        }

        // ìƒˆë¡œê³ ì¹¨
        function refreshRooms() {
            if (currentClassCode) {
                const classId = getClassId();
                loadRooms(classId);
            }
        }


        // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
        function updateSidebar() {
            // í•™ìƒ ì •ë³´ ì—…ë°ì´íŠ¸
            const studentNameEl = document.getElementById('sidebarStudentName');
            const studentAvatarEl = document.getElementById('studentAvatar');
            if (studentNameEl && currentStudent) {
                studentNameEl.textContent = currentStudent;
                if (studentAvatarEl) {
                    studentAvatarEl.textContent = currentStudent.charAt(0);
                }
            }
            
            // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
            const roomTitleEl = document.getElementById('sidebarRoomTitle');
            const roomTypeEl = document.getElementById('sidebarRoomType');
            if (roomTitleEl && currentTopicData) {
                roomTitleEl.textContent = currentTopicData.title;
                if (roomTypeEl) {
                    const typeNames = {
                        'debate': 'ì°¬ë°˜ í† ë¡ ',
                        'discussion': 'ììœ  í† ë¡ ',
                        'survey': 'ì„¤ë¬¸ ì¡°ì‚¬'
                    };
                    roomTypeEl.textContent = typeNames[currentTopicData.type] || 'ììœ  í† ë¡ ';
                }
            }
            
            // ë‹¤ë¥¸ í† ë¡ ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
            updateOtherRoomsList();
            
            // ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
            if (currentTopicData && currentTopicData.endTime) {
                startStatusPanelUpdater();
            }
        }
        
        // ë‹¤ë¥¸ í† ë¡ ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateOtherRoomsList() {
            console.log('updateOtherRoomsList ì‹œì‘');
            const otherRoomsEl = document.getElementById('otherRoomsList');
            if (!otherRoomsEl || !currentRooms) {
                console.log('âŒ otherRoomsEl ë˜ëŠ” currentRoomsê°€ ì—†ìŒ:', {otherRoomsEl, currentRooms});
                return;
            }
            
            // í˜„ì¬ í† ë¡ ë°© ì œì™¸
            let otherRooms = currentRooms.filter(room => room.id !== currentTopicId);
            console.log('í˜„ì¬ í† ë¡ ë°© ì œì™¸í•œ ëª©ë¡:', otherRooms.length, 'ê°œ');
            
            // ìµœì‹  ìƒì„±ìˆœìœ¼ë¡œ ì •ë ¬ (createdAt ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
            otherRooms.sort((a, b) => {
                const timeA = a.createdAt || 0;
                const timeB = b.createdAt || 0;
                return timeB - timeA;
            });
            console.log('ìµœì‹ ìˆœ ì •ë ¬ ì™„ë£Œ');
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ (ì‚¬ì´ë“œë°”ìš©)
            const showClosedCheckbox = document.getElementById('showClosedRoomsSidebarCheckbox');
            const showClosed = showClosedCheckbox ? showClosedCheckbox.checked : false;
            console.log('ì‚¬ì´ë“œë°” ì²´í¬ë°•ìŠ¤ ìƒíƒœ:', showClosed);
            
            // ì¢…ë£Œëœ í† ë¡ ë°© í•„í„°ë§
            if (!showClosed) {
                console.log('ì¢…ë£Œëœ í† ë¡ ë°© ì œì™¸ - í•„í„°ë§ ì „:', otherRooms.map(r => ({id: r.id, title: r.title, status: r.status})));
                // ì§„í–‰ ì¤‘ì¸ í† ë¡ ë°©ë§Œ í‘œì‹œ (active, waitingë§Œ í—ˆìš©)
                otherRooms = otherRooms.filter(room => room.status === 'active' || room.status === 'waiting');
                console.log('ì¢…ë£Œëœ í† ë¡ ë°© ì œì™¸ - í•„í„°ë§ í›„:', otherRooms.map(r => ({id: r.id, title: r.title, status: r.status})));
            } else {
                console.log('ëª¨ë“  í† ë¡ ë°© í‘œì‹œ:', otherRooms.map(r => ({id: r.id, title: r.title, status: r.status})));
            }
            
            if (otherRooms.length === 0) {
                const message = showClosed ? 'ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤' : 'ì§„í–‰ ì¤‘ì¸ ë‹¤ë¥¸ í† ë¡ ë°©ì´ ì—†ìŠµë‹ˆë‹¤';
                otherRoomsEl.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">
                        ${message}
                    </div>
                `;
                return;
            }
            
            const roomsHtml = otherRooms.map(room => {
                const statusText = room.status === 'active' ? 'ì§„í–‰ì¤‘' : room.status === 'waiting' ? 'ëŒ€ê¸°ì¤‘' : 'ì¢…ë£Œ';
                const statusClass = room.status === 'active' ? '' : 'style="opacity: 0.6;"';
                
                return `
                    <div class="room-item-mini" onclick="switchToRoom('${room.id}', '${room.title}', '${room.status}')" ${statusClass}>
                        <div style="font-weight: bold; margin-bottom: 2px;">${room.title}</div>
                        <div style="color: #6c757d;">${statusText} â€¢ ${Object.keys(room.participants || {}).length}ëª…</div>
                    </div>
                `;
            }).join('');
            
            otherRoomsEl.innerHTML = roomsHtml;
        }
        
        // í¬ìŠ¤íŠ¸ì‡ ë³´ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializePostitBoard() {
            const board = document.getElementById('postitBoard');
            if (board) {
                // ë³´ë“œ ì™„ì „íˆ ì´ˆê¸°í™”
                board.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px; grid-column: 1 / -1;">
                        ğŸ“ ì•„ì§ ì‘ì„±ëœ í¬ìŠ¤íŠ¸ì‡ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
                console.log('í¬ìŠ¤íŠ¸ì‡ ë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
            }
        }

        // í† ë¡ ë°© ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateRoomStatus(room) {
            if (!room.endTime) return;
            
            const now = Date.now();
            const endTime = room.endTime;
            
            // í† ë¡  ì‹œê°„ì´ ëë‚¬ëŠ”ë° ì•„ì§ active ìƒíƒœë¼ë©´ closedë¡œ ë³€ê²½
            if (endTime < now && room.status === 'active') {
                room.status = 'closed';
                console.log(`í† ë¡ ë°© "${room.title}" ì‹œê°„ ì¢…ë£Œë¡œ ìƒíƒœ ë³€ê²½: active â†’ closed`);
            }
        }

        // ì¢…ë£Œëœ í† ë¡ ë°© í‘œì‹œ í† ê¸€
        function toggleClosedRooms() {
            // í˜„ì¬ í™”ë©´ì— ë”°ë¼ ë‹¤ë¥¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
            const roomListScreen = document.getElementById('roomListScreen');
            const discussionScreen = document.getElementById('discussionScreen');
            
            if (roomListScreen && roomListScreen.style.display !== 'none') {
                // í† ë¡ ë°© ëª©ë¡ í™”ë©´ì—ì„œ í˜¸ì¶œëœ ê²½ìš°
                displayRooms();
            } else if (discussionScreen && discussionScreen.style.display !== 'none') {
                // í† ë¡  ì°¸ì—¬ í™”ë©´ì—ì„œ í˜¸ì¶œëœ ê²½ìš° (ì‚¬ì´ë“œë°”ì˜ ë‹¤ë¥¸ í† ë¡ ë°© ëª©ë¡)
                updateOtherRoomsList();
            }
        }

        // ì‚¬ì´ë“œë°” ì²´í¬ë°•ìŠ¤ìš© í† ê¸€ í•¨ìˆ˜ (ìƒˆë¡œê³ ì¹¨ í¬í•¨)
        async function toggleClosedRoomsWithRefresh() {
            console.log('ì‚¬ì´ë“œë°” ì²´í¬ë°•ìŠ¤ í´ë¦­ - í† ë¡ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë¨¼ì € í™•ì¸
            const showClosedCheckbox = document.getElementById('showClosedRoomsSidebarCheckbox');
            const showClosed = showClosedCheckbox ? showClosedCheckbox.checked : false;
            console.log('ì²´í¬ë°•ìŠ¤ ìƒíƒœ:', showClosed);
            
            try {
                // í† ë¡ ë°© ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œ
                if (currentClassCode) {
                    console.log('í† ë¡ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨:', currentClassCode);
                    await loadRooms(currentClassCode);
                    console.log('âœ… í† ë¡ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                    
                    // ìƒˆë¡œê³ ì¹¨ í›„ ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
                    updateOtherRoomsList();
                    console.log('âœ… ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    console.log('âŒ currentClassCodeê°€ ì—†ì–´ì„œ ìƒˆë¡œê³ ì¹¨ ë¶ˆê°€');
                    // ìƒˆë¡œê³ ì¹¨ ì—†ì´ ê¸°ì¡´ ëª©ë¡ë§Œ ì—…ë°ì´íŠ¸
                    updateOtherRoomsList();
                }
            } catch (error) {
                console.error('í† ë¡ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´
                updateOtherRoomsList();
            }
        }
        
        // ë‹¤ë¥¸ í† ë¡ ë°©ìœ¼ë¡œ ì „í™˜
        function switchToRoom(roomId, roomTitle, status) {
            if (status !== 'active') {
                alert('ì§„í–‰ ì¤‘ì¸ í† ë¡ ë§Œ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('í˜„ì¬ í† ë¡ ì„ ë‚˜ê°€ê³  ë‹¤ë¥¸ í† ë¡ ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // í˜„ì¬ í† ë¡ ì—ì„œ ë‚˜ê°€ê¸°
                if (currentTopicId && currentStudent) {
                    database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants/${currentStudent}`).remove();
                }
                
                // ìƒˆ í† ë¡  ì°¸ê°€
                joinRoom(roomId, roomTitle, status);
            }
        }
        
        // ìƒíƒœ íŒ¨ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDiscussionStats(participantCount) {
            const discussionStatsEl = document.getElementById('discussionStats');
            if (!discussionStatsEl) return;
            
            if (!currentTopicData || !currentTopicData.endTime) {
                discussionStatsEl.innerHTML = `ğŸ‘¥ ${participantCount}ëª…`;
                return;
            }
            
            const now = Date.now();
            const endTime = currentTopicData.endTime;
            const timeLeft = endTime - now;
            
            if (timeLeft <= 0) {
                discussionStatsEl.innerHTML = `ì¢…ë£Œë¨ | ğŸ‘¥ ${participantCount}ëª…`;
                return;
            }
            
            const minutes = Math.floor(timeLeft / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            discussionStatsEl.innerHTML = `${minutes}ë¶„ ${seconds.toString().padStart(2, '0')}ì´ˆ | ğŸ‘¥ ${participantCount}ëª…`;
        }

        // ìƒíƒœ íŒ¨ë„ ì‹œê°„ ì—…ë°ì´í„° ì‹œì‘
        function startStatusPanelUpdater() {
            if (!currentTopicData || !currentTopicData.endTime) return;
            
            function updateStatusPanel() {
                // í˜„ì¬ ì°¸ì—¬ì ìˆ˜ ê³„ì‚°
                const participants = Object.keys(currentTopicData.participants || {}).length;
                updateDiscussionStats(participants);
            }
            
            updateStatusPanel();
            setInterval(updateStatusPanel, 1000);
        }
        
        // íŒ ë¡œí…Œì´ì…˜
        function rotateTips() {
            const tipsBox = document.getElementById('tipsBox');
            if (!tipsBox) return;
            
            const allTips = [
                'êµ¬ì²´ì ì¸ ì˜ˆì‹œë¥¼ ë“¤ì–´ ì˜ê²¬ì„ í‘œí˜„í•´ë³´ì„¸ìš”',
                'ë‹¤ë¥¸ ì¹œêµ¬ë“¤ì˜ ì˜ê²¬ë„ ì¡´ì¤‘í•´ì£¼ì„¸ìš”',
                'ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ë‚˜ëˆ„ì–´ë³´ì„¸ìš”',
                'ì£¼ì œì— ë§ëŠ” ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”',
                'í˜‘ë ¥í•˜ì—¬ ë” ë‚˜ì€ ê²°ë¡ ì„ ì°¾ì•„ë³´ì„¸ìš”',
                'ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”'
            ];
            
            let currentTipIndex = 0;
            
            function updateTip() {
                tipsBox.textContent = allTips[currentTipIndex];
                currentTipIndex = (currentTipIndex + 1) % allTips.length;
            }
            
            // 15ì´ˆë§ˆë‹¤ íŒ ë¡œí…Œì´ì…˜
            setInterval(updateTip, 15000);
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function getClassId() {
            // currentClassCodeì— ì‹¤ì œ classIdê°€ ì €ì¥ë˜ì–´ ìˆìŒ
            return currentClassCode;
        }


        // í† ë¡  ì´ë ¥ ë³´ê¸° (í•™ìƒìš©)
        async function viewRoomHistory(roomId, roomTitle) {
            try {
                console.log('í† ë¡  ì´ë ¥ ë¡œë“œ ì¤‘:', roomId);
                
                // í† ë¡  ê¸°ë³¸ ì •ë³´ ë¡œë“œ
                const topicSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}`).once('value');
                const topicData = topicSnapshot.val();
                
                if (!topicData) {
                    alert('í† ë¡  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // í† ë¡  ë©”ì‹œì§€/í¬ìŠ¤íŠ¸ì‡ ë¡œë“œ
                const messagesSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}/messages`).once('value');
                const messages = messagesSnapshot.val() || {};
                
                // ì°¬ë°˜ í† ë¡ ì¸ ê²½ìš° íˆ¬í‘œ ë°ì´í„°ë„ ë¡œë“œ
                let votes = {};
                if (topicData.type === 'debate') {
                    const votesSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}/votes`).once('value');
                    votes = votesSnapshot.val() || {};
                }
                
                // ì°¸ì—¬ì ë°ì´í„° ë¡œë“œ
                const participantsSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                // í•™ìƒìš© ì´ë ¥ ëª¨ë‹¬ í‘œì‹œ
                showStudentHistoryModal(topicData, messages, votes, participants);
                
            } catch (error) {
                console.error('í† ë¡  ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('í† ë¡  ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // í•™ìƒìš© í† ë¡  ì´ë ¥ ëª¨ë‹¬ í‘œì‹œ
        function showStudentHistoryModal(topicData, messages, votes, participants) {
            const typeNames = {
                'debate': 'ì°¬ë°˜ í† ë¡ ',
                'discussion': 'ììœ  í† ë¡ ', 
                'postit': 'í¬ìŠ¤íŠ¸ì‡ í† ë¡ ',
                'survey': 'ì„¤ë¬¸ ì¡°ì‚¬'
            };
            
            const createdDate = new Date(topicData.createdAt).toLocaleString();
            const endDate = topicData.endTime ? new Date(topicData.endTime).toLocaleString() : 'ì§„í–‰ ì¤‘';
            const participantCount = Object.keys(participants).length;
            const messageCount = Object.keys(messages).length;
            
            // ë‚´ê°€ ì°¸ì—¬í–ˆëŠ”ì§€ í™•ì¸
            const didParticipate = participants[currentStudent] ? true : false;
            
            // ëª¨ë‹¬ HTML ìƒì„±
            const modalHTML = `
                <div id="historyModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <!-- í—¤ë” -->
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0 0 8px 0;">ğŸ“š ${topicData.title}</h3>
                                    <p style="margin: 0; opacity: 0.9;">${typeNames[topicData.type] || 'í† ë¡ '} â€¢ ${didParticipate ? 'ì°¸ì—¬í•¨' : 'ì°¸ì—¬ ì•ˆí•¨'}</p>
                                </div>
                                <button onclick="closeHistoryModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">Ã—</button>
                            </div>
                        </div>
                        
                        <!-- ë‚´ìš© -->
                        <div style="padding: 20px;">
                            <!-- ê¸°ë³¸ ì •ë³´ -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                    <div>
                                        <strong>ğŸ“… ì‹œì‘ ì‹œê°„</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${createdDate}</span>
                                    </div>
                                    <div>
                                        <strong>â° ì¢…ë£Œ ì‹œê°„</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${endDate}</span>
                                    </div>
                                    <div>
                                        <strong>ğŸ‘¥ ì°¸ì—¬ì</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${participantCount}ëª…</span>
                                    </div>
                                    <div>
                                        <strong>ğŸ’¬ í™œë™ëŸ‰</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${messageCount}ê°œ</span>
                                    </div>
                                </div>
                                ${topicData.description ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dee2e6;">
                                        <strong>ğŸ“ ì£¼ì œ ì„¤ëª…</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${topicData.description}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- ì°¸ì—¬ ìƒíƒœ -->
                            <div style="margin-bottom: 20px;">
                                ${didParticipate ? `
                                    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 8px; text-align: center;">
                                        âœ… ì´ í† ë¡ ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤
                                    </div>
                                ` : `
                                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 12px; border-radius: 8px; text-align: center;">
                                        âŒ ì´ í† ë¡ ì— ì°¸ì—¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
                                    </div>
                                `}
                            </div>
                            
                            <!-- í† ë¡  ê²°ê³¼ -->
                            <div id="historyContent">
                                ${generateStudentHistoryContent(topicData.type, messages, votes, participants, didParticipate)}
                            </div>
                        </div>
                        
                        <!-- í‘¸í„° -->
                        <div style="padding: 15px 20px; border-top: 1px solid #dee2e6; text-align: right;">
                            <button class="btn btn-secondary" onclick="closeHistoryModal()">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // í•™ìƒìš© í† ë¡  ì´ë ¥ ë‚´ìš© ìƒì„±
        function generateStudentHistoryContent(type, messages, votes, participants, didParticipate) {
            if (type === 'debate') {
                return generateStudentDebateHistory(votes, participants, didParticipate);
            } else {
                return generateStudentDiscussionHistory(messages, participants, didParticipate);
            }
        }

        // í•™ìƒìš© ì°¬ë°˜ í† ë¡  ì´ë ¥
        function generateStudentDebateHistory(votes, participants, didParticipate) {
            const agreeVotes = [];
            const disagreeVotes = [];
            let myVote = null;
            
            Object.values(votes).forEach(vote => {
                if (vote.participantId === currentStudent) {
                    myVote = vote;
                }
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            const agreeCount = agreeVotes.length;
            const disagreeCount = disagreeVotes.length;
            const total = agreeCount + disagreeCount;
            const agreePercent = total > 0 ? (agreeCount / total * 100).toFixed(1) : 0;
            const disagreePercent = total > 0 ? (disagreeCount / total * 100).toFixed(1) : 0;
            
            return `
                <!-- ìµœì¢… íˆ¬í‘œ ê²°ê³¼ -->
                <div style="margin-bottom: 20px;">
                    <h5 style="margin-bottom: 12px;">ğŸ“Š ìµœì¢… íˆ¬í‘œ ê²°ê³¼</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1; background: #d4edda; height: 25px; border-radius: 12px; position: relative; overflow: hidden;">
                                <div style="background: #28a745; height: 100%; width: ${agreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 11px;">
                                    ì°¬ì„± ${agreeCount}ëª… (${agreePercent}%)
                                </span>
                            </div>
                            <div style="flex: 1; background: #f8d7da; height: 25px; border-radius: 12px; position: relative; overflow: hidden;">
                                <div style="background: #dc3545; height: 100%; width: ${disagreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 11px;">
                                    ë°˜ëŒ€ ${disagreeCount}ëª… (${disagreePercent}%)
                                </span>
                            </div>
                        </div>
                        <div style="text-align: center; color: #6c757d; font-size: 11px;">
                            ì´ ${total}ëª…ì´ íˆ¬í‘œì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤
                        </div>
                    </div>
                </div>
                
                <!-- ë‚´ íˆ¬í‘œ -->
                ${myVote ? `
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin-bottom: 10px;">âœ‹ ë‚˜ì˜ íˆ¬í‘œ</h6>
                        <div style="background: ${myVote.position === 'agree' ? '#d4edda' : '#f8d7da'}; border: 2px solid ${myVote.position === 'agree' ? '#28a745' : '#dc3545'}; padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; color: ${myVote.position === 'agree' ? '#155724' : '#721c24'}; margin-bottom: 5px;">
                                ${myVote.position === 'agree' ? 'âœ… ì°¬ì„±' : 'âŒ ë°˜ëŒ€'} íˆ¬í‘œ
                            </div>
                            <div style="color: ${myVote.position === 'agree' ? '#155724' : '#721c24'}; font-size: 13px;">
                                ${myVote.opinion}${myVote.isEdited ? ' <small>(ìˆ˜ì •ë¨)</small>' : ''}
                            </div>
                        </div>
                    </div>
                ` : didParticipate ? `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                        ğŸ“ ì´ í† ë¡ ì—ì„œ íˆ¬í‘œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
                    </div>
                ` : ''}
                
                <!-- ì£¼ìš” ì˜ê²¬ë“¤ (ì¼ë¶€ë§Œ) -->
                <div>
                    <h6 style="margin-bottom: 12px;">ğŸ’­ ì£¼ìš” ì˜ê²¬ë“¤</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: #28a745; font-weight: bold; margin-bottom: 8px; font-size: 12px;">âœ… ì°¬ì„± ì˜ê²¬</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${agreeVotes.slice(0, 3).map(vote => `
                                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 6px; font-size: 12px;">
                                        <div style="color: #6c757d; margin-bottom: 3px;">${vote.participantName}</div>
                                        <div>${vote.opinion}</div>
                                    </div>
                                `).join('') || '<div style="text-align: center; color: #6c757d; padding: 15px; font-size: 12px;">ì°¬ì„± ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                                ${agreeVotes.length > 3 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">ì™¸ ${agreeVotes.length - 3}ê°œ ë”...</div>` : ''}
                            </div>
                        </div>
                        <div>
                            <div style="color: #dc3545; font-weight: bold; margin-bottom: 8px; font-size: 12px;">âŒ ë°˜ëŒ€ ì˜ê²¬</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${disagreeVotes.slice(0, 3).map(vote => `
                                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 6px; font-size: 12px;">
                                        <div style="color: #6c757d; margin-bottom: 3px;">${vote.participantName}</div>
                                        <div>${vote.opinion}</div>
                                    </div>
                                `).join('') || '<div style="text-align: center; color: #6c757d; padding: 15px; font-size: 12px;">ë°˜ëŒ€ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                                ${disagreeVotes.length > 3 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">ì™¸ ${disagreeVotes.length - 3}ê°œ ë”...</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // í•™ìƒìš© ììœ  í† ë¡  ì´ë ¥
        function generateStudentDiscussionHistory(messages, participants, didParticipate) {
            const messageArray = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
            const myMessages = messageArray.filter(msg => msg.participantId === currentStudent);
            const postits = messageArray.filter(msg => msg.type === 'postit');
            const chatMessages = messageArray.filter(msg => msg.type !== 'postit');
            
            return `
                <!-- ë‚´ í™œë™ ìš”ì•½ -->
                ${myMessages.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin-bottom: 10px;">âœ‹ ë‚˜ì˜ í™œë™</h6>
                        <div style="background: #e7f3ff; border: 2px solid #007bff; padding: 12px; border-radius: 8px;">
                            <div style="display: flex; gap: 20px; text-align: center;">
                                <div>
                                    <div style="font-weight: bold; color: #0056b3;">${myMessages.filter(m => m.type === 'postit').length}</div>
                                    <div style="font-size: 11px; color: #6c757d;">í¬ìŠ¤íŠ¸ì‡</div>
                                </div>
                                <div>
                                    <div style="font-weight: bold; color: #0056b3;">${myMessages.filter(m => m.type !== 'postit').length}</div>
                                    <div style="font-size: 11px; color: #6c757d;">ë©”ì‹œì§€</div>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : didParticipate ? `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                        ğŸ“ ì´ í† ë¡ ì—ì„œ í™œë™í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
                    </div>
                ` : ''}
                
                <!-- ì „ì²´ í™œë™ ìš”ì•½ -->
                <div>
                    <h6 style="margin-bottom: 12px;">ğŸ“ í† ë¡  ë‚´ìš©</h6>
                    
                    ${postits.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #495057; font-weight: bold; margin-bottom: 8px; font-size: 13px;">ğŸ“Œ í¬ìŠ¤íŠ¸ì‡ (${postits.length}ê°œ)</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                                ${postits.slice(0, 6).map(postit => `
                                    <div style="background: ${getPostitColor(postit.color)}; padding: 8px; border-radius: 4px; font-size: 11px; position: relative; ${postit.participantId === currentStudent ? 'border: 2px solid #007bff;' : ''}">
                                        <div style="line-height: 1.3; margin-bottom: 5px;">${postit.content}</div>
                                        <div style="font-size: 9px; opacity: 0.7; position: absolute; bottom: 3px; right: 5px;">${postit.participantName}</div>
                                    </div>
                                `).join('')}
                            </div>
                            ${postits.length > 6 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">ì™¸ ${postits.length - 6}ê°œ ë”...</div>` : ''}
                        </div>
                    ` : ''}
                    
                    ${chatMessages.length > 0 ? `
                        <div>
                            <div style="color: #495057; font-weight: bold; margin-bottom: 8px; font-size: 13px;">ğŸ’¬ ë©”ì‹œì§€ (${chatMessages.length}ê°œ)</div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px;">
                                ${chatMessages.slice(0, 10).map(msg => `
                                    <div style="margin-bottom: 8px; padding: 6px; background: ${msg.participantId === currentStudent ? '#e7f3ff' : '#f8f9fa'}; border-radius: 4px; font-size: 12px; ${msg.participantId === currentStudent ? 'border-left: 3px solid #007bff;' : ''}">
                                        <div style="color: #6c757d; margin-bottom: 2px; font-size: 10px;">${msg.participantName} â€¢ ${new Date(msg.timestamp).toLocaleTimeString()}</div>
                                        <div>${msg.content || msg.text}</div>
                                    </div>
                                `).join('')}
                                ${chatMessages.length > 10 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">ì™¸ ${chatMessages.length - 10}ê°œ ë”...</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${postits.length === 0 && chatMessages.length === 0 ? `
                        <div style="text-align: center; color: #6c757d; padding: 30px;">
                            ğŸ’­ ì´ í† ë¡ ì—ëŠ” ì•„ì§ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // í¬ìŠ¤íŠ¸ì‡ ìƒ‰ìƒ ë³€í™˜
        function getPostitColor(color) {
            const colors = {
                'yellow': '#ffeb3b',
                'blue': '#2196f3', 
                'green': '#4caf50',
                'pink': '#e91e63'
            };
            return colors[color] || '#ffeb3b';
        }

        // ì´ë ¥ ëª¨ë‹¬ ë‹«ê¸°
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í•™ê¸‰ í† ë¡  ì°¸ì—¬ ì‹œìŠ¤í…œ - í•™ìƒìš© ë¡œë“œ ì™„ë£Œ');
            
            // URL íŒŒë¼ë¯¸í„° í™•ì¸ (êµì‚¬ê°€ ì§ì ‘ ë§í¬ë¥¼ ì œê³µí•œ ê²½ìš°)
            const urlParams = new URLSearchParams(window.location.search);
            const classCode = urlParams.get('class');
            const studentName = urlParams.get('name');
            
            if (classCode) {
                document.getElementById('classCodeInput').value = classCode;
            }
            if (studentName) {
                document.getElementById('nameInput').value = studentName;
            }
            
            // íŒ ë¡œí…Œì´ì…˜ ì‹œì‘
            rotateTips();
        });
        
        // êµì‚¬ ë©”ì‹œì§€ ì €ì¥ ë°°ì—´
        let teacherMessages = [];
        
        // êµì‚¬ ë©”ì‹œì§€ ì´ˆê¸°í™” í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
        window.clearTeacherMessages = function() {
            teacherMessages = [];
            currentMessageIndex = 0;
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
                messageRotationInterval = null;
            }
            const messagesBox = document.getElementById('teacherMessagesBox');
            if (messagesBox) {
                messagesBox.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px; font-style: italic;">ğŸ“¢ êµì‚¬ ë©”ì‹œì§€ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤<br><small>ë©”ì‹œì§€ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤</small></div>';
            }
            console.log('ğŸ§¹ êµì‚¬ ë©”ì‹œì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        };
        let currentMessageIndex = 0;
        let messageRotationInterval = null;
        
        // í˜„ì¬ í™œì„± ë¦¬ìŠ¤ë„ˆë“¤ ì¶”ì 
        let activeListeners = {
            teacherMessages: null,
            settings: null,
            participants: null,
            messages: null
        };

        // êµì‚¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function displayTeacherMessage(messageData) {
            console.log('ğŸ“ displayTeacherMessage í˜¸ì¶œ:', messageData);
            const messagesBox = document.getElementById('teacherMessagesBox');
            
            // ë©”ì‹œì§€ë¥¼ ë°°ì—´ì— ì¶”ê°€
            const messageTime = new Date(messageData.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const messageContent = messageData.message || messageData.text || messageData.content || '[ë©”ì‹œì§€ ë‚´ìš© ì—†ìŒ]';
            console.log('ğŸ” ë©”ì‹œì§€ ë‚´ìš© ì¶”ì¶œ:', {
                'messageData.message': messageData.message,
                'messageData.text': messageData.text,
                'messageData.content': messageData.content,
                'ìµœì¢… ì„ íƒëœ ë‚´ìš©': messageContent
            });
            
            const formattedMessage = {
                content: messageContent,
                time: messageTime,
                timestamp: messageData.timestamp
            };
            
            teacherMessages.push(formattedMessage);
            console.log('ìƒˆ êµì‚¬ ë©”ì‹œì§€ ì¶”ê°€:', formattedMessage.content);
            
            // ë©”ì‹œì§€ ë¡œí…Œì´ì…˜ ì‹œì‘ ë˜ëŠ” ì—…ë°ì´íŠ¸
            startMessageRotation();
        }
        
        // ë©”ì‹œì§€ ë¡œí…Œì´ì…˜ ì‹œì‘
        function startMessageRotation() {
            const messagesBox = document.getElementById('teacherMessagesBox');
            
            if (teacherMessages.length === 0) return;
            
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
            }
            
            // í˜„ì¬ ë©”ì‹œì§€ í‘œì‹œ
            function showCurrentMessage() {
                const message = teacherMessages[currentMessageIndex];
                messagesBox.innerHTML = `
                    <div class="teacher-message" ondblclick="showTeacherMessagesModal()" title="ë”ë¸”í´ë¦­í•˜ì—¬ ëª¨ë“  ë©”ì‹œì§€ ë³´ê¸°">
                        <div class="teacher-message-content">${message.content}</div>
                        <div class="teacher-message-time">${message.time}</div>
                        ${teacherMessages.length > 1 ? `<div style="text-align: center; font-size: 10px; color: #007bff; margin-top: 5px;">ğŸ’¡ ë”ë¸”í´ë¦­í•˜ì—¬ ëª¨ë“  ë©”ì‹œì§€ ë³´ê¸° (${currentMessageIndex + 1}/${teacherMessages.length})</div>` : ''}
                    </div>
                `;
            }
            
            // ì²« ë©”ì‹œì§€ ì¦‰ì‹œ í‘œì‹œ
            showCurrentMessage();
            
            // ë©”ì‹œì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ ë¡œí…Œì´ì…˜
            if (teacherMessages.length > 1) {
                messageRotationInterval = setInterval(() => {
                    currentMessageIndex = (currentMessageIndex + 1) % teacherMessages.length;
                    showCurrentMessage();
                }, 5000); // 5ì´ˆë§ˆë‹¤ ë¡œí…Œì´ì…˜
            }
        }

        // êµì‚¬ ë©”ì‹œì§€ ëª¨ë‹¬ í‘œì‹œ
        function showTeacherMessagesModal() {
            if (teacherMessages.length === 0) {
                alert('í‘œì‹œí•  êµì‚¬ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
            const sortedMessages = [...teacherMessages].sort((a, b) => b.timestamp - a.timestamp);

            const modal = document.createElement('div');
            modal.className = 'teacher-message-modal';
            modal.innerHTML = `
                <div class="teacher-message-modal-content">
                    <div class="teacher-message-modal-header">
                        <h3 style="margin: 0; font-size: 16px;">ğŸ’¬ êµì‚¬ ë©”ì‹œì§€ ì „ì²´ ë³´ê¸°</h3>
                        <button class="modal-close-btn" onclick="closeTeacherMessagesModal()">Ã—</button>
                    </div>
                    <div class="teacher-message-modal-body">
                        <div style="margin-bottom: 15px; color: #6c757d; font-size: 13px; text-align: center;">
                            ì´ ${teacherMessages.length}ê°œì˜ ë©”ì‹œì§€ (ìµœì‹ ìˆœ)
                        </div>
                        ${sortedMessages.map((message, index) => `
                            <div class="teacher-message-item">
                                <div class="teacher-message-item-content">${message.content}</div>
                                <div class="teacher-message-item-time">
                                    ${message.time}
                                    ${index === 0 ? '<span style="color: #28a745; font-weight: bold;"> (ìµœì‹ )</span>' : ''}
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6; text-align: center;">
                            <button onclick="closeTeacherMessagesModal()" style="background: #6c757d; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 12px;">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ESC í‚¤ë¡œ ë‹«ê¸°
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTeacherMessagesModal();
                }
            });

            // ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTeacherMessagesModal();
                }
            });

            document.body.appendChild(modal);
            modal.focus(); // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ë¥¼ ìœ„í•´ í¬ì»¤ìŠ¤ ì„¤ì •

            console.log('êµì‚¬ ë©”ì‹œì§€ ëª¨ë‹¬ í‘œì‹œ:', teacherMessages.length, 'ê°œ ë©”ì‹œì§€');
        }

        // êµì‚¬ ë©”ì‹œì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeTeacherMessagesModal() {
            const modal = document.querySelector('.teacher-message-modal');
            if (modal) {
                modal.remove();
                console.log('êµì‚¬ ë©”ì‹œì§€ ëª¨ë‹¬ ë‹«í˜');
            }
        }

        // ì±„íŒ… ì˜ì—­ ì´ˆê¸°í™”
        function initializeChatArea() {
            const chatMessages = document.getElementById('chatMessages');
            const chatWelcome = document.getElementById('chatWelcome');
            if (chatMessages && chatWelcome) {
                chatWelcome.style.display = 'block';
            }
        }

        // ë‹µì¥ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
        let replyToMessage = null;
        
        // ë‹µì¥ ì‹œì‘
        function startReply(messageId, authorName, content) {
            replyToMessage = {
                id: messageId,
                author: authorName,
                content: content.substring(0, 100) + (content.length > 100 ? '...' : '') // 100ìê¹Œì§€ë§Œ í‘œì‹œ
            };
            
            // ë‹µì¥ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const replyPreview = document.getElementById('replyPreview');
            const replyContent = document.getElementById('replyContent');
            
            replyContent.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px;">${authorName}</div>
                <div>${replyToMessage.content}</div>
            `;
            
            replyPreview.style.display = 'block';
            
            // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            document.getElementById('chatInput').focus();
        }
        
        // ë‹µì¥ ì·¨ì†Œ
        function cancelReply() {
            replyToMessage = null;
            document.getElementById('replyPreview').style.display = 'none';
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // ë©”ì‹œì§€ ID ìƒì„±
                const messageRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`).push();
                const messageId = messageRef.key;

                // ì±„íŒ… ë©”ì‹œì§€ ë°ì´í„°
                const messageData = {
                    id: messageId,
                    participantId: currentStudent,
                    participantName: currentStudent,
                    content: message,
                    type: 'chat',
                    isAnonymous: false,
                    timestamp: Date.now(),
                    edited: false
                };
                
                // ë‹µì¥ ì •ë³´ ì¶”ê°€
                if (replyToMessage) {
                    messageData.replyToId = replyToMessage.id;
                    messageData.replyToAuthor = replyToMessage.author;
                    messageData.replyToContent = replyToMessage.content;
                }

                // Firebaseì— ì €ì¥
                await database.ref(`discussions/${currentTopicId}/messages/${messageId}`).set(messageData);
                
                console.log('ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ:', messageData);
                input.value = '';
                
                // ë‹µì¥ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
                if (replyToMessage) {
                    cancelReply();
                }
                
            } catch (error) {
                console.error('ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(messageData) {
            const chatMessages = document.getElementById('chatMessages');
            const chatWelcome = document.getElementById('chatWelcome');
            
            if (!chatMessages) return;
            
            // ì¤‘ë³µ ë©”ì‹œì§€ í™•ì¸ (ê°™ì€ IDì˜ ë©”ì‹œì§€ê°€ ì´ë¯¸ ìˆëŠ”ì§€ ì²´í¬)
            const existingMessage = chatMessages.querySelector(`[data-message-id="${messageData.id}"]`);
            if (existingMessage) {
                console.log('ì¤‘ë³µ ì±„íŒ… ë©”ì‹œì§€ ë¬´ì‹œ:', messageData.id);
                return;
            }
            
            // í™˜ì˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            if (chatWelcome) {
                chatWelcome.style.display = 'none';
            }
            
            // ë©”ì‹œì§€ ì‹œê°„ í¬ë§·íŒ…
            const messageTime = new Date(messageData.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // ë‚´ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            const isMyMessage = messageData.participantId === currentStudent;
            const messageClass = isMyMessage ? 'my-message' : 'other-message';
            
            // ë‹µì¥ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            const replyContent = messageData.replyToId ? `
                <div class="reply-preview" style="background: #f1f3f4; border-left: 3px solid #007bff; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; color: #6c757d;">
                    <div style="font-weight: bold; margin-bottom: 2px;">â†³ ${messageData.replyToAuthor}ì—ê²Œ ë‹µì¥</div>
                    <div style="opacity: 0.8;">${messageData.replyToContent}</div>
                </div>
            ` : '';
            
            // ë©”ì‹œì§€ HTML ìƒì„±
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${messageClass}`;
            messageDiv.setAttribute('data-message-id', messageData.id);
            messageDiv.style.position = 'relative';
            messageDiv.innerHTML = `
                ${replyContent}
                <div class="message-header">
                    <span class="message-author">${messageData.participantName}</span>
                    <span class="message-time">${messageTime}</span>
                    <button class="reply-btn" onclick="startReply('${messageData.id}', '${messageData.participantName}', '${messageData.content.replace(/'/g, "&#39;").replace(/"/g, "&quot;")}')" 
                            style="position: absolute; right: 8px; top: 8px; background: none; border: 1px solid #dee2e6; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; font-size: 12px;" 
                            title="ë‹µì¥í•˜ê¸°">
                        â†©ï¸
                    </button>
                </div>
                <div class="message-content">${messageData.content}</div>
            `;
            
            // ë‹µì¥ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
            messageDiv.addEventListener('mouseenter', function() {
                const replyBtn = this.querySelector('.reply-btn');
                if (replyBtn) replyBtn.style.opacity = '1';
            });
            
            messageDiv.addEventListener('mouseleave', function() {
                const replyBtn = this.querySelector('.reply-btn');
                if (replyBtn) replyBtn.style.opacity = '0';
            });
            
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ì±„íŒ… ì…ë ¥ì—ì„œ ì—”í„°í‚¤ ì²˜ë¦¬
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // ì´ëª¨ì§€ ë°ì´í„°
        const emojiData = {
            face: ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜‹', 'ğŸ˜œ', 'ğŸ¤”', 'ğŸ˜', 'ğŸ¤—', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¡', 'ğŸ¤¯', 'ğŸ˜´'],
            gesture: ['ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ‘', 'ğŸ™', 'ğŸ’ª', 'ğŸ‘‹', 'ğŸ‘ğŸ»', 'ğŸ‘ğŸ»', 'ğŸ‘ŒğŸ»', 'âœŒğŸ»', 'ğŸ¤ğŸ»', 'ğŸ‘ğŸ»', 'ğŸ™ğŸ»'],
            heart: ['â¤ï¸', 'ğŸ’™', 'ğŸ’š', 'ğŸ’›', 'ğŸ§¡', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ’–', 'ğŸ’•', 'ğŸ’—', 'ğŸ’˜', 'ğŸ’', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’¢', 'ğŸ’¯'],
            nature: ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸŒ¿', 'ğŸ€', 'ğŸŒ³', 'ğŸŒ²', 'ğŸ¦‹', 'ğŸ', 'ğŸŒˆ', 'â­', 'ğŸŒ™', 'â˜€ï¸', 'ğŸ”¥'],
            food: ['ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸ’', 'ğŸ¥', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥•'],
            activity: ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ±', 'ğŸ“', 'ğŸ¸', 'ğŸ¯', 'â›³', 'ğŸ®', 'ğŸµ', 'ğŸ¶', 'ğŸ“š']
        };

        // ì´ëª¨ì§€ í”¼ì»¤ í† ê¸€
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') {
                emojiPicker.style.display = 'block';
                showEmojiCategory('face'); // ê¸°ë³¸ìœ¼ë¡œ ì–¼êµ´ ì´ëª¨ì§€ í‘œì‹œ
            } else {
                emojiPicker.style.display = 'none';
            }
        }

        // ì´ëª¨ì§€ ì¹´í…Œê³ ë¦¬ í‘œì‹œ
        function showEmojiCategory(category) {
            // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.emoji-category').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');

            // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ëª¨ì§€ë“¤ í‘œì‹œ
            const emojiGrid = document.getElementById('emojiGrid');
            const emojis = emojiData[category] || [];
            
            emojiGrid.innerHTML = emojis.map(emoji => 
                `<button class="emoji-item" onclick="insertEmoji('${emoji}')" title="${emoji}">${emoji}</button>`
            ).join('');
        }

        // ì´ëª¨ì§€ ì‚½ì…
        function insertEmoji(emoji) {
            const chatInput = document.getElementById('chatInput');
            const currentValue = chatInput.value;
            const cursorPos = chatInput.selectionStart;
            
            // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
            const newValue = currentValue.slice(0, cursorPos) + emoji + currentValue.slice(cursorPos);
            chatInput.value = newValue;
            
            // ì»¤ì„œë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™
            chatInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            
            // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            chatInput.focus();
            
            // ì´ëª¨ì§€ í”¼ì»¤ ë‹«ê¸°
            document.getElementById('emojiPicker').style.display = 'none';
        }

        // ì´ëª¨ì§€ í”¼ì»¤ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.querySelector('.emoji-btn');
            
            if (emojiPicker && !emojiPicker.contains(event.target) && event.target !== emojiBtn) {
                emojiPicker.style.display = 'none';
            }
        });
    </script>
</body>
</html>