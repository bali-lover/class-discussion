<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌïôÍ∏â ÌÜ†Î°† Ï∞∏Ïó¨ - ÌïôÏÉùÏö© | Real-time Classroom Discussion</title>
    <meta name="description" content="Ïã§ÏãúÍ∞Ñ ÌïôÍ∏â ÌÜ†Î°† Ï∞∏Ïó¨ ÏãúÏä§ÌÖú - ÌïôÏÉùÏö© Ïù∏ÌÑ∞ÌéòÏù¥Ïä§">
    <meta name="keywords" content="ÌïôÍ∏âÌÜ†Î°†, ÌïôÏÉùÏ∞∏Ïó¨, Ïã§ÏãúÍ∞ÑÌÜ†Î°†, Ïò®ÎùºÏù∏ÍµêÏú°">
    <meta name="author" content="Claude Code">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ÌïôÍ∏â ÌÜ†Î°† Ï∞∏Ïó¨ - ÌïôÏÉùÏö©">
    <meta property="og:description" content="Ïã§ÏãúÍ∞Ñ ÌïôÍ∏â ÌÜ†Î°†Ïóê Ï∞∏Ïó¨ÌïòÏÑ∏Ïöî">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-username.github.io/classroom-discussion/student.html">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>"
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Ìó§Îçî Ïä§ÌÉÄÏùº */
        .header {
            background-color: white;
            color: #333;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0 0 4px 0;
            font-size: 20px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .header h1::before {
            content: "üéì";
            margin-right: 10px;
            font-size: 24px;
        }

        .header-subtitle {
            font-size: 12px;
            color: #6c757d;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        /* Ïª®ÌÖåÏù¥ÎÑà Ïä§ÌÉÄÏùº */
        .main-container {
            width: 100%;
            margin: 0;
            padding: 0 15px;
        }

        /* ÏÉÅÌÉú ÏòÅÏó≠ Ïä§ÌÉÄÏùº */
        .status-section {
            background: white;
            border-radius: 6px;
            padding: 12px 15px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }


        .discussion-info {
            text-align: center;
            color: #495057;
        }

        .discussion-title-box {
            background: #fff3cd;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
        }

        .discussion-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 0;
            text-align: left;
        }

        .discussion-stats {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
        }


        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ */
        .content-section {
            background: white;
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        /* ÏûÖÎ†• Ìèº Ïä§ÌÉÄÏùº */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            border-color: #007bff;
            outline: none;
        }

        /* ÌÜ†Î°†Î∞© Î™©Î°ù Ïä§ÌÉÄÏùº */
        .room-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .room-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .room-item:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .room-item.active {
            border-color: #28a745;
            background: #d4edda;
        }

        .room-item.waiting {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .room-item.closed {
            border-color: #6c757d;
            background: #f8f9fa;
            opacity: 0.7;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .room-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
        }

        .room-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background: #cce7ff;
            color: #004085;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .room-info {
            font-size: 13px;
            color: #6c757d;
            display: flex;
            gap: 15px;
        }

        /* Ï±ÑÌåÖ Î∞è ÌÜ†Î°† ÏòÅÏó≠ */
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 500px;
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î Ïä§ÌÉÄÏùº */
        .sidebar {
            width: 260px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .student-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .room-info-box {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .time-remaining {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            margin: 8px 0;
        }

        .teacher-messages {
            background: #e7f3ff;
            border: 1px solid #b6d7ff;
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .teacher-message {
            background: white;
            margin: 5px;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .teacher-message-content {
            color: #333;
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .teacher-message-time {
            font-size: 10px;
            color: #6c757d;
            text-align: right;
        }

        .teacher-message {
            cursor: pointer;
            transition: all 0.2s;
        }

        .teacher-message:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* ÍµêÏÇ¨ Î©îÏãúÏßÄ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .teacher-message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .teacher-message-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .teacher-message-modal-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .teacher-message-modal-body {
            padding: 20px;
        }

        .teacher-message-item {
            background: #f8f9fa;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .teacher-message-item:last-child {
            margin-bottom: 0;
        }

        .teacher-message-item-content {
            color: #333;
            line-height: 1.5;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .teacher-message-item-time {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Ï±ÑÌåÖ Î©îÏãúÏßÄ Ïä§ÌÉÄÏùº */
        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
        }

        .chat-message.my-message {
            background: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .chat-message.other-message {
            background: white;
            border: 1px solid #dee2e6;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .message-author {
            font-weight: bold;
        }

        .my-message .message-author,
        .my-message .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .other-message .message-author {
            color: #495057;
        }

        .message-time {
            color: #6c757d;
        }

        .message-content {
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* Ïù¥Î™®ÏßÄ ÌîºÏª§ Ïä§ÌÉÄÏùº */
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 320px;
            max-height: 300px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .emoji-categories {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .emoji-category {
            flex: 1;
            padding: 10px 5px;
            border: none;
            background: none;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .emoji-category:hover {
            background: #e9ecef;
        }

        .emoji-category.active {
            background: #007bff;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            font-size: 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-item:hover {
            background: #f8f9fa;
        }

        .emoji-btn:hover {
            background: #f8f9fa !important;
            border-radius: 50%;
        }

        .other-rooms {
            max-height: 150px;
            overflow-y: auto;
        }

        .room-item-mini {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .room-item-mini:hover {
            background: #e9ecef;
        }

        .room-item-mini.current {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }

        /* ÌÜ†Î°† ÌôîÎ©¥ Î†àÏù¥ÏïÑÏõÉ ÏàòÏ†ï */
        .discussion-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
            align-items: start;
            width: 100%;
        }

        .chat-section {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 5px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message-mine {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message-other {
            background: #e9ecef;
            color: #495057;
        }

        .message-author {
            font-size: 11px;
            margin-bottom: 3px;
            opacity: 0.8;
        }

        .chat-input {
            display: flex;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            font-size: 14px;
        }

        .chat-input button {
            padding: 8px 15px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Ìè¨Ïä§Ìä∏Ïûá Î≥¥Îìú */
        .postit-board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .postit {
            background: #ffeb3b;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-size: 12px;
            min-height: 20px;
            position: relative;
        }

        .postit.blue {
            background: #2196f3;
            color: white;
        }

        .postit.green {
            background: #4caf50;
            color: white;
        }

        .postit.pink {
            background: #e91e63;
            color: white;
        }

        .postit-author {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 10px;
            opacity: 0.7;
        }

        .postit-actions {
            position: absolute;
            top: 3px;
            right: 3px;
            display: none;
            gap: 3px;
        }

        .postit:hover .postit-actions {
            display: flex;
        }

        .postit-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .postit-edit-btn {
            background: #007bff;
            color: white;
        }

        .postit-delete-btn {
            background: #dc3545;
            color: white;
        }

        .postit-btn:hover {
            transform: scale(1.1);
        }

        /* Ìé∏Ïßë Î™®Îìú Ïä§ÌÉÄÏùº */
        .postit-editing {
            border: 2px solid #007bff !important;
        }

        .postit-edit-textarea {
            width: 100%;
            height: 300px;
            border: none;
            background: transparent;
            font-size: 13px;
            resize: none;
            outline: none;
        }

        .postit-edit-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: flex-end;
        }

        .postit-save-btn {
            padding: 3px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }

        .postit-cancel-btn {
            padding: 3px 8px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }

        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .status-section {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }

            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .chat-section {
                height: 300px;
            }

            .discussion-layout {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            #discussionContent {
                order: 1;
            }
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Ìó§Îçî -->
        <div class="header">
            <div>
                <h1>ÌïôÍ∏â ÌÜ†Î°† Ï∞∏Ïó¨</h1>
                <p class="header-subtitle">Ïã§ÏãúÍ∞Ñ ÌÜ†Î°†Ïóê Ï∞∏Ïó¨Ìï¥Î≥¥ÏÑ∏Ïöî</p>
            </div>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="leaveDiscussion()" id="backToRoomListBtn" style="display: none;">‚Üê ÌÜ†Î°†Î∞© Î™©Î°ù</button>
                <button class="btn btn-secondary" onclick="goBack()" id="backToLoginBtn" style="display: none;">‚Üê Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                <button class="btn btn-info" onclick="refreshRooms()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                <button class="btn btn-secondary" onclick="exitDiscussion()">üö™ ÎÇòÍ∞ÄÍ∏∞</button>
            </div>
        </div>

        <!-- ÏÉÅÌÉú ÏòÅÏó≠ -->
        <div class="status-section" id="statusSection" style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
            <div class="discussion-title-box">
                <div class="discussion-title" id="discussionTitle">ÌÜ†Î°†Î∞©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</div>
            </div>
            <div class="discussion-stats" id="discussionStats">‚è∞ - | üë• -</div>
        </div>

        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div class="content-section" id="mainContent">
            
            <!-- 1. Ï¥àÍ∏∞ ÏûÖÎ†• ÌôîÎ©¥ -->
            <div id="loginScreen" class="fade-in">
                <h2 style="text-align: center; margin-bottom: 20px; color: #495057;">üéì ÌÜ†Î°† Ï∞∏Ïó¨ÌïòÍ∏∞</h2>
                
                <div class="form-group">
                    <label for="nameInput">üë®‚Äçüéì Ï∞∏Ïó¨Ïûê Ïù¥Î¶Ñ</label>
                    <input type="text" id="nameInput" placeholder="ÍπÄÎØºÏàò" maxlength="10">
                </div>

                <div class="form-group">
                    <label for="classCodeInput">üî¢ Î∞ò ÏΩîÎìú</label>
                    <input type="text" id="classCodeInput" placeholder="ABC123" maxlength="10" style="text-transform: uppercase;">
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="joinClass()" style="font-size: 16px; padding: 12px 24px;">
                        üöÄ ÌÜ†Î°† Ï∞∏Ïó¨ÌïòÍ∏∞
                    </button>
                </div>

                <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 3px solid #bee5eb;">
                    <p style="margin: 0; font-size: 13px; color: #0c5460;">
                        <strong>üí° ÏïàÎÇ¥:</strong> ÍµêÏÇ¨Í∞Ä Ï†úÍ≥µÌïú Î∞ò ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÎ©¥ Ìï¥Îãπ ÌïôÍ∏âÏùò ÌôúÏÑ± ÌÜ†Î°†Î∞© Î™©Î°ùÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                    </p>
                </div>
            </div>

            <!-- 2. ÌÜ†Î°†Î∞© Î™©Î°ù ÌôîÎ©¥ -->
            <div id="roomListScreen" style="display: none;">
                <!-- Ï†úÎ™©Í≥º Ï≤¥ÌÅ¨Î∞ïÏä§Í∞Ä ÏûàÎäî ÏÉÅÎã® Ìó§Îçî -->
                <div style="display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #495057;">
                        üìö <span id="className">-</span> - ÌÜ†Î°†Î∞© Î™©Î°ù
                    </h2>
                    
                    <!-- Ïö∞Ï∏° Ï†ïÎ†¨Îêú Ï≤¥ÌÅ¨Î∞ïÏä§ -->
                    <div style="position: absolute; right: 0;">
                        <label style="font-size: 14px; color: #6c757d; cursor: pointer;">
                            <input type="checkbox" id="showClosedRoomsCheckbox" onchange="toggleClosedRooms()" style="margin-right: 8px;">
                            Ï¢ÖÎ£åÎêú ÌÜ†Î°†Î∞© Î≥¥Í∏∞
                        </label>
                    </div>
                </div>

                <div id="roomsList" class="room-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        ÌÜ†Î°†Î∞© Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                    </div>
                </div>

            </div>

            <!-- 3. Ïã§ÏãúÍ∞Ñ ÌÜ†Î°† ÌôîÎ©¥ -->
            <div id="discussionScreen" style="display: none;">

                <!-- ÏÇ¨Ïù¥ÎìúÎ∞îÏôÄ ÌÜ†Î°† ÏòÅÏó≠ -->
                <div class="discussion-layout">
                    <!-- Ï¢åÏ∏° ÏÇ¨Ïù¥ÎìúÎ∞î -->
                    <div class="sidebar">
                        <!-- 1. ÌïôÏÉù Ï†ïÎ≥¥ -->
                        <div class="sidebar-section">
                            <div class="sidebar-title">üë®‚Äçüéì Ï∞∏Ïó¨Ïûê Ï†ïÎ≥¥</div>
                            <div class="student-profile">
                                <div class="student-avatar" id="studentAvatar">ÍπÄ</div>
                                <div>
                                    <div style="font-weight: bold; color: #495057;" id="sidebarStudentName">ÍπÄÎØºÏàò</div>
                                    <div style="font-size: 11px; color: #6c757d;">ÌïôÏÉù</div>
                                </div>
                            </div>
                        </div>


                        <!-- 3. ÍµêÏÇ¨ Î©îÏãúÏßÄ -->
                        <div class="sidebar-section">
                            <div class="sidebar-title">üí¨ ÍµêÏÇ¨ Î©îÏãúÏßÄ</div>
                            <div class="teacher-messages" id="teacherMessagesBox">
                                <div style="text-align: center; color: #6c757d; padding: 15px; font-size: 12px;" ondblclick="showTeacherMessagesModal()" title="ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ Î©îÏãúÏßÄ Ïù¥Î†• Î≥¥Í∏∞">
                                    üì¢ ÍµêÏÇ¨ Î©îÏãúÏßÄÎ•º Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§<br>
                                    <small style="font-size: 10px; color: #007bff;">ÎçîÎ∏îÌÅ¥Î¶≠ÏúºÎ°ú Ïù¥Ï†Ñ Î©îÏãúÏßÄ ÌôïÏù∏</small>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Îã§Î•∏ ÎåÄÌôî Î™©Î°ù -->
                        <div class="sidebar-section">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div class="sidebar-title" style="margin: 0;">üìã Îã§Î•∏ ÌÜ†Î°†Î∞©</div>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 9px; color: #6c757d; cursor: pointer;">
                                    <input type="checkbox" id="showClosedRoomsSidebarCheckbox" onchange="toggleClosedRoomsWithRefresh()" style="transform: scale(0.8);">
                                    <span>Ï¢ÖÎ£å</span>
                                </label>
                            </div>
                            <div class="other-rooms" id="otherRoomsList">
                                <div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">
                                    Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ïö∞Ï∏° ÌÜ†Î°† Ïª®ÌÖêÏ∏† ÏòÅÏó≠ (ÌÉÄÏûÖÏóê Îî∞Îùº Îã¨ÎùºÏßê) -->
                <div id="discussionContent">
                    <!-- ÏûêÏú† ÌÜ†Î°† UI (Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ) -->
                    <div id="generalDiscussion" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                        <div class="chat-header" style="margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #495057;">üí¨ ÏûêÏú† ÌÜ†Î°† Ï±ÑÌåÖ</div>
                        
                        <!-- Ï±ÑÌåÖ Î©îÏãúÏßÄ ÏòÅÏó≠ -->
                        <div id="chatMessages" style="height: 400px; background: #f8f9fa; border-radius: 8px; padding: 15px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #dee2e6;">
                            <div style="text-align: center; color: #6c757d; padding: 40px; font-size: 16px;" id="chatWelcome">
                                üí¨ Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Î≥¥ÏÑ∏Ïöî!
                            </div>
                        </div>

                        <!-- ÎãµÏû• ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                        <div id="replyPreview" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: bold; color: #495057;">‚Ü©Ô∏è ÎãµÏû• Ï§ë</span>
                                <button onclick="cancelReply()" style="background: none; border: none; cursor: pointer; color: #6c757d; font-size: 16px; margin-left: auto;" title="ÎãµÏû• Ï∑®ÏÜå">‚úï</button>
                            </div>
                            <div id="replyContent" style="background: white; border-left: 3px solid #007bff; padding: 8px; border-radius: 4px; font-size: 13px; color: #6c757d;">
                                <!-- ÎãµÏû• ÎåÄÏÉÅ Î©îÏãúÏßÄÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                            </div>
                        </div>

                        <!-- Ï±ÑÌåÖ ÏûÖÎ†• ÏòÅÏó≠ -->
                        <div class="chat-input" style="display: flex; gap: 15px; position: relative; align-items: center;">
                            <input type="text" id="chatInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeypress="handleChatEnter(event)" 
                                style="flex: 1; padding: 12px 80px 12px 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px; margin-right: 10px;">
                            <button onclick="toggleEmojiPicker()" class="emoji-btn" style="position: absolute; right: 95px; top: 50%; transform: translateY(-50%); background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 50%; font-size: 18px; cursor: pointer; padding: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;" title="Ïù¥Î™®ÏßÄ ÏÑ†ÌÉù">
                                üòä
                            </button>
                            <button onclick="sendChatMessage()" class="btn btn-primary" style="padding: 12px 20px; border-radius: 25px; margin-left: 5px;">
                                üì§ Ï†ÑÏÜ°
                            </button>
                        </div>

                        <!-- Ïù¥Î™®ÏßÄ ÌîºÏª§ -->
                        <div id="emojiPicker" class="emoji-picker" style="display: none;">
                            <div class="emoji-categories">
                                <button class="emoji-category active" onclick="showEmojiCategory('face')" data-category="face">üòä</button>
                                <button class="emoji-category" onclick="showEmojiCategory('gesture')" data-category="gesture">üëç</button>
                                <button class="emoji-category" onclick="showEmojiCategory('heart')" data-category="heart">‚ù§Ô∏è</button>
                                <button class="emoji-category" onclick="showEmojiCategory('nature')" data-category="nature">üå∏</button>
                                <button class="emoji-category" onclick="showEmojiCategory('food')" data-category="food">üçé</button>
                                <button class="emoji-category" onclick="showEmojiCategory('activity')" data-category="activity">‚öΩ</button>
                            </div>
                            <div class="emoji-grid" id="emojiGrid">
                                <!-- Ïù¥Î™®ÏßÄÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                            </div>
                        </div>
                    </div>

                    <!-- Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°† UI -->
                    <div id="postitDiscussion" style="display: none; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                        <div class="chat-header" style="margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #495057;">üìù Ìè¨Ïä§Ìä∏Ïûá ÏùòÍ≤¨ Î≥¥Îìú</div>
                        
                        <!-- Ìè¨Ïä§Ìä∏Ïûá ÏûÖÎ†• ÏòÅÏó≠ -->
                        <div class="chat-input" style="margin-bottom: 20px;">
                            <input type="text" id="postitInput" placeholder="ÏùòÍ≤¨ÏùÑ Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî..." onkeypress="handlePostitEnter(event)" 
                                style="flex: 1; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px;">
                            <button onclick="addPostit()" class="btn btn-primary" style="margin-left: 10px; padding: 12px 20px; border-radius: 25px;">
                                üìå Î∂ôÏù¥Í∏∞
                            </button>
                        </div>

                        <!-- Ìè¨Ïä§Ìä∏Ïûá Î≥¥Îìú (Îçî ÎÑìÏùÄ Í≥µÍ∞Ñ) -->
                        <div class="postit-board" id="postitBoard" style="min-height: 400px; background: #f8f9fa; border-radius: 8px; padding: 20px;">
                            <div style="text-align: center; color: #6c757d; padding: 40px; font-size: 16px;">
                                üí≠ Ï≤´ Î≤àÏß∏ ÏùòÍ≤¨ÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!
                            </div>
                        </div>
                    </div>

                    <!-- Ï∞¨Î∞ò ÌÜ†Î°† UI -->
                    <div id="debateDiscussion" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- Ï∞¨ÏÑ± ÏùòÍ≤¨ -->
                            <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 15px;">
                                <h5 style="color: #155724; margin: 0 0 10px 0;">‚úÖ Ï∞¨ÏÑ± ÏùòÍ≤¨</h5>
                                <div id="agreeSection" style="min-height: 300px;">
                                    <textarea id="agreeInput" placeholder="Ï∞¨ÏÑ± ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                                        style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #c3e6cb; border-radius: 4px;"></textarea>
                                    <button class="btn btn-success" onclick="submitDebateVote('agree')" style="width: 100%; margin-bottom: 10px;">
                                        ‚úÖ Ï∞¨ÏÑ± ÏùòÍ≤¨ Îì±Î°ù
                                    </button>
                                    <div id="agreeList">
                                        Î°úÎî© Ï§ë...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Î∞òÎåÄ ÏùòÍ≤¨ -->
                            <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 15px;">
                                <h5 style="color: #721c24; margin: 0 0 10px 0;">‚ùå Î∞òÎåÄ ÏùòÍ≤¨</h5>
                                <div id="disagreeSection" style="min-height: 300px;">
                                    <textarea id="disagreeInput" placeholder="Î∞òÎåÄ ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                                        style="width: 100%; height: 60px; margin-bottom: 8px; padding: 8px; border: 1px solid #f5c6cb; border-radius: 4px;"></textarea>
                                    <button class="btn" onclick="submitDebateVote('disagree')" 
                                        style="width: 100%; margin-bottom: 10px; background: #dc3545; color: white;">
                                        ‚ùå Î∞òÎåÄ ÏùòÍ≤¨ Îì±Î°ù
                                    </button>
                                    <div id="disagreeList">
                                        Î°úÎî© Ï§ë...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ïã§ÏãúÍ∞Ñ Í≤∞Í≥º -->
                        <div style="margin-top: 15px; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: #495057;">üìä Ïã§ÏãúÍ∞Ñ Í≤∞Í≥º</h6>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; background: #d4edda; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="agreeBar" style="background: #28a745; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        Ï∞¨ÏÑ± <span id="agreeCount">0</span>
                                    </span>
                                </div>
                                <div style="flex: 1; background: #f8d7da; height: 20px; border-radius: 10px; position: relative;">
                                    <div id="disagreeBar" style="background: #dc3545; height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s;"></div>
                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">
                                        Î∞òÎåÄ <span id="disagreeCount">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentStudent = null;
        let currentClassCode = null;
        let currentClassName = null;
        let currentTopicId = null;
        let currentTopicData = null;
        let currentRooms = [];
        let database = null;
        let tipsIndex = 0;
        
        // ÌïôÏÉù Í≤åÏãúÍ∏Ä ÌóàÏö© Ïó¨Î∂Ä ÌôïÏù∏
        function isStudentPostAllowed() {
            if (!currentTopicData || !currentTopicData.settings) {
                return true; // Í∏∞Î≥∏Í∞í: ÌóàÏö©
            }
            return currentTopicData.settings.allowStudentPost !== false;
        }
        
        // ÏûÖÎ†• ÌïÑÎìú ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
        function updateInputFieldsState() {
            const allowed = isStudentPostAllowed();
            
            // Ìè¨Ïä§Ìä∏Ïûá ÏûÖÎ†• ÌïÑÎìú
            const postitInput = document.getElementById('postitInput');
            if (postitInput) {
                postitInput.disabled = !allowed;
                postitInput.placeholder = allowed ? 'ÏùòÍ≤¨ÏùÑ Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî...' : 'ÍµêÏÇ¨Í∞Ä ÌïôÏÉù Í≤åÏãúÍ∏ÄÏùÑ Ï†úÌïúÏ§ëÏûÖÎãàÎã§';
                postitInput.style.backgroundColor = allowed ? '' : '#f8f9fa';
                postitInput.style.color = allowed ? '' : '#6c757d';
            }
            
            // Ï∞¨Î∞ò ÌÜ†Î°† ÏûÖÎ†• ÌïÑÎìúÎì§
            const agreeInput = document.getElementById('agreeInput');
            const disagreeInput = document.getElementById('disagreeInput');
            
            [agreeInput, disagreeInput].forEach(input => {
                if (input) {
                    input.disabled = !allowed;
                    input.placeholder = allowed ? 
                        (input.id === 'agreeInput' ? 'Ï∞¨ÏÑ± ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...' : 'Î∞òÎåÄ ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...') :
                        'ÍµêÏÇ¨Í∞Ä ÌïôÏÉù ÏùòÍ≤¨ ÏûëÏÑ±ÏùÑ Ï†úÌïúÏ§ëÏûÖÎãàÎã§';
                    input.style.backgroundColor = allowed ? '' : '#f8f9fa';
                    input.style.color = allowed ? '' : '#6c757d';
                }
            });
            
            // Î≤ÑÌäºÎì§ÎèÑ ÎπÑÌôúÏÑ±Ìôî
            const buttons = [
                document.querySelector('button[onclick="addPostit()"]'),
                document.querySelector('button[onclick="submitDebateVote(\'agree\')"]'),
                document.querySelector('button[onclick="submitDebateVote(\'disagree\')"]')
            ];
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                }
            });
        }
        
        const tips = [
            "üí° Íµ¨Ï≤¥Ï†ÅÏù∏ ÏòàÏãúÎ•º Îì§Ïñ¥ ÏùòÍ≤¨ÏùÑ ÌëúÌòÑÌï¥Î≥¥ÏÑ∏Ïöî",
            "ü§î Îã§Î•∏ ÏπúÍµ¨Îì§Ïùò ÏùòÍ≤¨ÎèÑ Ï°¥Ï§ëÌï¥Ï£ºÏÑ∏Ïöî",
            "‚ú® Ï∞ΩÏùòÏ†ÅÏù∏ ÏïÑÏù¥ÎîîÏñ¥Î•º ÏûêÏú†Î°≠Í≤å ÎÇòÎàÑÏñ¥Î≥¥ÏÑ∏Ïöî",
            "üéØ Ï£ºÏ†úÏóê ÎßûÎäî ÏùòÍ≤¨ÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî",
            "üë• ÌòëÎ†•ÌïòÏó¨ Îçî ÎÇòÏùÄ Í≤∞Î°†ÏùÑ Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî"
        ];

        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Firebase ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
        function getFirebaseConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api');
            const projectId = urlParams.get('project');
            
            if (apiKey && projectId) {
                // localStorageÏóê Ï†ÄÏû•
                localStorage.setItem('user_firebase_apiKey', decodeURIComponent(apiKey));
                localStorage.setItem('user_firebase_projectId', decodeURIComponent(projectId));
                localStorage.setItem('user_firebase_databaseURL', `https://${decodeURIComponent(projectId)}-default-rtdb.asia-southeast1.firebasedatabase.app`);
                
                return {
                    apiKey: decodeURIComponent(apiKey),
                    authDomain: `${decodeURIComponent(projectId)}.firebaseapp.com`,
                    databaseURL: `https://${decodeURIComponent(projectId)}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: decodeURIComponent(projectId),
                    storageBucket: `${decodeURIComponent(projectId)}.appspot.com`
                };
            }
            return null;
        }

        // ÏÇ¨Ïö©Ïûê Firebase ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞
        function loadUserFirebaseConfig() {
            // Î®ºÏ†Ä URL ÌååÎùºÎØ∏ÌÑ∞ ÌôïÏù∏
            const urlConfig = getFirebaseConfigFromUrl();
            if (urlConfig) {
                return urlConfig;
            }
            
            // localStorageÏóêÏÑú ÌôïÏù∏
            const apiKey = localStorage.getItem('user_firebase_apiKey');
            const projectId = localStorage.getItem('user_firebase_projectId');
            
            if (apiKey && projectId) {
                return {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`
                };
            }
            return null;
        }

        // Firebase ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
        function getFirebaseConfig() {
            const userConfig = loadUserFirebaseConfig();
            if (userConfig) {
                return userConfig;
            } else {
                // Firebase ÏÑ§Ï†ïÏù¥ ÏóÜÏúºÎ©¥ Ïò§Î•ò ÌëúÏãú
                showError('Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. ÍµêÏÇ¨ÏóêÍ≤å Ïò¨Î∞îÎ•∏ ÎßÅÌÅ¨Î•º ÏöîÏ≤≠ÌïòÏÑ∏Ïöî.');
                throw new Error('Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
            }
        }

        // Firebase SDK Î°úÎìú
        async function loadFirebase() {
            if (typeof firebase !== 'undefined') {
                return true;
            }

            try {
                // Firebase Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
                await loadScript('https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js');
                await loadScript('https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js');
                
                // Firebase Ï¥àÍ∏∞Ìôî
                const config = getFirebaseConfig();
                const app = firebase.initializeApp(config, 'studentApp-' + Date.now());
                database = app.database();
                
                console.log('Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                return true;
            } catch (error) {
                console.error('Firebase Î°úÎìú Ïã§Ìå®:', error);
                alert('Firebase Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÍµêÏÇ¨ÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.');
                return false;
            }
        }

        // Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ìï®Ïàò
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Î∞ò Ï∞∏Í∞Ä
        async function joinClass() {
            const name = document.getElementById('nameInput').value.trim();
            const classCode = document.getElementById('classCodeInput').value.trim().toUpperCase();

            if (!name || !classCode) {
                alert('Ïù¥Î¶ÑÍ≥º Î∞ò ÏΩîÎìúÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (!await loadFirebase()) {
                return;
            }

            try {
                console.log('Î∞ò Ï∞∏Í∞Ä ÏãúÎèÑ:', { name, classCode });
                
                // Î∞ò ÏΩîÎìúÎ°ú Î∞ò Ï†ïÎ≥¥ Ï∞æÍ∏∞ (ÍµêÏÇ¨Ïö©Í≥º ÎèôÏùºÌïú Íµ¨Ï°∞ ÏÇ¨Ïö©)
                const classSnapshot = await database.ref(`classes/${classCode}`).once('value');
                const classData = classSnapshot.val();
                
                console.log('Î∞ò Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Í≤∞Í≥º:', classData);

                if (!classData) {
                    alert('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Î∞ò ÏΩîÎìúÏûÖÎãàÎã§. ÍµêÏÇ¨ÏóêÍ≤å Ï†ïÌôïÌïú ÏΩîÎìúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                // ÌïôÏÉù Ï†ïÎ≥¥Î•º Î∞òÏóê Îì±Î°ù
                await database.ref(`classes/${classCode}/students/${name}`).set({
                    name: name,
                    joinedAt: Date.now(),
                    status: 'active'
                });

                // ÌïôÏÉù Ï†ïÎ≥¥ ÏÑ§Ï†ï
                currentStudent = name;
                currentClassCode = classCode; // Î∞ò ÏΩîÎìúÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                currentClassName = classData.className || classData.name;

                console.log('ÏÑ§Ï†ïÎêú Ï†ïÎ≥¥:', { currentStudent, currentClassCode, currentClassName });

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('className').textContent = classData.className || classData.name;

                // ÌôîÎ©¥ Ï†ÑÌôò
                switchScreen('roomListScreen');
                
                // Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞ Î≤ÑÌäº ÌëúÏãú
                const backToLoginBtn = document.getElementById('backToLoginBtn');
                if (backToLoginBtn) {
                    backToLoginBtn.style.display = 'inline-block';
                }
                
                // ÌÜ†Î°†Î∞© Î™©Î°ù Î°úÎìú
                await loadRooms(classCode);

            } catch (error) {
                console.error('Î∞ò Ï∞∏Í∞Ä Ïò§Î•ò:', error);
                alert('Î∞ò Ï∞∏Í∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // ÌÜ†Î°†Î∞© Î™©Î°ù Î°úÎìú
        async function loadRooms(classId) {
            try {
                console.log('ÌÜ†Î°†Î∞© Î°úÎìú ÏãúÏûë:', classId);
                
                // ÍµêÏÇ¨Ïö©Í≥º ÎèôÏùºÌïú Í≤ΩÎ°úÎ°ú ÌÜ†Î°† Ï£ºÏ†ú Ï°∞Ìöå
                const roomsSnapshot = await database.ref(`classes/${classId}/discussions`).once('value');
                const roomsData = roomsSnapshot.val() || {};
                
                console.log('ÌÜ†Î°†Î∞© Îç∞Ïù¥ÌÑ∞ (classes Í≤ΩÎ°ú):', roomsData);

                currentRooms = Object.keys(roomsData).map(id => {
                    const room = { id: id, ...roomsData[id] };
                    // ÌÜ†Î°† ÏãúÍ∞Ñ Ï¢ÖÎ£å Ï≤¥ÌÅ¨ Î∞è ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    updateRoomStatus(room);
                    return room;
                });

                console.log('Î≥ÄÌôòÎêú ÌÜ†Î°†Î∞© Î™©Î°ù:', currentRooms);
                
                displayRooms();

                // Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ§Ï†ï - ÍµêÏÇ¨Ïö©Í≥º ÎèôÏùºÌïú Í≤ΩÎ°ú ÏÇ¨Ïö©
                database.ref(`classes/${classId}/discussions`).on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    console.log('Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞:', data);
                    currentRooms = Object.keys(data).map(id => {
                        const room = { id: id, ...data[id] };
                        // ÌÜ†Î°† ÏãúÍ∞Ñ Ï¢ÖÎ£å Ï≤¥ÌÅ¨ Î∞è ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        updateRoomStatus(room);
                        return room;
                    });
                    displayRooms();
                });

            } catch (error) {
                console.error('ÌÜ†Î°†Î∞© Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('roomsList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        ‚ùå ÌÜ†Î°†Î∞© Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // ÌÜ†Î°†Î∞© Î™©Î°ù ÌëúÏãú
        function displayRooms() {
            const roomsList = document.getElementById('roomsList');
            
            if (currentRooms.length === 0) {
                roomsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #6c757d;">
                        üì≠ ÏïÑÏßÅ ÏßÑÌñâ Ï§ëÏù∏ ÌÜ†Î°†Ïù¥ ÏóÜÏäµÎãàÎã§.<br>
                        <small>ÍµêÏÇ¨Í∞Ä ÌÜ†Î°†ÏùÑ ÏãúÏûëÌï† ÎïåÍπåÏßÄ Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</small>
                    </div>
                `;
                return;
            }

            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú ÌôïÏù∏
            const showClosedCheckbox = document.getElementById('showClosedRoomsCheckbox');
            const showClosed = showClosedCheckbox ? showClosedCheckbox.checked : false;
            
            // ÌïÑÌÑ∞ÎßÅÎêú ÌÜ†Î°†Î∞© Î™©Î°ù
            let filteredRooms = currentRooms.filter(room => {
                const status = room.status || 'active';
                if (showClosed) {
                    return true; // Î™®Îì† Î∞© ÌëúÏãú
                } else {
                    return status === 'active' || status === 'waiting'; // ÏßÑÌñâÏ§ë/ÎåÄÍ∏∞Ï§ëÎßå ÌëúÏãú
                }
            });

            // ÏµúÏã† ÏÉùÏÑ±ÏàúÏúºÎ°ú Ï†ïÎ†¨ (createdAt Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú)
            filteredRooms.sort((a, b) => {
                const timeA = a.createdAt || 0;
                const timeB = b.createdAt || 0;
                return timeB - timeA;
            });

            if (filteredRooms.length === 0) {
                roomsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #6c757d;">
                        üì≠ ÌëúÏãúÌï† ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§.<br>
                        <small>${showClosed ? 'ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§.' : 'ÏßÑÌñâ Ï§ëÏù∏ ÌÜ†Î°†Ïù¥ ÏóÜÏäµÎãàÎã§. "Ï¢ÖÎ£åÎêú ÌÜ†Î°†Î∞© Î≥¥Í∏∞"Î•º Ï≤¥ÌÅ¨ÌïòÎ©¥ Î™®Îì† ÌÜ†Î°†Î∞©ÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§.'}</small>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredRooms.forEach(room => {
                const status = room.status || 'active';
                const participants = room.participants || {};
                const participantCount = Object.keys(participants).length;
                
                // ÌÜ†Î°† ÌòïÌÉúÎ•º ÌïúÍ∏ÄÎ°ú Î≥ÄÌôò
                const typeNames = {
                    'debate': 'Ï∞¨Î∞ò ÌÜ†Î°†',
                    'discussion': 'ÏûêÏú† ÌÜ†Î°†',
                    'postit': 'Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†',
                    'survey': 'ÏÑ§Î¨∏ Ï°∞ÏÇ¨',
                    'general': 'ÏûêÏú† ÌÜ†Î°†'
                };
                const roomType = typeNames[room.type] || 'ÏûêÏú† ÌÜ†Î°†';
                
                let statusClass = 'active';
                let statusText = 'ÏßÑÌñâÏ§ë';
                let statusStyle = 'status-active';
                
                if (status === 'waiting') {
                    statusClass = 'waiting';
                    statusText = 'ÎåÄÍ∏∞Ï§ë';
                    statusStyle = 'status-waiting';
                } else if (status === 'closed') {
                    statusClass = 'closed';
                    statusText = 'Ï¢ÖÎ£åÎê®';
                    statusStyle = 'status-closed';
                }

                const clickAction = status === 'active' ? 
                    `onclick="joinRoom('${room.id}', '${room.title}', '${status}')"` : 
                    `onclick="viewRoomHistory('${room.id}', '${room.title}')"`;
                
                html += `
                    <div class="room-item ${statusClass}" ${clickAction}>
                        <div class="room-header">
                            <div class="room-title">üí¨ ${room.title}</div>
                            <div class="room-status ${statusStyle}">${statusText}</div>
                        </div>
                        <div class="room-info">
                            <span>üë• ${participantCount}Î™Ö Ï∞∏Ïó¨</span>
                            <span>‚è∞ ${room.duration || 30}Î∂Ñ</span>
                            <span>üìÅ ${roomType}</span>
                        </div>
                        ${room.description ? `<div style="margin-top: 8px; font-size: 12px; color: #6c757d;">${room.description}</div>` : ''}
                        ${status !== 'active' ? `<div style="text-align: center; margin-top: 8px; font-size: 11px; color: #6c757d;">ÌÅ¥Î¶≠ÌïòÏó¨ ÌÜ†Î°† Í≤∞Í≥º Î≥¥Í∏∞</div>` : ''}
                    </div>
                `;
            });

            roomsList.innerHTML = html;
        }

        // ÌÜ†Î°†Î∞© Ï∞∏Í∞Ä
        async function joinRoom(roomId, roomTitle, status) {
            if (status === 'closed') {
                alert('Ï¢ÖÎ£åÎêú ÌÜ†Î°†ÏûÖÎãàÎã§.');
                return;
            }

            if (status === 'waiting') {
                alert('ÏïÑÏßÅ ÏãúÏûëÎêòÏßÄ ÏïäÏùÄ ÌÜ†Î°†ÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                currentTopicId = roomId;
                
                // ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const topicSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}`).once('value');
                currentTopicData = topicSnapshot.val();
                
                console.log('ÌÜ†Î°† Îç∞Ïù¥ÌÑ∞:', currentTopicData);
                
                // ÍµêÏÇ¨Ïö©Í≥º ÎèôÏùºÌïú Í≤ΩÎ°úÎ°ú Ï∞∏Ïó¨Ïûê Îì±Î°ù
                const participantData = {
                    name: currentStudent,
                    role: 'student',
                    isAnonymous: false,
                    joinedAt: Date.now(),
                    lastActive: Date.now()
                };
                
                await database.ref(`classes/${currentClassCode}/discussions/${roomId}/participants/${currentStudent}`).set(participantData);
                
                // Ï∞∏Ïó¨Ïûê Ïàò Ï¶ùÍ∞Ä
                await database.ref(`classes/${currentClassCode}/discussions/${roomId}/participantCount`).transaction(count => {
                    return (count || 0) + 1;
                });

                console.log('Ï∞∏Ïó¨Ïûê Îì±Î°ù ÏôÑÎ£å:', currentStudent, roomId);

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                const discussionTitleEl = document.getElementById('discussionTitle');
                if (discussionTitleEl) {
                    discussionTitleEl.textContent = roomTitle;
                }
                
                // ÏÇ¨Ïù¥ÎìúÎ∞î ÏóÖÎç∞Ïù¥Ìä∏
                updateSidebar();
                
                // ÌÜ†Î°† ÌÉÄÏûÖÏóê Îî∞Îùº UI ÏÑ§Ï†ï
                setupDiscussionUI();
                
                // ÌôîÎ©¥ Ï†ÑÌôò
                switchScreen('discussionScreen');
                
                // ÏÉÅÌÉú Ìå®ÎÑê ÌëúÏãú
                document.getElementById('statusSection').style.display = 'flex';
                
                // ÌÜ†Î°†Î∞© Î™©Î°ù Î≤ÑÌäº ÌëúÏãú
                const backToRoomListBtn = document.getElementById('backToRoomListBtn');
                if (backToRoomListBtn) {
                    backToRoomListBtn.style.display = 'inline-block';
                }
                
                // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                setupRealtimeListeners();
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
                setTimeout(() => {
                    updateInputFieldsState();
                }, 500);

            } catch (error) {
                console.error('ÌÜ†Î°†Î∞© Ï∞∏Í∞Ä Ïò§Î•ò:', error);
                alert('ÌÜ†Î°†Î∞© Ï∞∏Í∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // ÌÜ†Î°† UI ÏÑ§Ï†ï
        function setupDiscussionUI() {
            const debateDiscussion = document.getElementById('debateDiscussion');
            const generalDiscussion = document.getElementById('generalDiscussion');
            const postitDiscussion = document.getElementById('postitDiscussion');
            
            // Î™®Îì† UI Ïà®Í∏∞Í∏∞
            debateDiscussion.style.display = 'none';
            generalDiscussion.style.display = 'none';
            postitDiscussion.style.display = 'none';
            
            if (currentTopicData && currentTopicData.type === 'debate') {
                // Ï∞¨Î∞ò ÌÜ†Î°† UI ÌëúÏãú
                debateDiscussion.style.display = 'block';
                console.log('Ï∞¨Î∞ò ÌÜ†Î°† UIÎ°ú Ï†ÑÌôò');
            } else if (currentTopicData && currentTopicData.type === 'postit') {
                // Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°† UI ÌëúÏãú
                postitDiscussion.style.display = 'block';
                console.log('Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°† UIÎ°ú Ï†ÑÌôò');
                
                // Ìè¨Ïä§Ìä∏Ïûá Î≥¥Îìú Ï¥àÍ∏∞Ìôî
                initializePostitBoard();
            } else {
                // ÏûêÏú† ÌÜ†Î°† UI ÌëúÏãú (Í∏∞Î≥∏ - Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ)
                generalDiscussion.style.display = 'block';
                console.log('ÏûêÏú† ÌÜ†Î°†(Ï±ÑÌåÖ) UIÎ°ú Ï†ÑÌôò');
                
                // Ï±ÑÌåÖ Ï¥àÍ∏∞Ìôî
                initializeChatArea();
            }
        }

        // Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupRealtimeListeners() {
            console.log('üéØ Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏãúÏûë:', currentTopicId);
            
            // Í∏∞Ï°¥ Î¶¨Ïä§ÎÑàÎì§ Î™ÖÏãúÏ†ÅÏúºÎ°ú Ï†úÍ±∞
            cleanupListeners();
            
            console.log('üéØ ÏÉàÎ°úÏö¥ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï - ÌÜ†Î°†Î∞©:', currentTopicId);
            
            // ÌòÑÏû¨ ÌÜ†Î°†Î∞©Ïùò Î¶¨Ïä§ÎÑàÎßå ÏÑ§Ï†ï
            
            // ÌÜ†Î°† ÏÑ§Ï†ï Î≥ÄÍ≤Ω Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/settings`).on('value', (snapshot) => {
                if (snapshot.exists() && currentTopicData) {
                    currentTopicData.settings = snapshot.val();
                    updateInputFieldsState(); // ÏûÖÎ†• ÌïÑÎìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                }
            });
            
            if (currentTopicData && currentTopicData.type === 'debate') {
                // Ï∞¨Î∞ò ÌÜ†Î°†Ïö© Î¶¨Ïä§ÎÑà
                setupDebateListeners();
            } else if (currentTopicData && currentTopicData.type === 'postit') {
                // Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†Ïö© Î¶¨Ïä§ÎÑà
                setupPostitListeners();
            } else {
                // ÏûêÏú† ÌÜ†Î°†Ïö© Î¶¨Ïä§ÎÑà (Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ)
                setupChatListeners();
            }

            // Í≥µÌÜµ Ï∞∏Ïó¨Ïûê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants`).on('value', (snapshot) => {
                const participants = snapshot.val() || {};
                const count = Object.keys(participants).length;
                console.log('Ï∞∏Ïó¨Ïûê ÏóÖÎç∞Ïù¥Ìä∏:', count);
                const discussionStatsEl = document.getElementById('discussionStats');
                if (discussionStatsEl) {
                    updateDiscussionStats(count);
                }
                
                // ÏÇ¨Ïù¥ÎìúÎ∞î Ï∞∏Ïó¨Ïûê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                const participantCountEl = document.getElementById('participantCount');
                if (participantCountEl) {
                    participantCountEl.textContent = `üë• ${count}Î™Ö Ï∞∏Ïó¨`;
                }
            });
            
            // ÍµêÏÇ¨ Î©îÏãúÏßÄ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            const teacherMessagesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/teacherMessages`);
            console.log('üì¢ ÍµêÏÇ¨ Î©îÏãúÏßÄ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï:', `classes/${currentClassCode}/discussions/${currentTopicId}/teacherMessages`);
            
            const teacherMessageListener = (snapshot) => {
                const teacherMessage = snapshot.val();
                console.log('ÏÉà ÍµêÏÇ¨ Î©îÏãúÏßÄ ÏàòÏã† (Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞):', teacherMessage);
                console.log('ÏÉà ÍµêÏÇ¨ Î©îÏãúÏßÄ ÏàòÏã†:', {
                    currentTopicId: currentTopicId,
                    messageTopicId: teacherMessage.topicId,
                    message: teacherMessage.message,
                    timestamp: teacherMessage.timestamp
                });
                
                // Î©îÏãúÏßÄÍ∞Ä ÌòÑÏû¨ ÌÜ†Î°†Î∞©Ïö©Ïù∏ÏßÄ ÌôïÏù∏
                if (teacherMessage.topicId && teacherMessage.topicId !== currentTopicId) {
                    console.log('‚ùå Îã§Î•∏ ÌÜ†Î°†Î∞© Î©îÏãúÏßÄ Î¨¥Ïãú:', teacherMessage.topicId, 'vs', currentTopicId);
                    return;
                }
                
                console.log('‚úÖ Î©îÏãúÏßÄ ÌëúÏãú:', teacherMessage.message);
                displayTeacherMessage(teacherMessage);
            };
            
            // Î¶¨Ïä§ÎÑà Îì±Î°ù Î∞è Ï∂îÏ†Å
            teacherMessagesRef.on('child_added', teacherMessageListener);
            activeListeners.teacherMessages = {
                ref: teacherMessagesRef,
                event: 'child_added',
                listener: teacherMessageListener
            };
            
            // Í∏∞Ï°¥ ÍµêÏÇ¨ Î©îÏãúÏßÄÎì§ Î°úÎìú
            database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/teacherMessages`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    // Í∏∞Ï°¥ Î©îÏãúÏßÄÎì§ÏùÑ ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨Ìï¥ÏÑú Î°úÌÖåÏù¥ÏÖòÏóê Ï∂îÍ∞Ä
                    Object.values(messages)
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(message => {
                            // Î©îÏãúÏßÄÍ∞Ä ÌòÑÏû¨ ÌÜ†Î°†Î∞©Ïö©Ïù∏ÏßÄ ÌôïÏù∏
                            if (message.topicId && message.topicId !== currentTopicId) {
                                console.log('Í∏∞Ï°¥ Î©îÏãúÏßÄ - Îã§Î•∏ ÌÜ†Î°†Î∞© Î©îÏãúÏßÄ Î¨¥Ïãú:', message.topicId, 'vs', currentTopicId);
                                return;
                            }
                            
                            if (!teacherMessages.some(tm => tm.timestamp === message.timestamp)) {
                                displayTeacherMessage(message);
                            }
                        });
                }
            });
        }

        // Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨ Ìï®Ïàò
        function cleanupListeners() {
            console.log('üßπ Í∏∞Ï°¥ Î¶¨Ïä§ÎÑàÎì§ Ï†ïÎ¶¨ ÏãúÏûë');
            
            // Ï∂îÏ†ÅÎêú Î¶¨Ïä§ÎÑàÎì§ Ï†úÍ±∞
            Object.keys(activeListeners).forEach(key => {
                const listenerInfo = activeListeners[key];
                if (listenerInfo && listenerInfo.ref) {
                    console.log(`üóëÔ∏è ${key} Î¶¨Ïä§ÎÑà Ï†úÍ±∞`);
                    listenerInfo.ref.off(listenerInfo.event, listenerInfo.listener);
                    activeListeners[key] = null;
                }
            });
            
            // Ï∂îÍ∞Ä ÏïàÏ†ÑÏû•Ïπò: Ï†ÑÏ≤¥ discussions Í≤ΩÎ°ú Î¶¨Ïä§ÎÑà Ï†úÍ±∞
            database.ref('discussions').off();
            console.log('üßπ Ï†ÑÏ≤¥ discussions Î¶¨Ïä§ÎÑà Ï†úÍ±∞ ÏôÑÎ£å');
        }

        // Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°† Î¶¨Ïä§ÎÑà
        function setupPostitListeners() {
            const messagesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`);
            
            // üîß Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            messagesRef.off();
            console.log('üßπ Ìè¨Ïä§Ìä∏Ïûá Î¶¨Ïä§ÎÑà Í∏∞Ï°¥ Îì±Î°ù Ìï¥Ï†ú');
            
            const joinTime = Date.now(); // Ï∞∏Ïó¨ ÏãúÏ†ê Í∏∞Î°ù
            
            // Í∏∞Ï°¥ Ìè¨Ïä§Ìä∏ÏûáÎì§ÏùÑ ÌïúÎ≤àÏóê Î°úÎìú
            messagesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    Object.values(messages)
                        .filter(msg => msg.type === 'postit')
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(message => {
                            console.log('Í∏∞Ï°¥ Ìè¨Ïä§Ìä∏Ïûá Î°úÎìú:', message);
                            addPostitToBoard(message);
                        });
                }
            });
            
            // ÏÉàÎ°úÏö¥ Ìè¨Ïä§Ìä∏ÏûáÎßå Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ï∂îÍ∞Ä (Ï∞∏Ïó¨ ÏãúÏ†ê Ïù¥ÌõÑ)
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                
                // Ìè¨Ïä§Ìä∏ÏûáÏù¥Í≥† Ï∞∏Ïó¨ ÏãúÏ†ê Ïù¥ÌõÑÏóê ÏûëÏÑ±Îêú Í≤ÉÎßå Ï≤òÎ¶¨
                if (message.type === 'postit' && message.timestamp > joinTime) {
                    console.log('ÏÉà Ìè¨Ïä§Ìä∏Ïûá Ïã§ÏãúÍ∞Ñ Ï∂îÍ∞Ä:', message);
                    addPostitToBoard(message);
                }
            });
            
            console.log('üéØ Ìè¨Ïä§Ìä∏Ïûá Î¶¨Ïä§ÎÑà ÏÉàÎ°ú ÏÑ§Ï†ï ÏôÑÎ£å');
        }

        // ÏûêÏú† ÌÜ†Î°† Î¶¨Ïä§ÎÑà (Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ)
        function setupChatListeners() {
            const messagesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`);
            
            // üîß Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            messagesRef.off();
            console.log('üßπ Ï±ÑÌåÖ Î¶¨Ïä§ÎÑà Í∏∞Ï°¥ Îì±Î°ù Ìï¥Ï†ú');
            
            const joinTime = Date.now(); // Ï∞∏Ïó¨ ÏãúÏ†ê Í∏∞Î°ù
            
            // Í∏∞Ï°¥ Ï±ÑÌåÖ Î©îÏãúÏßÄÎì§ÏùÑ ÌïúÎ≤àÏóê Î°úÎìú
            messagesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    Object.values(messages)
                        .filter(msg => msg.type === 'chat')
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(message => {
                            console.log('Í∏∞Ï°¥ Ï±ÑÌåÖ Î©îÏãúÏßÄ Î°úÎìú:', message);
                            addChatMessage(message);
                        });
                }
            });
            
            // Ïã§ÏãúÍ∞Ñ ÏÉà Î©îÏãúÏßÄ Î¶¨Ïä§ÎÑà
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                
                // Ï±ÑÌåÖ Î©îÏãúÏßÄÏù¥Í≥† Ï∞∏Ïó¨ ÏãúÏ†ê Ïù¥ÌõÑÏóê ÏûëÏÑ±Îêú Í≤ÉÎßå Ï≤òÎ¶¨
                if (message.type === 'chat' && message.timestamp > joinTime) {
                    console.log('ÏÉà Ï±ÑÌåÖ Î©îÏãúÏßÄ Ïã§ÏãúÍ∞Ñ Ï∂îÍ∞Ä:', message);
                    addChatMessage(message);
                }
            });
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† Î¶¨Ïä§ÎÑà
        function setupDebateListeners() {
            const votesRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes`);
            
            // üîß Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            votesRef.off();
            console.log('üßπ Ï∞¨Î∞òÌÜ†Î°† Î¶¨Ïä§ÎÑà Í∏∞Ï°¥ Îì±Î°ù Ìï¥Ï†ú');
            
            // Ìà¨Ìëú Î¶¨Ïä§ÎÑà
            votesRef.on('value', (snapshot) => {
                const votes = snapshot.val() || {};
                console.log('Ìà¨Ìëú ÏóÖÎç∞Ïù¥Ìä∏:', votes);
                updateDebateResults(votes);
                updateDebateOpinions(votes);
            });
        }


        // Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞Ä
        async function addPostit() {
            // ÌïôÏÉù Í≤åÏãúÍ∏Ä ÌóàÏö© Ïó¨Î∂Ä ÌôïÏù∏
            if (!isStudentPostAllowed()) {
                alert('üìù ÌòÑÏû¨ ÍµêÏÇ¨Í∞Ä ÌïôÏÉù Í≤åÏãúÍ∏ÄÏùÑ Ï†úÌïúÌïòÍ≥† ÏûàÏäµÎãàÎã§.\nÏû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const input = document.getElementById('postitInput');
            const content = input.value.trim();
            
            if (!content) return;

            try {
                const colors = ['yellow', 'blue', 'green', 'pink'];
                const color = colors[Math.floor(Math.random() * colors.length)];

                // Î©îÏãúÏßÄ ID ÏÉùÏÑ±
                const messageRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`).push();
                const messageId = messageRef.key;

                // Ìè¨Ïä§Ìä∏ÏûáÎèÑ Î©îÏãúÏßÄ ÌòïÌÉúÎ°ú Ï†ÄÏû• (typeÏúºÎ°ú Íµ¨Î∂Ñ)
                await messageRef.set({
                    participantId: currentStudent,
                    participantName: currentStudent,
                    content: content,
                    type: 'postit',
                    color: color,
                    isAnonymous: false,
                    timestamp: Date.now(),
                    messageId: messageId
                });

                console.log('Ìè¨Ïä§Ìä∏Ïûá Ï†ÑÏÜ° ÏôÑÎ£å:', content);
                input.value = '';
            } catch (error) {
                console.error('Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                alert('Ìè¨Ïä§Ìä∏Ïûá Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† Ìà¨Ìëú Ï†úÏ∂ú
        async function submitDebateVote(position) {
            // ÌïôÏÉù Í≤åÏãúÍ∏Ä ÌóàÏö© Ïó¨Î∂Ä ÌôïÏù∏
            if (!isStudentPostAllowed()) {
                alert('üìù ÌòÑÏû¨ ÍµêÏÇ¨Í∞Ä ÌïôÏÉù ÏùòÍ≤¨ ÏûëÏÑ±ÏùÑ Ï†úÌïúÌïòÍ≥† ÏûàÏäµÎãàÎã§.\nÏû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const inputId = position === 'agree' ? 'agreeInput' : 'disagreeInput';
            const inputEl = document.getElementById(inputId);
            
            if (!inputEl) {
                console.error(`Input element not found: ${inputId}`);
                return;
            }
            
            const opinion = inputEl.value.trim();
            
            if (!opinion) {
                alert('ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const voteData = {
                    participantId: currentStudent,
                    participantName: currentStudent,
                    position: position,
                    opinion: opinion,
                    timestamp: Date.now()
                };
                
                const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes/${voteId}`).set(voteData);
                
                console.log('Ìà¨Ìëú Ï†úÏ∂ú ÏôÑÎ£å:', voteData);
                inputEl.value = '';
                alert(`${position === 'agree' ? 'Ï∞¨ÏÑ±' : 'Î∞òÎåÄ'} ÏùòÍ≤¨Ïù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.`);
                
            } catch (error) {
                console.error('Ìà¨Ìëú Ï†úÏ∂ú Ïò§Î•ò:', error);
                alert('Ìà¨Ìëú Ï†úÏ∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
        function updateDebateResults(votes) {
            const agreeVotes = [];
            const disagreeVotes = [];
            
            Object.values(votes).forEach(vote => {
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            const agreeCount = agreeVotes.length;
            const disagreeCount = disagreeVotes.length;
            const total = agreeCount + disagreeCount;
            
            // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            const agreeCountEl = document.getElementById('agreeCount');
            const disagreeCountEl = document.getElementById('disagreeCount');
            if (agreeCountEl) agreeCountEl.textContent = agreeCount;
            if (disagreeCountEl) disagreeCountEl.textContent = disagreeCount;
            
            // ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const agreeBar = document.getElementById('agreeBar');
            const disagreeBar = document.getElementById('disagreeBar');
            if (total > 0 && agreeBar && disagreeBar) {
                const agreePercent = (agreeCount / total) * 100;
                const disagreePercent = (disagreeCount / total) * 100;
                
                agreeBar.style.width = `${agreePercent}%`;
                disagreeBar.style.width = `${disagreePercent}%`;
            }
            
            console.log(`Ï∞¨Î∞òÌÜ†Î°† Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏: Ï∞¨ÏÑ± ${agreeCount}, Î∞òÎåÄ ${disagreeCount}`);
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† ÏùòÍ≤¨ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateDebateOpinions(votes) {
            const agreeList = document.getElementById('agreeList');
            const disagreeList = document.getElementById('disagreeList');
            
            if (!agreeList || !disagreeList) return;
            
            const agreeVotes = [];
            const disagreeVotes = [];
            
            Object.keys(votes).forEach(voteId => {
                const vote = votes[voteId];
                vote.id = voteId; // ID Ï∂îÍ∞Ä
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            // Ï∞¨ÏÑ± ÏùòÍ≤¨ Î™©Î°ù
            agreeList.innerHTML = agreeVotes.map(vote => {
                const isMe = vote.participantId === currentStudent;
                const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                const actionsHtml = isMe ? `
                    <div style="margin-top: 5px;">
                        <button onclick="editDebateVote('${vote.id}')" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-right: 3px;">‚úèÔ∏è ÏàòÏ†ï</button>
                        <button onclick="deleteDebateVote('${vote.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">üóëÔ∏è ÏÇ≠Ï†ú</button>
                    </div>
                ` : '';
                
                return `
                    <div style="background: ${isMe ? '#c3e6cb' : '#f8f9fa'}; padding: 8px; border-radius: 4px; margin-bottom: 5px; font-size: 12px;" data-vote-id="${vote.id}">
                        <strong>${vote.participantName}</strong> (${timestamp})<br>
                        <div class="vote-opinion">${vote.opinion}${vote.isEdited ? ' <small style="opacity: 0.6;">(ÏàòÏ†ïÎê®)</small>' : ''}</div>
                        ${actionsHtml}
                    </div>
                `;
            }).join('') || '<div style="color: #6c757d; text-align: center; padding: 20px;">ÏïÑÏßÅ Ï∞¨ÏÑ± ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
            
            // Î∞òÎåÄ ÏùòÍ≤¨ Î™©Î°ù
            disagreeList.innerHTML = disagreeVotes.map(vote => {
                const isMe = vote.participantId === currentStudent;
                const timestamp = new Date(vote.timestamp).toLocaleTimeString();
                const actionsHtml = isMe ? `
                    <div style="margin-top: 5px;">
                        <button onclick="editDebateVote('${vote.id}')" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-right: 3px;">‚úèÔ∏è ÏàòÏ†ï</button>
                        <button onclick="deleteDebateVote('${vote.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">üóëÔ∏è ÏÇ≠Ï†ú</button>
                    </div>
                ` : '';
                
                return `
                    <div style="background: ${isMe ? '#f5c6cb' : '#f8f9fa'}; padding: 8px; border-radius: 4px; margin-bottom: 5px; font-size: 12px;" data-vote-id="${vote.id}">
                        <strong>${vote.participantName}</strong> (${timestamp})<br>
                        <div class="vote-opinion">${vote.opinion}${vote.isEdited ? ' <small style="opacity: 0.6;">(ÏàòÏ†ïÎê®)</small>' : ''}</div>
                        ${actionsHtml}
                    </div>
                `;
            }).join('') || '<div style="color: #6c757d; text-align: center; padding: 20px;">ÏïÑÏßÅ Î∞òÎåÄ ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† ÏùòÍ≤¨ ÏàòÏ†ï
        function editDebateVote(voteId) {
            const voteDiv = document.querySelector(`[data-vote-id="${voteId}"]`);
            if (!voteDiv) return;
            
            const opinionDiv = voteDiv.querySelector('.vote-opinion');
            const currentOpinion = opinionDiv.textContent.replace(' (ÏàòÏ†ïÎê®)', '').trim();
            
            // Ìé∏Ïßë Î™®ÎìúÎ°ú Ï†ÑÌôò
            opinionDiv.innerHTML = `
                <textarea style="width: 100%; height: 40px; font-size: 11px; border: 1px solid #ccc; border-radius: 3px; padding: 4px;" id="edit-vote-${voteId}">${currentOpinion}</textarea>
                <div style="margin-top: 5px;">
                    <button onclick="saveDebateVote('${voteId}')" style="background: #28a745; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-right: 3px;">Ï†ÄÏû•</button>
                    <button onclick="cancelEditDebateVote('${voteId}', '${currentOpinion.replace(/'/g, "\\'")}')" style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">Ï∑®ÏÜå</button>
                </div>
            `;
            
            // textareaÏóê Ìè¨Ïª§Ïä§
            const textarea = document.getElementById(`edit-vote-${voteId}`);
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† ÏùòÍ≤¨ ÏàòÏ†ï Ï†ÄÏû•
        async function saveDebateVote(voteId) {
            const textarea = document.getElementById(`edit-vote-${voteId}`);
            const newOpinion = textarea.value.trim();
            
            if (!newOpinion) {
                alert('ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                // FirebaseÏóêÏÑú Ìà¨Ìëú ÏóÖÎç∞Ïù¥Ìä∏
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes/${voteId}`).update({
                    opinion: newOpinion,
                    lastModified: Date.now(),
                    isEdited: true
                });
                
                console.log('Ìà¨Ìëú ÏàòÏ†ï ÏôÑÎ£å:', voteId);
                
            } catch (error) {
                console.error('Ìà¨Ìëú ÏàòÏ†ï Ïò§Î•ò:', error);
                alert('ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† ÏùòÍ≤¨ ÏàòÏ†ï Ï∑®ÏÜå
        function cancelEditDebateVote(voteId, originalOpinion) {
            const voteDiv = document.querySelector(`[data-vote-id="${voteId}"]`);
            const opinionDiv = voteDiv.querySelector('.vote-opinion');
            
            // ÏõêÎûò ÎÇ¥Ïö©ÏúºÎ°ú Î≥µÏõê
            opinionDiv.innerHTML = originalOpinion;
        }

        // Ï∞¨Î∞ò ÌÜ†Î°† ÏùòÍ≤¨ ÏÇ≠Ï†ú
        async function deleteDebateVote(voteId) {
            if (!confirm('Ïù¥ ÏùòÍ≤¨ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                // FirebaseÏóêÏÑú Ìà¨Ìëú ÏÇ≠Ï†ú
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/votes/${voteId}`).remove();
                
                console.log('Ìà¨Ìëú ÏÇ≠Ï†ú ÏôÑÎ£å:', voteId);
                
            } catch (error) {
                console.error('Ìà¨Ìëú ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ìè¨Ïä§Ìä∏Ïûá Î≥¥ÎìúÏóê Ï∂îÍ∞Ä
        function addPostitToBoard(postitData) {
            const board = document.getElementById('postitBoard');
            
            // Ï§ëÎ≥µ Ìè¨Ïä§Ìä∏Ïûá Ï≤¥ÌÅ¨ (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÏôÄ ÎÇ¥Ïö©ÏúºÎ°ú ÌôïÏù∏)
            const existingPostits = board.querySelectorAll('.postit');
            for (let existingPostit of existingPostits) {
                const existingTimestamp = existingPostit.getAttribute('data-timestamp');
                const existingContent = existingPostit.querySelector('.postit-content')?.textContent;
                if (existingTimestamp === String(postitData.timestamp) && 
                    existingContent === postitData.message) {
                    console.log('Ï§ëÎ≥µ Ìè¨Ïä§Ìä∏Ïûá Í∞êÏßÄ, Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå:', postitData.message);
                    return;
                }
            }
            
            // Ï≤´ Î≤àÏß∏ Ìè¨Ïä§Ìä∏ÏûáÏùº Îïå ÏïàÎÇ¥ Î©îÏãúÏßÄ Ï†úÍ±∞
            const welcomeMsg = board.querySelector('[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const postit = document.createElement('div');
            postit.className = `postit ${postitData.color || 'yellow'}`;
            postit.setAttribute('data-message-id', postitData.messageId || postitData.id);
            postit.setAttribute('data-participant-id', postitData.participantId);
            postit.setAttribute('data-timestamp', postitData.timestamp);
            
            const isMyPostit = postitData.participantId === currentStudent;
            const actionsHtml = isMyPostit ? `
                <div class="postit-actions">
                    <button class="postit-btn postit-edit-btn" onclick="editPostit('${postitData.messageId || postitData.id}')" title="ÏàòÏ†ï">‚úèÔ∏è</button>
                    <button class="postit-btn postit-delete-btn" onclick="deletePostit('${postitData.messageId || postitData.id}')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                </div>
            ` : '';
            
            postit.innerHTML = `
                ${actionsHtml}
                <div class="postit-content">${postitData.content}</div>
                <div class="postit-author">${postitData.participantName}</div>
            `;

            board.appendChild(postit);
        }

        // Ìè¨Ïä§Ìä∏Ïûá ÏàòÏ†ï
        function editPostit(messageId) {
            const postit = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!postit) return;
            
            const contentDiv = postit.querySelector('.postit-content');
            const currentContent = contentDiv.textContent;
            
            // Ìé∏Ïßë Î™®ÎìúÎ°ú Ï†ÑÌôò
            postit.classList.add('postit-editing');
            contentDiv.innerHTML = `
                <textarea class="postit-edit-textarea" placeholder="Ìè¨Ïä§Ìä∏Ïûá ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">${currentContent}</textarea>
                <div class="postit-edit-actions">
                    <button class="postit-save-btn" onclick="savePostit('${messageId}')">Ï†ÄÏû•</button>
                    <button class="postit-cancel-btn" onclick="cancelEditPostit('${messageId}', '${currentContent.replace(/'/g, "\\'")}')">Ï∑®ÏÜå</button>
                </div>
            `;
            
            // ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº Ïà®ÍπÄ
            const actions = postit.querySelector('.postit-actions');
            if (actions) actions.style.display = 'none';
            
            // textareaÏóê Ìè¨Ïª§Ïä§
            const textarea = postit.querySelector('.postit-edit-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // Ìè¨Ïä§Ìä∏Ïûá ÏàòÏ†ï Ï†ÄÏû•
        async function savePostit(messageId) {
            const postit = document.querySelector(`[data-message-id="${messageId}"]`);
            const textarea = postit.querySelector('.postit-edit-textarea');
            const newContent = textarea.value.trim();
            
            if (!newContent) {
                alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                // FirebaseÏóêÏÑú Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages/${messageId}`).update({
                    content: newContent,
                    lastModified: Date.now(),
                    isEdited: true
                });
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                const contentDiv = postit.querySelector('.postit-content');
                contentDiv.innerHTML = newContent + ' <small style="opacity: 0.6;">(ÏàòÏ†ïÎê®)</small>';
                
                // Ìé∏Ïßë Î™®Îìú Ìï¥Ï†ú
                postit.classList.remove('postit-editing');
                
                // ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº Îã§Ïãú ÌëúÏãú
                const actions = postit.querySelector('.postit-actions');
                if (actions) actions.style.display = '';
                
                console.log('Ìè¨Ïä§Ìä∏Ïûá ÏàòÏ†ï ÏôÑÎ£å:', messageId);
                
            } catch (error) {
                console.error('Ìè¨Ïä§Ìä∏Ïûá ÏàòÏ†ï Ïò§Î•ò:', error);
                alert('ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ìè¨Ïä§Ìä∏Ïûá ÏàòÏ†ï Ï∑®ÏÜå
        function cancelEditPostit(messageId, originalContent) {
            const postit = document.querySelector(`[data-message-id="${messageId}"]`);
            const contentDiv = postit.querySelector('.postit-content');
            
            // ÏõêÎûò ÎÇ¥Ïö©ÏúºÎ°ú Î≥µÏõê
            contentDiv.innerHTML = originalContent;
            
            // Ìé∏Ïßë Î™®Îìú Ìï¥Ï†ú
            postit.classList.remove('postit-editing');
            
            // ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº Îã§Ïãú ÌëúÏãú
            const actions = postit.querySelector('.postit-actions');
            if (actions) actions.style.display = '';
        }

        // Ìè¨Ïä§Ìä∏Ïûá ÏÇ≠Ï†ú
        async function deletePostit(messageId) {
            if (!confirm('Ïù¥ Ìè¨Ïä§Ìä∏ÏûáÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                // FirebaseÏóêÏÑú Î©îÏãúÏßÄ ÏÇ≠Ï†ú
                await database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages/${messageId}`).remove();
                
                // UIÏóêÏÑú Ìè¨Ïä§Ìä∏Ïûá Ï†úÍ±∞
                const postit = document.querySelector(`[data-message-id="${messageId}"]`);
                if (postit) {
                    postit.style.animation = 'fadeOut 0.3s ease-in-out';
                    setTimeout(() => {
                        postit.remove();
                        
                        // Ìè¨Ïä§Ìä∏ÏûáÏù¥ Î™®Îëê ÏÇ≠Ï†úÎêòÏóàÏúºÎ©¥ ÏïàÎÇ¥ Î©îÏãúÏßÄ ÌëúÏãú
                        const board = document.getElementById('postitBoard');
                        if (board && board.children.length === 0) {
                            board.innerHTML = `
                                <div style="text-align: center; color: #6c757d; padding: 40px; font-size: 16px;">
                                    üí≠ Ï≤´ Î≤àÏß∏ ÏùòÍ≤¨ÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!
                                </div>
                            `;
                        }
                    }, 300);
                }
                
                console.log('Ìè¨Ïä§Ìä∏Ïûá ÏÇ≠Ï†ú ÏôÑÎ£å:', messageId);
                
            } catch (error) {
                console.error('Ìè¨Ïä§Ìä∏Ïûá ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // ÌÇ§Î≥¥Îìú ÏóîÌÑ∞ Ï≤òÎ¶¨
        function handlePostitEnter(event) {
            if (event.key === 'Enter') {
                addPostit();
            }
        }

        // ÌôîÎ©¥ Ï†ÑÌôò
        function switchScreen(screenId) {
            const screens = ['loginScreen', 'roomListScreen', 'discussionScreen'];
            screens.forEach(id => {
                document.getElementById(id).style.display = id === screenId ? 'block' : 'none';
            });
        }

        // Îí§Î°ú Í∞ÄÍ∏∞
        function goBack() {
            switchScreen('loginScreen');
            document.getElementById('statusSection').style.display = 'none';
            
            // ÌÜ†Î°†Î∞© Î™©Î°ù Î≤ÑÌäº Ïà®Í∏∞Í∏∞
            const backToRoomListBtn = document.getElementById('backToRoomListBtn');
            if (backToRoomListBtn) {
                backToRoomListBtn.style.display = 'none';
            }
            
            // Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞ Î≤ÑÌäº Ïà®Í∏∞Í∏∞
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            if (backToLoginBtn) {
                backToLoginBtn.style.display = 'none';
            }
            
            // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            currentStudent = null;
            currentClassCode = null;
            currentClassName = null;
        }

        // ÌÜ†Î°† ÎÇòÍ∞ÄÍ∏∞
        function leaveDiscussion() {
            if (currentTopicId && currentStudent) {
                // Ï∞∏Ïó¨Ïûê Î™©Î°ùÏóêÏÑú Ï†úÍ±∞ - ÍµêÏÇ¨Ïö©Í≥º ÎèôÏùºÌïú Í≤ΩÎ°ú ÏÇ¨Ïö©
                database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants/${currentStudent}`).remove();
            }
            
            // ÍµêÏÇ¨ Î©îÏãúÏßÄ Î°úÌÖåÏù¥ÏÖò Ï†ïÎ¶¨
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
                messageRotationInterval = null;
            }
            teacherMessages = [];
            currentMessageIndex = 0;
            
            // Î™®Îì† Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
            cleanupListeners();
            
            switchScreen('roomListScreen');
            currentTopicId = null;
            
            // ÏÉÅÌÉú Ìå®ÎÑê Ïà®Í∏∞Í∏∞
            document.getElementById('statusSection').style.display = 'none';
            
            // ÌÜ†Î°†Î∞© Î™©Î°ù Î≤ÑÌäº Ïà®Í∏∞Í∏∞
            const backToRoomListBtn = document.getElementById('backToRoomListBtn');
            if (backToRoomListBtn) {
                backToRoomListBtn.style.display = 'none';
            }
            
            // Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞ Î≤ÑÌäº ÌëúÏãú
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            if (backToLoginBtn) {
                backToLoginBtn.style.display = 'inline-block';
            }
        }

        // ÌîÑÎ°úÍ∑∏Îû® Ï¢ÖÎ£å
        function exitDiscussion() {
            if (confirm('Ï†ïÎßê ÌÜ†Î°†ÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                if (currentTopicId && currentStudent) {
                    // ÍµêÏÇ¨Ïö©Í≥º ÎèôÏùºÌïú Í≤ΩÎ°ú ÏÇ¨Ïö©
                    database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants/${currentStudent}`).remove();
                }
                
                // ÍµêÏÇ¨ Î©îÏãúÏßÄ Î°úÌÖåÏù¥ÏÖò Ï†ïÎ¶¨
                if (messageRotationInterval) {
                    clearInterval(messageRotationInterval);
                    messageRotationInterval = null;
                }
                teacherMessages = [];
                currentMessageIndex = 0;
                
                goBack();
            }
        }

        // ÏÉàÎ°úÍ≥†Ïπ®
        function refreshRooms() {
            if (currentClassCode) {
                const classId = getClassId();
                loadRooms(classId);
            }
        }


        // ÏÇ¨Ïù¥ÎìúÎ∞î ÏóÖÎç∞Ïù¥Ìä∏
        function updateSidebar() {
            // ÌïôÏÉù Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            const studentNameEl = document.getElementById('sidebarStudentName');
            const studentAvatarEl = document.getElementById('studentAvatar');
            if (studentNameEl && currentStudent) {
                studentNameEl.textContent = currentStudent;
                if (studentAvatarEl) {
                    studentAvatarEl.textContent = currentStudent.charAt(0);
                }
            }
            
            // Î∞© Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            const roomTitleEl = document.getElementById('sidebarRoomTitle');
            const roomTypeEl = document.getElementById('sidebarRoomType');
            if (roomTitleEl && currentTopicData) {
                roomTitleEl.textContent = currentTopicData.title;
                if (roomTypeEl) {
                    const typeNames = {
                        'debate': 'Ï∞¨Î∞ò ÌÜ†Î°†',
                        'discussion': 'ÏûêÏú† ÌÜ†Î°†',
                        'survey': 'ÏÑ§Î¨∏ Ï°∞ÏÇ¨'
                    };
                    roomTypeEl.textContent = typeNames[currentTopicData.type] || 'ÏûêÏú† ÌÜ†Î°†';
                }
            }
            
            // Îã§Î•∏ ÌÜ†Î°†Î∞© Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            updateOtherRoomsList();
            
            // ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
            if (currentTopicData && currentTopicData.endTime) {
                startStatusPanelUpdater();
            }
        }
        
        // Îã§Î•∏ ÌÜ†Î°†Î∞© Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateOtherRoomsList() {
            console.log('updateOtherRoomsList ÏãúÏûë');
            const otherRoomsEl = document.getElementById('otherRoomsList');
            if (!otherRoomsEl || !currentRooms) {
                console.log('‚ùå otherRoomsEl ÎòêÎäî currentRoomsÍ∞Ä ÏóÜÏùå:', {otherRoomsEl, currentRooms});
                return;
            }
            
            // ÌòÑÏû¨ ÌÜ†Î°†Î∞© Ï†úÏô∏
            let otherRooms = currentRooms.filter(room => room.id !== currentTopicId);
            console.log('ÌòÑÏû¨ ÌÜ†Î°†Î∞© Ï†úÏô∏Ìïú Î™©Î°ù:', otherRooms.length, 'Í∞ú');
            
            // ÏµúÏã† ÏÉùÏÑ±ÏàúÏúºÎ°ú Ï†ïÎ†¨ (createdAt Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú)
            otherRooms.sort((a, b) => {
                const timeA = a.createdAt || 0;
                const timeB = b.createdAt || 0;
                return timeB - timeA;
            });
            console.log('ÏµúÏã†Ïàú Ï†ïÎ†¨ ÏôÑÎ£å');
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú ÌôïÏù∏ (ÏÇ¨Ïù¥ÎìúÎ∞îÏö©)
            const showClosedCheckbox = document.getElementById('showClosedRoomsSidebarCheckbox');
            const showClosed = showClosedCheckbox ? showClosedCheckbox.checked : false;
            console.log('ÏÇ¨Ïù¥ÎìúÎ∞î Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú:', showClosed);
            
            // Ï¢ÖÎ£åÎêú ÌÜ†Î°†Î∞© ÌïÑÌÑ∞ÎßÅ
            if (!showClosed) {
                console.log('Ï¢ÖÎ£åÎêú ÌÜ†Î°†Î∞© Ï†úÏô∏ - ÌïÑÌÑ∞ÎßÅ Ï†Ñ:', otherRooms.map(r => ({id: r.id, title: r.title, status: r.status})));
                // ÏßÑÌñâ Ï§ëÏù∏ ÌÜ†Î°†Î∞©Îßå ÌëúÏãú (active, waitingÎßå ÌóàÏö©)
                otherRooms = otherRooms.filter(room => room.status === 'active' || room.status === 'waiting');
                console.log('Ï¢ÖÎ£åÎêú ÌÜ†Î°†Î∞© Ï†úÏô∏ - ÌïÑÌÑ∞ÎßÅ ÌõÑ:', otherRooms.map(r => ({id: r.id, title: r.title, status: r.status})));
            } else {
                console.log('Î™®Îì† ÌÜ†Î°†Î∞© ÌëúÏãú:', otherRooms.map(r => ({id: r.id, title: r.title, status: r.status})));
            }
            
            if (otherRooms.length === 0) {
                const message = showClosed ? 'Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§' : 'ÏßÑÌñâ Ï§ëÏù∏ Îã§Î•∏ ÌÜ†Î°†Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§';
                otherRoomsEl.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 10px; font-size: 12px;">
                        ${message}
                    </div>
                `;
                return;
            }
            
            const roomsHtml = otherRooms.map(room => {
                const statusText = room.status === 'active' ? 'ÏßÑÌñâÏ§ë' : room.status === 'waiting' ? 'ÎåÄÍ∏∞Ï§ë' : 'Ï¢ÖÎ£å';
                const statusClass = room.status === 'active' ? '' : 'style="opacity: 0.6;"';
                
                return `
                    <div class="room-item-mini" onclick="switchToRoom('${room.id}', '${room.title}', '${room.status}')" ${statusClass}>
                        <div style="font-weight: bold; margin-bottom: 2px;">${room.title}</div>
                        <div style="color: #6c757d;">${statusText} ‚Ä¢ ${Object.keys(room.participants || {}).length}Î™Ö</div>
                    </div>
                `;
            }).join('');
            
            otherRoomsEl.innerHTML = roomsHtml;
        }
        
        // Ìè¨Ïä§Ìä∏Ïûá Î≥¥Îìú Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function initializePostitBoard() {
            const board = document.getElementById('postitBoard');
            if (board) {
                // Î≥¥Îìú ÏôÑÏ†ÑÌûà Ï¥àÍ∏∞Ìôî
                board.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px; grid-column: 1 / -1;">
                        üìù ÏïÑÏßÅ ÏûëÏÑ±Îêú Ìè¨Ïä§Ìä∏ÏûáÏù¥ ÏóÜÏäµÎãàÎã§.
                    </div>
                `;
                console.log('Ìè¨Ïä§Ìä∏Ïûá Î≥¥Îìú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }
        }

        // ÌÜ†Î°†Î∞© ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateRoomStatus(room) {
            if (!room.endTime) return;
            
            const now = Date.now();
            const endTime = room.endTime;
            
            // ÌÜ†Î°† ÏãúÍ∞ÑÏù¥ ÎÅùÎÇ¨ÎäîÎç∞ ÏïÑÏßÅ active ÏÉÅÌÉúÎùºÎ©¥ closedÎ°ú Î≥ÄÍ≤Ω
            if (endTime < now && room.status === 'active') {
                room.status = 'closed';
                console.log(`ÌÜ†Î°†Î∞© "${room.title}" ÏãúÍ∞Ñ Ï¢ÖÎ£åÎ°ú ÏÉÅÌÉú Î≥ÄÍ≤Ω: active ‚Üí closed`);
            }
        }

        // Ï¢ÖÎ£åÎêú ÌÜ†Î°†Î∞© ÌëúÏãú ÌÜ†Í∏Ä
        function toggleClosedRooms() {
            // ÌòÑÏû¨ ÌôîÎ©¥Ïóê Îî∞Îùº Îã§Î•∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò Ìò∏Ï∂ú
            const roomListScreen = document.getElementById('roomListScreen');
            const discussionScreen = document.getElementById('discussionScreen');
            
            if (roomListScreen && roomListScreen.style.display !== 'none') {
                // ÌÜ†Î°†Î∞© Î™©Î°ù ÌôîÎ©¥ÏóêÏÑú Ìò∏Ï∂úÎêú Í≤ΩÏö∞
                displayRooms();
            } else if (discussionScreen && discussionScreen.style.display !== 'none') {
                // ÌÜ†Î°† Ï∞∏Ïó¨ ÌôîÎ©¥ÏóêÏÑú Ìò∏Ï∂úÎêú Í≤ΩÏö∞ (ÏÇ¨Ïù¥ÎìúÎ∞îÏùò Îã§Î•∏ ÌÜ†Î°†Î∞© Î™©Î°ù)
                updateOtherRoomsList();
            }
        }

        // ÏÇ¨Ïù¥ÎìúÎ∞î Ï≤¥ÌÅ¨Î∞ïÏä§Ïö© ÌÜ†Í∏Ä Ìï®Ïàò (ÏÉàÎ°úÍ≥†Ïπ® Ìè¨Ìï®)
        async function toggleClosedRoomsWithRefresh() {
            console.log('ÏÇ¨Ïù¥ÎìúÎ∞î Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÅ¥Î¶≠ - ÌÜ†Î°†Î∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë');
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú Î®ºÏ†Ä ÌôïÏù∏
            const showClosedCheckbox = document.getElementById('showClosedRoomsSidebarCheckbox');
            const showClosed = showClosedCheckbox ? showClosedCheckbox.checked : false;
            console.log('Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú:', showClosed);
            
            try {
                // ÌÜ†Î°†Î∞© Î™©Î°ùÏùÑ Îã§Ïãú Î°úÎìú
                if (currentClassCode) {
                    console.log('ÌÜ†Î°†Î∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®:', currentClassCode);
                    await loadRooms(currentClassCode);
                    console.log('‚úÖ ÌÜ†Î°†Î∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
                    
                    // ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ ÏÇ¨Ïù¥ÎìúÎ∞î ÏóÖÎç∞Ïù¥Ìä∏
                    updateOtherRoomsList();
                    console.log('‚úÖ ÏÇ¨Ïù¥ÎìúÎ∞î ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.log('‚ùå currentClassCodeÍ∞Ä ÏóÜÏñ¥ÏÑú ÏÉàÎ°úÍ≥†Ïπ® Î∂àÍ∞Ä');
                    // ÏÉàÎ°úÍ≥†Ïπ® ÏóÜÏù¥ Í∏∞Ï°¥ Î™©Î°ùÎßå ÏóÖÎç∞Ïù¥Ìä∏
                    updateOtherRoomsList();
                }
            } catch (error) {
                console.error('ÌÜ†Î°†Î∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® Ïò§Î•ò:', error);
                // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Ï°¥ Î∞©ÏãùÏúºÎ°ú ÎåÄÏ≤¥
                updateOtherRoomsList();
            }
        }
        
        // Îã§Î•∏ ÌÜ†Î°†Î∞©ÏúºÎ°ú Ï†ÑÌôò
        function switchToRoom(roomId, roomTitle, status) {
            if (status !== 'active') {
                alert('ÏßÑÌñâ Ï§ëÏù∏ ÌÜ†Î°†Îßå Ï∞∏Ïó¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            if (confirm('ÌòÑÏû¨ ÌÜ†Î°†ÏùÑ ÎÇòÍ∞ÄÍ≥† Îã§Î•∏ ÌÜ†Î°†ÏúºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                // ÌòÑÏû¨ ÌÜ†Î°†ÏóêÏÑú ÎÇòÍ∞ÄÍ∏∞
                if (currentTopicId && currentStudent) {
                    database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/participants/${currentStudent}`).remove();
                }
                
                // ÏÉà ÌÜ†Î°† Ï∞∏Í∞Ä
                joinRoom(roomId, roomTitle, status);
            }
        }
        
        // ÏÉÅÌÉú Ìå®ÎÑê ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateDiscussionStats(participantCount) {
            const discussionStatsEl = document.getElementById('discussionStats');
            if (!discussionStatsEl) return;
            
            if (!currentTopicData || !currentTopicData.endTime) {
                discussionStatsEl.innerHTML = `üë• ${participantCount}Î™Ö`;
                return;
            }
            
            const now = Date.now();
            const endTime = currentTopicData.endTime;
            const timeLeft = endTime - now;
            
            if (timeLeft <= 0) {
                discussionStatsEl.innerHTML = `Ï¢ÖÎ£åÎê® | üë• ${participantCount}Î™Ö`;
                return;
            }
            
            const minutes = Math.floor(timeLeft / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            discussionStatsEl.innerHTML = `${minutes}Î∂Ñ ${seconds.toString().padStart(2, '0')}Ï¥à | üë• ${participantCount}Î™Ö`;
        }

        // ÏÉÅÌÉú Ìå®ÎÑê ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥ÌÑ∞ ÏãúÏûë
        function startStatusPanelUpdater() {
            if (!currentTopicData || !currentTopicData.endTime) return;
            
            function updateStatusPanel() {
                // ÌòÑÏû¨ Ï∞∏Ïó¨Ïûê Ïàò Í≥ÑÏÇ∞
                const participants = Object.keys(currentTopicData.participants || {}).length;
                updateDiscussionStats(participants);
            }
            
            updateStatusPanel();
            setInterval(updateStatusPanel, 1000);
        }
        
        // ÌåÅ Î°úÌÖåÏù¥ÏÖò
        function rotateTips() {
            const tipsBox = document.getElementById('tipsBox');
            if (!tipsBox) return;
            
            const allTips = [
                'Íµ¨Ï≤¥Ï†ÅÏù∏ ÏòàÏãúÎ•º Îì§Ïñ¥ ÏùòÍ≤¨ÏùÑ ÌëúÌòÑÌï¥Î≥¥ÏÑ∏Ïöî',
                'Îã§Î•∏ ÏπúÍµ¨Îì§Ïùò ÏùòÍ≤¨ÎèÑ Ï°¥Ï§ëÌï¥Ï£ºÏÑ∏Ïöî',
                'Ï∞ΩÏùòÏ†ÅÏù∏ ÏïÑÏù¥ÎîîÏñ¥Î•º ÏûêÏú†Î°≠Í≤å ÎÇòÎàÑÏñ¥Î≥¥ÏÑ∏Ïöî',
                'Ï£ºÏ†úÏóê ÎßûÎäî ÏùòÍ≤¨ÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî',
                'ÌòëÎ†•ÌïòÏó¨ Îçî ÎÇòÏùÄ Í≤∞Î°†ÏùÑ Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî',
                'ÏßàÎ¨∏Ïù¥ ÏûàÏúºÎ©¥ Ïñ∏Ï†úÎì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî'
            ];
            
            let currentTipIndex = 0;
            
            function updateTip() {
                tipsBox.textContent = allTips[currentTipIndex];
                currentTipIndex = (currentTipIndex + 1) % allTips.length;
            }
            
            // 15Ï¥àÎßàÎã§ ÌåÅ Î°úÌÖåÏù¥ÏÖò
            setInterval(updateTip, 15000);
        }
        
        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
        function getClassId() {
            // currentClassCodeÏóê Ïã§Ï†ú classIdÍ∞Ä Ï†ÄÏû•ÎêòÏñ¥ ÏûàÏùå
            return currentClassCode;
        }


        // ÌÜ†Î°† Ïù¥Î†• Î≥¥Í∏∞ (ÌïôÏÉùÏö©)
        async function viewRoomHistory(roomId, roomTitle) {
            try {
                console.log('ÌÜ†Î°† Ïù¥Î†• Î°úÎìú Ï§ë:', roomId);
                
                // ÌÜ†Î°† Í∏∞Î≥∏ Ï†ïÎ≥¥ Î°úÎìú
                const topicSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}`).once('value');
                const topicData = topicSnapshot.val();
                
                if (!topicData) {
                    alert('ÌÜ†Î°† Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                // ÌÜ†Î°† Î©îÏãúÏßÄ/Ìè¨Ïä§Ìä∏Ïûá Î°úÎìú
                const messagesSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}/messages`).once('value');
                const messages = messagesSnapshot.val() || {};
                
                // Ï∞¨Î∞ò ÌÜ†Î°†Ïù∏ Í≤ΩÏö∞ Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞ÎèÑ Î°úÎìú
                let votes = {};
                if (topicData.type === 'debate') {
                    const votesSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}/votes`).once('value');
                    votes = votesSnapshot.val() || {};
                }
                
                // Ï∞∏Ïó¨Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const participantsSnapshot = await database.ref(`classes/${currentClassCode}/discussions/${roomId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                // ÌïôÏÉùÏö© Ïù¥Î†• Î™®Îã¨ ÌëúÏãú
                showStudentHistoryModal(topicData, messages, votes, participants);
                
            } catch (error) {
                console.error('ÌÜ†Î°† Ïù¥Î†• Î°úÎìú Ïò§Î•ò:', error);
                alert('ÌÜ†Î°† Ïù¥Î†•ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // ÌïôÏÉùÏö© ÌÜ†Î°† Ïù¥Î†• Î™®Îã¨ ÌëúÏãú
        function showStudentHistoryModal(topicData, messages, votes, participants) {
            const typeNames = {
                'debate': 'Ï∞¨Î∞ò ÌÜ†Î°†',
                'discussion': 'ÏûêÏú† ÌÜ†Î°†', 
                'postit': 'Ìè¨Ïä§Ìä∏Ïûá ÌÜ†Î°†',
                'survey': 'ÏÑ§Î¨∏ Ï°∞ÏÇ¨'
            };
            
            const createdDate = new Date(topicData.createdAt).toLocaleString();
            const endDate = topicData.endTime ? new Date(topicData.endTime).toLocaleString() : 'ÏßÑÌñâ Ï§ë';
            const participantCount = Object.keys(participants).length;
            const messageCount = Object.keys(messages).length;
            
            // ÎÇ¥Í∞Ä Ï∞∏Ïó¨ÌñàÎäîÏßÄ ÌôïÏù∏
            const didParticipate = participants[currentStudent] ? true : false;
            
            // Î™®Îã¨ HTML ÏÉùÏÑ±
            const modalHTML = `
                <div id="historyModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <!-- Ìó§Îçî -->
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0 0 8px 0;">üìö ${topicData.title}</h3>
                                    <p style="margin: 0; opacity: 0.9;">${typeNames[topicData.type] || 'ÌÜ†Î°†'} ‚Ä¢ ${didParticipate ? 'Ï∞∏Ïó¨Ìï®' : 'Ï∞∏Ïó¨ ÏïàÌï®'}</p>
                                </div>
                                <button onclick="closeHistoryModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">√ó</button>
                            </div>
                        </div>
                        
                        <!-- ÎÇ¥Ïö© -->
                        <div style="padding: 20px;">
                            <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                    <div>
                                        <strong>üìÖ ÏãúÏûë ÏãúÍ∞Ñ</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${createdDate}</span>
                                    </div>
                                    <div>
                                        <strong>‚è∞ Ï¢ÖÎ£å ÏãúÍ∞Ñ</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${endDate}</span>
                                    </div>
                                    <div>
                                        <strong>üë• Ï∞∏Ïó¨Ïûê</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${participantCount}Î™Ö</span>
                                    </div>
                                    <div>
                                        <strong>üí¨ ÌôúÎèôÎüâ</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${messageCount}Í∞ú</span>
                                    </div>
                                </div>
                                ${topicData.description ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dee2e6;">
                                        <strong>üìù Ï£ºÏ†ú ÏÑ§Î™Ö</strong><br>
                                        <span style="color: #6c757d; font-size: 13px;">${topicData.description}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Ï∞∏Ïó¨ ÏÉÅÌÉú -->
                            <div style="margin-bottom: 20px;">
                                ${didParticipate ? `
                                    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 8px; text-align: center;">
                                        ‚úÖ Ïù¥ ÌÜ†Î°†Ïóê Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§
                                    </div>
                                ` : `
                                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 12px; border-radius: 8px; text-align: center;">
                                        ‚ùå Ïù¥ ÌÜ†Î°†Ïóê Ï∞∏Ïó¨ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§
                                    </div>
                                `}
                            </div>
                            
                            <!-- ÌÜ†Î°† Í≤∞Í≥º -->
                            <div id="historyContent">
                                ${generateStudentHistoryContent(topicData.type, messages, votes, participants, didParticipate)}
                            </div>
                        </div>
                        
                        <!-- Ìë∏ÌÑ∞ -->
                        <div style="padding: 15px 20px; border-top: 1px solid #dee2e6; text-align: right;">
                            <button class="btn btn-secondary" onclick="closeHistoryModal()">Îã´Í∏∞</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Î™®Îã¨ÏùÑ bodyÏóê Ï∂îÍ∞Ä
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ÌïôÏÉùÏö© ÌÜ†Î°† Ïù¥Î†• ÎÇ¥Ïö© ÏÉùÏÑ±
        function generateStudentHistoryContent(type, messages, votes, participants, didParticipate) {
            if (type === 'debate') {
                return generateStudentDebateHistory(votes, participants, didParticipate);
            } else {
                return generateStudentDiscussionHistory(messages, participants, didParticipate);
            }
        }

        // ÌïôÏÉùÏö© Ï∞¨Î∞ò ÌÜ†Î°† Ïù¥Î†•
        function generateStudentDebateHistory(votes, participants, didParticipate) {
            const agreeVotes = [];
            const disagreeVotes = [];
            let myVote = null;
            
            Object.values(votes).forEach(vote => {
                if (vote.participantId === currentStudent) {
                    myVote = vote;
                }
                if (vote.position === 'agree') {
                    agreeVotes.push(vote);
                } else if (vote.position === 'disagree') {
                    disagreeVotes.push(vote);
                }
            });
            
            const agreeCount = agreeVotes.length;
            const disagreeCount = disagreeVotes.length;
            const total = agreeCount + disagreeCount;
            const agreePercent = total > 0 ? (agreeCount / total * 100).toFixed(1) : 0;
            const disagreePercent = total > 0 ? (disagreeCount / total * 100).toFixed(1) : 0;
            
            return `
                <!-- ÏµúÏ¢Ö Ìà¨Ìëú Í≤∞Í≥º -->
                <div style="margin-bottom: 20px;">
                    <h5 style="margin-bottom: 12px;">üìä ÏµúÏ¢Ö Ìà¨Ìëú Í≤∞Í≥º</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1; background: #d4edda; height: 25px; border-radius: 12px; position: relative; overflow: hidden;">
                                <div style="background: #28a745; height: 100%; width: ${agreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 11px;">
                                    Ï∞¨ÏÑ± ${agreeCount}Î™Ö (${agreePercent}%)
                                </span>
                            </div>
                            <div style="flex: 1; background: #f8d7da; height: 25px; border-radius: 12px; position: relative; overflow: hidden;">
                                <div style="background: #dc3545; height: 100%; width: ${disagreePercent}%; transition: width 1s ease;"></div>
                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 11px;">
                                    Î∞òÎåÄ ${disagreeCount}Î™Ö (${disagreePercent}%)
                                </span>
                            </div>
                        </div>
                        <div style="text-align: center; color: #6c757d; font-size: 11px;">
                            Ï¥ù ${total}Î™ÖÏù¥ Ìà¨ÌëúÏóê Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§
                        </div>
                    </div>
                </div>
                
                <!-- ÎÇ¥ Ìà¨Ìëú -->
                ${myVote ? `
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin-bottom: 10px;">‚úã ÎÇòÏùò Ìà¨Ìëú</h6>
                        <div style="background: ${myVote.position === 'agree' ? '#d4edda' : '#f8d7da'}; border: 2px solid ${myVote.position === 'agree' ? '#28a745' : '#dc3545'}; padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; color: ${myVote.position === 'agree' ? '#155724' : '#721c24'}; margin-bottom: 5px;">
                                ${myVote.position === 'agree' ? '‚úÖ Ï∞¨ÏÑ±' : '‚ùå Î∞òÎåÄ'} Ìà¨Ìëú
                            </div>
                            <div style="color: ${myVote.position === 'agree' ? '#155724' : '#721c24'}; font-size: 13px;">
                                ${myVote.opinion}${myVote.isEdited ? ' <small>(ÏàòÏ†ïÎê®)</small>' : ''}
                            </div>
                        </div>
                    </div>
                ` : didParticipate ? `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                        üìù Ïù¥ ÌÜ†Î°†ÏóêÏÑú Ìà¨ÌëúÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§
                    </div>
                ` : ''}
                
                <!-- Ï£ºÏöî ÏùòÍ≤¨Îì§ (ÏùºÎ∂ÄÎßå) -->
                <div>
                    <h6 style="margin-bottom: 12px;">üí≠ Ï£ºÏöî ÏùòÍ≤¨Îì§</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: #28a745; font-weight: bold; margin-bottom: 8px; font-size: 12px;">‚úÖ Ï∞¨ÏÑ± ÏùòÍ≤¨</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${agreeVotes.slice(0, 3).map(vote => `
                                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 6px; font-size: 12px;">
                                        <div style="color: #6c757d; margin-bottom: 3px;">${vote.participantName}</div>
                                        <div>${vote.opinion}</div>
                                    </div>
                                `).join('') || '<div style="text-align: center; color: #6c757d; padding: 15px; font-size: 12px;">Ï∞¨ÏÑ± ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§</div>'}
                                ${agreeVotes.length > 3 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">Ïô∏ ${agreeVotes.length - 3}Í∞ú Îçî...</div>` : ''}
                            </div>
                        </div>
                        <div>
                            <div style="color: #dc3545; font-weight: bold; margin-bottom: 8px; font-size: 12px;">‚ùå Î∞òÎåÄ ÏùòÍ≤¨</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${disagreeVotes.slice(0, 3).map(vote => `
                                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 6px; font-size: 12px;">
                                        <div style="color: #6c757d; margin-bottom: 3px;">${vote.participantName}</div>
                                        <div>${vote.opinion}</div>
                                    </div>
                                `).join('') || '<div style="text-align: center; color: #6c757d; padding: 15px; font-size: 12px;">Î∞òÎåÄ ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§</div>'}
                                ${disagreeVotes.length > 3 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">Ïô∏ ${disagreeVotes.length - 3}Í∞ú Îçî...</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ÌïôÏÉùÏö© ÏûêÏú† ÌÜ†Î°† Ïù¥Î†•
        function generateStudentDiscussionHistory(messages, participants, didParticipate) {
            const messageArray = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
            const myMessages = messageArray.filter(msg => msg.participantId === currentStudent);
            const postits = messageArray.filter(msg => msg.type === 'postit');
            const chatMessages = messageArray.filter(msg => msg.type !== 'postit');
            
            return `
                <!-- ÎÇ¥ ÌôúÎèô ÏöîÏïΩ -->
                ${myMessages.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin-bottom: 10px;">‚úã ÎÇòÏùò ÌôúÎèô</h6>
                        <div style="background: #e7f3ff; border: 2px solid #007bff; padding: 12px; border-radius: 8px;">
                            <div style="display: flex; gap: 20px; text-align: center;">
                                <div>
                                    <div style="font-weight: bold; color: #0056b3;">${myMessages.filter(m => m.type === 'postit').length}</div>
                                    <div style="font-size: 11px; color: #6c757d;">Ìè¨Ïä§Ìä∏Ïûá</div>
                                </div>
                                <div>
                                    <div style="font-weight: bold; color: #0056b3;">${myMessages.filter(m => m.type !== 'postit').length}</div>
                                    <div style="font-size: 11px; color: #6c757d;">Î©îÏãúÏßÄ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : didParticipate ? `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                        üìù Ïù¥ ÌÜ†Î°†ÏóêÏÑú ÌôúÎèôÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§
                    </div>
                ` : ''}
                
                <!-- Ï†ÑÏ≤¥ ÌôúÎèô ÏöîÏïΩ -->
                <div>
                    <h6 style="margin-bottom: 12px;">üìù ÌÜ†Î°† ÎÇ¥Ïö©</h6>
                    
                    ${postits.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #495057; font-weight: bold; margin-bottom: 8px; font-size: 13px;">üìå Ìè¨Ïä§Ìä∏Ïûá (${postits.length}Í∞ú)</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                                ${postits.slice(0, 6).map(postit => `
                                    <div style="background: ${getPostitColor(postit.color)}; padding: 8px; border-radius: 4px; font-size: 11px; position: relative; ${postit.participantId === currentStudent ? 'border: 2px solid #007bff;' : ''}">
                                        <div style="line-height: 1.3; margin-bottom: 5px;">${postit.content}</div>
                                        <div style="font-size: 9px; opacity: 0.7; position: absolute; bottom: 3px; right: 5px;">${postit.participantName}</div>
                                    </div>
                                `).join('')}
                            </div>
                            ${postits.length > 6 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">Ïô∏ ${postits.length - 6}Í∞ú Îçî...</div>` : ''}
                        </div>
                    ` : ''}
                    
                    ${chatMessages.length > 0 ? `
                        <div>
                            <div style="color: #495057; font-weight: bold; margin-bottom: 8px; font-size: 13px;">üí¨ Î©îÏãúÏßÄ (${chatMessages.length}Í∞ú)</div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px;">
                                ${chatMessages.slice(0, 10).map(msg => `
                                    <div style="margin-bottom: 8px; padding: 6px; background: ${msg.participantId === currentStudent ? '#e7f3ff' : '#f8f9fa'}; border-radius: 4px; font-size: 12px; ${msg.participantId === currentStudent ? 'border-left: 3px solid #007bff;' : ''}">
                                        <div style="color: #6c757d; margin-bottom: 2px; font-size: 10px;">${msg.participantName} ‚Ä¢ ${new Date(msg.timestamp).toLocaleTimeString()}</div>
                                        <div>${msg.content || msg.text}</div>
                                    </div>
                                `).join('')}
                                ${chatMessages.length > 10 ? `<div style="text-align: center; color: #6c757d; font-size: 11px; margin-top: 5px;">Ïô∏ ${chatMessages.length - 10}Í∞ú Îçî...</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${postits.length === 0 && chatMessages.length === 0 ? `
                        <div style="text-align: center; color: #6c757d; padding: 30px;">
                            üí≠ Ïù¥ ÌÜ†Î°†ÏóêÎäî ÏïÑÏßÅ ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Ìè¨Ïä§Ìä∏Ïûá ÏÉâÏÉÅ Î≥ÄÌôò
        function getPostitColor(color) {
            const colors = {
                'yellow': '#ffeb3b',
                'blue': '#2196f3', 
                'green': '#4caf50',
                'pink': '#e91e63'
            };
            return colors[color] || '#ffeb3b';
        }

        // Ïù¥Î†• Î™®Îã¨ Îã´Í∏∞
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ÌïôÍ∏â ÌÜ†Î°† Ï∞∏Ïó¨ ÏãúÏä§ÌÖú - ÌïôÏÉùÏö© Î°úÎìú ÏôÑÎ£å');
            
            // URL ÌååÎùºÎØ∏ÌÑ∞ ÌôïÏù∏ (ÍµêÏÇ¨Í∞Ä ÏßÅÏ†ë ÎßÅÌÅ¨Î•º Ï†úÍ≥µÌïú Í≤ΩÏö∞)
            const urlParams = new URLSearchParams(window.location.search);
            const classCode = urlParams.get('class');
            const studentName = urlParams.get('name');
            
            if (classCode) {
                document.getElementById('classCodeInput').value = classCode;
            }
            if (studentName) {
                document.getElementById('nameInput').value = studentName;
            }
            
            // ÌåÅ Î°úÌÖåÏù¥ÏÖò ÏãúÏûë
            rotateTips();
        });
        
        // ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï†ÄÏû• Î∞∞Ïó¥
        let teacherMessages = [];
        
        // ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï¥àÍ∏∞Ìôî Ìï®Ïàò (ÎîîÎ≤ÑÍπÖÏö©)
        window.clearTeacherMessages = function() {
            teacherMessages = [];
            currentMessageIndex = 0;
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
                messageRotationInterval = null;
            }
            const messagesBox = document.getElementById('teacherMessagesBox');
            if (messagesBox) {
                messagesBox.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px; font-style: italic;">üì¢ ÍµêÏÇ¨ Î©îÏãúÏßÄÎ•º Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§<br><small>Î©îÏãúÏßÄÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§</small></div>';
            }
            console.log('üßπ ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        };
        let currentMessageIndex = 0;
        let messageRotationInterval = null;
        
        // ÌòÑÏû¨ ÌôúÏÑ± Î¶¨Ïä§ÎÑàÎì§ Ï∂îÏ†Å
        let activeListeners = {
            teacherMessages: null,
            settings: null,
            participants: null,
            messages: null
        };

        // ÍµêÏÇ¨ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function displayTeacherMessage(messageData) {
            console.log('üìù displayTeacherMessage Ìò∏Ï∂ú:', messageData);
            const messagesBox = document.getElementById('teacherMessagesBox');
            
            // Î©îÏãúÏßÄÎ•º Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä
            const messageTime = new Date(messageData.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const messageContent = messageData.message || messageData.text || messageData.content || '[Î©îÏãúÏßÄ ÎÇ¥Ïö© ÏóÜÏùå]';
            console.log('üîç Î©îÏãúÏßÄ ÎÇ¥Ïö© Ï∂îÏ∂ú:', {
                'messageData.message': messageData.message,
                'messageData.text': messageData.text,
                'messageData.content': messageData.content,
                'ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú ÎÇ¥Ïö©': messageContent
            });
            
            const formattedMessage = {
                content: messageContent,
                time: messageTime,
                timestamp: messageData.timestamp
            };
            
            teacherMessages.push(formattedMessage);
            console.log('ÏÉà ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï∂îÍ∞Ä:', formattedMessage.content);
            
            // Î©îÏãúÏßÄ Î°úÌÖåÏù¥ÏÖò ÏãúÏûë ÎòêÎäî ÏóÖÎç∞Ïù¥Ìä∏
            startMessageRotation();
        }
        
        // Î©îÏãúÏßÄ Î°úÌÖåÏù¥ÏÖò ÏãúÏûë
        function startMessageRotation() {
            const messagesBox = document.getElementById('teacherMessagesBox');
            
            if (teacherMessages.length === 0) return;
            
            // Í∏∞Ï°¥ Ïù∏ÌÑ∞Î≤å Ï†ïÎ¶¨
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
            }
            
            // ÌòÑÏû¨ Î©îÏãúÏßÄ ÌëúÏãú
            function showCurrentMessage() {
                const message = teacherMessages[currentMessageIndex];
                messagesBox.innerHTML = `
                    <div class="teacher-message" ondblclick="showTeacherMessagesModal()" title="ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ Î™®Îì† Î©îÏãúÏßÄ Î≥¥Í∏∞">
                        <div class="teacher-message-content">${message.content}</div>
                        <div class="teacher-message-time">${message.time}</div>
                        ${teacherMessages.length > 1 ? `<div style="text-align: center; font-size: 10px; color: #007bff; margin-top: 5px;">üí° ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ Î™®Îì† Î©îÏãúÏßÄ Î≥¥Í∏∞ (${currentMessageIndex + 1}/${teacherMessages.length})</div>` : ''}
                    </div>
                `;
            }
            
            // Ï≤´ Î©îÏãúÏßÄ Ï¶âÏãú ÌëúÏãú
            showCurrentMessage();
            
            // Î©îÏãúÏßÄÍ∞Ä 2Í∞ú Ïù¥ÏÉÅÏùº ÎïåÎßå Î°úÌÖåÏù¥ÏÖò
            if (teacherMessages.length > 1) {
                messageRotationInterval = setInterval(() => {
                    currentMessageIndex = (currentMessageIndex + 1) % teacherMessages.length;
                    showCurrentMessage();
                }, 5000); // 5Ï¥àÎßàÎã§ Î°úÌÖåÏù¥ÏÖò
            }
        }

        // ÍµêÏÇ¨ Î©îÏãúÏßÄ Î™®Îã¨ ÌëúÏãú
        function showTeacherMessagesModal() {
            if (teacherMessages.length === 0) {
                alert('ÌëúÏãúÌï† ÍµêÏÇ¨ Î©îÏãúÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            const sortedMessages = [...teacherMessages].sort((a, b) => b.timestamp - a.timestamp);

            const modal = document.createElement('div');
            modal.className = 'teacher-message-modal';
            modal.innerHTML = `
                <div class="teacher-message-modal-content">
                    <div class="teacher-message-modal-header">
                        <h3 style="margin: 0; font-size: 16px;">üí¨ ÍµêÏÇ¨ Î©îÏãúÏßÄ Ï†ÑÏ≤¥ Î≥¥Í∏∞</h3>
                        <button class="modal-close-btn" onclick="closeTeacherMessagesModal()">√ó</button>
                    </div>
                    <div class="teacher-message-modal-body">
                        <div style="margin-bottom: 15px; color: #6c757d; font-size: 13px; text-align: center;">
                            Ï¥ù ${teacherMessages.length}Í∞úÏùò Î©îÏãúÏßÄ (ÏµúÏã†Ïàú)
                        </div>
                        ${sortedMessages.map((message, index) => `
                            <div class="teacher-message-item">
                                <div class="teacher-message-item-content">${message.content}</div>
                                <div class="teacher-message-item-time">
                                    ${message.time}
                                    ${index === 0 ? '<span style="color: #28a745; font-weight: bold;"> (ÏµúÏã†)</span>' : ''}
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6; text-align: center;">
                            <button onclick="closeTeacherMessagesModal()" style="background: #6c757d; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 12px;">
                                Îã´Í∏∞
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ESC ÌÇ§Î°ú Îã´Í∏∞
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTeacherMessagesModal();
                }
            });

            // Î∞∞Í≤Ω ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTeacherMessagesModal();
                }
            });

            document.body.appendChild(modal);
            modal.focus(); // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏Î•º ÏúÑÌï¥ Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï

            console.log('ÍµêÏÇ¨ Î©îÏãúÏßÄ Î™®Îã¨ ÌëúÏãú:', teacherMessages.length, 'Í∞ú Î©îÏãúÏßÄ');
        }

        // ÍµêÏÇ¨ Î©îÏãúÏßÄ Î™®Îã¨ Îã´Í∏∞
        function closeTeacherMessagesModal() {
            const modal = document.querySelector('.teacher-message-modal');
            if (modal) {
                modal.remove();
                console.log('ÍµêÏÇ¨ Î©îÏãúÏßÄ Î™®Îã¨ Îã´Ìûò');
            }
        }

        // Ï±ÑÌåÖ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
        function initializeChatArea() {
            const chatMessages = document.getElementById('chatMessages');
            const chatWelcome = document.getElementById('chatWelcome');
            if (chatMessages && chatWelcome) {
                chatWelcome.style.display = 'block';
            }
        }

        // ÎãµÏû• Í¥ÄÎ†® Ï†ÑÏó≠ Î≥ÄÏàò
        let replyToMessage = null;
        
        // ÎãµÏû• ÏãúÏûë
        function startReply(messageId, authorName, content) {
            replyToMessage = {
                id: messageId,
                author: authorName,
                content: content.substring(0, 100) + (content.length > 100 ? '...' : '') // 100ÏûêÍπåÏßÄÎßå ÌëúÏãú
            };
            
            // ÎãµÏû• ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
            const replyPreview = document.getElementById('replyPreview');
            const replyContent = document.getElementById('replyContent');
            
            replyContent.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px;">${authorName}</div>
                <div>${replyToMessage.content}</div>
            `;
            
            replyPreview.style.display = 'block';
            
            // ÏûÖÎ†•Ï∞ΩÏóê Ìè¨Ïª§Ïä§
            document.getElementById('chatInput').focus();
        }
        
        // ÎãµÏû• Ï∑®ÏÜå
        function cancelReply() {
            replyToMessage = null;
            document.getElementById('replyPreview').style.display = 'none';
        }

        // Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) {
                alert('Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                // Î©îÏãúÏßÄ ID ÏÉùÏÑ±
                const messageRef = database.ref(`classes/${currentClassCode}/discussions/${currentTopicId}/messages`).push();
                const messageId = messageRef.key;

                // Ï±ÑÌåÖ Î©îÏãúÏßÄ Îç∞Ïù¥ÌÑ∞
                const messageData = {
                    id: messageId,
                    participantId: currentStudent,
                    participantName: currentStudent,
                    content: message,
                    type: 'chat',
                    isAnonymous: false,
                    timestamp: Date.now(),
                    edited: false
                };
                
                // ÎãµÏû• Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                if (replyToMessage) {
                    messageData.replyToId = replyToMessage.id;
                    messageData.replyToAuthor = replyToMessage.author;
                    messageData.replyToContent = replyToMessage.content;
                }

                // FirebaseÏóê Ï†ÄÏû•
                await database.ref(`discussions/${currentTopicId}/messages/${messageId}`).set(messageData);
                
                console.log('Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏôÑÎ£å:', messageData);
                input.value = '';
                
                // ÎãµÏû• ÎØ∏Î¶¨Î≥¥Í∏∞ Ïà®Í∏∞Í∏∞
                if (replyToMessage) {
                    cancelReply();
                }
                
            } catch (error) {
                console.error('Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïò§Î•ò:', error);
                alert('Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        function addChatMessage(messageData) {
            const chatMessages = document.getElementById('chatMessages');
            const chatWelcome = document.getElementById('chatWelcome');
            
            if (!chatMessages) return;
            
            // Ï§ëÎ≥µ Î©îÏãúÏßÄ ÌôïÏù∏ (Í∞ôÏùÄ IDÏùò Î©îÏãúÏßÄÍ∞Ä Ïù¥ÎØ∏ ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨)
            const existingMessage = chatMessages.querySelector(`[data-message-id="${messageData.id}"]`);
            if (existingMessage) {
                console.log('Ï§ëÎ≥µ Ï±ÑÌåÖ Î©îÏãúÏßÄ Î¨¥Ïãú:', messageData.id);
                return;
            }
            
            // ÌôòÏòÅ Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
            if (chatWelcome) {
                chatWelcome.style.display = 'none';
            }
            
            // Î©îÏãúÏßÄ ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
            const messageTime = new Date(messageData.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // ÎÇ¥ Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
            const isMyMessage = messageData.participantId === currentStudent;
            const messageClass = isMyMessage ? 'my-message' : 'other-message';
            
            // ÎãµÏû• Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
            const replyContent = messageData.replyToId ? `
                <div class="reply-preview" style="background: #f1f3f4; border-left: 3px solid #007bff; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; color: #6c757d;">
                    <div style="font-weight: bold; margin-bottom: 2px;">‚Ü≥ ${messageData.replyToAuthor}ÏóêÍ≤å ÎãµÏû•</div>
                    <div style="opacity: 0.8;">${messageData.replyToContent}</div>
                </div>
            ` : '';
            
            // Î©îÏãúÏßÄ HTML ÏÉùÏÑ±
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${messageClass}`;
            messageDiv.setAttribute('data-message-id', messageData.id);
            messageDiv.style.position = 'relative';
            messageDiv.innerHTML = `
                ${replyContent}
                <div class="message-header">
                    <span class="message-author">${messageData.participantName}</span>
                    <span class="message-time">${messageTime}</span>
                    <button class="reply-btn" onclick="startReply('${messageData.id}', '${messageData.participantName}', '${messageData.content.replace(/'/g, "&#39;").replace(/"/g, "&quot;")}')" 
                            style="position: absolute; right: 8px; top: 8px; background: none; border: 1px solid #dee2e6; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; font-size: 12px;" 
                            title="ÎãµÏû•ÌïòÍ∏∞">
                        ‚Ü©Ô∏è
                    </button>
                </div>
                <div class="message-content">${messageData.content}</div>
            `;
            
            // ÎãµÏû• Î≤ÑÌäº Ìò∏Î≤Ñ Ìö®Í≥º Ï∂îÍ∞Ä
            messageDiv.addEventListener('mouseenter', function() {
                const replyBtn = this.querySelector('.reply-btn');
                if (replyBtn) replyBtn.style.opacity = '1';
            });
            
            messageDiv.addEventListener('mouseleave', function() {
                const replyBtn = this.querySelector('.reply-btn');
                if (replyBtn) replyBtn.style.opacity = '0';
            });
            
            chatMessages.appendChild(messageDiv);
            
            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Ï±ÑÌåÖ ÏûÖÎ†•ÏóêÏÑú ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Ïù¥Î™®ÏßÄ Îç∞Ïù¥ÌÑ∞
        const emojiData = {
            face: ['üòä', 'üòÇ', 'ü§£', 'üòç', 'ü•∞', 'üòò', 'üòã', 'üòú', 'ü§î', 'üòé', 'ü§ó', 'üò¢', 'üò≠', 'üò°', 'ü§Ø', 'üò¥'],
            gesture: ['üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'üëè', 'üôè', 'üí™', 'üëã', 'üëçüèª', 'üëéüèª', 'üëåüèª', '‚úåüèª', 'ü§ûüèª', 'üëèüèª', 'üôèüèª'],
            heart: ['‚ù§Ô∏è', 'üíô', 'üíö', 'üíõ', 'üß°', 'üíú', 'üñ§', 'üíñ', 'üíï', 'üíó', 'üíò', 'üíù', 'üíû', 'üíü', 'üí¢', 'üíØ'],
            nature: ['üå∏', 'üå∫', 'üåª', 'üå∑', 'üåπ', 'üåø', 'üçÄ', 'üå≥', 'üå≤', 'ü¶ã', 'üêù', 'üåà', '‚≠ê', 'üåô', '‚òÄÔ∏è', 'üî•'],
            food: ['üçé', 'üçä', 'üçã', 'üçå', 'üçá', 'üçì', 'ü´ê', 'üçí', 'ü•ù', 'üçë', 'ü•≠', 'üçç', 'ü••', 'üçÖ', 'üçÜ', 'ü•ï'],
            activity: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üèâ', 'üé±', 'üèì', 'üè∏', 'üéØ', '‚õ≥', 'üéÆ', 'üéµ', 'üé∂', 'üìö']
        };

        // Ïù¥Î™®ÏßÄ ÌîºÏª§ ÌÜ†Í∏Ä
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') {
                emojiPicker.style.display = 'block';
                showEmojiCategory('face'); // Í∏∞Î≥∏ÏúºÎ°ú ÏñºÍµ¥ Ïù¥Î™®ÏßÄ ÌëúÏãú
            } else {
                emojiPicker.style.display = 'none';
            }
        }

        // Ïù¥Î™®ÏßÄ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌëúÏãú
        function showEmojiCategory(category) {
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.emoji-category').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');

            // Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Ïù¥Î™®ÏßÄÎì§ ÌëúÏãú
            const emojiGrid = document.getElementById('emojiGrid');
            const emojis = emojiData[category] || [];
            
            emojiGrid.innerHTML = emojis.map(emoji => 
                `<button class="emoji-item" onclick="insertEmoji('${emoji}')" title="${emoji}">${emoji}</button>`
            ).join('');
        }

        // Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
        function insertEmoji(emoji) {
            const chatInput = document.getElementById('chatInput');
            const currentValue = chatInput.value;
            const cursorPos = chatInput.selectionStart;
            
            // Ïª§ÏÑú ÏúÑÏπòÏóê Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
            const newValue = currentValue.slice(0, cursorPos) + emoji + currentValue.slice(cursorPos);
            chatInput.value = newValue;
            
            // Ïª§ÏÑúÎ•º Ïù¥Î™®ÏßÄ Îí§Î°ú Ïù¥Îèô
            chatInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            
            // ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§
            chatInput.focus();
            
            // Ïù¥Î™®ÏßÄ ÌîºÏª§ Îã´Í∏∞
            document.getElementById('emojiPicker').style.display = 'none';
        }

        // Ïù¥Î™®ÏßÄ ÌîºÏª§ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.addEventListener('click', function(event) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.querySelector('.emoji-btn');
            
            if (emojiPicker && !emojiPicker.contains(event.target) && event.target !== emojiBtn) {
                emojiPicker.style.display = 'none';
            }
        });
    </script>
</body>
</html>